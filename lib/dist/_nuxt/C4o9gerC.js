import{u as Ve}from"./GMLocJHP.js";import{ag as De,ap as me,ax as je,cL as _e,gO as Ke,J as Pe,r as S,bL as Ae,dz as Fe,cX as Ce,f as qe,az as xe,gU as Ie,dc as ce,hL as ze,ah as K,ai as C,y as Ee,g$ as de}from"./DZZ6t_j4.js";import{a as Ne,b as Ue}from"./B05h-4V9.js";import{e as V,r as Z}from"./BDAIZopQ.js";import{d as Je}from"./boyBAVNN.js";const[Xe,Le]=Ve((n,r,ve=!1)=>{var re;if(!n)throw new Error("Table meta is not available");const fe="addNewStack",{t:T}=De(),{api:q}=me(),{base:y,sqlUis:M}=je(_e()),{$e:pe,$api:P}=Ee(),{sorts:N,nestedFilters:U}=Ne(),{sharedView:ee,fetchSharedViewData:ge,fetchSharedViewGroupedData:we}=Ke(),{isUIAllowed:J}=Pe(),D=S(ve)||Ae(Fe,S(!1)),ye=S(null),{search:x}=Ue(),{addUndo:L,clone:A,defineViewScope:B}=Ce(),G=S([]),ae=S((re=n.value)!=null&&re.source_id?M.value[n.value.source_id]:Object.values(M.value)[0]),H=qe(()=>{var t,a,l,s;let e;const u=((a=(t=n.value)==null?void 0:t.columns)==null?void 0:a.find(({id:i})=>i===x.value.field))||((s=(l=n.value)==null?void 0:l.columns)==null?void 0:s.find(i=>i.pv));if(u&&x.value.query.trim())return ae.value&&["text","string"].includes(ae.value.getAbstractType(u))&&u.dt!=="bigint"?e=`(${u.title},like,%${x.value.query.trim()}%)`:e=`(${u.title},eq,${x.value.query.trim()})`,e});xe(Ie,ye);const j=S({}),_=S([]),o=S(new Map),d=S(new Map),g=S(""),p=S(),R=S({}),le=S(!1),te=e=>e.map(u=>({row:{...u},oldRow:{...u},rowMeta:{}}));async function he(){var u,t,a,l;if((!((u=y==null?void 0:y.value)!=null&&u.id)||!((t=n.value)!=null&&t.id)||!((a=r==null?void 0:r.value)!=null&&a.id)||!((l=p==null?void 0:p.value)!=null&&l.id))&&!D.value)return;o.value=new Map,d.value=new Map;let e;D.value?e=await we(p.value.id,{sortsArr:N.value,filtersArr:U.value}):e=await q.dbViewRow.groupedDataList("noco",y.value.id,n.value.id,r.value.id,p.value.id,{where:H.value},{});for(const s of e??[]){const i=s.key;o.value.set(i,te(s.value.list)),d.value.set(i,s.value.pageInfo.totalRows||0)}}const Re=(e,u)=>{const t=(e||[]).reduce((a,l)=>{const s=V(l.row,n.value.columns);return s&&(a[s]=l),a},{});return(u||[]).filter(({row:a})=>{const l=V(a,n.value.columns);return!(l&&t[l])})};async function be(e,u={}){var l,s,i;if((!((l=y==null?void 0:y.value)!=null&&l.id)||!((s=n.value)!=null&&s.id)||!((i=r.value)!=null&&i.id))&&!D.value)return;let t=`(${g.value},eq,${e})`;e===null&&(t=`(${g.value},is,null)`),H.value&&(t=`${t} and ${H.value}`);const a=D.value?await ge({...u,sortsArr:N.value,filtersArr:U.value,offset:u.offset,where:t}):await q.dbViewRow.list("noco",y.value.id,n.value.id,r.value.id,{...u,...J("sortSync")?{}:{sortArrJson:JSON.stringify(N.value)},...J("filterSync")?{}:{filterArrJson:JSON.stringify(U.value)},where:t});o.value.set(e,[...o.value.get(e),...Re(o.value.get(e),te(a.list))])}async function Oe(){var t,a,l,s,i,f,O,k,b;if(!((t=r==null?void 0:r.value)!=null&&t.id)||!((a=n==null?void 0:n.value)!=null&&a.columns))return;j.value=D.value?(l=ee.value)==null?void 0:l.view:await P.dbView.kanbanRead(r.value.id),p.value=D.value?ce((s=ee.value)==null?void 0:s.meta).groupingFieldColumn:n.value.columns.filter(c=>c.id===j.value.fk_grp_col_id)[0]||{},g.value=p.value.title;const{fk_grp_col_id:e,meta:u}=j.value;if(R.value=ce(u)||{},R.value&&e&&R.value[e]){let c=!1,h=!1;for(const v of((i=p.value.colOptions)==null?void 0:i.options)??[]){const m=R.value[e].findIndex(z=>z.id===v.id);if(m!==-1){const{collapsed:z,...E}=R.value[e][m];if(!Je(E,v)){if(D.value)continue;R.value[e][m]={...R.value[e][m],...v},v.title!==E.title&&(o.value.set(v.title,o.value.get(E.title)),d.value.set(v.title,d.value.get(E.title)),await Y(v.title)),c=!0}}else R.value[e].push({...v,collapsed:!1}),o.value.set(v.title,[]),d.value.set(v.title,0),c=!0,h=!0}const $=(O=(f=p.value)==null?void 0:f.colOptions)==null?void 0:O.options.map(({id:v})=>v),w=R.value[e].filter(({id:v})=>v!=="uncategorized"&&!$.includes(v));for(const v of w){const m=R.value[e].map(z=>z.id).indexOf(v.id);m!==-1&&(R.value[e].splice(m,1),o.value.size&&d.value.size&&o.value.has(v.title)&&(await Y(v.title,!0),o.value.set(null,[...o.value.get(null)||[],...o.value.get(v.title)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(v.title)||0))),c=!0)}_.value=[...R.value[e]],c&&(await I(),h&&(le.value=!0))}else _.value=[...((b=(k=p.value)==null?void 0:k.colOptions)==null?void 0:b.options)??[],{id:"uncategorized",title:null,order:0,color:ze.gray[500]}].sort((c,h)=>c.order-h.order).map(c=>({...c,collapsed:!1})),await I()}async function I(){const{fk_grp_col_id:e}=j.value;e&&(R.value[e]=_.value,await ue({meta:R.value}))}async function ue(e){var u;!((u=r==null?void 0:r.value)!=null&&u.id)||!J("dataEdit",{skipSourceCheck:!0})||await P.dbView.kanbanUpdate(r.value.id,e)}function Q(e){var t;const u=Z(e,(t=n==null?void 0:n.value)==null?void 0:t.columns);for(const a of o.value.values())for(const l of a)if(Object.keys(u).every(s=>u[s]===l.row[s]))return l}async function W(e,u=o.value.get(null).length,t=!1){var a,l,s,i,f;try{const O=((a=n==null?void 0:n.value)==null?void 0:a.columns).reduce((b,c)=>((!c.ai||t)&&(e==null?void 0:e[c.title])!==null&&(b[c.title]=e==null?void 0:e[c.title]),b),{}),k=await P.dbViewRow.create(de,y==null?void 0:y.value.id,(l=n.value)==null?void 0:l.id,(s=r==null?void 0:r.value)==null?void 0:s.id,O);if(!t){const b=V(k,(i=n.value)==null?void 0:i.columns);L({redo:{fn:async function(h,$){var v;const w=Z(h.row,(v=n.value)==null?void 0:v.columns);h.row={...w,...h.row},await W(h,$,!0),F(h,!0)},args:[A(e),u]},undo:{fn:async function(h){await ie(h);const $=Q(k);$&&oe($)},args:[b]},scope:B({view:r.value})})}return(f=o.value.get(null))==null||f.splice(u??0,1,{row:k,rowMeta:{},oldRow:{...k}}),k}catch(O){K.error(await C(O))}}async function X(e,u,t=!1){var a,l,s;try{const i=V(e.row,(a=n==null?void 0:n.value)==null?void 0:a.columns),f=await P.dbViewRow.update(de,y==null?void 0:y.value.id,(l=n.value)==null?void 0:l.id,(s=r==null?void 0:r.value)==null?void 0:s.id,encodeURIComponent(i),{[u]:e.row[u]});if(!t){const O=G.value.find(b=>b.op==="removed"&&b.pk===i),k=G.value.find(b=>b.op==="added"&&b.pk===i);L({redo:{fn:async function(c,h){const $=await X(c,h,!0),w=Q(c.row);w&&(Object.assign(w.row,$),w.row[g.value]!==w.oldRow[g.value]&&F(w,!1,k==null?void 0:k.index),Object.assign(w.oldRow,$))},args:[A(e),u]},undo:{fn:async function(c,h){const $=await X({row:c.oldRow,oldRow:c.row,rowMeta:c.rowMeta},h,!0),w=Q(c.row);w&&(Object.assign(w.row,$),w.row[g.value]!==w.oldRow[g.value]&&F(w,!1,O==null?void 0:O.index),Object.assign(w.oldRow,$))},args:[A(e),u]},scope:B({view:r.value})}),Object.assign(e.row,f),Object.assign(e.oldRow,f)}return f}catch(i){K.error(`${T("msg.error.rowUpdateFailed")} ${await C(i)}`)}}async function Se(e){e.rowMeta.new?await W(e.row,o.value.get(e.row.title).indexOf(e)):await X(e,g.value)}async function Y(e,u=!1){var t;try{const a=u?null:e;await q.dbTableRow.bulkUpdateAll("noco",y.value.id,(t=n.value)==null?void 0:t.id,{[g.value]:a},{where:`(${g.value},eq,${e})`}),o.value.has(e)&&o.value.set(e,(o.value.get(e)||[]).map(l=>({...l,row:{...l.row,[g.value]:a},oldRow:{...l.oldRow,[g.value]:l.row[g.value]}})))}catch(a){K.error(await C(a))}}async function ke(e,u){var t;if(!(!((t=r==null?void 0:r.value)!=null&&t.id)||!p.value))try{await Y(e,!0),o.value.set(null,[...o.value.get(null),...o.value.get(e)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(e)||0)),o.value.delete(e),d.value.delete(e);const a=p.value.colOptions.options.filter(s=>s.title!==e);p.value.colOptions.options=a;const l=p.value.cdf?p.value.cdf.replace(/^'/,"").replace(/'$/,""):null;await q.dbTableColumn.update(p.value.id,{...p.value,colOptions:{options:a},cdf:l===e?null:l}),_.value.splice(u,1),R.value[j.value.fk_grp_col_id]=_.value,await I(),pe("a:kanban:delete-stack")}catch(a){K.error(await C(a))}}function $e(e=o.value.get(null).length){return o.value.get(null).splice(e,0,{row:{},oldRow:{},rowMeta:{new:!0}}),o.value.get(null)[e]}function F(e,u,t){const a=e.row[g.value],l=e.oldRow[g.value];if(u)a&&(t!==void 0?o.value.get(a).splice(t,0,e):o.value.get(a).push(e),d.value.set(a,d.value.get(a)+1),ne());else{const s=V(e.row,n.value.columns),i=o.value.get(l).findIndex(f=>V(f.row,n.value.columns)===s);if(i!==-1)if(a!==l){d.value.set(l,d.value.get(l)-1);const f=o.value.get(l);if(f.splice(i,1),o.value.set(l,f),d.value.set(a,d.value.get(a)+1),t!==void 0){const O=o.value.get(a);O.splice(t,0,e),o.value.set(a,O)}else o.value.set(a,[...o.value.get(a),e])}else{const f=o.value.get(a);t!==void 0?(f.splice(i,1),f.splice(t,0,e)):f[i]=e,o.value.set(l,f)}}}function oe(e){const u=V(e.row,n.value.columns),t=e.row[g.value];o.value.set(t,o.value.get(t).filter(a=>V(a.row,n.value.columns)!==u)),d.value.set(t,d.value.get(t)-1)}function ne(){D.value||(o.value.get(null).pop(),d.value.set(null,d.value.get(null)-1))}async function se(e,u=!1){var t;try{if(u||L({redo:{fn:async function(l){await se(l,!0)},args:[A(e)]},undo:{fn:async function(l){var i;const s=Z(l.row,(i=n.value)==null?void 0:i.columns);l.row={...s,...l.row},await W(l.row,void 0,!0),F(l,!0)},args:[A(e)]},scope:B({view:r.value})}),!e.rowMeta.new){const a=V(e.row,(t=n==null?void 0:n.value)==null?void 0:t.columns);if(!await ie(a))return}oe(e)}catch(a){K.error(`${T("msg.error.deleteRowFailed")}: ${await C(a)}`)}}async function ie(e){var t,a;if(!e)throw new Error("Delete not allowed for table which doesn't have primary Key");const u=await P.dbViewRow.delete("noco",y.value.id,(t=n.value)==null?void 0:t.id,(a=r.value)==null?void 0:a.id,encodeURIComponent(e));return u.message?(K.info(`Record delete failed: ${`Unable to delete record with ID ${e} because of the following:
              
${u.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}return{loadKanbanData:he,loadMoreKanbanData:be,loadKanbanMeta:Oe,updateKanbanMeta:ue,kanbanMetaData:j,formattedData:o,countByStack:d,groupingField:g,groupingFieldColOptions:_,groupingFieldColumn:p,updateOrSaveRow:Se,addEmptyRow:$e,addOrEditStackRow:F,deleteStack:ke,updateKanbanStackMeta:I,removeRowFromUncategorizedStack:ne,shouldScrollToRight:le,deleteRow:se,moveHistory:G,addNewStackId:fe}},"kanban-view-store");function Ye(){const n=Le();if(n==null)throw new Error("Please call `useProvideKanbanViewStore` on the appropriate parent component");return n}export{Ye as a,Xe as u};
