import{g5 as st,eL as rt,k as ct,hj as ut,ga as at,aN as dt,hk as mt,r as A,ap as pt,L as j,F as H,ah as Q,gx as Z,cp as nt,e as F,a5 as U,o as i,c as N,a as f,a6 as X,N as t,t as D,R as O,Q as k,w as m,b as _,S as E,W as B,d as z,Y as L,Z as Y,$ as ft,n as tt,hl as G,gz as _t,ax as yt,a8 as J,ao as W,at as et,O as vt,fU as gt,_ as xt,ba as wt}from"./DZZ6t_j4.js";import{_ as bt}from"./sz1d3zjm.js";import{_ as ht}from"./TJfB7GlU.js";import{_ as Nt}from"./BLgccLvp.js";import{_ as it}from"./vK-WmZ7a.js";import{_ as kt}from"./8DEek4Fb.js";import{t as It}from"./2FgppHLC.js";import{_ as $t}from"./Ck-cgwga.js";import{W as ot}from"./9ZvwAtsX.js";const P=`tab-${Math.random().toString(36).slice(2,9)}`;function St(x,l,s={}){const{timeout:d=5e3,storageDelay:y=50,debug:n=!1}=s,v=`nc-shared-execution-${x}-result`,u=`nc-shared-execution-${x}-lock`,a=st(v,{}),c=(...e)=>{n&&console.log(`[${P}]`,...e)};c(`Tab initialized with ID: ${P}`);const p=()=>{try{return JSON.parse(localStorage.getItem(u)||"null")}catch(e){return c("Error reading lock:",e),null}},I=async()=>{let e=p();const g=Date.now();return e?g-e.timestamp>d?(localStorage.setItem(u,JSON.stringify({timestamp:g,tabId:P})),await new Promise(S=>setTimeout(S,y)),e=p(),(e==null?void 0:e.tabId)===P?(c("Stale lock acquired successfully"),!0):(c(`Stale lock acquired by ${e==null?void 0:e.tabId}`),!1)):(c(`Lock is held by ${e==null?void 0:e.tabId}`),!1):(localStorage.setItem(u,JSON.stringify({timestamp:g,tabId:P})),await new Promise(S=>setTimeout(S,y)),e=p(),(e==null?void 0:e.tabId)===P?(c("Lock acquired successfully"),!0):(c(`Lock acquired by ${e==null?void 0:e.tabId}`),!1))},h=()=>{const e=p();(e==null?void 0:e.tabId)===P&&(c("Releasing lock."),localStorage.removeItem(u))},R=async()=>{if(c("sharedExecutionFn called"),!await I()){const e=p();return new Promise((g,$)=>{let S=!1;const{start:M,stop:K}=ut(()=>{S=!0,localStorage.removeItem(u),$(new Error(`Timeout waiting for result on key ${x}`))},e!=null&&e.timestamp?d-(Date.now()-e.timestamp):d);M(),a.value.status&&(a.value={...a.value,status:void 0}),at(()=>a.value).toMatch(C=>C.status==="success"||C.status==="error").then(C=>{if(S)return;K();const{result:w,error:T}=C;w?g(w):$(T)})})}try{a.value={...a.value,status:void 0};const e=await l();return a.value={status:"success",result:e},e}catch(e){throw a.value={status:"error",error:e},e}finally{h(),c("Function execution completed (success or failure).")}};return rt(()=>{window.addEventListener("beforeunload",h)}),ct(()=>{window.removeEventListener("beforeunload",h)}),R}const Rt=nt.CancelToken,q=dt("notificationStore",()=>{const x=st(mt,!1),l=A([]),s=A([]),d=A(),y=A(),n=A(0),v=A("unread"),{api:u,isLoading:a}=pt(),{token:c}=j();let p=null,I;const R=St("notification",async()=>(I=Rt.source(),await u.notification.poll({cancelToken:I.token})),{timeout:3e4}),e=async()=>{try{if(!c.value)return;const o=await R();o.status==="success"&&(v.value==="unread"&&(s.value=[JSON.parse(o.data),...s.value]),n.value=n.value+1),p=setTimeout(e,0)}catch(o){if(nt.isCancel(o))return;p=setTimeout(e,2e3)}},g=async o=>{try{const r=await u.notification.list({is_read:!0,limit:10,offset:o?l.value.length:0});o?l.value=[...l.value,...r.list]:l.value=r.list,d.value=r.pageInfo,n.value=Number(r.unreadCount)}catch(r){console.log(r)}},$=async o=>{try{const r=await u.notification.list({is_read:!1,limit:10,offset:o?s.value.length:0});o?s.value=[...s.value,...r.list]:s.value=r.list,y.value=r.pageInfo,n.value=Number(r.unreadCount)}catch(r){console.log(r)}},S=(o,r)=>{r?(l.value=l.value.filter(b=>b.id!==o.id),s.value=[o,...s.value].sort((b,V)=>new Date(V.created_at).getTime()-new Date(b.created_at).getTime()),n.value=n.value+1):(l.value=[o,...l.value].sort((b,V)=>new Date(V.created_at).getTime()-new Date(b.created_at).getTime()),s.value=s.value.filter(b=>b.id!==o.id),n.value=n.value-1)},M=async(o,r)=>{if(r)return;const b=o.is_read;try{await u.notification.update(o.id,{is_read:!b}),o.is_read=!b,S(o,b)}catch(V){Q.error(`Failed to update Notification: ${await Z(V)}`)}},K=async o=>{o.is_read||(await u.notification.markAllAsRead(),await Promise.allSettled([g(),$()]))},C=async o=>{try{l.value=l.value.filter(r=>r.id!==o.id),await u.notification.delete(o.id)}catch(r){l.value=[o,...l.value],Q.error(`Failed to delete Notification: ${await Z(r)}`)}};H(v,async o=>{o==="read"?await g():await $()});const w=async()=>{p&&(clearTimeout(p),p=null);const o=I;I=null,await at(x).toMatch(r=>!r,{timeout:1e4}),o==null||o.cancel()},T=async()=>{await Promise.allSettled([g(),$()]),window.isPlaywright||(w().catch(o=>console.log(o)),e().catch(o=>console.log(o)))};return H(c,async(o,r)=>{try{o&&o!==r?await T():o||w().catch(b=>console.log(b))}catch(b){console.error(b)}},{immediate:!0}),{unreadNotifications:s,readNotifications:l,loadUnReadNotifications:$,loadReadNotifications:g,deleteNotification:C,readPageInfo:d,unreadPageInfo:y,isLoading:a,notificationTab:v,toggleRead:M,markAllAsRead:K,unreadCount:n}}),Ct={class:"flex pl-6 pr-4 w-full overflow-x-hidden group py-4 hover:bg-gray-50 gap-3 relative cursor-pointer"},Tt={class:"w-9.625"},Et={class:"text-[13px] min-h-12 w-full leading-5"},Pt={key:0,class:"text-xs whitespace-nowrap absolute right-4.1 bottom-5 text-gray-600"},At={class:"flex items-start"},lt=F({__name:"Wrapper",props:{item:{}},setup(x){const s=U(x,"item"),{isMobileMode:d}=j(),y=q(),{toggleRead:n,deleteNotification:v}=y;return(u,a)=>{const c=L,p=Y,I=ft,h=bt,R=ht,e=Nt,g=it;return i(),N("div",Ct,[f("div",Tt,[X(u.$slots,"avatar",{},()=>[a[4]||(a[4]=f("img",{src:kt,alt:"NocoDB",class:"w-8"},null,-1))])]),f("div",Et,[X(u.$slots,"default")]),t(s)?(i(),N("div",Pt,D(t(It)(t(s).created_at)),1)):O("",!0),f("div",At,[t(s).is_read?(i(),k(g,{key:1,class:E([{"!opacity-100":t(d)},"transition-all duration-100 opacity-0 !group-hover:opacity-100"])},{overlay:m(()=>[_(e,null,{default:m(()=>[_(h,{onClick:a[2]||(a[2]=B(()=>t(n)(t(s)),["stop"]))},{default:m(()=>a[6]||(a[6]=[z(" Mark as unread ")])),_:1}),_(R),_(h,{class:"!text-red-500 !hover:bg-red-50",onClick:a[3]||(a[3]=B($=>t(v)(t(s)),["stop"]))},{default:m(()=>a[7]||(a[7]=[z(" Delete ")])),_:1})]),_:1})]),default:m(()=>[_(p,{size:"xsmall",type:"secondary",onClick:a[1]||(a[1]=B(()=>{},["stop"]))},{default:m(()=>[_(c,{icon:"threeDotVertical"})]),_:1})]),_:1},8,["class"])):(i(),k(I,{key:0},{title:m(()=>a[5]||(a[5]=[f("span",null,"Mark as read",-1)])),default:m(()=>[_(p,{class:E([{"!opacity-100":t(d)},"!border-0 transition-all duration-100 opacity-0 !group-hover:opacity-100"]),type:"secondary",size:"xsmall",onClick:a[0]||(a[0]=B(()=>t(n)(t(s)),["stop"]))},{default:m(()=>[_(c,{icon:"check",class:"text-gray-700"})]),_:1},8,["class"])]),_:1}))])])}}}),Dt=F({__name:"Welcome",props:{item:{}},setup(x){const s=U(x,"item");return(d,y)=>{const n=lt;return i(),k(n,{item:t(s)},{default:m(()=>y[0]||(y[0]=[f("div",null,[z("Welcome to "),f("span",{class:"font-semibold"},"NocoDB!"),z(" Weâ€™re excited to have you onboard.")],-1)])),_:1},8,["item"])}}}),Mt={class:"font-semibold"},Wt={class:"font-semibold"},Ot=F({__name:"ProjectInvite",props:{item:{}},setup(x){const l=x,{navigateToProject:s}=j(),d=U(l,"item");return(y,n)=>{const v=lt;return i(),k(v,{item:t(d),onClick:n[0]||(n[0]=u=>t(s)({baseId:t(d).body.base.id}))},{default:m(()=>[f("div",null,[f("span",Mt,D(t(d).body.user.display_name??t(d).body.user.email),1),n[1]||(n[1]=z(" has invited you to collaborate on ")),f("span",Wt,D(t(d).body.base.title),1),n[2]||(n[2]=z(" base. "))])]),_:1},8,["item"])}}}),Bt={key:4},zt=F({__name:"Item",props:{item:{}},setup(x){const s=U(x,"item"),d=q(),{toggleRead:y}=d;return(n,v)=>{const u=Dt,a=Ot,c=tt("NotificationItemWorkspaceInvite"),p=tt("NotificationItemMentionEvent");return i(),N("div",{class:"select-none",onClick:v[0]||(v[0]=I=>t(y)(t(s),t(s).is_read))},[t(s).type===t(G).WELCOME?(i(),k(u,{key:0,item:t(s)},null,8,["item"])):t(s).type===t(G).PROJECT_INVITE?(i(),k(a,{key:1,item:t(s)},null,8,["item"])):t(s).type===t(G).WORKSPACE_INVITE?(i(),k(c,{key:2,item:t(s)},null,8,["item"])):["mention"].includes(t(s).type)?(i(),k(p,{key:3,item:t(s)},null,8,["item"])):(i(),N("span",Bt))])}}}),Ft={class:"space-y-3"},Kt={class:"flex px-6 justify-between items-center"},Vt={class:"text-sm !text-gray-500"},jt={class:"text-sm text-gray-500"},Ut=F({__name:"Card",setup(x){const l=q(),{isMobileMode:s}=j(),d=A(),{height:y}=_t(d),{loadUnReadNotifications:n,loadReadNotifications:v,markAllAsRead:u}=l,{unreadNotifications:a,readNotifications:c,readPageInfo:p,unreadPageInfo:I,notificationTab:h}=yt(l);return(R,e)=>{var C;const g=L,$=Y,S=zt,M=gt,K=$t;return i(),N("div",{ref_key:"container",ref:d,style:J([{"box-shadow":"0px -12px 16px -4px rgba(0, 0, 0, 0.1), 0px -4px 6px -2px rgba(0, 0, 0, 0.06)"},t(s)?"":"width: min(80svw, 520px);"]),class:E([{"max-h-[70vh] h-[620px]":!t(s),"h-[100svh] w-[100svw]":t(s)},"!rounded-lg pt-4"])},[f("div",Ft,[f("div",Kt,[f("span",{class:"text-md font-bold text-gray-800",onClick:e[0]||(e[0]=B(()=>{},["stop"]))},D(R.$t("general.notification"))+"s ",1),t(s)?(i(),k($,{key:0,size:"small",type:"secondary"},{default:m(()=>[_(g,{icon:"close",class:"text-gray-700"})]),_:1})):O("",!0)]),t(h)!=="read"?(i(),N("div",{key:0,class:E([{"text-gray-400":!((C=t(a))!=null&&C.length)},"cursor-pointer right-5 pointer-events-auto top-12.5 z-2 absolute text-[13px] text-gray-600 font-weight-semibold"]),onClick:e[1]||(e[1]=B((...w)=>t(u)&&t(u)(...w),["stop"]))},D(R.$t("activity.markAllAsRead")),3)):O("",!0),_(K,{activeKey:t(h),"onUpdate:activeKey":e[4]||(e[4]=w=>vt(h)?h.value=w:null)},{default:m(()=>[_(M,{key:"unread"},{tab:m(()=>[f("span",{class:E([{"font-semibold":t(h)==="unread"},"text-xs"])}," Unread ",2)]),default:m(()=>{var w,T;return[f("div",{class:E(["overflow-y-auto",{"flex flex-col items-center min-h-[48svh] justify-center":!((w=t(a))!=null&&w.length)}]),style:J(`height: ${t(y)-72}px`)},[(T=t(a))!=null&&T.length?(i(),N(W,{key:1},[(i(!0),N(W,null,et(t(a),o=>(i(),k(S,{key:o.id,item:o},null,8,["item"]))),128)),t(a)&&t(I)&&t(I).totalRows>t(a).length?(i(),k(t(ot),{key:0,onInfinite:e[2]||(e[2]=o=>t(n)(!0))})):O("",!0)],64)):(i(),N(W,{key:0},[f("div",Vt,D(R.$t("msg.noNewNotifications")),1),_(g,{icon:"inbox",class:"!text-40px !text-gray-500"})],64))],6)]}),_:1}),_(M,{key:"read"},{tab:m(()=>[f("span",{class:E([{"font-semibold":t(h)==="read"},"text-xs"])}," Read ",2)]),default:m(()=>{var w,T;return[f("div",{class:E(["overflow-y-auto",{"flex flex-col items-center min-h-[48svh] justify-center":!((w=t(c))!=null&&w.length)}]),style:J(t(s)?"":`height: ${t(y)-72}px`)},[(T=t(c))!=null&&T.length?(i(),N(W,{key:1},[(i(!0),N(W,null,et(t(c),o=>(i(),k(S,{key:o.id,item:o},null,8,["item"]))),128)),t(c)&&t(p)&&t(p).totalRows>t(c).length?(i(),k(t(ot),{key:0,onInfinite:e[3]||(e[3]=o=>t(v)(!0))})):O("",!0)],64)):(i(),N(W,{key:0},[f("div",jt,D(R.$t("msg.noNewNotifications")),1),_(g,{icon:"inbox",class:"!text-40px text-gray-500"})],64))],6)]}),_:1})]),_:1},8,["activeKey"])])],6)}}}),qt=xt(Ut,[["__scopeId","data-v-02e83c3f"]]),Gt={class:"cursor-pointer flex items-center"},oe=F({__name:"Menu",setup(x){const l=q(),{unreadCount:s}=wt(l);return(d,y)=>{const n=L,v=Y,u=qt,a=it;return i(),N("div",Gt,[_(a,{"overlay-class-name":"!shadow-none",placement:"bottomRight",trigger:["click"]},{overlay:m(()=>[_(u)]),default:m(()=>[_(v,{size:"small",class:"!border-none !bg-gray-50",type:"secondary"},{default:m(()=>[t(s)?(i(),N("span",{key:t(s),class:"bg-red-500 w-2 h-2 border-1 border-white rounded-[6px] absolute top-[5px] left-[15px]"})):O("",!0),_(n,{icon:"notification"})]),_:1})]),_:1})])}}});export{oe as _};
