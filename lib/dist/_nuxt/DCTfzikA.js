import{u as ge}from"./B_8aIjz8.js";import{r as n,at as U,cG as we,av as Se,g7 as be,ag as ye,cP as Me,cB as ke,au as Fe,ai as Oe,M as Ve,g as T,cV as x,cU as l,fG as y,fw as te,d4 as m,H as j,g8 as De,fX as Re,dS as _e,g9 as Ne,ga as Ye,gb as ae,an as B,gc as Te,ao as je,gd as ie,ce as h,ge as qe,fI as Ee}from"./B2hUoZAs.js";import{u as Ie}from"./B-HHpLTx.js";import{u as Le}from"./nk4tSM_m.js";import{i as se,A as Pe}from"./BXXS6TCz.js";import{i as Ce}from"./MeGaiume.js";import{g as Ae,e as He,r as Ue}from"./Cbc39be_.js";import{F as xe}from"./By21eAqY.js";const Be=xe.useForm,[et,$e]=ge(R=>{const _=n(!1),$=n(!1),N=n(!1),q=n(!1),w=n(null),M=n(null),k=n(0),{sharedView:Y}=U(we());Se(be,w);const S=n(),F=n(),b=n(),O=n({}),E=_e(),{api:G,isLoading:re}=ye(),{metas:le,setMeta:W}=Me(),I=ke(),{base:oe,sqlUis:Z}=U(I),ne=Fe(),{basesUser:J}=U(ne),{t:K}=Oe(),L=Ve(),u=n({}),X=n({}),V=n({});Ie(F);const{state:v}=Le(n({row:u,rowMeta:{new:!0},oldRow:{}})),D=T(()=>{var e;return((e=b.value)==null?void 0:e.filter(t=>t.show).filter(t=>!x(t)&&t.uidt!==l.SpecificDBType&&(!y(t)||te(t.uidt))))||[]}),ue=async()=>{var e,t;M.value=null;try{const a=await G.public.sharedViewMetaGet(R,{headers:{"xc-password":w.value}});q.value=!1,Y.value=a,S.value=a.view,F.value=a.model;const s=(a.columns||[]).reduce((i,o)=>({...i,[o.fk_column_id]:o}),{});b.value=(((e=a.model)==null?void 0:e.columns)||[]).filter(i=>s[i.id]).map(i=>{if(!x(i)&&!y(i)&&!se(i)&&i.uidt!==l.SpecificDBType&&(i!=null&&i.title)&&Ce(i==null?void 0:i.cdf)&&!/^\w+\(\)|CURRENT_TIMESTAMP$/.test(i.cdf)){const o=typeof i.cdf=="string"?i.cdf.replace(/^'|'$/g,""):i.cdf;[l.Number,l.Duration,l.Percent,l.Currency,l.Decimal].includes(i.uidt)?(u.value[i.title]=Number(o)||null,V.value[i.title]=Number(o)||null):i.uidt===l.Checkbox?["true","1"].includes(String(o).toLowerCase())?(u.value[i.title]=!0,V.value[i.title]=!0):["false","0"].includes(String(o).toLowerCase())&&(u.value[i.title]=!1,V.value[i.title]=!1):(u.value[i.title]=o,V.value[i.title]=o)}return{...i,meta:{...m(s[i.id].meta),...m(i.meta)},description:s[i.id].description}});const d=a.meta;O.value=Ne(d)?JSON.parse(d):d,await W(a.model),(t=oe.value)!=null&&t.sources||I.setProject({sources:[{id:a.source_id,type:a.client}]});const f={...a.relatedMetas};Object.keys(f).forEach(i=>W(f[i])),a.users&&J.value.set(a.base_id,a.users),ve()}catch(a){const s=await Ye(a);a.response&&a.response.status===404?$.value=!0:s.error===ae.INVALID_SHARED_VIEW_PASSWORD?(q.value=!0,w.value&&w.value!==""&&(M.value=s.message)):s.error===ae.UNKNOWN_ERROR&&(console.error("Error occurred while loading shared form view",a),B.error("Error occurred while loading shared form view"))}},p=T(()=>{const e=new Set;return D.value.reduce((t,a)=>(t[a.title]=Ae(a.title,e),t),{})}),z=T(()=>{const e={};if(!D.value||!Object.keys(p.value).length)return e;for(const t of D.value){let a=[{validator:(d,f)=>new Promise((i,o)=>H(t)&&(typeof f=="string"&&(f=f.trim()),t.uidt===l.Checkbox&&!f||t.uidt!==l.Checkbox&&!Ue(f))?o(K("msg.error.fieldRequired")):i())}];const s=He(m(t.meta).validators??[],t);a=[...a,...s],a.length&&(e[p.value[t.title]]=a)}return e}),de=T(()=>{if(!Object.keys(p.value).length)return{};const e=Object.keys(u.value).reduce((a,s)=>(a[p.value[s]]=u.value[s],a),{}),t=Object.keys(v.value).reduce((a,s)=>(a[p.value[s]]=v.value[s],a),{});return{...e,...t}}),{validate:P,validateInfos:fe,clearValidate:C}=Be(de,z),Q=()=>{for(const e of D.value)e.title&&H(e)&&u.value[e.title]===void 0&&v.value[e.title]===void 0&&(y(e)?v.value[e.title]=null:u.value[e.title]=null)},me=async()=>{Q();try{return await P([...Object.keys(u.value).map(e=>p.value[e]),...Object.keys(v.value).map(e=>p.value[e])]),!0}catch(e){if(e.errorFields.length)return B.error(K("msg.error.someOfTheRequiredFieldsAreEmpty")),!1}},ce=async()=>{var e,t,a;try{if(!await me())return;_.value=!0;const s={...u.value,...v.value},d={};for(const i of(a=(t=le.value)==null?void 0:t[(e=Y.value)==null?void 0:e.fk_model_id])==null?void 0:a.columns)i.uidt===l.Attachment&&s[i.title]&&(d[`_${i.title}`]=s[i.title].map(o=>o.file));const f=Te({data:s,...d});await G.public.dataCreate(Y.value.uuid,f,{headers:{"xc-password":w.value}}),N.value=!0,_.value=!1}catch(s){console.log(s),await B.error(await je(s))}_.value=!1},ee=async()=>{E.trigger(),v.value={},u.value={...V.value,...O.value.preFillEnabled?X.value:{}},C()};function ve(){Object.keys(L.query||{}).length&&O.value.preFillEnabled&&(b.value=(b.value||[]).map(e=>{const t=L.query[e.title]||L.query[encodeURIComponent(e.title)];if(!e.title||!t||x(e)||y(e)||se(e)||e.uidt===l.SpecificDBType)return e;const a=he(e,decodeURIComponent(t).trim());if(a!==void 0)switch(u.value[e.title]=a,X.value[e.title]=a,O.value.preFilledMode){case ie.Hidden:{e.show=!1;break}case ie.Locked:{e.read_only=!0;break}}return e}))}function pe(e){var t;return(t=e!=null&&e.source_id?Z.value[e==null?void 0:e.source_id]:Object.values(Z.value)[0])==null?void 0:t.getAbstractType(e)}function he(e,t){var s,d,f;let a;switch(e.uidt){case l.SingleSelect:case l.MultiSelect:case l.User:{const i=(m(e.meta).isLimitOption?m(e.meta).limitOptions||[]:[]).reduce((r,c)=>(c!=null&&c.id&&(r[c.id]=c),r),{}),o=t.split(",");let g=[];[l.SingleSelect,l.MultiSelect].includes(e.uidt)?(g=(((s=e.colOptions)==null?void 0:s.options)||[]).filter(r=>{var c;return!!(r!=null&&r.id&&(r!=null&&r.title)&&o.includes(r.title)&&(i[r.id]?(c=i[r.id])!=null&&c.show:!m(e.meta).isLimitOption||!(m(e.meta).limitOptions||[]).length))}).map(r=>r.title),g.length&&(a=e.uidt===l.SingleSelect?g[0]:g.join(","))):(g=((d=F.value)!=null&&d.base_id?J.value.get(F.value.base_id)||[]:[]).filter(r=>{var c;return!!(r!=null&&r.id&&(r!=null&&r.email)&&(o.includes(r.email)||o.includes(r.id))&&(i[r.id]?(c=i[r.id])!=null&&c.show:!m(e.meta).isLimitOption||!(m(e.meta).limitOptions||[]).length))}).map(r=>r.email),g.length&&(a=(f=m(e.meta))!=null&&f.is_multi?g.join(","):g[0]));break}case l.Checkbox:{["true",!0,"1",1].includes(t.toLowerCase())?a=!0:["false",!1,"0",0].includes(t.toLowerCase())&&(a=!1);break}case l.Rating:{isNaN(Number(t))||(a=Math.min(Math.max(Number(t),0),m(e.meta).max??5));break}case l.URL:{m(e.meta).validate?qe(t)&&(a=t):a=t;break}case l.Year:{/^\d+$/.test(t)&&(a=Number(t));break}case l.Date:{const i=h(t);(i.isValid()&&i.toISOString()===t||h(t,"YYYY-MM-DD").isValid())&&(a=h(t).format("YYYY-MM-DD"));break}case l.DateTime:{const i=h(t);(i.isValid()&&i.toISOString()===t||h(t,"YYYY-MM-DD HH:mm:ss").isValid())&&(a=h(t).utc().format("YYYY-MM-DD HH:mm:ssZ"));break}case l.Time:{let i=h(t);i.isValid()||(i=h(t,"HH:mm:ss")),i.isValid()||(i=h(`1999-01-01 ${t}`)),i.isValid()&&(a=i.format(I.isMysql(e.source_id)?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD HH:mm:ssZ"));break}case l.LinkToAnotherRecord:case l.Links:break;default:Pe(e,pe(e))?isNaN(Number(t))||(a=Number(t)):a=t}return a}let A;j(N,e=>{var t,a;e&&((t=S.value)!=null&&t.show_blank_form)&&(k.value=5,A=De(()=>{k.value=k.value-1,k.value<0&&(N.value=!1,E.trigger(),clearInterval(A))},1e3)),e||((a=S.value)!=null&&a.show_blank_form&&clearInterval(A),ee(),C())});function H(e){var t;if(!y(e)&&(e.rqd&&!e.cdf||e.pk&&!(e.ai||e.cdf)||e.required))return!0;if(te(e)&&e.colOptions&&e.colOptions.type===Ee.BELONGS_TO){const a=(t=b.value)==null?void 0:t.find(s=>{var d;return s.id===((d=e==null?void 0:e.colOptions)==null?void 0:d.fk_child_column_id)});if((a&&a.rqd&&!a.cdf||e.required)&&a)return!0}else if(y(e)&&e.required)return!0;return!1}return j(w,(e,t)=>{e!==t&&M.value&&(M.value=null)}),j(()=>{var e;return(e=S.value)==null?void 0:e.heading},()=>{var e;Re(`${((e=S.value)==null?void 0:e.heading)??"NocoDB"}`)},{flush:"post"}),j(v,async()=>{try{await P(Object.keys(v.value).map(e=>p.value[e]))}catch{}},{deep:!0}),{sharedView:Y,sharedFormView:S,loadSharedView:ue,columns:b,submitForm:ce,clearForm:ee,progress:_,meta:F,validators:z,formColumns:D,formState:u,notFound:$,password:w,passwordError:M,submitted:N,secondsRemain:k,passwordDlg:q,isLoading:re,sharedViewMeta:O,onReset:E.on,validate:P,validateInfos:fe,clearValidate:C,additionalState:v,isRequired:H,handleAddMissingRequiredFieldDefaultState:Q,fieldMappings:p}},"shared-form-view-store");function tt(){const R=$e();if(R==null)throw new Error("Please call `useProvideSharedFormStore` on the appropriate parent component");return R}export{tt as a,et as u};
