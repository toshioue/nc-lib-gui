import{_ as ie}from"./CynerQ2m.js";import{e as re,c_ as d,L as ce,r as E,gz as de,f as M,cq as O,d4 as ue,g as pe,o as c,Q as w,w as l,a as n,S as y,N as t,b as r,c as v,ao as T,at as P,d as _,t as x,T as R,U as z,R as S,ah as A,ai as me,fS as fe,iZ as xe,z as ve,dn as _e,$ as be,d5 as ye,Z as we,Y as he,aL as ge,y as Ee,_ as Se}from"./DZZ6t_j4.js";import{_ as ke}from"./DnSVh-oD.js";import{_ as Ce}from"./jk15w8bt.js";import{a as Ie}from"./20waaH4V.js";import{u as Le}from"./DA0VIM8P.js";import{t as Te}from"./2FgppHLC.js";import{S as De}from"./D_MsYLkT.js";import"./sz1d3zjm.js";import"./TJfB7GlU.js";import"./0azk-b-q.js";import"./BLgccLvp.js";import"./vK-WmZ7a.js";import"./GMLocJHP.js";import"./B05h-4V9.js";import"./BDAIZopQ.js";import"./DKN1hQ6S.js";import"./BQuyMdA-.js";import"./BQQOEPN4.js";import"./vll-Pnjv.js";import"./B5RRVMt5.js";import"./DGj1ycqW.js";import"./DyDFI6NE.js";import"./0QUe8GCE.js";import"./Bdv7ru7D.js";import"./BVrX6sNU.js";import"./Dwil3It4.js";import"./B0udi9ji.js";import"./Dg0-TbNo.js";import"./t0mbNaqp.js";import"./Ck-cgwga.js";import"./CMIIcM5i.js";import"./9kNwGLxE.js";import"./DS_HXCWn.js";import"./C4o9gerC.js";import"./boyBAVNN.js";import"./BhreHRvP.js";import"./DWT0yQl9.js";import"./Cyxyb8KW.js";import"./i4aLU0Nw.js";import"./BIg_TdrP.js";import"./qW2V2r_p.js";import"./ByVBARmO.js";import"./BCJFTkwv.js";import"./CB1aB6F1.js";const Je={class:"pb-3 flex items-center justify-between gap-2.5 flex-wrap"},$e={class:"flex-1 flex items-center border-1 border-gray-200 rounded-lg focus-within:border-brand-500 focus-within:shadow-selected transition-colors transition-shadow"},Me={class:"w-full flex items-center gap-2"},Oe={class:"min-w-5 flex items-center justify-center"},Pe={class:"w-full flex items-center gap-2"},Ae={class:"min-w-5 flex items-center justify-center"},Fe={class:"flex-none flex justify-end"},Ve={class:"data-exporter-body flex-1 flex flex-col"},je={key:0,class:"flex-1 flex flex-col nc-scrollbar-thin max-h-[calc(100%_-_25px)]"},Ne={key:1,class:"h-5 flex items-center"},Be={class:"flex-1 max-w-[calc(100%_-_28px)] flex flex-col gap-1"},Re={class:"inline-flex gap-1 text-sm text-gray-800 -ml-[1px]"},ze={class:"inline-flex items-center h-5"},Ge={key:0,name:"error",class:"text-small leading-[18px] text-nc-content-gray-muted"},Ue=["onClick"],He={class:"flex items-center gap-2"},We={class:"flex"},Ye={key:1,class:"px-3 py-2 flex-1 flex items-center justify-center text-gray-600"},Ze=re({__name:"index",setup(qe){const G={[d.COMPLETED]:"Export successful",[d.FAILED]:"Export failed"},{$api:U,$poller:H}=Ee(),{appInfo:W}=ce(),{extension:b,tables:F,fullscreen:m,getViewsForTable:Y}=Ie(),{jobList:k,loadJobsForBase:Z}=Le(),C=E([]),I=E([]),V=E(),{width:D}=de(V),j=M(()=>k.value.filter(e=>{var s;return e.job==="data-export"&&((s=e.result)==null?void 0:s.extension_id)===b.value.id&&!I.value.includes(e.id)}).map(e=>({...e,result:e.result||{}})).sort((e,s)=>O(s.created_at).unix()-O(e.created_at).unix())),o=E({}),q=M(()=>F.value.map(e=>({label:e.title,value:e.id,meta:e.meta}))),K=M(()=>o.value.tableId?C.value.filter(e=>e.type===ue.GRID).map(e=>({label:e.is_default?"Default View":e.title,value:e.id,meta:e.meta,type:e.type}))||[]:[]),N=async()=>{o.value.tableId&&(C.value=await Y(o.value.tableId))},Q=async e=>{var s;o.value.tableId=e,await N(),o.value.viewId=(s=C.value.find(i=>i.is_default))==null?void 0:s.id,await b.value.kvStore.set("exportPayload",o.value)},X=async e=>{o.value.viewId=e,await b.value.kvStore.set("exportPayload",o.value)},f=E(!1);async function ee(){try{if(f.value||!o.value.viewId)return;f.value=!0;const e=await U.export.data(o.value.viewId,"csv",{extension_id:b.value.id});k.value.unshift(e),H.subscribe({id:e.id},async s=>{var i,u,h;if(s.status!=="close"){if(s.status===d.COMPLETED){A.info("Successfully exported data!");const p=k.value.find(g=>g.id===s.id);p&&(p.status=d.COMPLETED,p.result=(i=s.data)==null?void 0:i.result),f.value=!1}else if(s.status===d.FAILED){A.error("Failed to export data!");const p=k.value.find(g=>g.id===s.id);p&&(p.status=d.FAILED,p.result=(u=s.data)==null?void 0:u.result,(h=p.result)!=null&&h.title||(p.result={...p.result||{},title:J()})),f.value=!1}}})}catch(e){A.error(await me(e))}}const te=e=>e.startsWith("http")?e:`${W.value.ncSiteUrl||fe}/${e}`,ae=async e=>{if(await xe(e)){ve(e,{open:_e});return}const i=document.createElement("a");i.href=e,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)};function J(){const e=F.value.find(i=>i.id===o.value.tableId),s=C.value.find(i=>i.id===o.value.viewId);return`${e==null?void 0:e.title} (${s!=null&&s.is_default?"Default View":s==null?void 0:s.title})`}const se=async e=>{I.value.push(e),await b.value.kvStore.set("deletedExports",I.value)},B=(e,s)=>{var i,u;return(u=(i=s.key)==null?void 0:i.toLowerCase())==null?void 0:u.includes(e==null?void 0:e.toLowerCase())};return pe(()=>{o.value=b.value.kvStore.get("exportPayload")||{},I.value=b.value.kvStore.get("deletedExports")||[],N(),Z()}),(e,s)=>{const i=ie,u=be,h=De,p=ke,g=ye,$=we,L=he,le=ge,oe=Ce;return c(),w(oe,null,{default:l(()=>[n("div",{ref_key:"dataExporterRef",ref:V,class:y(["data-exporter",{"p-4":t(m),"p-3":!t(m)}])},[n("div",Je,[n("div",{class:y(["flex-1 flex items-center",{"max-w-[min(350px,calc(100%-124px))]":t(f)&&!t(m)&&t(D)>325,"max-w-[min(350px,calc(100%_-_84px))]":!t(f)&&!t(m)&&t(D)>325,"max-w-full":t(D)<=325,"max-w-[480px]":t(m)}])},[n("div",$e,[r(p,{value:t(o).tableId,"onUpdate:value":s[0]||(s[0]=a=>t(o).tableId=a),placeholder:"-select table-",disabled:t(f),class:y(["nc-data-exporter-table-select",{"flex-1 max-w-[240px]":t(m),"min-w-1/2 max-w-[175px]":!t(m)}]),bordered:!1,"filter-option":B,"dropdown-class-name":"w-[250px]","show-search":"",onChange:Q},{default:l(()=>[(c(!0),v(T,null,P(t(q),a=>(c(),w(h,{key:a.label,value:a.value},{default:l(()=>[n("div",Me,[n("div",Oe,[r(i,{meta:{meta:a.meta},class:"text-gray-500"},null,8,["meta"])]),r(u,{class:"flex-1 truncate","show-on-truncate-only":""},{title:l(()=>[_(x(a.label),1)]),default:l(()=>[n("span",null,x(a.label),1)]),_:2},1024),t(o).tableId===a.value?(c(),w(R(("iconMap"in e?e.iconMap:t(z)).check),{key:0,id:"nc-selected-item-icon",class:"flex-none text-primary w-4 h-4"})):S("",!0)])]),_:2},1032,["value"]))),128))]),_:1},8,["value","disabled","class"]),s[2]||(s[2]=n("div",{class:"flex-none h-8 border-l-1 border-gray-200"},null,-1)),r(p,{value:t(o).viewId,"onUpdate:value":s[1]||(s[1]=a=>t(o).viewId=a),placeholder:"-select view-",disabled:t(f),class:y(["nc-data-exporter-view-select",{"flex-1 max-w-[240px]":t(m),"min-w-1/2 max-w-[175px]":!t(m)}]),bordered:!1,"dropdown-class-name":"w-[250px]","filter-option":B,"show-search":"",onChange:X},{default:l(()=>[(c(!0),v(T,null,P(t(K),a=>(c(),w(h,{key:a.label,value:a.value},{default:l(()=>[n("div",Pe,[n("div",Ae,[r(g,{meta:{meta:a.meta,type:a.type},class:"flex-none text-gray-500"},null,8,["meta"])]),r(u,{class:"flex-1 truncate","show-on-truncate-only":""},{title:l(()=>[_(x(a.label),1)]),default:l(()=>[n("span",null,x(a.label),1)]),_:2},1024),t(o).viewId===a.value?(c(),w(R(("iconMap"in e?e.iconMap:t(z)).check),{key:0,id:"nc-selected-item-icon",class:"flex-none text-primary w-4 h-4"})):S("",!0)])]),_:2},1032,["value"]))),128))]),_:1},8,["value","disabled","class"])])],2),n("div",Fe,[r(u,{class:"flex",placement:"topRight",disabled:!t(f)},{title:l(()=>s[3]||(s[3]=[_(" The CSV file is being prepared in the background. You'll be notified once it's ready. ")])),default:l(()=>{var a;return[r($,{disabled:!((a=t(o))!=null&&a.viewId),loading:t(f),size:"xs",onClick:ee},{default:l(()=>[_(x(t(f)?"Generating":"Export"),1)]),_:1},8,["disabled","loading"])]}),_:1},8,["disabled"])])]),n("div",Ve,[s[4]||(s[4]=n("div",{class:"data-exporter-header"},"Recent Exports",-1)),t(j).length?(c(),v("div",je,[(c(!0),v(T,null,P(t(j),a=>(c(),v(T,null,[a.status!==("JobStatus"in e?e.JobStatus:t(d)).COMPLETED||a.result?(c(),v("div",{key:a.id,class:y(["p-3 flex gap-2 justify-between border-b-1 hover:bg-gray-50",{"px-4 py-3":t(m),"px-3 py-2":!t(m)}])},[n("div",{class:y(["flex-1 flex items-start gap-3",{"max-w-[calc(100%_-_74px)]":a.status===("JobStatus"in e?e.JobStatus:t(d)).COMPLETED,"max-w-[calc(100%_-_38px)]":a.status!==("JobStatus"in e?e.JobStatus:t(d)).COMPLETED}])},[[("JobStatus"in e?e.JobStatus:t(d)).COMPLETED,("JobStatus"in e?e.JobStatus:t(d)).FAILED].includes(a.status)?(c(),w(u,{key:0,class:"flex"},{title:l(()=>[_(x(G[a.status]),1)]),default:l(()=>[r(L,{icon:a.status===("JobStatus"in e?e.JobStatus:t(d)).COMPLETED?"circleCheckSolid":"alertTriangleSolid",class:y(["flex-none h-5 w-5",{"!text-green-700":a.status===("JobStatus"in e?e.JobStatus:t(d)).COMPLETED,"!text-red-700":a.status===("JobStatus"in e?e.JobStatus:t(d)).FAILED}])},null,8,["icon","class"])]),_:2},1024)):(c(),v("div",Ne,[r(le,{size:"regular",class:"flex-none"})])),n("div",Be,[n("div",Re,[n("span",ze,[r(L,{icon:"file",class:"flex-none text-gray-600/80 h-3.5 w-3.5"})]),r(u,{class:"truncate max-w-[calc(100%_-_20px)]","show-on-truncate-only":""},{title:l(()=>[_(x(a.result.title||J()),1)]),default:l(()=>[_(" "+x(a.result.title||J()),1)]),_:2},1024)]),a.result.timestamp?(c(),v("div",Ge,x(("timeAgo"in e?e.timeAgo:t(Te))(t(O)(a.result.timestamp).toString())),1)):S("",!0)])],2),a.status===("JobStatus"in e?e.JobStatus:t(d)).COMPLETED?(c(),v("div",{key:0,class:"flex",onClick:ne=>ae(te(a.result.url))},[r(u,{class:"flex"},{title:l(()=>[_(x(e.$t("general.download")),1)]),default:l(()=>[r($,{type:"secondary",size:"xs",class:"!px-[5px]"},{default:l(()=>[n("div",He,[r(L,{icon:"download"})])]),_:1})]),_:1})],8,Ue)):S("",!0),n("div",We,[r(u,{class:"flex"},{title:l(()=>[_(x(e.$t("general.remove")),1)]),default:l(()=>[r($,{type:"text",size:"xs",class:"!px-[5px]",onClick:ne=>se(a.id)},{default:l(()=>[r(L,{icon:"close"})]),_:2},1032,["onClick"])]),_:2},1024)])],2)):S("",!0)],64))),256))])):(c(),v("div",Ye,"No exports"))])],2)]),_:1})}}}),Rt=Se(Ze,[["__scopeId","data-v-dc4f673a"]]);export{Rt as default};
