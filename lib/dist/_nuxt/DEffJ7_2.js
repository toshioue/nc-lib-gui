import{f as We,L as De,as as qe,at as Ie,au as Ee,r as A,g as ke,N as Me,av as J,aw as Ke,ax as Qe,ay as Je,az as Fe,H as Le,i as He,aA as Xe,o as i,c as p,P as s,S as I,a as e,T as b,t as l,U as M,w as u,d as _,b as g,V as Ze,W as es,al as N,am as ss,R as ts,aB as as,ak as $e,Q as F,aC as Be,aD as H,aE as X,aF as ls,an as Se,ao as je,ap as os,a2 as ns,$ as is,aG as rs,aH as cs,aI as ds,p as us,e as ps,A as _s,_ as fs,aJ as ms,ag as gs}from"./BLdk6lRf.js";import{_ as vs}from"./L5affmRm.js";import{_ as bs}from"./ColGkCL0.js";import{p as Ae}from"./w_fTcf7g.js";const q=k=>(us("data-v-69fdf5e4"),k=k(),ps(),k),hs={key:0,class:"text-red-500"},ys={class:"flex flex-row items-center gap-3 justify-between"},xs={class:"keep-word min-w-[100px]"},ws={key:0,class:"flex items-center gap-3 justify-end flex-wrap"},Is={class:"flex items-center gap-3"},ks={class:"flex items-center gap-2"},$s={class:"!sticky top-0 z-10"},Bs={class:"flex items-center gap-3"},Ss={class:"flex items-center gap-3"},js=q(()=>e("div",null,"Time",-1)),As={class:"cell-base"},Ds={class:"cell-type"},Es={class:"cell-sub-type"},Ms={class:"cell-description"},Ls={class:"cell-ip"},zs={key:0},Cs=["onClick"],Ts={class:"cell-user"},Us={key:0,class:"w-full flex gap-3 items-center"},Rs={class:"flex-1 flex flex-col max-w-[calc(100%_-_44px)]"},Ns={class:"w-full flex gap-3"},Ps={class:"cell-timestamp"},Ys={class:"cell-base"},Gs={key:0,class:"w-full"},Os={class:"text-gray-600 text-xs"},Vs={class:"cell-type"},Ws={class:"truncate bg-gray-200 px-2 py-1 rounded-lg"},qs={class:"truncate"},Ks={class:"cell-sub-type"},Qs={class:"truncate"},Js={class:"truncate"},Fs={class:"cell-description"},Hs={class:"truncate"},Xs={class:"cell-ip"},Zs={class:"truncate"},et={class:"flex items-center justify-center absolute left-0 top-0 w-full h-full z-10 pb-10 pointer-events-none"},st={class:"flex flex-col justify-center items-center gap-2"},tt={class:"text-center"},at={key:0,class:"flex items-center justify-center absolute left-0 top-0 w-full h-full pb-10 flex items-center justify-center text-gray-500"},lt={class:"flex justify-between items-center w-full px-6"},ot=q(()=>e("div",null,"Â ",-1)),nt={class:"text-gray-500 text-xs"},it={class:"flex items-center justify-between gap-x-2 w-full"},rt=q(()=>e("div",{class:"flex-1 text-base font-weight-700 text-gray-900"},"Audit Details",-1)),ct={class:"flex items-center gap-2"},dt={key:0,class:"flex flex-col gap-4"},ut={class:"bg-gray-50 rounded-lg border-1 border-gray-200"},pt={class:"flex"},_t={class:"w-1/2 border-r border-gray-200 flex flex-col gap-2 px-4 py-3"},ft=q(()=>e("div",{class:"cell-header"},"Performed by",-1)),mt={key:0,class:"w-full flex gap-3 items-center"},gt={class:"flex-1 flex flex-col"},vt={class:"w-full flex gap-3"},bt={class:"text-sm text-gray-800 capitalize font-semibold"},ht={class:"text-xs text-gray-600"},yt={key:1,class:"text-small leading-[18px] text-gray-600"},xt={class:"w-1/2 flex flex-col gap-2 px-4 py-3"},wt={class:"cell-header"},It={class:"text-small leading-[18px] text-gray-600"},kt={class:"border-t-1 border-gray-200 flex"},$t={class:"w-1/2 border-r border-gray-200 flex flex-col gap-2 px-4 py-3"},Bt={class:"cell-header"},St={key:0,class:"flex items-stretch gap-3"},jt={class:"flex items-center"},At={class:"text-sm font-weight-500 text-gray-900"},Dt={class:"text-small leading-[18px] text-gray-600"},Et={class:"w-1/2"},Mt={class:"h-1/2 border-b border-gray-200 flex items-center gap-2 px-4 py-3"},Lt={class:"cell-header"},zt={class:"text-small leading-[18px] text-gray-600 bg-gray-200 px-1 rounded-md"},Ct={class:"h-1/2 flex items-center gap-2 px-4 py-3"},Tt={class:"cell-header"},Ut={class:"text-small leading-[18px] text-gray-600"},Rt={class:"flex flex-col gap-2"},Nt={class:"cell-header"},Pt={class:"text-small leading-[18px] text-gray-600"},Yt=We({__name:"AuditLogs",props:{workspaceId:{},baseId:{},sourceId:{},bordered:{type:Boolean,default:!0}},setup(k){const v=k,{isUIAllowed:P}=De(),{$api:K}=_s(),Y=qe(),{loadAudits:G}=Y,{audits:m,auditLogsQuery:d,auditCurrentLimit:L,auditCurrentPage:$,auditTotalRows:O}=Ie(Y),Z=Ee(),{getBaseUsers:ze,loadProjects:Ce}=Z,{bases:h}=Ie(Z),Q=A([]),f=ke(()=>{var o;const t=new Map;return(o=Q.value)==null||o.forEach(r=>{r!=null&&r.email&&t.set(r.email,r)}),t}),{appInfo:V}=Me(),B=A(!1),D=A(!1),n=A(null),E=A();async function z(t=$.value,o=L.value,r=!0){try{if(!P("workspaceAuditList")&&!v.baseId||!P("baseAuditList")&&v.baseId)return;r&&($.value=1),B.value=!0,await G(v.workspaceId,r?1:t,o)}catch{}finally{B.value=!1}}const Te=async()=>{try{if(!d.value.baseId)return;const{users:t}=await ze({baseId:d.value.baseId});Q.value=t}catch(t){Se.error(await je(t))}},Ue=async()=>{try{const t=await K.orgUsers.list();if(!(t!=null&&t.list))return;Q.value=t.list}catch(t){Se.error(await je(t))}},Re=t=>{n.value=t,D.value=!0},ee=t=>{var o,r,S;(o=m.value)!=null&&o.length&&(((r=d.value.orderBy)==null?void 0:r[t])==="asc"?d.value.orderBy[t]="desc":((S=d.value.orderBy)==null?void 0:S[t])==="desc"?d.value.orderBy[t]=void 0:d.value.orderBy[t]="asc",z(void 0,void 0,!1))},Ne=ke(()=>!0);return J(Ke,A(!0)),J(Je,Qe(Ne)),J(Fe,A(!0)),Le(()=>d.value.baseId,()=>{d.value.baseId&&Te()},{immediate:!0}),He(async()=>{v.baseId?d.value.baseId=v.baseId:(d.value.baseId=void 0,d.value.sourceId=void 0),v.sourceId&&(d.value.sourceId=v.sourceId),v.baseId||await Promise.allSettled([Ce(),Ue()]),V.value.auditEnabled&&await z($.value,L.value,!1)}),Xe(E,"scroll",()=>{var r,S,j,C;const t=(r=E.value)==null?void 0:r.querySelector("th.cell-user"),o=(S=E.value)==null?void 0:S.querySelector("th.cell-base");!(t!=null&&t.getBoundingClientRect().right)||!(o!=null&&o.getBoundingClientRect().left)||((o==null?void 0:o.getBoundingClientRect().left)<(t==null?void 0:t.getBoundingClientRect().right)+180?(j=E.value)==null||j.classList.add("sticky-shadow"):(C=E.value)==null||C.classList.remove("sticky-shadow"))}),(t,o)=>{var se,te,ae,le,oe,ne,ie,re;const r=os,S=ns,j=is,C=vs,Pe=rs,Ye=$e,Ge=bs,Oe=cs,Ve=ds;return i(),p("div",{class:b(["h-full flex flex-col",{"gap-6 pb-6":!t.baseId,"gap-4":t.baseId}])},[s(V).auditEnabled?I("",!0):(i(),p("div",hs,"Audit logs are currently disabled by administrators.")),e("div",{class:b(["flex flex-col",{"gap-6":!t.baseId,"gap-4":t.baseId}])},[e("div",ys,[e("div",{class:b({"flex-1 max-w-[75%]":t.baseId})},[e("h6",{class:b(["font-semibold text-gray-900 !my-0 flex items-center gap-1",{"text-xl":t.baseId,"text-2xl":!t.baseId}]),style:{"word-break":"keep-all"}},[e("span",xs,l(t.$t("title.auditLogs")),1),t.baseId?(i(),M(r,{key:0,class:b(["max-w-[80%] truncate",{"!leading-7":t.baseId,"!leading-8":!t.baseId}]),"show-on-truncate-only":"",placement:"bottom"},{title:u(()=>{var a;return[_(l((a=s(h).get(t.baseId))==null?void 0:a.title),1)]}),default:u(()=>{var a;return[_(" : "+l((a=s(h).get(t.baseId))==null?void 0:a.title),1)]}),_:1},8,["class"])):I("",!0)],2)],2),s(V).auditEnabled?(i(),p("div",ws,[e("div",Is,[g(S,{type:"text",size:"small",disabled:s(B),onClick:o[0]||(o[0]=a=>z())},{default:u(()=>[e("div",ks,[_(l(t.$t("general.refresh"))+" ",1),(i(),M(Ze(("iconMap"in t?t.iconMap:s(es)).refresh),{class:b(["h-3.5 w-3.5",{"animate-infinite animate-spin":s(B)}])},null,8,["class"]))])]),_:1},8,["disabled"])])])):I("",!0)])],2),s(V).auditEnabled?(i(),p(N,{key:1},[e("div",{class:b(["table-container relative",{"h-[calc(100%_-_48px)] ":t.baseId,"h-[calc(100%_-_56px)]":!t.baseId,bordered:t.bordered}])},[e("div",{ref_key:"tableWrapper",ref:E,class:"nc-audit-logs-table h-full max-h-[calc(100%_-_40px)] relative nc-scrollbar-thin !overflow-auto"},[e("table",$s,[e("thead",null,[e("tr",null,[e("th",{class:b(["cell-user !hover:bg-gray-100 select-none cursor-pointer",{"cursor-not-allowed":!((se=s(m))!=null&&se.length)}]),onClick:o[1]||(o[1]=a=>ee("user"))},[e("div",Bs,[e("div",null,l(t.$t("objects.user")),1),(te=s(d).orderBy)!=null&&te.user?(i(),M(j,{key:0,icon:"chevronDown",class:b(["flex-none",{"transform rotate-180":((ae=s(d).orderBy)==null?void 0:ae.user)==="asc"}])},null,8,["class"])):(i(),M(j,{key:1,icon:"chevronUpDown",class:"flex-none"}))])],2),e("th",{class:b(["cell-timestamp !hover:bg-gray-100 select-none cursor-pointer",{"cursor-not-allowed":!((le=s(m))!=null&&le.length)}]),onClick:o[2]||(o[2]=a=>ee("created_at"))},[e("div",Ss,[js,(oe=s(d).orderBy)!=null&&oe.created_at?(i(),M(j,{key:0,icon:"chevronDown",class:b(["flex-none",{"transform rotate-180":((ne=s(d).orderBy)==null?void 0:ne.created_at)==="asc"}])},null,8,["class"])):(i(),M(j,{key:1,icon:"chevronUpDown",class:"flex-none"}))])],2),e("th",As,[e("div",null,l(t.$t("objects.project")),1)]),e("th",Ds,[e("div",null,l(t.$t("general.type")),1)]),e("th",Es,[e("div",null,l(t.$t("general.subType")),1)]),e("th",Ms,[e("div",null,l(t.$t("labels.description")),1)]),e("th",Ls,[e("div",null,l(t.$t("general.ipAddress")),1)])])])]),(ie=s(m))!=null&&ie.length?(i(),p("table",zs,[e("tbody",null,[(i(!0),p(N,null,ss(s(m),(a,W)=>{var T,U,R;return i(),p("tr",{key:W,class:b({selected:((T=s(n))==null?void 0:T.id)===a.id&&s(D)}),onClick:c=>Re(a)},[e("td",Ts,[e("div",null,[a.user&&((U=s(f).get(a.user))!=null&&U.email)?(i(),p("div",Us,[g(C,{email:(R=s(f).get(a.user))==null?void 0:R.email,size:"base",class:"flex-none"},null,8,["email"]),e("div",Rs,[e("div",Ns,[g(r,{class:"text-sm !leading-5 text-gray-800 capitalize font-semibold truncate","show-on-truncate-only":"",placement:"bottom"},{title:u(()=>{var c,y,x,w;return[_(l(((c=s(f).get(a.user))==null?void 0:c.display_name)||((w=(y=s(f).get(a.user))==null?void 0:y.email)==null?void 0:w.slice(0,(x=s(f).get(a.user))==null?void 0:x.email.indexOf("@")))),1)]}),default:u(()=>{var c,y,x,w;return[_(" "+l(((c=s(f).get(a.user))==null?void 0:c.display_name)||((w=(y=s(f).get(a.user))==null?void 0:y.email)==null?void 0:w.slice(0,(x=s(f).get(a.user))==null?void 0:x.email.indexOf("@")))),1)]}),_:2},1024)]),g(r,{class:"text-xs !leading-4 text-gray-600 truncate","show-on-truncate-only":"",placement:"bottom"},{title:u(()=>{var c;return[_(l((c=s(f).get(a.user))==null?void 0:c.email),1)]}),default:u(()=>{var c;return[_(" "+l((c=s(f).get(a.user))==null?void 0:c.email),1)]}),_:2},1024)])])):(i(),p(N,{key:1},[_(l(a.user),1)],64))])]),e("td",Ps,[e("div",null,[g(r,{placement:"bottom"},{title:u(()=>[_(l(("parseStringDateTime"in t?t.parseStringDateTime:s(Ae))(a.created_at,"D MMMM YYYY HH:mm")),1)]),default:u(()=>[_(" "+l(s(Be)(a.created_at)),1)]),_:2},1024)])]),e("td",Ys,[e("div",null,[a.base_id?(i(),p("div",Gs,[g(r,{class:"truncate text-sm !leading-5 text-gray-800 font-semibold","show-on-truncate-only":"",placement:"bottom"},{title:u(()=>{var c;return[_(l((c=s(h).get(a.base_id))==null?void 0:c.title),1)]}),default:u(()=>{var c;return[_(" "+l((c=s(h).get(a.base_id))==null?void 0:c.title),1)]}),_:2},1024),e("div",Os,"ID: "+l(a.base_id),1)])):(i(),p(N,{key:1},[_(l(a.base_id),1)],64))])]),e("td",Vs,[e("div",null,[e("div",Ws,[g(r,{class:"truncate",placement:"bottom","show-on-truncate-only":""},{title:u(()=>[_(l(s(H)[a.op_type]),1)]),default:u(()=>[e("span",qs,l(s(H)[a.op_type]),1)]),_:2},1024)])])]),e("td",Ks,[e("div",null,[e("div",Qs,[g(r,{class:"truncate",placement:"bottom","show-on-truncate-only":""},{title:u(()=>[_(l(s(X)[a.op_sub_type]),1)]),default:u(()=>[e("span",Js,l(s(X)[a.op_sub_type]),1)]),_:2},1024)])])]),e("td",Fs,[e("div",null,[e("div",Hs,l(a.description),1)])]),e("td",Xs,[e("div",null,[e("div",Zs,l(a.ip),1)])])],10,Cs)}),128))])])):I("",!0)],512),ts(e("div",et,[e("div",st,[g(Pe,{size:"xlarge"}),e("span",tt,l(t.$t("general.loading")),1)])],512),[[as,s(B)]]),!s(B)&&!((re=s(m))!=null&&re.length)?(i(),p("div",at,[g(Ye,{image:s($e).PRESENTED_IMAGE_SIMPLE,description:t.$t("labels.noData"),class:"!my-0"},null,8,["image","description"])])):I("",!0),s(O)?(i(),p("div",{key:1,class:b(["flex flex-row justify-center items-center bg-gray-50 min-h-10",{"pointer-events-none":s(B)}])},[e("div",lt,[ot,g(Ge,{current:s($),"onUpdate:current":[o[3]||(o[3]=a=>F($)?$.value=a:null),o[5]||(o[5]=a=>z(void 0,void 0,!1))],"page-size":s(L),"onUpdate:pageSize":[o[4]||(o[4]=a=>F(L)?L.value=a:null),o[6]||(o[6]=a=>z(s($),a,!1))],total:+s(O),"show-size-changer":"","use-stored-page-size":!1},null,8,["current","page-size","total"]),e("div",nt,l(s(O))+" "+l(s(O)===1?"record":"records"),1)])],2)):I("",!0)],2),g(Ve,{visible:s(D),"onUpdate:visible":o[7]||(o[7]=a=>F(D)?D.value=a:null),size:"medium","show-separator":!1,onKeydown:o[8]||(o[8]=ls(a=>D.value=!1,["esc"]))},{header:u(()=>[e("div",it,[rt,e("div",ct,[g(r,{placement:"bottom",class:"text-gray-600 text-small leading-[18px]"},{title:u(()=>[_(l(("parseStringDateTime"in t?t.parseStringDateTime:s(Ae))(s(n).created_at,"D MMMM YYYY HH:mm")),1)]),default:u(()=>[_(" "+l(s(Be)(s(n).created_at)),1)]),_:1})])])]),default:u(()=>{var a,W,T,U,R,c,y,x,w,ce,de,ue,pe,_e,fe,me,ge,ve,be,he,ye,xe,we;return[s(n)?(i(),p("div",dt,[e("div",ut,[e("div",pt,[e("div",_t,[ft,(a=s(n))!=null&&a.user&&((W=s(f).get(s(n).user))!=null&&W.email)?(i(),p("div",mt,[g(C,{email:(T=s(f).get(s(n).user))==null?void 0:T.email,size:"base",class:"flex-none"},null,8,["email"]),e("div",gt,[e("div",vt,[e("span",bt,l(((U=s(f).get(s(n).user))==null?void 0:U.display_name)||((y=(R=s(f).get(s(n).user))==null?void 0:R.email)==null?void 0:y.slice(0,(c=s(f).get(s(n).user))==null?void 0:c.email.indexOf("@")))),1)]),e("span",ht,l((x=s(f).get(s(n).user))==null?void 0:x.email),1)])])):(i(),p("div",yt,l((w=s(n))==null?void 0:w.user),1))]),e("div",xt,[e("div",wt,l(t.$t("general.ipAddress")),1),e("div",It,l((ce=s(n))==null?void 0:ce.ip),1)])]),e("div",kt,[e("div",$t,[e("div",Bt,l(t.$t("objects.project")),1),(de=s(n))!=null&&de.base_id&&s(h).get((ue=s(n))==null?void 0:ue.base_id)?(i(),p("div",St,[e("div",jt,[g(Oe,{color:(fe=(_e=s(h).get((pe=s(n))==null?void 0:pe.base_id))==null?void 0:_e.meta)==null?void 0:fe.iconColor,type:((ge=s(h).get((me=s(n))==null?void 0:me.base_id))==null?void 0:ge.type)||"database",class:"nc-view-icon w-5 h-5"},null,8,["color","type"])]),e("div",null,[e("div",At,l((be=s(h).get((ve=s(n))==null?void 0:ve.base_id))==null?void 0:be.title),1),e("div",Dt,l((he=s(n))==null?void 0:he.base_id),1)])])):(i(),p(N,{key:1},[_(l(s(n).base_id),1)],64))]),e("div",Et,[e("div",Mt,[e("div",Lt,l(t.$t("general.type")),1),e("div",zt,l(s(H)[(ye=s(n))==null?void 0:ye.op_type]),1)]),e("div",Ct,[e("div",Tt,l(t.$t("general.subType")),1),e("div",Ut,l(s(X)[(xe=s(n))==null?void 0:xe.op_sub_type]),1)])])])]),e("div",Rt,[e("div",Nt,l(t.$t("labels.description")),1),e("div",Pt,l((we=s(n))==null?void 0:we.description),1)])])):I("",!0)]}),_:1},8,["visible"])],64)):I("",!0)],2)}}}),qt=fs(Yt,[["__scopeId","data-v-69fdf5e4"]]),Kt=ms("userStore",()=>{const{api:k}=gs(),{user:v}=Me(),{loadRoles:P}=De(),K=Ee(),Y=async({attrs:m})=>{if(!v.value)throw new Error("User is not defined");await k.userProfile.update(m),v.value={...v.value,...m},K.clearBasesUser()},G=P;return Le(()=>{var m;return(m=v.value)==null?void 0:m.id},(m,d)=>{m&&m!==d&&G()},{immediate:!0}),{loadCurrentUser:G,updateUserProfile:Y}});export{qt as _,Kt as u};
