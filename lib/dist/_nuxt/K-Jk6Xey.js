import{e as Qe,J as Se,aw as Fe,ax as we,ay as Le,r as D,f as Ie,L as Me,az as J,aA as Ze,aB as He,aC as Xe,aD as es,F as ze,g as ss,aE as ts,ac as K,o as n,c as u,Q as z,w as c,b as g,a as e,t as l,R as x,N as s,S as y,d as _,T as as,U as ls,ao as U,at as os,P as ns,aF as is,as as ke,aG as $e,aH as Q,aI as F,O as rs,aJ as cs,ah as Ae,ai as Be,aK as ds,Y as ps,$ as us,Z as _s,aL as gs,aM as fs,y as ms,_ as vs,aN as ys,ap as bs}from"./DZZ6t_j4.js";import{_ as hs}from"./By7kEk8u.js";import{_ as xs}from"./DnwRMKX3.js";import{_ as ws}from"./QHHXY-Ma.js";import{_ as Is}from"./Bdv7ru7D.js";import{u as ks}from"./CXKU6jgO.js";import{p as De}from"./2FgppHLC.js";const $s={"data-rec":"true"},As={key:0,class:"text-red-500"},Bs={class:"flex flex-row items-center gap-3 justify-between"},Ds={class:"keep-word min-w-[100px]"},Ss={key:0,class:"flex items-center gap-3 justify-end flex-wrap"},Ls={class:"flex items-center gap-3"},Ms={class:"flex items-center gap-2"},zs={class:"!sticky top-0 z-5"},Es={class:"flex items-center gap-3"},Rs={class:"flex items-center gap-3"},js={class:"cell-base"},Us={class:"cell-type"},Ts={class:"cell-sub-type"},Cs={class:"cell-description"},Ps={class:"cell-ip"},Ns={key:0},Os=["onClick"],Ys={class:"cell-user"},Gs={key:0,class:"w-full flex gap-3 items-center"},Ks={class:"flex-1 flex flex-col max-w-[calc(100%_-_44px)]"},Vs={class:"w-full flex gap-3"},Ws={class:"cell-timestamp"},qs={class:"cell-base"},Js={key:0,class:"w-full"},Qs={class:"text-gray-600 text-xs"},Fs={class:"cell-type"},Zs={class:"truncate bg-gray-200 px-2 py-1 rounded-lg"},Hs={class:"truncate"},Xs={class:"cell-sub-type"},et={class:"truncate"},st={class:"truncate"},tt={class:"cell-description"},at={class:"truncate"},lt={class:"cell-ip"},ot={class:"truncate"},nt={class:"flex items-center justify-center absolute left-0 top-0 w-full h-full z-10 pb-10 pointer-events-none"},it={class:"flex flex-col justify-center items-center gap-2"},rt={class:"text-center"},ct={key:0,class:"flex items-center justify-center absolute left-0 top-0 w-full h-full pb-10 flex items-center justify-center text-gray-500"},dt={class:"flex justify-between items-center w-full px-6"},pt={class:"text-gray-500 text-xs"},ut={class:"flex items-center justify-between gap-x-2 w-full"},_t={class:"flex items-center gap-2"},gt={key:0,class:"nc-expanded-audit flex flex-col gap-4"},ft={class:"bg-gray-50 rounded-lg border-1 border-gray-200"},mt={class:"flex"},vt={class:"w-1/2 border-r border-gray-200 flex flex-col gap-2 px-4 py-3"},yt={key:0,class:"w-full flex gap-3 items-center"},bt={class:"flex-1 flex flex-col"},ht={class:"w-full flex gap-3"},xt={class:"text-sm text-gray-800 capitalize font-semibold"},wt={class:"text-xs text-gray-600"},It={key:1,class:"text-small leading-[18px] text-gray-600"},kt={class:"w-1/2 flex flex-col gap-2 px-4 py-3"},$t={class:"cell-header"},At={class:"text-small leading-[18px] text-gray-600"},Bt={class:"border-t-1 border-gray-200 flex"},Dt={class:"w-1/2 border-r border-gray-200 flex flex-col gap-2 px-4 py-3"},St={class:"cell-header"},Lt={key:0,class:"flex items-stretch gap-3"},Mt={class:"flex items-center"},zt={class:"text-sm font-weight-500 text-gray-900"},Et={class:"text-small leading-[18px] text-gray-600"},Rt={class:"w-1/2"},jt={class:"h-1/2 border-b border-gray-200 flex items-center gap-2 px-4 py-3"},Ut={class:"cell-header"},Tt={class:"text-small leading-[18px] text-gray-600 bg-gray-200 px-1 rounded-md"},Ct={class:"h-1/2 flex items-center gap-2 px-4 py-3"},Pt={class:"cell-header"},Nt={class:"text-small leading-[18px] text-gray-600"},Ot={class:"flex flex-col gap-2"},Yt={class:"cell-header"},Gt={class:"!text-small !leading-[18px] !text-gray-600 mb-0"},Kt=Qe({__name:"AuditLogs",props:{workspaceId:{},baseId:{},sourceId:{},bordered:{type:Boolean,default:!0}},setup(V){const b=V,{isUIAllowed:T}=Se(),{$api:W}=ms(),C=Fe(),{loadAudits:P}=C,{audits:m,auditLogsQuery:p,auditPaginationData:v}=we(C),Z=Le(),{getBaseUsers:Ee,loadProjects:Re}=Z,{bases:w}=we(Z),q=D([]),f=Ie(()=>{var o;const t=new Map;return(o=q.value)==null||o.forEach(d=>{d!=null&&d.email&&t.set(d.email,d)}),t}),{appInfo:N}=Me(),I=D(!1),S=D(!1),i=D(null),L=D();async function M(t=v.value.page,o=v.value.pageSize,d=!0){try{if(!T("workspaceAuditList")&&!b.baseId||!T("baseAuditList")&&b.baseId)return;d&&(v.value.page=1),I.value=!0,await P(b.workspaceId,d?1:t,o)}catch{}finally{I.value=!1}}const je=async t=>{v.value.page=t,await M(void 0,void 0,!1)},{onLeft:Ue,onRight:Te,onUp:Ce,onDown:Pe}=ks({paginationDataRef:v,changePage:je,isViewDataLoading:I}),Ne=async()=>{try{if(!p.value.baseId)return;const{users:t}=await Ee({baseId:p.value.baseId});q.value=t}catch(t){Ae.error(await Be(t))}},Oe=async()=>{try{const t=await W.orgUsers.list();if(!(t!=null&&t.list))return;q.value=t.list}catch(t){Ae.error(await Be(t))}},Ye=t=>{i.value=t,S.value=!0},H=t=>{var o,d,B;(o=m.value)!=null&&o.length&&(((d=p.value.orderBy)==null?void 0:d[t])==="asc"?p.value.orderBy[t]="desc":((B=p.value.orderBy)==null?void 0:B[t])==="desc"?p.value.orderBy[t]=void 0:p.value.orderBy[t]="asc",M(void 0,void 0,!1))},Ge=Ie(()=>!0);J(Ze,D(!0)),J(Xe,He(Ge)),J(es,D(!0)),ze(()=>p.value.baseId,()=>{p.value.baseId&&Ne()},{immediate:!0}),ss(async()=>{b.baseId?p.value.baseId=b.baseId:(p.value.baseId=void 0,p.value.sourceId=void 0),b.sourceId&&(p.value.sourceId=b.sourceId),b.baseId||await Promise.allSettled([Re(),Oe()]),N.value.auditEnabled&&await M(v.value.page,v.value.pageSize,!1)}),ts(L,"scroll",()=>{var d,B,h,Y;const t=(d=L.value)==null?void 0:d.querySelector("th.cell-user"),o=(B=L.value)==null?void 0:B.querySelector("th.cell-base");!(t!=null&&t.getBoundingClientRect().right)||!(o!=null&&o.getBoundingClientRect().left)||((o==null?void 0:o.getBoundingClientRect().left)<(t==null?void 0:t.getBoundingClientRect().right)+180?(h=L.value)==null||h.classList.add("sticky-shadow"):(Y=L.value)==null||Y.classList.remove("sticky-shadow"))});const O=()=>ds()?"⌥":"ALT";return K("ArrowLeft",Ue),K("ArrowRight",Te),K("ArrowUp",Ce),K("ArrowDown",Pe),(t,o)=>{var ee,se,te,ae,le,oe,ne,ie;const d=ps,B=hs,h=us,Y=_s,X=xs,Ke=gs,Ve=ke,We=ws,qe=fs,Je=Is;return n(),u("div",{class:y(["h-full flex flex-col",{"gap-4 px-1":t.baseId}])},[t.baseId?x("",!0):(n(),z(B,{key:0},{icon:c(()=>[g(d,{icon:"audit",class:"flex-none text-gray-700 h-5 w-5"})]),title:c(()=>[e("span",$s,l(t.$t("title.auditLogs")),1)]),_:1})),e("div",{class:y(["nc-content-max-w flex flex-col",{"gap-6 p-6 h-[calc(100vh_-_100px)]":!t.baseId,"gap-4 h-full":t.baseId}])},[s(N).auditEnabled?x("",!0):(n(),u("div",As,"Audit logs are currently disabled by administrators.")),e("div",{class:y(["flex flex-col",{"gap-6":!t.baseId,"gap-4":t.baseId}])},[e("div",Bs,[e("div",{class:y({"flex-1 max-w-[75%]":t.baseId})},[t.baseId?(n(),u("h6",{key:0,class:y(["font-semibold text-gray-900 !my-0 flex items-center gap-1",{"text-xl":t.baseId,"text-2xl":!t.baseId}]),style:{"word-break":"keep-all"}},[e("span",Ds,l(t.$t("title.auditLogs")),1),g(h,{class:y(["max-w-[80%] truncate",{"!leading-7":t.baseId,"!leading-8":!t.baseId}]),"show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var a;return[_(l((a=s(w).get(t.baseId))==null?void 0:a.title),1)]}),default:c(()=>{var a;return[_(" : "+l((a=s(w).get(t.baseId))==null?void 0:a.title),1)]}),_:1},8,["class"])],2)):x("",!0)],2),s(N).auditEnabled?(n(),u("div",Ss,[e("div",Ls,[g(Y,{type:"text",size:"small",disabled:s(I),onClick:o[0]||(o[0]=a=>M())},{default:c(()=>[e("div",Ms,[_(l(t.$t("general.refresh"))+" ",1),(n(),z(as(("iconMap"in t?t.iconMap:s(ls)).refresh),{class:y(["h-3.5 w-3.5",{"animate-infinite animate-spin":s(I)}])},null,8,["class"]))])]),_:1},8,["disabled"])])])):x("",!0)])],2),s(N).auditEnabled?(n(),u(U,{key:1},[e("div",{class:y(["table-container relative",{"h-[calc(100%_-_48px)] ":t.baseId,"h-[calc(100%_-_56px)]":!t.baseId,bordered:t.bordered}])},[e("div",{ref_key:"tableWrapper",ref:L,class:"nc-audit-logs-table h-full max-h-[calc(100%_-_40px)] relative nc-scrollbar-thin !overflow-auto"},[e("table",zs,[e("thead",null,[e("tr",null,[e("th",{class:y(["cell-user !hover:bg-gray-100 select-none cursor-pointer",{"cursor-not-allowed":!((ee=s(m))!=null&&ee.length)}]),onClick:o[1]||(o[1]=a=>H("user"))},[e("div",Es,[e("div",null,l(t.$t("objects.user")),1),(se=s(p).orderBy)!=null&&se.user?(n(),z(d,{key:0,icon:"chevronDown",class:y(["flex-none",{"transform rotate-180":((te=s(p).orderBy)==null?void 0:te.user)==="asc"}])},null,8,["class"])):(n(),z(d,{key:1,icon:"chevronUpDown",class:"flex-none"}))])],2),e("th",{class:y(["cell-timestamp !hover:bg-gray-100 select-none cursor-pointer",{"cursor-not-allowed":!((ae=s(m))!=null&&ae.length)}]),onClick:o[2]||(o[2]=a=>H("created_at"))},[e("div",Rs,[o[9]||(o[9]=e("div",null,"Time",-1)),(le=s(p).orderBy)!=null&&le.created_at?(n(),z(d,{key:0,icon:"chevronDown",class:y(["flex-none",{"transform rotate-180":((oe=s(p).orderBy)==null?void 0:oe.created_at)==="asc"}])},null,8,["class"])):(n(),z(d,{key:1,icon:"chevronUpDown",class:"flex-none"}))])],2),e("th",js,[e("div",null,l(t.$t("objects.project")),1)]),e("th",Us,[e("div",null,l(t.$t("general.type")),1)]),e("th",Ts,[e("div",null,l(t.$t("general.subType")),1)]),e("th",Cs,[e("div",null,l(t.$t("labels.description")),1)]),e("th",Ps,[e("div",null,l(t.$t("general.ipAddress")),1)])])])]),(ne=s(m))!=null&&ne.length?(n(),u("table",Ns,[e("tbody",null,[(n(!0),u(U,null,os(s(m),(a,G)=>{var E,R,j;return n(),u("tr",{key:G,class:y({selected:((E=s(i))==null?void 0:E.id)===a.id&&s(S)}),onClick:r=>Ye(a)},[e("td",Ys,[e("div",null,[a.user&&((R=s(f).get(a.user))!=null&&R.email)?(n(),u("div",Gs,[g(X,{email:(j=s(f).get(a.user))==null?void 0:j.email,size:"base",class:"flex-none"},null,8,["email"]),e("div",Ks,[e("div",Vs,[g(h,{class:"text-sm !leading-5 text-gray-800 capitalize font-semibold truncate","show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var r,k,$,A;return[_(l(((r=s(f).get(a.user))==null?void 0:r.display_name)||((A=(k=s(f).get(a.user))==null?void 0:k.email)==null?void 0:A.slice(0,($=s(f).get(a.user))==null?void 0:$.email.indexOf("@")))),1)]}),default:c(()=>{var r,k,$,A;return[_(" "+l(((r=s(f).get(a.user))==null?void 0:r.display_name)||((A=(k=s(f).get(a.user))==null?void 0:k.email)==null?void 0:A.slice(0,($=s(f).get(a.user))==null?void 0:$.email.indexOf("@")))),1)]}),_:2},1024)]),g(h,{class:"text-xs !leading-4 text-gray-600 truncate","show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var r;return[_(l((r=s(f).get(a.user))==null?void 0:r.email),1)]}),default:c(()=>{var r;return[_(" "+l((r=s(f).get(a.user))==null?void 0:r.email),1)]}),_:2},1024)])])):(n(),u(U,{key:1},[_(l(a.user),1)],64))])]),e("td",Ws,[e("div",null,[g(h,{placement:"bottom"},{title:c(()=>[_(l(("parseStringDateTime"in t?t.parseStringDateTime:s(De))(a.created_at,"D MMMM YYYY HH:mm")),1)]),default:c(()=>[_(" "+l(s($e)(a.created_at)),1)]),_:2},1024)])]),e("td",qs,[e("div",null,[a.base_id?(n(),u("div",Js,[g(h,{class:"truncate text-sm !leading-5 text-gray-800 font-semibold","show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var r;return[_(l((r=s(w).get(a.base_id))==null?void 0:r.title),1)]}),default:c(()=>{var r;return[_(" "+l((r=s(w).get(a.base_id))==null?void 0:r.title),1)]}),_:2},1024),e("div",Qs,"ID: "+l(a.base_id),1)])):(n(),u(U,{key:1},[_(l(a.base_id),1)],64))])]),e("td",Fs,[e("div",null,[e("div",Zs,[g(h,{class:"truncate",placement:"bottom","show-on-truncate-only":""},{title:c(()=>[_(l(s(Q)[a.op_type]),1)]),default:c(()=>[e("span",Hs,l(s(Q)[a.op_type]),1)]),_:2},1024)])])]),e("td",Xs,[e("div",null,[e("div",et,[g(h,{class:"truncate",placement:"bottom","show-on-truncate-only":""},{title:c(()=>[_(l(s(F)[a.op_sub_type]),1)]),default:c(()=>[e("span",st,l(s(F)[a.op_sub_type]),1)]),_:2},1024)])])]),e("td",tt,[e("div",null,[e("div",at,l(a.description),1)])]),e("td",lt,[e("div",null,[e("div",ot,l(a.ip),1)])])],10,Os)}),128))])])):x("",!0)],512),ns(e("div",nt,[e("div",it,[g(Ke,{size:"xlarge"}),e("span",rt,l(t.$t("general.loading")),1)])],512),[[is,s(I)]]),!s(I)&&!((ie=s(m))!=null&&ie.length)?(n(),u("div",ct,[g(Ve,{image:s(ke).PRESENTED_IMAGE_SIMPLE,description:t.$t("labels.noData"),class:"!my-0"},null,8,["image","description"])])):x("",!0),s(v).totalRows?(n(),u("div",{key:1,class:y(["flex flex-row justify-center items-center bg-gray-50 min-h-10",{"pointer-events-none":s(I)}])},[e("div",dt,[o[10]||(o[10]=e("div",null," ",-1)),g(We,{current:s(v).page,"onUpdate:current":[o[3]||(o[3]=a=>s(v).page=a),o[5]||(o[5]=a=>M(void 0,void 0,!1))],"page-size":s(v).pageSize,"onUpdate:pageSize":[o[4]||(o[4]=a=>s(v).pageSize=a),o[6]||(o[6]=a=>M(t.currentPage,a,!1))],total:+s(v).totalRows,"show-size-changer":"","use-stored-page-size":!1,"prev-page-tooltip":`${O()}+←`,"next-page-tooltip":`${O()}+→`,"first-page-tooltip":`${O()}+↓`,"last-page-tooltip":`${O()}+↑`},null,8,["current","page-size","total","prev-page-tooltip","next-page-tooltip","first-page-tooltip","last-page-tooltip"]),e("div",pt,l(s(v).totalRows)+" "+l(s(v).totalRows===1?"record":"records"),1)])],2)):x("",!0)],2),g(Je,{visible:s(S),"onUpdate:visible":o[7]||(o[7]=a=>rs(S)?S.value=a:null),size:"medium","show-separator":!1,onKeydown:o[8]||(o[8]=cs(a=>S.value=!1,["esc"]))},{header:c(()=>[e("div",ut,[o[11]||(o[11]=e("div",{class:"flex-1 text-base font-weight-700 text-gray-900"},"Audit Details",-1)),e("div",_t,[g(h,{placement:"bottom",class:"text-gray-600 text-small leading-[18px]"},{title:c(()=>[_(l(("parseStringDateTime"in t?t.parseStringDateTime:s(De))(s(i).created_at,"D MMMM YYYY HH:mm")),1)]),default:c(()=>[_(" "+l(s($e)(s(i).created_at)),1)]),_:1})])])]),default:c(()=>{var a,G,E,R,j,r,k,$,A,re,ce,de,pe,ue,_e,ge,fe,me,ve,ye,be,he,xe;return[s(i)?(n(),u("div",gt,[e("div",ft,[e("div",mt,[e("div",vt,[o[12]||(o[12]=e("div",{class:"cell-header"},"Performed by",-1)),(a=s(i))!=null&&a.user&&((G=s(f).get(s(i).user))!=null&&G.email)?(n(),u("div",yt,[g(X,{email:(E=s(f).get(s(i).user))==null?void 0:E.email,size:"base",class:"flex-none"},null,8,["email"]),e("div",bt,[e("div",ht,[e("span",xt,l(((R=s(f).get(s(i).user))==null?void 0:R.display_name)||((k=(j=s(f).get(s(i).user))==null?void 0:j.email)==null?void 0:k.slice(0,(r=s(f).get(s(i).user))==null?void 0:r.email.indexOf("@")))),1)]),e("span",wt,l(($=s(f).get(s(i).user))==null?void 0:$.email),1)])])):(n(),u("div",It,l((A=s(i))==null?void 0:A.user),1))]),e("div",kt,[e("div",$t,l(t.$t("general.ipAddress")),1),e("div",At,l((re=s(i))==null?void 0:re.ip),1)])]),e("div",Bt,[e("div",Dt,[e("div",St,l(t.$t("objects.project")),1),(ce=s(i))!=null&&ce.base_id&&s(w).get((de=s(i))==null?void 0:de.base_id)?(n(),u("div",Lt,[e("div",Mt,[g(qe,{color:(_e=(ue=s(w).get((pe=s(i))==null?void 0:pe.base_id))==null?void 0:ue.meta)==null?void 0:_e.iconColor,type:((fe=s(w).get((ge=s(i))==null?void 0:ge.base_id))==null?void 0:fe.type)||"database",class:"nc-view-icon w-5 h-5"},null,8,["color","type"])]),e("div",null,[e("div",zt,l((ve=s(w).get((me=s(i))==null?void 0:me.base_id))==null?void 0:ve.title),1),e("div",Et,l((ye=s(i))==null?void 0:ye.base_id),1)])])):(n(),u(U,{key:1},[_(l(s(i).base_id),1)],64))]),e("div",Rt,[e("div",jt,[e("div",Ut,l(t.$t("general.type")),1),e("div",Tt,l(s(Q)[(be=s(i))==null?void 0:be.op_type]),1)]),e("div",Ct,[e("div",Pt,l(t.$t("general.subType")),1),e("div",Nt,l(s(F)[(he=s(i))==null?void 0:he.op_sub_type]),1)])])])]),e("div",Ot,[e("div",Yt,l(t.$t("labels.description")),1),e("div",null,[e("pre",Gt,l((xe=s(i))==null?void 0:xe.description),1)])])])):x("",!0)]}),_:1},8,["visible"])],64)):x("",!0)],2)],2)}}}),Ht=vs(Kt,[["__scopeId","data-v-505aa1df"]]),Xt=ys("userStore",()=>{const{api:V}=bs(),{user:b}=Me(),{loadRoles:T}=Se(),W=Le(),C=async({attrs:m})=>{if(!b.value)throw new Error("User is not defined");await V.userProfile.update(m),b.value={...b.value,...m},W.clearBasesUser()},P=T;return ze(()=>{var m;return(m=b.value)==null?void 0:m.id},(m,p)=>{m&&m!==p&&P()},{immediate:!0}),{loadCurrentUser:P,updateUserProfile:C}});export{Ht as _,Xt as u};
