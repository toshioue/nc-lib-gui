import{u as Ve}from"./DTl_5Njz.js";import{ai as De,ag as me,at as _e,cB as je,g3 as Ke,L as Ae,r as O,bL as Pe,fC as Fe,cQ as Ce,g as qe,av as xe,g7 as Ee,d4 as re,hg as Ie,an as K,ao as C,A as Ne,gh as ce}from"./BLdk6lRf.js";import{a as ze,b as Be}from"./BtPl72f0.js";import{e as V,r as Z}from"./CwqgNcWF.js";import{d as Je}from"./boyBAVNN.js";const[Xe,Ue]=Ve((n,r,de=!1)=>{var ie;if(!n)throw new Error("Table meta is not available");const ve="addNewStack",{t:T}=De(),{api:q}=me(),{base:y,sqlUis:M}=_e(je()),{$e:fe,$api:A}=Ne(),{sorts:z,nestedFilters:B}=ze(),{sharedView:ee,fetchSharedViewData:pe,fetchSharedViewGroupedData:ge}=Ke(),{isUIAllowed:J}=Ae(),m=O(de)||Pe(Fe,O(!1)),we=O(null),{search:x}=Be(),{addUndo:U,clone:P,defineViewScope:L}=Ce(),G=O([]),ye=O((ie=n.value)!=null&&ie.source_id?M.value[n.value.source_id]:Object.values(M.value)[0]),Q=qe(()=>{var l,a,t,s;let e;const u=((a=(l=n.value)==null?void 0:l.columns)==null?void 0:a.find(({id:i})=>i===x.value.field))||((s=(t=n.value)==null?void 0:t.columns)==null?void 0:s.find(i=>i.pv));if(u&&x.value.query.trim())return["text","string"].includes(ye.value.getAbstractType(u))&&u.dt!=="bigint"?e=`(${u.title},like,%${x.value.query.trim()}%)`:e=`(${u.title},eq,${x.value.query.trim()})`,e});xe(Ee,we);const _=O({}),j=O([]),o=O(new Map),d=O(new Map),g=O(""),p=O(),R=O({}),ae=O(!1),le=e=>e.map(u=>({row:{...u},oldRow:{...u},rowMeta:{}}));async function he(){var u,l,a,t;if((!((u=y==null?void 0:y.value)!=null&&u.id)||!((l=n.value)!=null&&l.id)||!((a=r==null?void 0:r.value)!=null&&a.id)||!((t=p==null?void 0:p.value)!=null&&t.id))&&!m.value)return;o.value=new Map,d.value=new Map;let e;m.value?e=await ge(p.value.id,{sortsArr:z.value,filtersArr:B.value}):e=await q.dbViewRow.groupedDataList("noco",y.value.id,n.value.id,r.value.id,p.value.id,{where:Q.value},{});for(const s of e??[]){const i=s.key;o.value.set(i,le(s.value.list)),d.value.set(i,s.value.pageInfo.totalRows||0)}}const Re=(e,u)=>{const l=(e||[]).reduce((a,t)=>{const s=V(t.row,n.value.columns);return s&&(a[s]=t),a},{});return(u||[]).filter(({row:a})=>{const t=V(a,n.value.columns);return!(t&&l[t])})};async function be(e,u={}){var t,s,i;if((!((t=y==null?void 0:y.value)!=null&&t.id)||!((s=n.value)!=null&&s.id)||!((i=r.value)!=null&&i.id))&&!m.value)return;let l=`(${g.value},eq,${e})`;e===null&&(l=`(${g.value},is,null)`),Q.value&&(l=`${l} and ${Q.value}`);const a=m.value?await pe({...u,sortsArr:z.value,filtersArr:B.value,offset:u.offset,where:l}):await q.dbViewRow.list("noco",y.value.id,n.value.id,r.value.id,{...u,...J("sortSync")?{}:{sortArrJson:JSON.stringify(z.value)},...J("filterSync")?{}:{filterArrJson:JSON.stringify(B.value)},where:l});o.value.set(e,[...o.value.get(e),...Re(o.value.get(e),le(a.list))])}async function Se(){var l,a,t,s,i,f,S,k,b;if(!((l=r==null?void 0:r.value)!=null&&l.id)||!((a=n==null?void 0:n.value)!=null&&a.columns))return;_.value=m.value?(t=ee.value)==null?void 0:t.view:await A.dbView.kanbanRead(r.value.id),p.value=m.value?re((s=ee.value)==null?void 0:s.meta).groupingFieldColumn:n.value.columns.filter(c=>c.id===_.value.fk_grp_col_id)[0]||{},g.value=p.value.title;const{fk_grp_col_id:e,meta:u}=_.value;if(R.value=re(u)||{},R.value&&e&&R.value[e]){let c=!1,h=!1;for(const v of((i=p.value.colOptions)==null?void 0:i.options)??[]){const D=R.value[e].findIndex(I=>I.id===v.id);if(D!==-1){const{collapsed:I,...N}=R.value[e][D];Je(N,v)||(R.value[e][D]={...R.value[e][D],...v},v.title!==N.title&&(o.value.set(v.title,o.value.get(N.title)),d.value.set(v.title,d.value.get(N.title)),await Y(v.title)),c=!0)}else R.value[e].push({...v,collapsed:!1}),o.value.set(v.title,[]),d.value.set(v.title,0),c=!0,h=!0}const $=(S=(f=p.value)==null?void 0:f.colOptions)==null?void 0:S.options.map(({id:v})=>v),w=R.value[e].filter(({id:v})=>v!=="uncategorized"&&!$.includes(v));for(const v of w){const D=R.value[e].map(I=>I.id).indexOf(v.id);D!==-1&&(R.value[e].splice(D,1),o.value.size&&d.value.size&&o.value.has(v.title)&&(await Y(v.title,!0),o.value.set(null,[...o.value.get(null)||[],...o.value.get(v.title)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(v.title)||0))),c=!0)}j.value=[...R.value[e]],c&&(await E(),h&&(ae.value=!0))}else j.value=[...((b=(k=p.value)==null?void 0:k.colOptions)==null?void 0:b.options)??[],{id:"uncategorized",title:null,order:0,color:Ie.gray[500]}].sort((c,h)=>c.order-h.order).map(c=>({...c,collapsed:!1})),await E()}async function E(){const{fk_grp_col_id:e}=_.value;e&&(R.value[e]=j.value,await te({meta:R.value}))}async function te(e){var u;!((u=r==null?void 0:r.value)!=null&&u.id)||!J("dataEdit",{skipSourceCheck:!0})||await A.dbView.kanbanUpdate(r.value.id,e)}function H(e){var l;const u=Z(e,(l=n==null?void 0:n.value)==null?void 0:l.columns);for(const a of o.value.values())for(const t of a)if(Object.keys(u).every(s=>u[s]===t.row[s]))return t}async function W(e,u=o.value.get(null).length,l=!1){var a,t,s,i,f;try{const S=((a=n==null?void 0:n.value)==null?void 0:a.columns).reduce((b,c)=>((!c.ai||l)&&(e==null?void 0:e[c.title])!==null&&(b[c.title]=e==null?void 0:e[c.title]),b),{}),k=await A.dbViewRow.create(ce,y==null?void 0:y.value.id,(t=n.value)==null?void 0:t.id,(s=r==null?void 0:r.value)==null?void 0:s.id,S);if(!l){const b=V(k,(i=n.value)==null?void 0:i.columns);U({redo:{fn:async function(h,$){var v;const w=Z(h.row,(v=n.value)==null?void 0:v.columns);h.row={...w,...h.row},await W(h,$,!0),F(h,!0)},args:[P(e),u]},undo:{fn:async function(h){await se(h);const $=H(k);$&&ue($)},args:[b]},scope:L({view:r.value})})}return(f=o.value.get(null))==null||f.splice(u??0,1,{row:k,rowMeta:{},oldRow:{...k}}),k}catch(S){K.error(await C(S))}}async function X(e,u,l=!1){var a,t,s;try{const i=V(e.row,(a=n==null?void 0:n.value)==null?void 0:a.columns),f=await A.dbViewRow.update(ce,y==null?void 0:y.value.id,(t=n.value)==null?void 0:t.id,(s=r==null?void 0:r.value)==null?void 0:s.id,i,{[u]:e.row[u]});if(!l){const S=G.value.find(b=>b.op==="removed"&&b.pk===i),k=G.value.find(b=>b.op==="added"&&b.pk===i);U({redo:{fn:async function(c,h){const $=await X(c,h,!0),w=H(c.row);w&&(Object.assign(w.row,$),w.row[g.value]!==w.oldRow[g.value]&&F(w,!1,k==null?void 0:k.index),Object.assign(w.oldRow,$))},args:[P(e),u]},undo:{fn:async function(c,h){const $=await X({row:c.oldRow,oldRow:c.row,rowMeta:c.rowMeta},h,!0),w=H(c.row);w&&(Object.assign(w.row,$),w.row[g.value]!==w.oldRow[g.value]&&F(w,!1,S==null?void 0:S.index),Object.assign(w.oldRow,$))},args:[P(e),u]},scope:L({view:r.value})}),Object.assign(e.row,f),Object.assign(e.oldRow,f)}return f}catch(i){K.error(`${T("msg.error.rowUpdateFailed")} ${await C(i)}`)}}async function Oe(e){e.rowMeta.new?await W(e.row,o.value.get(e.row.title).indexOf(e)):await X(e,g.value)}async function Y(e,u=!1){var l;try{const a=u?null:e;await q.dbTableRow.bulkUpdateAll("noco",y.value.id,(l=n.value)==null?void 0:l.id,{[g.value]:a},{where:`(${g.value},eq,${e})`}),o.value.has(e)&&o.value.set(e,o.value.get(e).map(t=>({...t,row:{...t.row,[g.value]:a},oldRow:{...t.oldRow,[g.value]:t.row[g.value]}})))}catch(a){K.error(await C(a))}}async function ke(e,u){var l;if(!(!((l=r==null?void 0:r.value)!=null&&l.id)||!p.value))try{await Y(e,!0),o.value.set(null,[...o.value.get(null),...o.value.get(e)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(e)||0)),o.value.delete(e),d.value.delete(e);const a=p.value.colOptions.options.filter(s=>s.title!==e);p.value.colOptions.options=a;const t=p.value.cdf?p.value.cdf.replace(/^'/,"").replace(/'$/,""):null;await q.dbTableColumn.update(p.value.id,{...p.value,colOptions:{options:a},cdf:t===e?null:t}),j.value.splice(u,1),R.value[_.value.fk_grp_col_id]=j.value,await E(),fe("a:kanban:delete-stack")}catch(a){K.error(await C(a))}}function $e(e=o.value.get(null).length){return o.value.get(null).splice(e,0,{row:{},oldRow:{},rowMeta:{new:!0}}),o.value.get(null)[e]}function F(e,u,l){const a=e.row[g.value],t=e.oldRow[g.value];if(u)a&&(l!==void 0?o.value.get(a).splice(l,0,e):o.value.get(a).push(e),d.value.set(a,d.value.get(a)+1),oe());else{const s=V(e.row,n.value.columns),i=o.value.get(t).findIndex(f=>V(f.row,n.value.columns)===s);if(i!==-1)if(a!==t){d.value.set(t,d.value.get(t)-1);const f=o.value.get(t);if(f.splice(i,1),o.value.set(t,f),d.value.set(a,d.value.get(a)+1),l!==void 0){const S=o.value.get(a);S.splice(l,0,e),o.value.set(a,S)}else o.value.set(a,[...o.value.get(a),e])}else{const f=o.value.get(a);l!==void 0?(f.splice(i,1),f.splice(l,0,e)):f[i]=e,o.value.set(t,f)}}}function ue(e){const u=V(e.row,n.value.columns),l=e.row[g.value];o.value.set(l,o.value.get(l).filter(a=>V(a.row,n.value.columns)!==u)),d.value.set(l,d.value.get(l)-1)}function oe(){o.value.get(null).pop(),d.value.set(null,d.value.get(null)-1)}async function ne(e,u=!1){var l,a;try{if(u||U({redo:{fn:async function(s){await ne(s,!0)},args:[P(e)]},undo:{fn:async function(s){var f;const i=Z(s.row,(f=n.value)==null?void 0:f.columns);s.row={...i,...s.row},await W(s.row,void 0,!0),F(s,!0)},args:[P(e)]},scope:L({view:r.value})}),!e.rowMeta.new){const t=(a=(l=n==null?void 0:n.value)==null?void 0:l.columns)==null?void 0:a.filter(i=>i.pk).map(i=>e.row[i.title]).join("___");if(!await se(t))return}ue(e)}catch(t){K.error(`${T("msg.error.deleteRowFailed")}: ${await C(t)}`)}}async function se(e){var l,a;if(!e)throw new Error("Delete not allowed for table which doesn't have primary Key");const u=await A.dbViewRow.delete("noco",y.value.id,(l=n.value)==null?void 0:l.id,(a=r.value)==null?void 0:a.id,encodeURIComponent(e));return u.message?(K.info(`Record delete failed: ${`Unable to delete record with ID ${e} because of the following:
              
${u.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}return{loadKanbanData:he,loadMoreKanbanData:be,loadKanbanMeta:Se,updateKanbanMeta:te,kanbanMetaData:_,formattedData:o,countByStack:d,groupingField:g,groupingFieldColOptions:j,groupingFieldColumn:p,updateOrSaveRow:Oe,addEmptyRow:$e,addOrEditStackRow:F,deleteStack:ke,updateKanbanStackMeta:E,removeRowFromUncategorizedStack:oe,shouldScrollToRight:ae,deleteRow:ne,moveHistory:G,addNewStackId:ve}},"kanban-view-store");function Ye(){const n=Ue();if(n==null)throw new Error("Please call `useProvideKanbanViewStore` on the appropriate parent component");return n}export{Ye as a,Xe as u};
