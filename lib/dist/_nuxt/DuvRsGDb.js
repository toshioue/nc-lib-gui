import{ar as we,dB as ce,ag as ye,cW as Te,cS as de,u as he,ay as xe,ax as W,cP as ee,cL as ue,cO as se,f as R,F as $e,c$ as oe,ah as j,ai as ie,dC as Ie,ca as ke,d0 as Ce,m as Me,d1 as pe,z as Z,y as De,dn as ne,e as Pe,ab as Se,r as F,g as Be,a$ as Le,M as Ne,o as y,Q as B,w as p,a as f,b as g,d as L,t as w,N as o,aJ as J,cY as Ve,cZ as Ee,a7 as je,R as Q,c as X,S as Oe,W as ze,P as Fe,O as Re,Y as Ue,Z as Ae,a1 as Ge,dD as Ke,_ as Ye}from"./DZZ6t_j4.js";import{_ as qe}from"./Bdv7ru7D.js";import{u as fe}from"./BT-ahe-O.js";import{a as le}from"./C3jLTHF4.js";import{F as re}from"./BYINaHrJ.js";import"./DKN1hQ6S.js";import{I as He}from"./BQuyMdA-.js";import{C as We,a as Ze}from"./DNgdBwTe.js";import{_ as Je}from"./dfem9Uc_.js";import{_ as Qe}from"./DGj1ycqW.js";function Xe(C){const v=we({title:"",table_name:"",description:"",columns:ce,is_hybrid:!0}),{t:r}=ye(),{$e:M,$api:b}=De(),{getMeta:D,removeMeta:$}=Te(),{closeTab:U}=fe(),{refreshCommandPalette:O}=de(),I=he().currentRoute,T=xe(),{bases:h}=W(T),{baseTables:A}=W(ee()),{loadProjectTables:G}=ee(),{loadTables:m,baseUrl:K,isXcdbBase:Y}=ue(),{loadViews:q}=se(),{openedViewsTab:k,viewsByTable:H}=W(se()),x=R(()=>I.value.params.typeOrId),P=R(()=>A.value.get(C.baseId)||[]),z=R(()=>h.value.get(C.baseId)),N=async(a,c=!1,t=!0)=>{if(!a.base_id)return;let e=h.value.get(a.base_id);if(!e&&(await T.loadProject(a.base_id),await G(a.base_id),e=h.value.get(a.base_id),!e))throw new Error("Base not found");let i=x.value??"nc";["nc","base"].includes(I.value.params.typeOrId)&&(i=I.value.params.typeOrId);let d=e.id;["base"].includes(I.value.params.typeOrId)&&(d=I.value.params.baseId);const n=async()=>{t&&k.value==="view"&&await Z(`${c?"#":""}/${i}/${d}/${a==null?void 0:a.id}`,c?{open:ne}:void 0),a.isViewsLoading=!0;try{await q({tableId:a.id});const l=H.value.get(a.id)??[];if(t&&k.value!=="view"&&l.length&&l[0].id){const S=l.find(s=>s.is_default)||l[0];await Z(`${c?"#":""}/${i}/${d}/${a==null?void 0:a.id}/${S.id}/${k.value}`,c?{open:ne}:void 0)}}catch(l){console.error(l)}finally{a.isViewsLoading=!1}},_=async()=>{a.isMetaLoading=!0;try{await D(a.id)}catch(l){console.error(l)}finally{a.isMetaLoading=!1}};c?await n():await Promise.all([n(),_()])},V=async()=>{var n,_,l,S;const{onTableCreate:a,baseId:c}=C;v.title&&(v.title=v.title.trim());let{sourceId:t}=C;if(c in h.value||await T.loadProject(c),!t&&(t=(_=(n=h.value.get(c))==null?void 0:n.sources)==null?void 0:_[0].id,!t))throw new Error("Source not found");const e=await T.getSqlUi(c,t),i=(S=(l=h.value.get(c))==null?void 0:l.sources)==null?void 0:S.find(s=>s.id===t);if(!e)return;const d=e==null?void 0:e.getNewTableColumns().filter(s=>s.column_name==="id"&&v.columns.includes("id_ag")?(Object.assign(s,e==null?void 0:e.getDataTypeForUiType({uidt:oe.ID},"AG")),s.dtxp=e==null?void 0:e.getDefaultLengthForDatatype(s.dt),s.dtxs=e==null?void 0:e.getDefaultScaleForDatatype(s.dt),!0):v.columns.includes(s.column_name)).map(s=>(i&&i.inflection_column!=="camelize"&&(s.title=s.column_name),s));try{const s=await b.source.tableCreate(c,t,{...v,columns:d});M("a:table:create"),a==null||a(s),O(),await N(s)}catch(s){j.error(await ie(s))}};return $e(()=>v.title,a=>{v.table_name=`${a}`}),{table:v,tables:P,base:z,createTable:V,generateUniqueTitle:()=>{v.title=Ie("Table",P.value,"title")},deleteTable:a=>{M("c:table:delete"),ke.confirm({title:`${r("msg.info.deleteTableConfirmation")} : ${a.title}?`,wrapClassName:"nc-modal-table-delete",okText:r("general.yes"),okType:"danger",cancelText:r("general.no"),width:450,async onOk(){var c;try{const t=await D(a.id,!0),e=(c=t==null?void 0:t.columns)==null?void 0:c.filter(i=>i.uidt===oe.LinkToAnotherRecord&&!Ce(i));if(e!=null&&e.length&&!Y(a.source_id)){const i=await Promise.all(e.map(async(d,n)=>{var l;const _=await D((l=d==null?void 0:d.colOptions)==null?void 0:l.fk_related_model_id);return`${n+1}. ${d.title} is a LinkToAnotherRecord of ${_&&_.title||d.title}`}));j.info(Me("div",{innerHTML:`<div style="padding:10px 4px">Unable to delete tables because of the following.
              <br><br>${i.join("<br>")}<br><br>
              Delete them & try again</div>`}));return}await b.dbTable.delete(a==null?void 0:a.id),await U({type:pe.TABLE,id:a.id,title:a.title}),await m(),$(a.id),O(),j.info(r("msg.info.tableDeleted")),M("a:table:delete"),P.value.length===0?await Z(K({id:z.value.id,type:"database"})):await N(P.value[0])}catch(t){j.error(await ie(t))}}})},openTable:N}}const et={class:"flex justify-between w-full items-center"},tt={class:"flex flex-row items-center gap-x-2 text-base font-semibold text-gray-800"},at={href:"https://docs.nocodb.com/tables/create-table",target:"_blank",class:"text-[13px]"},st={class:"flex flex-col mt-1"},ot={class:"flex flex-col gap-5"},it={class:"flex gap-3 text-gray-800 h-7 mb-1 items-center justify-between"},nt={class:"text-[13px]"},lt={class:"mb-1"},rt={key:1,class:"flex"},ct={class:"flex flex-row justify-between gap-x-2"},dt={class:"flex !text-gray-700 items-center gap-2"},ut={class:"first-letter:capitalize"},pt={key:1},ft={class:"flex gap-2 items-center"},mt=Pe({__name:"TableCreate",props:{modelValue:{type:Boolean},sourceId:{},baseId:{}},emits:["update:modelValue","create"],setup(C,{emit:v}){const r=C,M=v,b=Se(r,"modelValue",M),D=F(!1),$=F(),{addTab:U}=fe(),{isMysql:O,isMssql:te,isPg:I,isSnowflake:T}=ue(),{loadProjectTables:h,addTable:A}=ee(),{refreshCommandPalette:G}=de(),{table:m,createTable:K,generateUniqueTitle:Y,tables:q,base:k}=Xe({async onTableCreate(t){await U({id:t.id,title:t.title,type:pe.TABLE,baseId:r.baseId}),A(r.baseId,t),await h(r.baseId,!0),M("create",t),b.value=!1},sourceId:r.sourceId,baseId:r.baseId}),H=re.useForm,x=F(!1),P=()=>{m.description="",x.value=!1},z=R(()=>({title:[le,{validator:(t,e)=>new Promise((i,d)=>(q.value||[]).some(n=>n.title===(e||"")&&n.source_id===r.sourceId)?d(new Error("Duplicate table alias")):i(!0))},{validator:(t,e)=>new Promise((i,d)=>{var l;let n=255;if(O(r.sourceId)?n=64:I(r.sourceId)?n=63:te(r.sourceId)&&(n=128),((((l=k==null?void 0:k.value)==null?void 0:l.prefix)||"")+e).length>n)return d(new Error(`Table name exceeds ${n} characters`));i()})}],table_name:[le]})),{validate:N,validateInfos:V}=H(m,z),ae=ce.map((t,e)=>({value:t,disabled:e===0})),E=F(!1),a=async()=>{if(!E.value)try{E.value=!0,await N(),await K(),b.value=!1}catch(t){if(console.error(t),t.errorFields.map(e=>j.error(e.errors.join(","))),t.errorFields.length)return}finally{setTimeout(()=>{E.value=!1},500),G()}},c=()=>{x.value?x.value=!1:(x.value=!0,setTimeout(()=>{var t;(t=$.value)==null||t.focus()},100))};return Be(()=>{Y(),Le(()=>{var t,e;(t=$.value)==null||t.focus(),(e=$.value)==null||e.select()})}),(t,e)=>{const i=Ue,d=He,n=Je,_=Ae,l=Qe,S=We,s=Ge,me=Ze,_e=Ke,ve=re,be=qe,ge=Ne("e");return y(),B(be,{visible:o(b),"onUpdate:visible":e[6]||(e[6]=u=>Re(b)?b.value=u:null),"show-separator":!1,header:t.$t("activity.createTable"),size:"small",onKeydown:e[7]||(e[7]=J(u=>b.value=!1,["esc"]))},{header:p(()=>[f("div",et,[f("div",tt,[g(i,{icon:"table",class:"!text-gray-600 w-5 h-5"}),L(" "+w(t.$t("activity.createTable")),1)]),f("a",at,w(t.$t("title.docs")),1)])]),default:p(()=>[f("div",st,[g(ve,{layout:"vertical",model:o(m),name:"create-new-table-form",class:"flex flex-col gap-5",onKeydown:[J(a,["enter"]),e[5]||(e[5]=J(u=>b.value=!1,["esc"]))]},{default:p(()=>[f("div",ot,[g(n,Ve(Ee(o(V).title)),{default:p(()=>[g(d,{ref_key:"inputEl",ref:$,value:o(m).title,"onUpdate:value":e[0]||(e[0]=u=>o(m).title=u),class:"nc-input-sm nc-input-shadow","hide-details":"","data-testid":"create-table-title-input",placeholder:t.$t("msg.info.enterTableName")},null,8,["value","placeholder"])]),_:1},16),o(x)?(y(),B(n,je({key:0},o(V).description,{class:{"!mb-1":o(T)(r.sourceId),"!mb-0":!o(T)(r.sourceId)}}),{default:p(()=>[f("div",it,[f("span",nt,w(t.$t("labels.description")),1),g(_,{type:"text",class:"!h-6 !w-5",size:"xsmall",onClick:P},{default:p(()=>[g(i,{icon:"delete",class:"text-gray-700 w-3.5 h-3.5"})]),_:1})]),g(l,{ref_key:"inputEl",ref:$,value:o(m).description,"onUpdate:value":e[1]||(e[1]=u=>o(m).description=u),class:"nc-input-sm nc-input-text-area nc-input-shadow px-3 !text-gray-800 max-h-[150px] min-h-[100px]","hide-details":"","data-testid":"create-table-title-input",placeholder:t.$t("msg.info.enterTableDescription")},null,8,["value","placeholder"])]),_:1},16,["class"])):Q("",!0),o(T)(r.sourceId)?(y(),B(S,{key:1,checked:o(m).is_hybrid,"onUpdate:checked":e[2]||(e[2]=u=>o(m).is_hybrid=u),class:"!flex flex-row items-center"},{default:p(()=>e[8]||(e[8]=[L(" Hybrid Table ")])),_:1},8,["checked"])):Q("",!0)]),o(D)?(y(),X("div",{key:0,class:Oe(["nc-table-advanced-options",{active:o(D)}])},[f("div",null,[f("div",lt,w(t.$t("msg.info.defaultColumns")),1),g(_e,null,{default:p(()=>[g(me,{value:o(m).columns,"onUpdate:value":e[3]||(e[3]=u=>o(m).columns=u),options:o(ae),class:"!flex flex-row justify-between w-full"},{label:p(({value:u})=>[u==="id"?(y(),B(s,{key:0,placement:"top",class:"!flex"},{title:p(()=>[f("span",null,w(t.$t("msg.idColumnRequired")),1)]),default:p(()=>[L(" "+w(t.$t("datatype.ID")),1)]),_:1})):(y(),X("div",rt,w(u),1))]),_:1},8,["value","options"])]),_:1})])],2)):Q("",!0),f("div",ct,[o(x)?(y(),X("div",pt)):(y(),B(_,{key:0,size:"small",type:"text",onClick:ze(c,["stop"])},{default:p(()=>[f("div",dt,[g(i,{icon:"plus",class:"h-4 w-4"}),f("span",ut,w(t.$t("labels.addDescription").toLowerCase()),1)])]),_:1})),f("div",ft,[g(_,{type:"secondary",size:"small",onClick:e[4]||(e[4]=u=>b.value=!1)},{default:p(()=>[L(w(t.$t("general.cancel")),1)]),_:1}),Fe((y(),B(_,{type:"primary",size:"small",disabled:o(V).title.validateStatus==="error",loading:o(E),onClick:a},{loading:p(()=>[L(w(t.$t("title.creatingTable")),1)]),default:p(()=>[L(w(t.$t("activity.createTable"))+" ",1)]),_:1},8,["disabled","loading"])),[[ge,["a:table:create"]]])])])]),_:1},8,["model"])])]),_:1},8,["visible","header"])}}}),It=Ye(mt,[["__scopeId","data-v-45c352c8"]]);export{It as _,Xe as u};
