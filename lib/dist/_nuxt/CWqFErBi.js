import{_ as G}from"./C600yAEI.js";import{f as M,N as O,r as x,g as w,ce as S,cZ as U,i as H,o as u,c as p,b as d,P as o,w as R,d as z,a as m,al as _,am as K,cT as c,t as y,T as W,an as I,ao as Z,dF as q,a2 as Q,$ as X,aG as Y,A as tt}from"./DKhUGBot.js";import{a as et}from"./DNFe8-bc.js";import{u as at}from"./Du3cTDPI.js";import"./CX4Cv_ut.js";import"./DEJjMRn_.js";import"./BQQOEPN4.js";import"./DX_5E9FR.js";import"./BOlDoh1A.js";import"./CUg8TjpL.js";import"./Cx8swDhG.js";import"./GAfEgWrt.js";import"./CzWiRRCe.js";import"./CyGutrdy.js";import"./B5mlyM8k.js";import"./DGy9VVU7.js";import"./D-d1Vlq3.js";import"./Ce4Hnuew.js";import"./BfoRuF4I.js";import"./Cz8K5PX4.js";import"./GPQ-Eg6I.js";import"./BpnlUwoJ.js";import"./CxxuE4Yq.js";import"./C6beNF3T.js";import"./DYyLu51D.js";import"./DqUBg5CU.js";import"./DsXhLEQW.js";import"./BjI6BKbX.js";import"./boyBAVNN.js";import"./Ca0l_TBy.js";import"./6zAE39KB.js";import"./Tw6PiqUh.js";import"./BMlI7u7p.js";import"./BDyus9Cs.js";import"./DO1hNe_j.js";import"./lyxpGZoZ.js";const ot={class:"flex flex-col gap-2 p-2"},st=["href"],Ot=M({__name:"index",setup(lt){const{$api:E,$poller:g}=tt(),{appInfo:k}=O(),{extension:b,tables:D,fullscreen:h,getViewsForTable:C}=et(),{jobList:v,loadJobsForBase:F}=at(),f=x([]),T=w(()=>v.value.filter(t=>t.job==="data-export").map(t=>({...t,result:t.result||{}})).sort((t,e)=>S(e.created_at).unix()-S(t.created_at).unix())),a=x({}),$=w(()=>D.value.map(t=>({label:t.title,value:t.id}))),A=w(()=>a.value.tableId?f.value.filter(t=>t.type===U.GRID).map(t=>({label:t.is_default?"Default View":t.title,value:t.id}))||[]:[]),L=async()=>{a.value.tableId&&(f.value=await C(a.value.tableId))},V=async t=>{var e;a.value.tableId=t,await L(),a.value.viewId=(e=f.value.find(s=>s.is_default))==null?void 0:e.id,await b.value.kvStore.set("exportPayload",a.value)},P=async t=>{a.value.viewId=t,await b.value.kvStore.set("exportPayload",a.value)},i=x(!1);async function B(){try{if(i.value||!a.value.viewId)return;i.value=!0;const t=await E.export.data(a.value.viewId,"csv",{});v.value.unshift(t),g.subscribe({id:t.id},async e=>{var s;if(e.status!=="close"){if(e.status===c.COMPLETED){I.info("Successfully exported data!");const r=v.value.find(n=>n.id===e.id);r&&(r.status=c.COMPLETED,r.result=(s=e.data)==null?void 0:s.result),i.value=!1}else if(e.status===c.FAILED){I.error("Failed to export data!");const r=v.value.find(n=>n.id===e.id);r&&(r.status=c.FAILED),i.value=!1}}})}catch(t){I.error(await Z(t))}}const J=t=>t.startsWith("http")?t:`${k.value.ncSiteUrl||q}/${t}`,N=()=>{const t=D.value.find(s=>s.id===a.value.tableId),e=f.value.find(s=>s.id===a.value.viewId);return`${t==null?void 0:t.title} (${e!=null&&e.is_default?"Default View":e==null?void 0:e.title})`};return H(()=>{a.value=b.value.kvStore.get("exportPayload")||{},L(),F()}),(t,e)=>{const s=G,r=Q,n=X,j=Y;return u(),p("div",ot,[d(s,{value:o(a).tableId,"onUpdate:value":e[0]||(e[0]=l=>o(a).tableId=l),options:o($),onDisabled:o(i),onChange:V},null,8,["value","options","onDisabled"]),d(s,{value:o(a).viewId,"onUpdate:value":e[1]||(e[1]=l=>o(a).viewId=l),options:o(A),onDisabled:o(i),onChange:P},null,8,["value","options","onDisabled"]),d(r,{onLoading:o(i),onClick:B},{default:R(()=>[z("Export")]),_:1},8,["onLoading"]),m("div",{class:W(["flex flex-col",{"max-h-[60px] overflow-auto":!o(h)}])},[(u(!0),p(_,null,K(o(T),l=>(u(),p("div",{key:l.id,class:"flex items-center gap-1"},[l.status===("JobStatus"in t?t.JobStatus:o(c)).COMPLETED&&l.result?(u(),p(_,{key:0},[d(n,{icon:"file"}),m("div",null,y(l.result.title),1),m("a",{href:J(l.result.url),target:"_blank"},"Download",8,st)],64)):l.status===("JobStatus"in t?t.JobStatus:o(c)).FAILED?(u(),p(_,{key:1},[d(n,{icon:"error",class:"text-red-500"}),m("div",null,y(l.result.title),1)],64)):(u(),p(_,{key:2},[d(j,{size:"small"}),m("div",null,y(N()),1)],64))]))),128))],2)])}}});export{Ot as default};
