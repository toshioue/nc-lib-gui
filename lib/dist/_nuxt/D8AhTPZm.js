import ae from"./BV5EkxN-.js";import le from"./CtMydB5S.js";import{f as se,cM as oe,cY as ne,bN as Q,r as _,d9 as ie,d8 as ce,bc as de,a7 as ue,ad as re,g1 as me,H as pe,d2 as fe,fr as ve,i as _e,o as b,S as $,w as r,a as i,V as N,P as l,W as j,d as m,t as u,b as f,Q as B,c as he,Y as be,A as ge,n as ke,fO as xe,d1 as ye,io as we,a0 as $e,a1 as Ce,p as Me,e as Le,_ as Ie}from"./3QBYHahY.js";import{_ as Ne}from"./DRopnK1z.js";import{_ as Te}from"./C95Svpv6.js";import{D as Ae}from"./Ddy65kPJ.js";import"./kHOslGNR.js";import{I as Ve}from"./CmN9vPg3.js";import"./DPqnb67u.js";import"./D4iSzjWt.js";import"./Dg1gNFnz.js";import"./Ci1lK5Ee.js";import"./xnDaHwV-.js";import"./DPgYHC40.js";import"./BsWDDIqE.js";import"./BQQOEPN4.js";import"./ceYq-xax.js";const je=g=>(Me("data-v-e4296839"),g=g(),Le(),g),Be={class:"flex flex-col gap-3"},Oe={class:"text-base text-gray-800 font-semibold"},Se={class:"text-gray-500 text-[13px] leading-5"},ze={class:"font-semibold"},Ue={class:"flex w-full gap-2 justify-between items-center"},Fe={class:"flex items-center gap-2"},Re={class:"border-1 rounded-md h-[300px] nc-scrollbar-md border-gray-200"},De=["data-testid","onClick"],Ee={class:"flex flex-row items-center w-full cursor-pointer truncate ml-1 py-[5px] pr-2"},He=je(()=>i("div",{class:"flex-1"},null,-1)),We={class:"flex w-full gap-2 justify-end"},Ye=se({__name:"AddLookups",props:{column:{},value:{type:Boolean}},setup(g){const O=g,{$api:S}=ge(),z=oe(),{getMeta:G,metas:U}=ne(),p=Q(ie,_()),F=Q(ce,_()),{loadTables:J}=z,{tables:R}=de(z),D=ue(O,"column"),k=re(O,"value"),E=_(),T=_(!1),x=_(""),h=_([]),c=_({}),K=e=>ke(xe(e)?ae:le,{columnMeta:e}),d=me(async()=>{var t;const e=(t=D.value.colOptions)==null?void 0:t.fk_related_model_id;if(e){let n=R.value.find(s=>s.id===e);return n||(await J(),n=R.value.find(s=>s.id===e)),n}return null}),X=()=>{Object.keys(c.value).forEach(e=>c.value[e]=!1)},Z=()=>{h.value.forEach(e=>c.value[e.id]=!0)},ee=async()=>{var e,t,n,s,C,M,L,v,y,a,w,H,W;try{T.value=!0;const I=[],Y=((t=(e=p.value)==null?void 0:e.columns)==null?void 0:t.length)??0;for(const[A]of Object.entries(c.value).filter(([,o])=>o)){const o=U.value[(n=d.value)==null?void 0:n.id].columns.find(V=>V.id===A),q=h.value.findIndex(V=>V.id===A),P={uidt:ye.Lookup,fk_lookup_column_id:A,fk_relation_column_id:D.value.id,lookupTableTitle:(s=d.value)==null?void 0:s.title,lookupColumnTitle:(o==null?void 0:o.title)||o.column_name,table_name:(C=p.value)==null?void 0:C.table_name,title:`${o==null?void 0:o.title} from ${(M=d.value)==null?void 0:M.title}`,view_id:(L=F.value)==null?void 0:L.id,order:Y+q,column_name:`${o==null?void 0:o.title} from (${(v=d.value)==null?void 0:v.title})`,column_order:{order:Y+q,view_id:(y=F.value)==null?void 0:y.id}},te=we({formState:P,metaColumns:(a=d.value)==null?void 0:a.columns,tableExplorerColumns:(w=p.value)==null?void 0:w.columns});I.push({op:"add",column:{...P,title:te}})}await S.dbTableColumn.bulk((H=p.value)==null?void 0:H.id,{hash:E.value,ops:I}),await G((W=p==null?void 0:p.value)==null?void 0:W.id,!0),k.value=!1}catch(I){console.error(I)}finally{T.value=!1}};return pe([d,x],async()=>{if(d.value){const e=U.value[d.value.id].columns;h.value=e.filter(t=>!fe(t)&&!ve(t)).filter(t=>{var n,s;return(s=t==null?void 0:t.title)==null?void 0:s.toLowerCase().startsWith((n=x.value)==null?void 0:n.toLowerCase())})}}),_e(async()=>{var e;E.value=(await S.dbTableColumn.hash((e=p.value)==null?void 0:e.id)).hash}),(e,t)=>{const n=Ve,s=$e,C=Ce,M=Ne,L=Te;return b(),$(L,{visible:l(k),"onUpdate:visible":t[3]||(t[3]=v=>B(k)?k.value=v:null),size:"small"},{default:r(()=>{var v,y;return[i("div",Be,[i("div",null,[i("h1",Oe,[(b(),$(N(("iconMap"in e?e.iconMap:l(j)).cellLookup),{class:"text-gray-500 pb-1"})),m(" "+u(e.$t("general.addLookupField")),1)]),i("div",Se,[m(u(e.$t("labels.addNewLookupHelperText1"))+" ",1),i("span",ze,u(((v=l(d))==null?void 0:v.title)??((y=l(d))==null?void 0:y.table_name)),1),m(" "+u(e.$t("labels.addNewLookupHelperText2")),1)])]),i("div",Ue,[f(n,{value:l(x),"onUpdate:value":t[0]||(t[0]=a=>B(x)?x.value=a:null),class:"w-full h-8 flex-1",size:"small",placeholder:e.$t("placeholder.searchFields")},{prefix:r(()=>[(b(),$(N(("iconMap"in e?e.iconMap:l(j)).search),{class:"w-4 text-gray-500 h-4"}))]),_:1},8,["value","placeholder"]),i("div",Fe,[f(s,{size:"small",type:"text",class:"!text-xs",onClick:X},{default:r(()=>[m(u(e.$t("labels.clearAll")),1)]),_:1}),f(s,{size:"small",type:"text",class:"!text-xs",onClick:Z},{default:r(()=>[m(u(e.$t("general.addAll")),1)]),_:1})])]),i("div",Re,[f(l(Ae),{modelValue:l(h),"onUpdate:modelValue":t[1]||(t[1]=a=>B(h)?h.value=a:null),"item-key":"id","ghost-class":"nc-lookup-menu-items-ghost"},{item:r(({element:a})=>[(b(),he("div",{key:a.id,"data-testid":`nc-lookup-add-menu-${a.title}`,class:"px-3 py-1 flex flex-row items-center rounded-md hover:bg-gray-100",onClick:be(w=>l(c)[a.id]=!l(c)[a.id],["stop"])},[(b(),$(N(("iconMap"in e?e.iconMap:l(j)).drag),{class:"cursor-move !h-3.75 text-gray-600 mr-1"})),i("div",Ee,[(b(),$(N(K(a)),{class:"!w-3.5 !h-3.5 !text-gray-500"})),f(C,{class:"flex-1 pl-1 pr-2 truncate","show-on-truncate-only":""},{title:r(()=>[m(u(a.title),1)]),default:r(()=>[m(u(a.title),1)]),_:2},1024),f(M,{checked:l(c)[a.id],"onUpdate:checked":w=>l(c)[a.id]=w,size:"default"},null,8,["checked","onUpdate:checked"])]),He],8,De))]),_:1},8,["modelValue"])]),i("div",We,[f(s,{type:"secondary",size:"small",onClick:t[2]||(t[2]=a=>k.value=!1)},{default:r(()=>[m(u(e.$t("general.cancel")),1)]),_:1}),f(s,{loading:l(T),disabled:!Object.values(l(c)).filter(Boolean).length,size:"small",onClick:ee},{default:r(()=>[m(u(e.$t("general.addLookupField",{count:Object.values(l(c)).filter(Boolean).length||""})),1)]),_:1},8,["loading","disabled"])])])]}),_:1},8,["visible"])}}}),dt=Ie(Ye,[["__scopeId","data-v-e4296839"]]);export{dt as default};
