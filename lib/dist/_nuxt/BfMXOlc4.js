import{u as J}from"./-Hb63wRq.js";import{r as p,L as K,at as X,cB as Y,cQ as I,g as F,cV as U,H as M,av as B,h6 as D,A as ee,hh as se,hi as ue,d4 as le,cZ as ie}from"./nEPQs079.js";const[ae,ne]=J((i,v,f,y=!1)=>{const L=p([]),a=p(),g=p(""),{$api:h,$e:A}=ee(),{isUIAllowed:b}=K(),{isSharedBase:N}=X(Y()),E=p(!1),{addUndo:j,defineViewScope:T}=I(),k=F(()=>y||!b("viewFieldEdit")||!b("viewFieldEdit")||N.value),P=p([]),R=e=>{var s,n,u;return((s=i.value)==null?void 0:s.type)===ie.MAP&&((u=(n=i.value)==null?void 0:n.view)==null?void 0:u.fk_geo_data_col_id)===e.id},r=F(()=>{var e;return(e=v.value)!=null&&e.columns?v.value.columns.reduce((s,n)=>({...s,[n.id]:n}),{}):{}}),m=p({}),w=async()=>{var s,n,u,l,o;if(!v||!i)return;let e=1;if((s=i.value)!=null&&s.id){const c=(y?(n=v.value)==null?void 0:n.columns:(await h.dbViewColumn.list(i.value.id)).list).reduce((_,d)=>(d.show=!!d.show,{..._,[d.fk_column_id]:d}),{});if(a.value=(l=(u=v.value)==null?void 0:u.columns)==null?void 0:l.filter(_=>!se(_)).map(_=>{var V;const d=c[_.id]||{};return{title:_.title,fk_column_id:_.id,...d,show:d.show||R(d),order:d.order||e++,aggregation:(d==null?void 0:d.aggregation)??ue.None,system:U((V=r==null?void 0:r.value)==null?void 0:V[d.fk_column_id]),isViewEssentialField:R(_)}}).sort((_,d)=>_.order-d.order),k.value&&a.value)for(const _ of P.value){const d=a.value.findIndex(V=>V.fk_column_id===_.fk_column_id);d!==void 0&&d>-1&&(a.value[d]=_,a.value=a.value.sort((V,q)=>V.order-q.order))}const x=(y.value?(o=i.value)==null?void 0:o.columns:a.value)??[];m.value=x.reduce((_,d)=>({..._,[d.fk_column_id]:d}),{})}},Q=async e=>{var s,n,u;if(k.value){const l=(a.value||[]).reduce((o,t)=>(t.fk_column_id&&(t.show=!0,o[t.fk_column_id]=t),o),{});a.value=(s=a.value)==null?void 0:s.map(o=>{var t;return{...o,show:(t=l[o.fk_column_id])==null?void 0:t.show}}),v.value.columns=(n=v.value.columns)==null?void 0:n.map(o=>l[o.id]?{...o,...l[o.id],id:l[o.id].fk_column_id}:o),f==null||f();return}(u=i==null?void 0:i.value)!=null&&u.id&&(e?await h.dbView.showAllColumn(i.value.id,{ignoreIds:e}):await h.dbView.showAllColumn(i.value.id)),await w(),f==null||f(),A("a:fields:show-all")},z=async e=>{var s,n,u;if(k.value){const l=(a.value||[]).reduce((o,t)=>(t.fk_column_id&&(t.show=!!t.isViewEssentialField,o[t.fk_column_id]=t),o),{});a.value=(s=a.value)==null?void 0:s.map(o=>{var t;return{...o,show:(t=l[o.fk_column_id])==null?void 0:t.show}}),v.value.columns=(n=v.value.columns)==null?void 0:n.map(o=>l[o.id]?{...o,...l[o.id],id:l[o.id].fk_column_id}:o),f==null||f();return}(u=i==null?void 0:i.value)!=null&&u.id&&(e?await h.dbView.hideAllColumn(i.value.id,{ignoreIds:e}):await h.dbView.hideAllColumn(i.value.id)),await w(),f==null||f(),A("a:fields:show-all")},C=async(e,s,n=!1,u=!1)=>{var l,o,t;if(k.value&&a.value&&(a.value[s]=e,v.value.columns=(l=v.value.columns)==null?void 0:l.map(c=>c.id===e.fk_column_id?{...c,...e,id:e.fk_column_id,...u?{meta:{...le(c.meta),defaultViewColOrder:e.order}}:{}}:c),P.value.push(e)),b("viewFieldEdit")){if(e.id&&((o=i==null?void 0:i.value)!=null&&o.id))await h.dbViewColumn.update(i.value.id,e.id,e);else if((t=i.value)!=null&&t.id){const c=await h.dbViewColumn.create(i.value.id,e);return a.value&&(a.value[s]=c),c}}n||(await w(),f==null||f({shouldShowLoading:!1}))},O=F({get(){var e;return((e=i.value)==null?void 0:e.show_system_fields)||!1},set(e){var s;(s=i==null?void 0:i.value)!=null&&s.id&&(k.value||h.dbView.update(i.value.id,{show_system_fields:e}).finally(()=>{w(),f==null||f()}),i.value.show_system_fields=e),A("a:fields:system-fields")}}),G=F(()=>{var e;return((e=a.value)==null?void 0:e.filter(s=>{var n,u,l;return(u=(n=r==null?void 0:r.value)==null?void 0:n[s.fk_column_id])!=null&&u.pv&&(!g.value||s.title.toLowerCase().includes(g.value.toLowerCase()))?!0:!O.value&&U((l=r==null?void 0:r.value)==null?void 0:l[s.fk_column_id])?!1:g.value===""?!0:s.title.toLowerCase().includes(g.value.toLowerCase())}))||[]}),$=F(()=>{var e,s,n;return((n=(s=(e=a==null?void 0:a.value)==null?void 0:e.filter(u=>{var l,o,t,c,x;return!O.value&&r.value&&((l=r==null?void 0:r.value)!=null&&l[u.fk_column_id])&&U((o=r.value)==null?void 0:o[u.fk_column_id])&&!((c=(t=r.value)==null?void 0:t[u.fk_column_id])!=null&&c.pv)?!1:u.show&&((x=r==null?void 0:r.value)==null?void 0:x[u.fk_column_id])}))==null?void 0:s.sort((u,l)=>u.order-l.order))==null?void 0:n.map(u=>{var l;return(l=r==null?void 0:r.value)==null?void 0:l[u.fk_column_id]}))||[]}),W=(e,s)=>{var u;const n=(u=a.value)==null?void 0:u.findIndex(l=>l.fk_column_id===s.fk_column_id);!n&&n!==0||(j({undo:{fn:l=>{s.show=!l,C(s,n)},args:[e]},redo:{fn:l=>{s.show=l,C(s,n)},args:[e]},scope:T({view:i.value})}),C(s,n,!e))},Z=(e,s,n)=>{var l;const u=(l=a.value)==null?void 0:l.findIndex(o=>o.fk_column_id===e.fk_column_id);!u&&u!==0||(e[s]=n,A("a:fields:style",{style:s,status:n}),C(e,u,!0))};M([()=>{var e;return(e=i==null?void 0:i.value)==null?void 0:e.id},()=>{var e;return(e=v.value)==null?void 0:e.columns}],async([e])=>{var s,n;if(e&&((s=i.value)==null?void 0:s.fk_model_id)===((n=v.value)==null?void 0:n.id)){E.value=!0;try{await w()}catch(u){console.error(u)}E.value=!1}},{immediate:!0});const H=p("180px"),S=async(e,s,n=!1)=>{var u,l;if(!n){const o=Object.keys(s).reduce((t,c)=>(m.value[e][c]&&(c==="width"?t[c]=`${H.value}px`:t[c]=m.value[e][c]),t),{});j({redo:{fn:t=>S(e,t,!0),args:[s]},undo:{fn:t=>S(e,t,!0),args:[o]},scope:T({view:i.value})})}!y.value&&b("viewFieldEdit")&&((u=m.value[e])!=null&&u.id)&&await h.dbView.gridColumnUpdate(m.value[e].id,{...s}),(l=m.value)!=null&&l[e]?Object.assign(m.value[e],{...m.value[e],...s}):await w()};return M($,e=>{L&&(L.value=e||[])},{immediate:!0}),B(D,L),{fields:a,loadViewColumns:w,filteredFieldList:G,filterQuery:g,showAll:Q,hideAll:z,saveOrUpdate:C,sortedAndFilteredFields:$,showSystemFields:O,metaColumnById:r,toggleFieldVisibility:W,toggleFieldStyles:Z,isViewColumnsLoading:E,updateGridViewColumn:S,gridViewCols:m,resizingColOldWith:H}},"useViewColumnsOrThrow");function re(){const i=ne();if(i==null)throw new Error("Please call `useProvideViewColumns` on the appropriate parent component");return i}export{re as a,ae as u};
