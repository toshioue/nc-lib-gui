import{u as Be,_ as Fe,v as Qe}from"./BpclqUFq.js";import{e as We,cL as Ve,ay as Oe,ax as Re,bL as je,gi as ze,f as x,cS as Ge,r as _,ap as Ke,ag as qe,fy as d,F as le,g as Ye,gm as N,o as f,c as U,a as c,b as n,w as s,a7 as w,N as a,ao as A,at as K,Q as v,R as D,d as P,t as g,T as Ze,U as He,O as q,S as se,y as Je,gl as Xe,ah as ie,ai as ce,gn as ea,a$ as aa,gp as ta,dD as oa,$ as na,Y as la,Z as sa,dp as ia,_ as ca}from"./DZZ6t_j4.js";import{_ as ra}from"./DnSVh-oD.js";import{a as da,b as ua}from"./C3dEhB1d.js";import{_ as ma}from"./0QUe8GCE.js";import{_ as pa}from"./TJfB7GlU.js";import{b as fa,e as _a,f as E}from"./C3jLTHF4.js";import{F as re}from"./BYINaHrJ.js";import"./DKN1hQ6S.js";import{I as va}from"./BQuyMdA-.js";import{_ as ba,C as Sa}from"./CbjHV4v2.js";import{_ as ga}from"./dfem9Uc_.js";import{S as ha}from"./D_MsYLkT.js";import"./B89oU1M4.js";import"./Bdv7ru7D.js";import"./DuJHisTB.js";import"./oyD85nwD.js";import"./DGj1ycqW.js";import"./BQQOEPN4.js";import"./vll-Pnjv.js";import"./vK-WmZ7a.js";import"./B4Lj1XSi.js";import"./boyBAVNN.js";import"./CwK0k4WN.js";import"./GMLocJHP.js";import"./DCjuPxLb.js";import"./C00NHga8.js";import"./G4Pt-Lbf.js";import"./C3wAmqC5.js";import"./DyDFI6NE.js";import"./CDWovrGB.js";import"./CxrpBWdD.js";import"./DA0VIM8P.js";import"./DNgdBwTe.js";import"./eX8_g88K.js";import"./0azk-b-q.js";import"./BO2leIU3.js";import"./CmWcz5yS.js";import"./CB1aB6F1.js";import"./CMQKmrr6.js";import"./CMIIcM5i.js";import"./ByvYYClF.js";import"./DuvRsGDb.js";import"./BT-ahe-O.js";import"./CynerQ2m.js";import"./CY3l82lI.js";import"./DgixBgIx.js";import"./C3XbZq4f.js";import"./CyRMlOXW.js";import"./By7kEk8u.js";import"./DfeSAprs.js";import"./DnwRMKX3.js";import"./B6xrG0q8.js";import"./YRNmwX8m.js";import"./2FgppHLC.js";import"./Ck-cgwga.js";import"./sz1d3zjm.js";import"./BLgccLvp.js";import"./BqKQ8afS.js";import"./CXD-Dj4T.js";import"./DS_HXCWn.js";import"./BVrX6sNU.js";import"./Dg0-TbNo.js";import"./t0mbNaqp.js";import"./D9tFZoTQ.js";import"./B5RRVMt5.js";import"./BCJFTkwv.js";const ya={class:"edit-source bg-white relative h-full flex flex-col w-full"},xa={class:"h-full max-h-[calc(100%_-_65px)] flex"},wa={class:"nc-edit-source-left-panel nc-scrollbar-thin relative"},ka={class:"h-full max-w-[768px] mx-auto"},Ca={class:"nc-form-section"},Pa={class:"nc-form-section-body"},Ia=["data-testid"],Ta={class:"nc-form-section"},$a={class:"nc-form-section-body"},Na={class:"nc-form-section"},Ua={class:"nc-form-section-body"},Da={class:"flex flex-col gap-4"},Ea={class:"flex flex-col gap-4"},La={class:"flex items-center justify-center h-full w-full !bg-white !bg-opacity-85 z-1000"},Ma={class:"nc-edit-source-right-panel"},Aa={class:"p-4 w-full flex items-center justify-between gap-3 border-t-1 border-gray-200"},Ba={class:"flex-1 flex items-center gap-3"},Fa={class:"flex-1 flex items-center gap-3 text-[#C86827]"},Qa={class:"flex items-center gap-3"},Wa=We({__name:"EditBase",props:{sourceId:{}},emits:["sourceUpdated","close"],setup(de,{emit:ue}){const Y=de,Z=ue,me=Ve(),pe=Oe(),{base:k}=Re(me),{integrations:B,loadIntegrations:fe}=Be(),F=je(ze,void 0),_e=x(()=>{var o;return(F==null?void 0:F.value)??((o=k.value)==null?void 0:o.id)}),{refreshCommandPalette:ve}=Ge(),be=re.useForm,b=_(!1),Q=_(!1),H=_(),{api:W}=Ke(),{$e:L}=Je(),{t:Se}=qe(),ge=_(!1),he=_(!1),J=_(0),C=_([]),I=_(!1),ye=()=>{J.value+=1,J.value>=2&&(he.value=!0)},e=_(((o=d.MYSQL)=>({title:"",dataSource:{...Xe(o)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:N.No,extraParameters:[],is_schema_readonly:!0,is_data_readonly:!1}))()),h=x(()=>e.value.fk_integration_id&&B.value.find(o=>o.id===e.value.fk_integration_id)),xe=x(()=>{var o,t,i;return(i=(t=(o=h.value)==null?void 0:o.config)==null?void 0:t.connection)==null?void 0:i.database}),V=x(()=>{var o,t,i;return(i=(t=(o=h.value)==null?void 0:o.config)==null?void 0:t.searchPath)==null?void 0:i[0]}),X=o=>{if(o==="database")return xe.value;if(o==="schema")return V.value},we=x(()=>({title:[fa()],extraParameters:[_a],"dataSource.client":[E()],...e.value.dataSource.client===d.SQLITE?{}:e.value.dataSource.client===d.SNOWFLAKE?{"dataSource.connection.database":[E()],"dataSource.connection.schema":[E()]}:{"dataSource.connection.database":h.value&&X("database")?[]:[E()],...[d.PG,d.MSSQL].includes(e.value.dataSource.client)&&e.value.dataSource.searchPath?{"dataSource.searchPath.0":h.value&&X("schema")?[]:[E()]}:{}}})),{validate:ee,validateInfos:y}=be(e,we),ke=()=>{if(e.value.dataSource.client!==d.SQLITE){const o=e.value.dataSource.connection;o.ssl?typeof o.ssl=="string"?e.value.sslUse=N.Allowed:e.value.sslUse=N.Preferred:e.value.sslUse=N.No}},ae=["camelize","none"];function te(){const o=Object.fromEntries(new Map(e.value.extraParameters.map(i=>[i.key,i.value]))),t={...e.value.dataSource.connection,...o};return t.ssl=Qe(t,e.value.sslUse,e.value.dataSource.client),t}const oe=()=>{var o,t,i,r,m;(m=(r=(i=(t=(o=H.value)==null?void 0:o.$el.querySelector(".ant-form-item-explain-error"))==null?void 0:t.parentNode)==null?void 0:i.parentNode)==null?void 0:r.querySelector("input"))==null||m.focus()},Ce=async()=>{var o,t,i,r,m,u;try{await ee()}catch{oe();return}try{if(!((o=k.value)!=null&&o.id))return;const S=te(),p={...e.value.dataSource,connection:S};p.client===d.SQLITE&&((i=(t=p.connection)==null?void 0:t.connection)!=null&&i.filename)&&(p.connection.filename=p.connection.connection.filename),h.value&&(((r=p.connection)==null?void 0:r.database)===""&&(p.connection.database=void 0),((m=p.searchPath)==null?void 0:m[0])===""&&(p.searchPath=void 0)),await W.source.update((u=k.value)==null?void 0:u.id,Y.sourceId,{alias:e.value.title,type:e.value.dataSource.client,config:p,inflection_column:e.value.inflection.inflectionColumn,inflection_table:e.value.inflection.inflectionTable,is_schema_readonly:e.value.is_schema_readonly,is_data_readonly:e.value.is_data_readonly}),L("a:source:edit:extdb"),await pe.loadProject(_e.value,!0),Z("sourceUpdated"),Z("close")}catch(S){ie.error(await ce(S))}finally{ve()}},T=_(),Pe=async()=>{try{await ee()}catch{oe();return}L("a:source:edit:extdb:test-connection",[]);try{if(Q.value=!0,e.value.dataSource.client===d.SQLITE)b.value=!0;else{const o=te();o.database=ea(e.value.dataSource);let t=e.value.dataSource.searchPath;h.value&&((o==null?void 0:o.database)===""&&(o.database=void 0),(t==null?void 0:t[0])===""&&(t=void 0));const i={...e.value.dataSource,connection:o,searchPath:t,fk_integration_id:e.value.fk_integration_id},r=await W.utils.testConnection(i);r.code===0?b.value=!0:(b.value=!1,ie.error(`${Se("msg.error.dbConnectionFailed")} ${r.message}`))}}catch(o){b.value=!1,T.value=await ce(o)}Q.value=!1};le(()=>e.value.dataSource,()=>{b.value=!1,T.value=null},{deep:!0}),Ye(async()=>{var o,t,i,r;if(I.value=!0,B.value.length||await fe(!0,(o=k.value)==null?void 0:o.id),(t=k.value)!=null&&t.id){const m=["host","port","user","password","database"],u=await W.source.read((i=k.value)==null?void 0:i.id,Y.sourceId),S=Object.entries(u.config.connection||{}).filter(([p])=>!m.includes(p)).map(([p,$])=>({key:p,value:$}));e.value={title:u.alias||"",dataSource:{connection:{},...u.config||{},searchPath:((r=u.config)==null?void 0:r.searchPath)||[]},inflection:{inflectionColumn:u.inflection_column,inflectionTable:u.inflection_table},extraParameters:S,sslUse:N.No,is_schema_readonly:u.is_schema_readonly,is_data_readonly:u.is_data_readonly,fk_integration_id:u.fk_integration_id},ke()}I.value=!1}),le(()=>e.value.dataSource.searchPath,o=>{[d.PG,d.MSSQL].includes(e.value.dataSource.client)&&!o&&(e.value.dataSource.searchPath=[])},{immediate:!0});const O=x({get:()=>!e.value.is_schema_readonly,set:o=>{e.value.is_schema_readonly=!o,o&&(e.value.is_data_readonly=!1),L("c:source:schema-write-toggle",{allowed:!o,edit:!0})}}),R=x({get:()=>!e.value.is_data_readonly,set:o=>{e.value.is_data_readonly=!o,L("c:source:data-write-toggle",{allowed:!o,edit:!0})}}),Ie=o=>{o?(C.value=["1"],Te(!0,"nc-source-advanced-options")):C.value=[]};let j;function Te(o,t){j&&clearTimeout(j),aa(()=>{const i=document.querySelector(`.edit-source .${t}`);i&&(j=setTimeout(()=>{i.scrollIntoView({block:"center",behavior:"smooth"})},400))})}return(o,t)=>{const i=va,r=ga,m=ta,u=oa,S=Fe,p=na,$=ha,z=ra,$e=da,M=la,G=sa,Ne=ba,Ue=Sa,De=re,Ee=ia,Le=ma,Me=ua,Ae=pa;return f(),U("div",ya,[c("div",xa,[c("div",wa,[c("div",ka,[n(De,{ref_key:"form",ref:H,model:a(e),"hide-required-mark":"",name:"external-base-create-form",layout:"vertical","no-style":"",class:"flex flex-col gap-5.5"},{default:s(()=>[c("div",Ca,[c("div",Pa,[n(u,{gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,w({label:"Data Source Name"},a(y).title),{default:s(()=>[n(i,{value:a(e).title,"onUpdate:value":t[0]||(t[0]=l=>a(e).title=l),class:"nc-extdb-proj-name"},null,8,["value"])]),_:1},16)]),_:1})]),_:1}),n(u,{gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,{label:"Select connection"},{default:s(()=>[n(z,{value:a(e).fk_integration_id,disabled:"",class:"nc-extdb-db-type nc-select-shadow","dropdown-class-name":"nc-dropdown-ext-db-type",placeholder:"Select connection","allow-clear":"","show-search":"","dropdown-match-select-width":""},{default:s(()=>[(f(!0),U(A,null,K(a(B),l=>(f(),v($,{key:l.id,value:l.id},{default:s(()=>[c("div",{class:"w-full flex gap-2 items-center","data-testid":l.title},[l!=null&&l.sub_type?(f(),v(S,{key:0,type:l.sub_type,style:{filter:"grayscale(100%) brightness(115%)"}},null,8,["type"])):D("",!0),n(p,{class:"flex-1 truncate","show-on-truncate-only":""},{title:s(()=>[P(g(l.title),1)]),default:s(()=>[P(" "+g(l.title),1)]),_:2},1024),a(e).fk_integration_id===l.id?(f(),v(Ze(("iconMap"in o?o.iconMap:a(He)).check),{key:1,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):D("",!0)],8,Ia)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})])]),c("div",Ta,[c("div",$a,[a(e).dataSource.client===a(d).SQLITE?(f(),U(A,{key:0},[],64)):a(e).dataSource.client===a(d).SNOWFLAKE?(f(),v(u,{key:1,gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,w({label:o.$t("labels.database")},a(y)["dataSource.connection.database"]),{default:s(()=>[n(i,{value:a(e).dataSource.connection.database,"onUpdate:value":t[1]||(t[1]=l=>a(e).dataSource.connection.database=l),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16,["label"])]),_:1}),n(m,{span:12},{default:s(()=>[n(r,w({label:"Schema"},a(y)["dataSource.connection.schema"]),{default:s(()=>[n(i,{value:a(e).dataSource.connection.schema,"onUpdate:value":t[2]||(t[2]=l=>a(e).dataSource.connection.schema=l),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16)]),_:1})]),_:1})):a(e).dataSource.client===a(d).DATABRICKS?(f(),v(u,{key:2,gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,w({label:"Database"},a(y)["dataSource.connection.database"]),{default:s(()=>[n(i,{value:a(e).dataSource.connection.database,"onUpdate:value":t[3]||(t[3]=l=>a(e).dataSource.connection.database=l),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16)]),_:1}),n(m,{span:12},{default:s(()=>[n(r,w({label:"Schema"},a(y)["dataSource.connection.schema"]),{default:s(()=>[n(i,{value:a(e).dataSource.connection.schema,"onUpdate:value":t[4]||(t[4]=l=>a(e).dataSource.connection.schema=l),class:"nc-extdb-host-schema"},null,8,["value"])]),_:1},16)]),_:1})]),_:1})):(f(),v(u,{key:3,gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,w({label:o.$t("labels.database")},a(y)["dataSource.connection.database"]),{default:s(()=>[n(i,{value:a(e).dataSource.connection.database,"onUpdate:value":t[5]||(t[5]=l=>a(e).dataSource.connection.database=l),placeholder:o.$t("labels.dbCreateIfNotExists"),class:"nc-extdb-host-database"},null,8,["value","placeholder"])]),_:1},16,["label"])]),_:1}),n(m,{span:12},{default:s(()=>{var l;return[([a(d).MSSQL,a(d).PG].includes(a(e).dataSource.client)||[a(d).MSSQL,a(d).PG].includes((l=a(h))==null?void 0:l.sub_type))&&a(e).dataSource.searchPath?(f(),v(r,w({key:0,label:o.$t("labels.schemaName")},a(y)["dataSource.searchPath.0"]),{default:s(()=>[n(i,{value:a(e).dataSource.searchPath[0],"onUpdate:value":t[6]||(t[6]=ne=>a(e).dataSource.searchPath[0]=ne),placeholder:a(V)&&`${a(V)} (default)`},null,8,["value","placeholder"])]),_:1},16,["label"])):D("",!0)]}),_:1})]),_:1}))])]),c("div",Na,[t[14]||(t[14]=c("div",{class:"nc-form-section-title"},"Permissions",-1)),c("div",Ua,[n($e,{allowMetaWrite:a(O),"onUpdate:allowMetaWrite":t[7]||(t[7]=l=>q(O)?O.value=l:null),allowDataWrite:a(R),"onUpdate:allowDataWrite":t[8]||(t[8]=l=>q(R)?R.value=l:null)},null,8,["allowMetaWrite","allowDataWrite"])])]),[a(d).SQLITE,a(d).SNOWFLAKE,a(d).DATABRICKS].includes(a(e).dataSource.client)?D("",!0):(f(),v(Ue,{key:0,"active-key":a(C),"onUpdate:activeKey":t[12]||(t[12]=l=>q(C)?C.value=l:null),ghost:"",class:"nc-source-advanced-options !mt-4"},{expandIcon:s(({isActive:l})=>[n(G,{type:"text",size:"small",class:"!-ml-1.5",onClick:t[9]||(t[9]=ne=>Ie(!a(C).length))},{default:s(()=>[t[15]||(t[15]=c("div",{class:"nc-form-section-title"},"Advanced options",-1)),n(M,{icon:"chevronDown",class:se(["ml-2 flex-none cursor-pointer transform transition-transform duration-500",{"!rotate-180":l}])},null,8,["class"])]),_:2},1024)]),default:s(()=>[n(Ne,{key:"1",collapsible:"disabled"},{header:s(()=>t[16]||(t[16]=[c("span",null,null,-1)])),default:s(()=>[c("div",Da,[c("div",Ea,[n(u,{gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,{label:o.$t("labels.inflection.tableName")},{default:s(()=>[n(z,{value:a(e).inflection.inflectionTable,"onUpdate:value":t[10]||(t[10]=l=>a(e).inflection.inflectionTable=l),class:"nc-select-shadow","dropdown-class-name":"nc-dropdown-inflection-table-name"},{default:s(()=>[(f(),U(A,null,K(ae,l=>n($,{key:l,value:l},{default:s(()=>[P(g(l),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"])]),_:1}),n(m,{span:12},{default:s(()=>[n(r,{label:o.$t("labels.inflection.columnName")},{default:s(()=>[n(z,{value:a(e).inflection.inflectionColumn,"onUpdate:value":t[11]||(t[11]=l=>a(e).inflection.inflectionColumn=l),class:"nc-select-shadow","dropdown-class-name":"nc-dropdown-inflection-column-name"},{default:s(()=>[(f(),U(A,null,K(ae,l=>n($,{key:l,value:l},{default:s(()=>[P(g(l),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["active-key"])),t[17]||(t[17]=c("div",null,null,-1))]),_:1},8,["model"])]),n(Le,{"model-value":a(I),inline:"",transition:"",class:"!bg-opacity-15"},{default:s(()=>[c("div",La,[n(Ee,{size:"large"})])]),_:1},8,["model-value"])]),c("div",Ma,[n(Me),n(Ae)])]),c("div",Aa,[c("div",Ba,[c("div",Fa,[n(M,{icon:"alertTriangle",class:"flex-none"}),c("div",null,g(o.$t("msg.warning.dbValid")),1)])]),c("div",Qa,[c("div",{class:"w-[15px] h-[15px] cursor-pointer",onDblclick:ye},null,32),n(p,{disabled:!a(T)},{title:s(()=>[P(g(a(T)),1)]),default:s(()=>[n(G,{type:"secondary",size:"small",class:se(["nc-extdb-btn-test-connection",{"pointer-events-none":a(b)}]),loading:a(Q),disabled:a(I),"icon-position":"right",onClick:t[13]||(t[13]=l=>Pe())},{icon:s(()=>[a(b)?(f(),v(M,{key:0,icon:"circleCheckSolid",class:"!text-green-700 w-4 h-4"})):a(T)?(f(),v(M,{key:1,icon:"alertTriangleSolid",class:"!text-red-700 w-4 h-4"})):D("",!0)]),default:s(()=>[c("span",null,g(a(b)?"Test successful":"Test connection"),1)]),_:1},8,["class","loading","disabled"])]),_:1},8,["disabled"]),n(G,{size:"small",type:"primary",disabled:!a(b)||a(I),loading:a(ge),class:"nc-extdb-btn-submit",onClick:Ce},{default:s(()=>[P(g(o.$t("general.submit")),1)]),_:1},8,["disabled","loading"])])])])}}}),ao=ca(Wa,[["__scopeId","data-v-e43c09de"]]);export{ao as default};
