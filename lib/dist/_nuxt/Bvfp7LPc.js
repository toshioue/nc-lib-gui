import{ag as Te,cW as Ee,cX as Ne,ax as Re,cL as je,cO as _e,bL as Le,hJ as Ue,f as ae,g$ as ee,ah as N,ai as X,i8 as Je,i9 as Ke,c$ as L,ga as Pe,y as $e,cP as qe,g_ as Qe,ap as Ge,u as He,L as Xe,r as k,dz as We,gO as Ye,J as Ze,cp as be,d4 as Ve,dc as ze,ia as me}from"./DZZ6t_j4.js";import{a as ke}from"./B05h-4V9.js";import{f as eo,p as xe,e as Y,r as E,h as re,i as oo,j as Oe}from"./BDAIZopQ.js";import{b as to,c as no,d as io}from"./ByVBARmO.js";function ro(ve){const{meta:o,viewMeta:C,formattedData:R,paginationData:f,callbacks:e}=ve,{t:M}=Te(),{getMeta:oe,metas:ge}=Ee(),{addUndo:te,clone:U,defineViewScope:ne}=Ne(),{base:$}=Re(je()),{$api:q}=$e(),{isPaginationLoading:V}=Re(_e()),j=Le(Ue),Se=ae({get(){return!!R.value.length&&R.value.every(t=>t.rowMeta.selected)},set(t){R.value.forEach(n=>n.rowMeta.selected=t)}});function se(t=R.value.length,n=o.value){return R.value.splice(t,0,{row:{...eo(n==null?void 0:n.columns)},oldRow:{},rowMeta:{new:!0}}),R.value[t]}async function ue(t,n={},{metaValue:r=o.value,viewMetaValue:d=C.value}={},i=!1){var D,P;const c=t.row;t.rowMeta&&(t.rowMeta.saving=!0);try{const{missingRequiredColumns:S,insertObj:a}=await xe({meta:r,ltarState:n,getMeta:oe,row:c,undo:i});if(S.size)return;const I=await q.dbViewRow.create(ee,$==null?void 0:$.value.id,r==null?void 0:r.id,d==null?void 0:d.id,{...a,...n||{}});if(await(j==null?void 0:j.trigger()),!i){Object.assign(t,{row:{...I,...c},rowMeta:{...t.rowMeta||{},new:void 0},oldRow:{...I}});const l=Y(I,r==null?void 0:r.columns),u=E(I,r==null?void 0:r.columns),w=re(u,R.value);te({redo:{fn:async function(s,y,g){var z,_;s.row={...u,...s.row};const m=await ue(s,y,void 0,!0);w!==-1&&g.pageSize===f.value.pageSize?g.page===f.value.page?R.value.splice(w,0,{row:{...s,...m},rowMeta:s.rowMeta,oldRow:s.oldRow}):await((z=e==null?void 0:e.changePage)==null?void 0:z.call(e,g.page)):await((_=e==null?void 0:e.loadData)==null?void 0:_.call(e))},args:[U(t),U(n),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(s){await W(s),w!==-1&&R.value.splice(w,1),f.value.totalRows=f.value.totalRows-1},args:[l]},scope:ne({view:C.value})})}return await((D=e==null?void 0:e.syncCount)==null?void 0:D.call(e)),I}catch(S){N.error(await X(S))}finally{t.rowMeta&&(t.rowMeta.saving=!1),await((P=e==null?void 0:e.globalCallback)==null?void 0:P.call(e))}}async function de(t,{metaValue:n=o.value,viewMetaValue:r=C.value}={},d=!1){var c,D,P;V.value=!0;const i=U((n==null?void 0:n.columns)||[]).filter(S=>!S.pk&&(Je(S)||Ke(S))).map(S=>S.title);try{const S=((c=await Promise.all(t.map(async I=>{const{missingRequiredColumns:l,insertObj:u}=await xe({meta:n,ltarState:{},getMeta:oe,row:I.row,undo:d});if(l.size===0)return i.forEach(w=>delete u[w]),u})))==null?void 0:c.filter(Boolean))??[],a=await q.dbDataTableRow.create(n==null?void 0:n.id,S,{viewId:r==null?void 0:r.id});return await((D=e==null?void 0:e.syncCount)==null?void 0:D.call(e)),a}catch(S){N.error(await X(S))}finally{await((P=e==null?void 0:e.globalCallback)==null?void 0:P.call(e)),V.value=!1}}async function we(t,n,{metaValue:r=o.value,viewMetaValue:d=C.value}={},i=!1){var c;t.rowMeta&&(t.rowMeta.saving=!0);try{const D=Y(t.row,r==null?void 0:r.columns),P=await q.dbViewRow.update(ee,$==null?void 0:$.value.id,r==null?void 0:r.id,d==null?void 0:d.id,encodeURIComponent(D),{[n]:t.row[n]??null});return await(j==null?void 0:j.trigger({fields:[{title:n}]})),i||(te({redo:{fn:async function(a,I,l){var w,v,s;const u=await we(a,I,void 0,!0);if(l.page===f.value.page&&l.pageSize===f.value.pageSize){const y=re(E(a.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),R.value);if(y!==-1){const g=R.value[y];Object.assign(g.row,u),Object.assign(g.oldRow,u)}else await((v=e==null?void 0:e.loadData)==null?void 0:v.call(e))}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,l.page))},args:[U(t),n,{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(a,I,l){var w,v,s;const u=await we({row:a.oldRow,oldRow:a.row,rowMeta:a.rowMeta},I,void 0,!0);if(l.page===f.value.page&&l.pageSize===f.value.pageSize){const y=re(E(a.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),R.value);if(y!==-1){const g=R.value[y];Object.assign(g.row,u),Object.assign(g.oldRow,u)}else await((v=e==null?void 0:e.loadData)==null?void 0:v.call(e))}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,l.page))},args:[U(t),n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:C.value})}),Object.assign(t.row,r.columns.reduce((S,a)=>(a.title in P&&(a.uidt===L.Formula||a.uidt===L.QrCode||a.uidt===L.Barcode||a.uidt===L.Rollup||a.uidt===L.Checkbox||a.uidt===L.User||a.uidt===L.LastModifiedTime||a.uidt===L.LastModifiedBy||a.uidt===L.Lookup||a.uidt===L.Button||a.uidt===L.Attachment||a.au||oo(a==null?void 0:a.cdf)&&/ on update /i.test(a.cdf))&&(S[a.title]=P[a.title]),S),{})),Object.assign(t.oldRow,P)),await((c=e==null?void 0:e.globalCallback)==null?void 0:c.call(e)),P}catch(D){t.row[n]=t.oldRow[n],N.error(`${M("msg.error.rowUpdateFailed")}: ${await X(D)}`)}finally{t.rowMeta&&(t.rowMeta.saving=!1)}}async function ce(t,n,r,d={}){if(t.rowMeta&&(t.rowMeta.changed=!1),await Pe(()=>{var i,c;return!((i=t.rowMeta)!=null&&i.new&&((c=t.rowMeta)!=null&&c.saving))}).toMatch(i=>i),t.rowMeta.new)return await ue(t,r,d);n&&await we(t,n,d)}async function pe(t,n,{metaValue:r=o.value,viewMetaValue:d=C.value}={},i=!1){var P,S;const c=[];for(const a of t)a.rowMeta&&(a.rowMeta.changed=!1),c.push(Pe(()=>{var I,l;return!((I=a.rowMeta)!=null&&I.new&&((l=a.rowMeta)!=null&&l.saving))}).toMatch(I=>I));await Promise.all(c);const D=[];for(const a of t){a.rowMeta&&(a.rowMeta.saving=!0);const I=E(a.row,r==null?void 0:r.columns),l=n.reduce((u,w)=>(u[w]=a.row[w],u),{});D.push({...l,...I})}await q.dbTableRow.bulkUpdate(ee,r==null?void 0:r.base_id,r==null?void 0:r.id,D),await(j==null?void 0:j.trigger({fields:n.map(a=>({title:a}))})),i||te({redo:{fn:async function(I,l,u){var w,v,s;if(await pe(I,l,{metaValue:r,viewMetaValue:d},!0),u.page===f.value.page&&u.pageSize===f.value.pageSize)for(const y of I){const g=re(E(y.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),R.value);if(g!==-1){const m=R.value[g];Object.assign(m.row,y.row),Object.assign(m.oldRow,y.row)}else{await((v=e==null?void 0:e.loadData)==null?void 0:v.call(e));break}}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,u.page))},args:[U(t),U(n),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(I,l,u){var w,v,s;if(await pe(I,l,{metaValue:r,viewMetaValue:d},!0),u.page===f.value.page&&u.pageSize===f.value.pageSize)for(const y of I){const g=re(E(y.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),R.value);if(g!==-1){const m=R.value[g];Object.assign(m.row,y.row),Object.assign(m.oldRow,y.row)}else{await((v=e==null?void 0:e.loadData)==null?void 0:v.call(e));break}}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,u.page))},args:[U(t.map(a=>({row:a.oldRow,oldRow:a.row,rowMeta:a.rowMeta}))),n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:d})});for(const a of t)a.rowMeta&&(a.rowMeta.saving=!1);r.columns.some(a=>[L.QrCode,L.LastModifiedTime,L.Barcode,L.Formula,L.Lookup,L.Rollup,L.LinkToAnotherRecord,L.LastModifiedBy].includes(a.uidt))&&await((P=e==null?void 0:e.loadData)==null?void 0:P.call(e)),await((S=e==null?void 0:e.globalCallback)==null?void 0:S.call(e))}async function G(t,{metaValue:n=o.value,viewMetaValue:r=C.value}={}){var d,i;r&&(await q.dbTableRow.bulkUpdateAll(ee,n==null?void 0:n.base_id,n==null?void 0:n.id,t,{viewId:r.id}),await(j==null?void 0:j.trigger()),await((d=e==null?void 0:e.loadData)==null?void 0:d.call(e)),await((i=e==null?void 0:e.globalCallback)==null?void 0:i.call(e)))}const le=async(t,n,r,d,{metaValue:i=o.value}={})=>{try{await q.dbTableRow.nestedAdd(ee,$.value.id,i==null?void 0:i.id,encodeURIComponent(t),d,r.title,encodeURIComponent(n))}catch(c){N.error(await X(c))}},Z=async(t,{metaValue:n=o.value}={})=>{var d;const r=Y(t,n==null?void 0:n.columns);for(const i of(n==null?void 0:n.columns)??[]){if(i.uidt!==L.LinkToAnotherRecord)continue;const c=i.colOptions,D=(d=ge.value)==null?void 0:d[c==null?void 0:c.fk_related_model_id];if(to(i)||no(i)){const P=t[i.title]??[];for(const S of P)await le(r,Y(S,D.columns),i,c.type,{metaValue:n})}else io(i)&&t[i.title]&&await le(r,Y(t[i.title],D.columns),i,c.type,{metaValue:n})}};async function W(t,{metaValue:n=o.value,viewMetaValue:r=C.value}={}){if(!t)throw new Error("Delete not allowed for table which doesn't have primary Key");const d=await q.dbViewRow.delete("noco",$.value.id,n==null?void 0:n.id,r==null?void 0:r.id,encodeURIComponent(t));return await(j==null?void 0:j.trigger()),d.message?(N.info(`Record delete failed: ${`Unable to delete record with ID ${t} because of the following:
              
${d.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}async function De(t,n){var r,d,i,c;try{const D=R.value[t];if(!D.rowMeta.new){const P=Y(D.row,(r=o==null?void 0:o.value)==null?void 0:r.columns),S=await q.dbTableRow.read(ee,$==null?void 0:$.value.id,(d=o.value)==null?void 0:d.id,encodeURIComponent(P),{getHiddenColumn:!0});if(D.row=S,!await W(P))return;n||te({redo:{fn:async function(l){var v;await W(l);const u=E(D.row,(v=o==null?void 0:o.value)==null?void 0:v.columns),w=re(u,R.value);w!==-1&&R.value.splice(w,1),f.value.totalRows=f.value.totalRows-1},args:[P]},undo:{fn:async function(l,u,w){var s,y,g;const v=E(l.row,(s=o.value)==null?void 0:s.columns);l.row={...v,...l.row},await ue(l,u,{},!0),Z(l.row),t!==-1&&w.pageSize===f.value.pageSize?w.page===f.value.page?R.value.splice(t,0,l):await((y=e==null?void 0:e.changePage)==null?void 0:y.call(e,w.page)):await((g=e==null?void 0:e.loadData)==null?void 0:g.call(e))},args:[U(D),{},{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:C.value})})}R.value.splice(t,1),await((i=e==null?void 0:e.syncCount)==null?void 0:i.call(e))}catch(D){N.error(`${M("msg.error.deleteRowFailed")}: ${await X(D)}`)}await((c=e==null?void 0:e.globalCallback)==null?void 0:c.call(e))}async function he(){var i,c,D,P,S,a,I,l;let t=R.value.length;const n=[];let r="";for(;t--;){const{row:u,rowMeta:w}=R.value[t];if(w.selected&&!w.new){const v=Oe((i=o==null?void 0:o.value)==null?void 0:i.columns),s=Y(u,(c=o==null?void 0:o.value)==null?void 0:c.columns),y=E(u,(D=o==null?void 0:o.value)==null?void 0:D.columns);v&&s&&(r||(r=v),n.push({[r]:s,pkData:y,row:U(R.value[t]),rowIndex:t}))}}if(!n.length)return;V.value=!0;const{list:d}=await q.dbTableRow.list(ee,$==null?void 0:$.value.id,(P=o.value)==null?void 0:P.id,{pks:n.map(u=>u[r]).join(",")});try{for(const u of n){const w=u.row,v=E(w.row,(S=o==null?void 0:o.value)==null?void 0:S.columns),s=d.find(y=>Object.keys(v).every(g=>v[g]===y[g]));w.row=U(s)}await b(n.map(u=>u.pkData))}catch(u){return N.error(`${M("msg.error.deleteRowFailed")}: ${await X(u)}`)}if(!n.length){V.value=!1;return}te({redo:{fn:async function(w){var s,y,g,m;V.value=!0;const v=await b(w.map(z=>z.pkData));if(Array.isArray(v))for(const{row:z}of w){const _=E(z.row,(s=o==null?void 0:o.value)==null?void 0:s.columns),H=re(_,R.value);H!==-1&&R.value.splice(H,1),f.value.totalRows=f.value.totalRows-1}await((y=e==null?void 0:e.syncCount)==null?void 0:y.call(e)),await((g=e==null?void 0:e.syncPagination)==null?void 0:g.call(e)),await((m=e==null?void 0:e.globalCallback)==null?void 0:m.call(e))},args:[n]},undo:{fn:async function(w,v){var g,m;const s=w.map(z=>{var H;const _=E(z.row,(H=o.value)==null?void 0:H.columns);return z.row={..._,...z.row},z}).reverse(),y=await de(s.map(z=>z.row),void 0,!0);if(Array.isArray(y))for(const{row:z,rowIndex:_}of s)Z(z.row),_!==-1&&v.pageSize===f.value.pageSize?v.page===f.value.page?R.value.splice(_,0,z):await((g=e==null?void 0:e.changePage)==null?void 0:g.call(e,v.page)):await((m=e==null?void 0:e.loadData)==null?void 0:m.call(e))},args:[n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:C.value})}),await((a=e==null?void 0:e.syncCount)==null?void 0:a.call(e)),await((I=e==null?void 0:e.syncPagination)==null?void 0:I.call(e)),await((l=e==null?void 0:e.globalCallback)==null?void 0:l.call(e))}async function ye(t){var P,S,a,I,l,u,w,v;if(!t._start||!t._end)return;const n=Math.max(t._start.row,t._end.row),r=Math.min(t._start.row,t._end.row);let d=n+1;const i=[];let c="";for(;d--;){try{const{row:s,rowMeta:y}=R.value[d];if(!y.new){const g=Oe((P=o==null?void 0:o.value)==null?void 0:P.columns),m=Y(s,(S=o==null?void 0:o.value)==null?void 0:S.columns),z=E(s,(a=o==null?void 0:o.value)==null?void 0:a.columns);g&&m&&(c||(c=g),i.push({[c]:m,pkData:z,row:U(R.value[d]),rowIndex:d}))}}catch(s){return N.error(`${M("msg.error.deleteRowFailed")}: ${await X(s)}`)}if(d===r)break}if(!i.length)return;V.value=!0;const{list:D}=await q.dbTableRow.list(ee,$==null?void 0:$.value.id,(I=o.value)==null?void 0:I.id,{pks:i.map(s=>s[c]).join(",")});try{for(const s of i){const y=s.row,g=E(y.row,(l=o==null?void 0:o.value)==null?void 0:l.columns),m=D.find(z=>Object.keys(g).every(_=>g[_]===z[_]));y.row=U(m)}await b(i.map(s=>s.pkData))}catch(s){return N.error(`${M("msg.error.deleteRowFailed")}: ${await X(s)}`)}if(!i.length){V.value=!1;return}te({redo:{fn:async function(y){var m,z,_,H;V.value=!0;const g=await b(y.map(J=>J.pkData));if(Array.isArray(g))for(const{row:J}of y){const ie=E(J.row,(m=o==null?void 0:o.value)==null?void 0:m.columns),fe=re(ie,R.value);fe!==-1&&R.value.splice(fe,1),f.value.totalRows=f.value.totalRows-1}await((z=e==null?void 0:e.syncCount)==null?void 0:z.call(e)),await((_=e==null?void 0:e.syncPagination)==null?void 0:_.call(e)),await((H=e==null?void 0:e.globalCallback)==null?void 0:H.call(e))},args:[i]},undo:{fn:async function(y,g){var _,H;const m=y.map(J=>{var fe;const ie=E(J.row,(fe=o.value)==null?void 0:fe.columns);return J.row={...ie,...J.row},J}).reverse(),z=await de(m.map(J=>J.row),void 0,!0);if(Array.isArray(z))for(const{row:J,rowIndex:ie}of m)Z(J.row),ie!==-1&&g.pageSize===f.value.pageSize?g.page===f.value.page?R.value.splice(ie,0,J):await((_=e==null?void 0:e.changePage)==null?void 0:_.call(e,g.page)):await((H=e==null?void 0:e.loadData)==null?void 0:H.call(e))},args:[i,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:C.value})}),await((u=e==null?void 0:e.syncCount)==null?void 0:u.call(e)),await((w=e==null?void 0:e.syncPagination)==null?void 0:w.call(e)),await((v=e==null?void 0:e.globalCallback)==null?void 0:v.call(e))}async function b(t,{metaValue:n=o.value,viewMetaValue:r=C.value}={}){try{const d=await q.dbDataTableRow.delete(n==null?void 0:n.id,t.length===1?t[0]:t,{viewId:r==null?void 0:r.id});return await(j==null?void 0:j.trigger()),t.length===1&&d?[d]:d}catch(d){N.error(await X(d))}}return{insertRow:ue,updateRowProperty:we,addEmptyRow:se,deleteRow:De,deleteRowById:W,deleteSelectedRows:he,deleteRangeOfRows:ye,updateOrSaveRow:ce,bulkUpdateRows:pe,bulkUpdateView:G,selectedAllRecords:Se,removeRowIfNew:t=>{const n=R.value.indexOf(t);return n>-1&&t.rowMeta.new?(R.value.splice(n,1),!0):!1},bulkDeleteRows:b,bulkInsertRows:de}}const ao=ve=>ve.map(o=>({row:{...o},oldRow:{...o},rowMeta:{}}));function go(ve,o,C){const R=qe(),{activeTableId:f,activeTable:e}=Re(R),M=ae(()=>ve.value||e.value),oe=ae(()=>{var p;return((p=ve.value)==null?void 0:p.id)||f.value}),{t:ge}=Te(),te=Qe("optimisedQuery",()=>!0),{api:U,isLoading:ne,error:$}=Ge(),q=He(),V=q.currentRoute,{appInfo:j,gridViewPageSize:Se}=Xe(),se=Se.value||j.value.defaultLimit||25,ue=k({page:1,pageSize:se}),de=k([]),we=k(),ce=k(),pe=k(),G=k([]),le=k(!1),Z=Le(We,k(!1)),{base:W}=Re(je()),{sharedView:De,fetchSharedViewData:he,paginationData:ye}=Ye(),{$api:b}=$e(),{sorts:Ce,nestedFilters:t}=ke(),{isUIAllowed:n}=Ze(),r=ae(()=>V.value.query),{isPaginationLoading:d}=Re(_e()),i=ae({get:()=>Z.value?ye.value:ue.value,set:p=>{Z.value?ye.value=p:ue.value=p}}),c=ae(()=>{var h;const p=Ie();return((h=i.value)==null?void 0:h.isLastPage)&&p===G.value.length-1}),D=ae(()=>{var h;const p=Ie();return((h=i.value)==null?void 0:h.isFirstPage)&&p===0}),P=ae(()=>({offset:((i.value.page??0)-1)*(i.value.pageSize??se),limit:i.value.pageSize??se,where:(C==null?void 0:C.value)??""}));async function S(){var h,O;const{count:p}=await b.dbViewRow.count(ee,(h=W==null?void 0:W.value)==null?void 0:h.id,oe.value,(O=o==null?void 0:o.value)==null?void 0:O.id);i.value.totalRows=p}async function a(){var K;const p=((K=i.value)==null?void 0:K.totalRows)??1/0,h=i.value.pageSize??se,O=i.value.page??1,F=Math.ceil(p/h),Q=Math.max(1,Math.min(F,O));O>Q?v==null||v(Q):await u({offset:(Q-1)*h,where:C==null?void 0:C.value})}async function I(){var h,O,F,Q,K;if(!n("commentCount")||Z.value)return;const p=(O=(h=G.value)==null?void 0:h.filter(({rowMeta:{new:T}})=>!T))==null?void 0:O.map(({row:T})=>{var x;return Y(T,(x=M==null?void 0:M.value)==null?void 0:x.columns)});if(!(!(p!=null&&p.length)||p!=null&&p.some(T=>!T)))try{de.value=await b.utils.commentCount({ids:p,fk_model_id:oe.value});for(const T of G.value){const x=Y(T.row,(F=M.value)==null?void 0:F.columns);T.rowMeta.commentCount=+(((K=(Q=de.value)==null?void 0:Q.find(A=>A.row_id===x))==null?void 0:K.count)||0)}}catch(T){console.error(T)}}const l=k();async function u(p={},h=!0){var Q,K,T,x,A;if((!((Q=W==null?void 0:W.value)!=null&&Q.id)||!oe.value||!((K=o.value)!=null&&K.id))&&!Z.value)return;l.value&&l.value.cancel();const O=be.CancelToken;l.value=O.source(),h&&(d.value=!0);let F;try{F=Z.value?await he({sortsArr:Ce.value,filtersArr:t.value,where:C==null?void 0:C.value}):await U.dbViewRow.list("noco",W.value.id,oe.value,o.value.id,{...P.value,...p,...n("sortSync")?{}:{sortArrJson:JSON.stringify(Ce.value)},...n("filterSync")?{}:{filterArrJson:JSON.stringify(t.value)},where:C==null?void 0:C.value,...le.value?{excludeCount:"true"}:{}},{cancelToken:l.value.token})}catch(B){return B.code==="ERR_CANCELED"?void 0:((x=(T=B==null?void 0:B.response)==null?void 0:T.data)==null?void 0:x.error)==="FORMULA_ERROR"?(N.error(await X(B)),await R.reloadTableMeta(oe.value),u(p,h)):(console.error(B),N.error(await X(B)))}if(G.value=ao(F.list),i.value=F.pageInfo||i.value||{},Z.value&&(ye.value=i.value),le.value=!F.pageInfo,d.value=!1,i.value.totalRows!==void 0&&i.value.totalRows!==null){const B=Math.max(1,Math.ceil(i.value.totalRows/i.value.pageSize));B<i.value.page&&await v(B)}((A=o.value)==null?void 0:A.type)===Ve.GRID&&I()}async function w(){var p,h;(p=o==null?void 0:o.value)!=null&&p.id&&(we.value=Z.value?(h=De.value)==null?void 0:h.view:await b.dbView.galleryRead(o.value.id))}async function v(p){i.value.page=p,await u({offset:(p-1)*(i.value.pageSize||se),where:C==null?void 0:C.value},!0)}const{insertRow:s,updateRowProperty:y,addEmptyRow:g,deleteRow:m,deleteRowById:z,deleteSelectedRows:_,deleteRangeOfRows:H,updateOrSaveRow:J,bulkUpdateRows:ie,bulkUpdateView:fe,selectedAllRecords:Fe,removeRowIfNew:Ae}=ro({meta:M,viewMeta:o,formattedData:G,paginationData:i,callbacks:{changePage:v,loadData:u,syncCount:S,syncPagination:a}});async function Me(){var p,h,O;if((p=o==null?void 0:o.value)!=null&&p.id)try{const{columns:F,...Q}=await b.dbView.formRead(o.value.id);let K=1;const T=(F||[]).reduce((x,A)=>(K<A.order&&(K=A.order),{...x,[A.fk_column_id]:A}),{});pe.value=Q,ce.value=(O=(h=M==null?void 0:M.value)==null?void 0:h.columns)==null?void 0:O.map(x=>{var A,B;return{...x,fk_column_id:x.id,fk_view_id:(A=o.value)==null?void 0:A.id,...T[x.id]?T[x.id]:{},meta:{validators:[],visibility:{errors:{}},...ze((B=T[x.id])==null?void 0:B.meta),...ze(x.meta)},order:T[x.id]&&T[x.id].order||K++,id:T[x.id]&&T[x.id].id,visible:!0}}).sort((x,A)=>x.order-A.order)}catch(F){return N.error(`${ge("msg.error.setFormDataFailed")}: ${await X(F)}`)}}async function Be(p){var h;try{if(!((h=o==null?void 0:o.value)!=null&&h.id)||!p)return;await b.dbView.formUpdate(o.value.id,p)}catch(O){return N.error(`${ge("msg.error.formViewUpdateFailed")}: ${await X(O)}`)}}function Ie(){return G.value.findIndex(p=>{var h;return r.value.rowId===Y(p.row,(h=M.value)==null?void 0:h.columns)})}return{error:$,isLoading:ne,loadData:u,paginationData:i,queryParams:P,formattedData:G,insertRow:s,updateRowProperty:y,changePage:v,addEmptyRow:g,deleteRow:m,deleteRowById:z,deleteSelectedRows:_,deleteRangeOfRows:H,updateOrSaveRow:J,bulkUpdateRows:ie,bulkUpdateView:fe,selectedAllRecords:Fe,syncCount:S,syncPagination:a,galleryData:we,loadGalleryData:w,loadFormView:Me,formColumnData:ce,formViewData:pe,updateFormView:Be,aggCommentCount:de,loadAggCommentsCount:I,removeRowIfNew:Ae,navigateToSiblingRow:async p=>{var K,T,x,A,B;let O=Ie()+(p===me.NEXT?1:-1);for(;(T=(K=G.value[O])==null?void 0:K.rowMeta)!=null&&T.new;)O=O+(p===me.NEXT?1:-1);const F=((x=i==null?void 0:i.value)==null?void 0:x.page)||1;if(O<0){if(F===1)return N.info(ge("msg.info.noMoreRecords"));await v(F-1),O=G.value.length-1}else if(O>=G.value.length){if((A=i==null?void 0:i.value)!=null&&A.isLastPage)return N.info(ge("msg.info.noMoreRecords"));await v(F+1),O=0}const Q=Y(G.value[O].row,(B=M.value)==null?void 0:B.columns);Q&&await q.push({query:{...r.value,rowId:Q}})},getExpandedRowIndex:Ie,optimisedQuery:te,islastRow:c,isFirstRow:D}}export{go as a,ro as u};
