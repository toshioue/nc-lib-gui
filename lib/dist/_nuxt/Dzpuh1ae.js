import{u as Ie}from"./GMLocJHP.js";import{cW as Se,ax as Ce,cL as be,bL as W,r as v,d6 as Pe,aD as Ve,cX as _e,gU as qe,ar as le,ag as Ue,dz as Fe,f as g,gO as Ae,c$ as se,dc as ge,cr as Ne,cs as we,iv as ze,F as ie,u as je,g$ as A,g3 as $,gx as Be,gy as Ge,ah as N,ai as X,ca as Je,y as xe}from"./DZZ6t_j4.js";import{e as Le}from"./BDAIZopQ.js";import{a as Ke}from"./bNr_om_C.js";const[Me,We]=Ie((s,y,_,w=z=>{})=>{var fe,ce,pe;const{metas:z,getMeta:Oe}=Se(),{base:q}=Ce(be()),{$api:L,$e:H}=xe(),ue=W(Pe,v()),me=W(Ve,v(!1)),{addUndo:re,clone:G,defineViewScope:oe}=_e(),ne=W(qe,v(null)),O=v(),k=v(),n=le({page:1,query:"",size:10}),m=v(0),c=le({page:1,query:"",size:10}),E=v(0),Q=v(!1),I=v([]),j=v([]),U=v([]),Y=v(!1),S=v([]),ve=le({state:null}),C=v(0),{t:J}=Ue(),de=W(Fe,v(!1)),f=g(()=>{var a;return(a=s.value)==null?void 0:a.colOptions}),{sharedView:Z}=Ae(),D=((fe=q.value)==null?void 0:fe.id)||((pe=(ce=Z.value)==null?void 0:ce.view)==null?void 0:pe.base_id),b=g(()=>{var a,e;return(e=z==null?void 0:z.value)==null?void 0:e[(a=s==null?void 0:s.value)==null?void 0:a.fk_model_id]}),r=g(()=>{var a,e;return(e=z.value)==null?void 0:e[(a=f.value)==null?void 0:a.fk_related_model_id]}),P=g(()=>Le(y.value.row,b.value.columns)),x=a=>{var e;return Le(a,(e=r.value)==null?void 0:e.columns)},Ee=async()=>{await Oe(f.value.fk_related_model_id)},V=g(()=>{var a,e,l,t,i;return((i=((e=(a=r.value)==null?void 0:a.columns)==null?void 0:e.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.title)||""}),Re=g(()=>{var a,e,l,t,i;return((i=((e=(a=r.value)==null?void 0:a.columns)==null?void 0:e.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.id)||""}),Te=g(()=>{var a,e,l;return((l=(e=(a=r.value)==null?void 0:a.columns)==null?void 0:e.filter(t=>t.pk))==null?void 0:l.map(t=>t.title))??[]}),K=g(()=>{var a,e,l,t,i;return(i=((e=(a=b.value)==null?void 0:a.columns)==null?void 0:e.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.title}),B=g(()=>{var l,t,i,u,d,R;let a={type:"",format:""};const e=((t=(l=r.value)==null?void 0:l.columns)==null?void 0:t.find(o=>o.pv))||((u=(i=r==null?void 0:r.value)==null?void 0:i.columns)==null?void 0:u[0]);return e&&((e==null?void 0:e.uidt)===se.DateTime&&(a={type:e==null?void 0:e.uidt,format:`${((d=ge(e==null?void 0:e.meta))==null?void 0:d.date_format)??Ne[0]} ${((R=ge(e==null?void 0:e.meta))==null?void 0:R.time_format)??we[0]}`}),(e==null?void 0:e.uidt)===se.Time&&(a={type:e==null?void 0:e.uidt,format:`${we[0]}`})),a}),$e=g(()=>y.value.row[K.value]&&B.value.type&&B.value.format?ze(y.value.row[K.value],B.value.format,B.value.format!==se.Time):y.value.row[K.value]),M=async(a,e=!1)=>{var l,t,i,u,d,R;a&&(ve.state=a);try{let o=n.size*(n.page-1)-m.value;if((o<0||e)&&(o=0,m.value=0,n.page=1),Y.value=!0,de.value){const p=je().currentRoute;let T;if(me.value){const{formState:F}=Ke();T=F==null?void 0:F.value}O.value=await L.public.dataRelationList(p.value.params.viewId,s.value.id,{},{headers:{"xc-password":ne.value},query:{limit:n.size,offset:o,where:n.query&&`(${V.value},like,${n.query})`,fields:[V.value,...Te.value],rowData:JSON.stringify(T)}})}else if(_!=null&&_.value)O.value=await L.dbTableRow.list(A,D,(l=r==null?void 0:r.value)==null?void 0:l.id,{limit:n.size,offset:o,where:n.query&&`(${V.value},like,${n.query})`,linkColumnId:s.value.fk_column_id||s.value.id,linkRowData:JSON.stringify(y.value.row)});else{let h;try{(t=y.value)!=null&&t.row&&(h=Object.keys((i=y.value)==null?void 0:i.row).reduce((p,T)=>(y.value.row[T]!==y.value.oldRow[T]&&(p[T]=y.value.row[T]),p),{}))}catch{}O.value=await L.dbTableRow.nestedChildrenExcludedList(A,D,b.value.id,encodeURIComponent(P.value),f.value.type,(u=s==null?void 0:s.value)==null?void 0:u.id,{limit:String(n.size),offset:String(o),where:n.query&&`(${V.value},like,${n.query})`,linkRowData:h?JSON.stringify(h):void 0})}(d=O.value)==null||d.list.forEach((h,p)=>{S.value[p]=!1,U.value[p]=!1}),(R=O.value)!=null&&R.list&&a&&a[s.value.title]&&O.value.list.forEach((h,p)=>{([$.BELONGS_TO,$.ONE_TO_ONE].includes(f.value.type)?[a[s.value.title]]:a[s.value.title]).find(F=>{let ye=!0;for(const he in F)F[he]!==h[he]&&(ye=!1);return ye})&&(S.value[p]=!0)})}catch(o){const h=await Be(o);if(h.error===Ge.INVALID_OFFSET_VALUE)return n.page=0,M(a,!0);N.error(`${J("msg.error.failedToLoadList")}: ${h.message}`)}finally{Y.value=!1}},ee=async(a=!1)=>{var e,l,t,i,u,d,R;try{if(Q.value=!0,[$.BELONGS_TO,$.ONE_TO_ONE].includes(f.value.type)||!P.value||!s.value)return;let o=c.size*(c.page-1)+E.value;o<0||a?(o=0,E.value=0,c.page=1):o>=C.value&&(o=0),de.value?k.value=await L.public.dataNestedList((e=Z.value)==null?void 0:e.uuid,encodeURIComponent(P.value),f.value.type,s.value.id,{limit:String(c.size),offset:String(o),where:c.query&&`(${V.value},like,${c.query})`},{headers:{"xc-password":ne.value}}):k.value=await L.dbTableRow.nestedList(A,((l=q==null?void 0:q.value)==null?void 0:l.id)||((i=(t=Z.value)==null?void 0:t.view)==null?void 0:i.base_id),b.value.id,encodeURIComponent(P.value),f.value.type,(u=s==null?void 0:s.value)==null?void 0:u.id,{limit:String(c.size),offset:String(o),where:c.query&&`(${V.value},like,${c.query})`}),(d=k.value)==null||d.list.forEach((h,p)=>{j.value[p]=!0,I.value[p]=!1}),c.query||(C.value=((R=k.value)==null?void 0:R.pageInfo.totalRows)??0)}catch(o){N.error(`${J("msg.error.failedToLoadChildrenList")}: ${await X(o)}`)}finally{Q.value=!1}},ke=async(a,e)=>{Je.confirm({title:"Do you want to delete the record?",type:"warning",onOk:async()=>{const l=x(a);try{const t=await L.dbTableRow.delete(A,D,r.value.id,encodeURIComponent(l));if(t.message)return N.info(`Record delete failed: ${`Unable to delete record with ID ${l} because of the following:
              
${t.message.join(`
`)}.

              Clear the data first & try again`})}`),!1;w==null||w({shouldShowLoading:!1}),_!=null&&_.value||await ee(),e==null||e(a),H("a:links:delete-related-row")}catch(t){N.error(`${J("msg.error.deleteFailed")}: ${await X(t)}`)}}})},ae=async(a,{metaValue:e=b.value}={},l=!1,t)=>{var i;try{E.value=E.value-1,m.value=m.value-1,U.value[t]=!0,I.value[t]=!0,await L.dbTableRow.nestedRemove(A,q.value.id,e.id,encodeURIComponent(P.value),f.value.type,(i=s==null?void 0:s.value)==null?void 0:i.id,encodeURIComponent(x(a))),l||re({redo:{fn:u=>ae(u,{},!0,t),args:[G(a)]},undo:{fn:u=>te(u,{},!0,t),args:[G(a)]},scope:oe({view:ue.value})}),S.value[t]=!1,j.value[t]=!1,f.value.type!==$.BELONGS_TO&&f.value.type!==$.ONE_TO_ONE&&(C.value=C.value-1)}catch(u){N.error(`${J("msg.error.unlinkFailed")}: ${await X(u)}`)}finally{U.value[t]=!1,I.value[t]=!1}w==null||w({shouldShowLoading:!1}),H("a:links:unlink")},te=async(a,{metaValue:e=b.value}={},l=!1,t)=>{var i,u;try{U.value[t]=!0,I.value[t]=!0,E.value=E.value+1,m.value=m.value+1,await L.dbTableRow.nestedAdd(A,q.value.id,e.id,encodeURIComponent(P.value),f.value.type,(i=s==null?void 0:s.value)==null?void 0:i.id,encodeURIComponent(x(a))),l||re({redo:{fn:d=>te(d,{},!0,t),args:[G(a)]},undo:{fn:d=>ae(d,{},!0,t),args:[G(a)]},scope:oe({view:ue.value})}),S.value[t]=!0,j.value[t]=!0,f.value.type!==$.BELONGS_TO&&f.value.type!==$.ONE_TO_ONE?C.value=C.value+1:(S.value=Array((u=O.value)==null?void 0:u.list.length).fill(!1),S.value[t]=!0)}catch(d){N.error(`Linking failed: ${await X(d)}`)}finally{U.value[t]=!1,I.value[t]=!1}w==null||w({shouldShowLoading:!1}),H("a:links:link")};return ie(n,async()=>{await M(ve.state)}),ie(c,async()=>{await ee()}),ie(k,async()=>{var a;(a=k.value)==null||a.list.forEach((e,l)=>{j.value[l]=!0,I.value[l]=!1})}),{relatedTableMeta:r,loadRelatedTableMeta:Ee,relatedTableDisplayValueProp:V,displayValueTypeAndFormatProp:B,childrenExcludedList:O,childrenList:k,childrenListCount:C,childrenListOffsetCount:E,childrenExcludedOffsetCount:m,rowId:P,childrenExcludedListPagination:n,childrenListPagination:c,displayValueProp:K,meta:b,unlink:ae,link:te,loadChildrenExcludedList:M,loadChildrenList:ee,isChildrenExcludedListLinked:S,isChildrenListLinked:j,isChildrenListLoading:I,isChildrenExcludedListLoading:U,row:y,isChildrenLoading:Q,isChildrenExcludedLoading:Y,deleteRelatedRow:ke,getRelatedTableRowId:x,headerDisplayValue:$e,relatedTableDisplayValuePropId:Re,resetChildrenExcludedOffsetCount:()=>{m.value=0},resetChildrenListOffsetCount:()=>{E.value=0}}},"ltar-store");function ea(){const s=We();if(s==null)throw new Error("Please call `useLTARStore` on the appropriate parent component");return s}export{ea as a,Me as u};
