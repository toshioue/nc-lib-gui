import Ue from"./hZgTYrdl.js";import Te from"./37hePIet.js";import{e as Ye,bL as D,r as N,d6 as ze,d7 as Ke,hG as Pe,gT as Qe,L as We,d8 as He,dz as Xe,f as Y,ij as Ze,ag as qe,cW as Je,cX as ea,hD as Ae,d4 as d,iC as pe,dc as ve,F as Ie,c$ as fe,M as aa,o as r,Q as f,w as c,a as w,W as E,N as s,c as A,t as x,b as g,O as q,ao as J,at as Ce,S as z,T as j,R as I,d as M,U as H,P as Le,y as sa,ah as ta,ai as la,m as oa,f$ as ia,Y as na,Z as ra,$ as da,aL as ca,_ as ua}from"./DZZ6t_j4.js";import{_ as ma}from"./sz1d3zjm.js";import{_ as pa}from"./BLgccLvp.js";import{_ as va}from"./vK-WmZ7a.js";import{_ as fa}from"./CJNscGy3.js";import{a as _a}from"./i4aLU0Nw.js";import{a as wa}from"./B05h-4V9.js";import{i as ga}from"./C4K5fdHe.js";import{u as ya}from"./BlrQG98t.js";import{_ as ba}from"./BVrX6sNU.js";import{D as xa}from"./Dg0-TbNo.js";import"./DKN1hQ6S.js";import{I as ka}from"./BQuyMdA-.js";import{S as ha,_ as Aa}from"./D_MsYLkT.js";import"./ByVBARmO.js";import"./CDWovrGB.js";import"./vll-Pnjv.js";import"./GMLocJHP.js";import"./t0mbNaqp.js";import"./B5RRVMt5.js";import"./DGj1ycqW.js";import"./BQQOEPN4.js";import"./DyDFI6NE.js";import"./BCJFTkwv.js";import"./CB1aB6F1.js";const Ia={class:"flex items-center gap-1"},Ca={class:"flex items-center gap-2"},La={key:2,class:"text-capitalize !text-[13px] font-medium"},Na={key:0,class:"bg-brand-50 text-brand-500 py-1 px-2 text-md rounded-md"},Ma={key:0,class:"flex items-center gap-2 px-2 mb-4 w-80"},$a={class:"pl-2 flex text-sm select-none text-gray-600"},Oa={class:"flex-1 nc-dropdown-cover-image-wrapper flex items-stretch border-1 border-gray-200 rounded-lg transition-all duration-0.3s max-w-[206px]"},Ra={class:"w-full flex gap-2 items-center justify-between max-w-[400px]"},Sa={class:"flex items-center px-2 border-l-1 border-gray-200 cursor-pointer"},Ea={class:"flex flex-col mt-2 pb-2 nc-scrollbar-thin max-h-[47vh] px-2"},Fa={class:"nc-fields-list"},Da={key:0,class:"px-2 py-6 text-gray-500 flex flex-col items-center gap-6 text-center"},ja=["data-testid"],Va=["onClick"],Ba={key:0,class:"flex mr-2"},Ga={key:1,class:"flex px-2 gap-2 py-2"},Ua=Ye({__name:"FieldsMenu",setup(Ta){const l=D(ze,N()),_e=D(Ke,N()),V=D(Pe,void 0),ee=D(Qe,void 0),{isMobileMode:Ne}=We(),Me=D(He,N(!1)),we=D(Xe,N(!1)),$e=D(Ze,Y(()=>!1)),{$api:K,$e:ge}=sa(),{t:ye}=qe(),{metas:be,getMeta:Oe}=Je(),{showSystemFields:X,fields:m,filteredFieldList:ae,numberOfHiddenFields:se,filterQuery:B,showAll:te,hideAll:le,saveOrUpdate:Re,metaColumnById:G,loadViewColumns:oe,toggleFieldStyles:ie,toggleFieldVisibility:Se,isLocalMode:Ee}=_a(),{eventBus:Fe,isDefaultView:De}=wa(),{addUndo:U,defineViewScope:T}=ea();Fe.on(e=>{(e===Ae.FIELD_RELOAD||e===Ae.MAPPED_BY_COLUMN_CHANGE)&&oe()});const je=Y(()=>{var a,o,n,u;if(((a=l.value)==null?void 0:a.type)!==d.GRID&&((o=l.value)==null?void 0:o.type)!==d.CALENDAR)return null;const e=(n=Object.values(G.value))==null?void 0:n.find(p=>p==null?void 0:p.pv);return(u=ae.value)==null?void 0:u.find(p=>p.fk_column_id===(e==null?void 0:e.id))}),ne=async(e,a=!1)=>{try{if(!m.value||(a||U({undo:{fn:()=>{if(!m.value)return;const o=m.value[e.moved.newIndex];m.value[e.moved.newIndex]=m.value[e.moved.oldIndex],m.value[e.moved.oldIndex]=o,ne({moved:{newIndex:e.moved.oldIndex,oldIndex:e.moved.newIndex}},!0)},args:[]},redo:{fn:()=>{if(!m.value)return;const o=m.value[e.moved.oldIndex];m.value[e.moved.oldIndex]=m.value[e.moved.newIndex],m.value[e.moved.newIndex]=o,ne(e,!0)},args:[]},scope:T({view:l.value})}),m.value.length<2))return;await Promise.all(m.value.map(async(o,n)=>{o.order!==n+1&&(o.order=n+1,await Re(o,n,!0,!!De.value))})),await oe(),ge("a:fields:reorder")}catch(o){ta.error(await la(o))}},P=N([]),re=async e=>{var a,o,n,u,p,k,i,y,C,_,L,b,O;(((a=l.value)==null?void 0:a.type)===d.GALLERY||((o=l.value)==null?void 0:o.type)===d.KANBAN||((n=l.value)==null?void 0:n.type)===d.CALENDAR)&&((u=l.value)!=null&&u.id)&&((p=l.value)!=null&&p.view)&&(((k=l.value)==null?void 0:k.type)===d.GALLERY?(await K.dbView.galleryUpdate((i=l.value)==null?void 0:i.id,{fk_cover_image_col_id:e}),l.value.view.fk_cover_image_col_id=e):((y=l.value)==null?void 0:y.type)===d.KANBAN?(await K.dbView.kanbanUpdate((C=l.value)==null?void 0:C.id,{fk_cover_image_col_id:e}),l.value.view.fk_cover_image_col_id=e):((_=l.value)==null?void 0:_.type)===d.CALENDAR&&(await K.dbView.calendarUpdate((L=l.value)==null?void 0:L.id,{fk_cover_image_col_id:e}),l.value.view.fk_cover_image_col_id=e),await(V==null?void 0:V.trigger()),e&&!((O=(b=m.value)==null?void 0:b.find(h=>h.fk_column_id===e))!=null&&O.show)&&await(ee==null?void 0:ee.trigger({shouldShowLoading:!1})))},$=Y({get:()=>{var a,o,n,u,p;const e=(((a=l.value)==null?void 0:a.type)===d.GALLERY||((o=l.value)==null?void 0:o.type)===d.KANBAN)&&((n=l.value)!=null&&n.view)?((u=l.value)==null?void 0:u.view).fk_cover_image_col_id:void 0;return(p=P.value)!=null&&p.find(k=>k.value===e)?e:e===null?null:void 0},set:async e=>{e!==$.value&&(U({undo:{fn:await re,args:[$.value]},redo:{fn:await re,args:[e]},scope:T({view:l.value})}),await re(e))}}),de=async e=>{var a,o,n,u,p,k,i,y,C,_,L;if(!(![d.GALLERY,d.KANBAN].includes((a=l.value)==null?void 0:a.type)||!((o=l.value)!=null&&o.id)||!((n=l.value)!=null&&n.view))){if(((u=l.value)==null?void 0:u.type)===d.GALLERY){const b={...ve((k=(p=l.value)==null?void 0:p.view)==null?void 0:k.meta),fk_cover_image_object_fit:e};await K.dbView.galleryUpdate((i=l.value)==null?void 0:i.id,{meta:b}),l.value.view.meta=b}else if(((y=l.value)==null?void 0:y.type)===d.KANBAN){const b={...ve((_=(C=l.value)==null?void 0:C.view)==null?void 0:_.meta),fk_cover_image_object_fit:e};await K.dbView.kanbanUpdate((L=l.value)==null?void 0:L.id,{meta:b}),l.value.view.meta=b}await(V==null?void 0:V.trigger())}},Ve=[{value:pe.FIT,label:ye("labels.fitImage")},{value:pe.COVER,label:ye("labels.coverImageArea")}],F=N({isOpen:!1,isSaving:null}),Q=Y({get:()=>{var e,a,o,n,u;return[d.GALLERY,d.KANBAN].includes((e=l.value)==null?void 0:e.type)&&((a=l.value)!=null&&a.view)?((u=ve((n=(o=l.value)==null?void 0:o.view)==null?void 0:n.meta))==null?void 0:u.fk_cover_image_object_fit)||pe.FIT:void 0},set:async e=>{e!==Q.value&&(F.value.isSaving=e,U({undo:{fn:de,args:[Q.value]},redo:{fn:de,args:[e]},scope:T({view:l.value})}),await de(e)),F.value.isSaving=null,F.value.isOpen=!1}}),Be=()=>{U({undo:{fn:async()=>{await le()},args:[]},redo:{fn:async()=>{await te()},args:[]},scope:T({view:l.value})}),te()},Ge=()=>{U({undo:{fn:async()=>{await te()},args:[]},redo:{fn:async()=>{await le()},args:[]},scope:T({view:l.value})}),le()},ce=Y({get:()=>{var e;return(e=ae.value)==null?void 0:e.every(a=>a.show)},set:async e=>{e?await Be():await Ge()}}),xe=e=>oa(ia(e)?Ue:Te,{columnMeta:e}),W=N(!1),ue=Y({get:()=>X.value,set:e=>{U({undo:{fn:a=>{X.value=!a},args:[e]},redo:{fn:a=>{X.value=a},args:[e]},scope:T({view:l.value})}),X.value=e}}),me=N(!1),ke=N();return Ie(W,e=>{e&&(B.value="",setTimeout(()=>{var a;(a=ke.value)==null||a.focus()},100))}),Ie(m,async e=>{var k;if(!e||we.value||![d.GALLERY,d.KANBAN].includes((k=l.value)==null?void 0:k.type))return;const a=e.filter(i=>i.fk_column_id&&G.value[i.fk_column_id].uidt===fe.Attachment).map(i=>({value:i.fk_column_id,label:i.title}))??[];P.value=[{value:null,label:"No Image"},...a];const o=e.filter(i=>i.fk_column_id&&G.value[i.fk_column_id].uidt===fe.Lookup).map(i=>G.value[i.fk_column_id]),n=new Set,u=async(i,y,C)=>{var L,b,O,h,R,S,t;const _=C||(L=_e.value)!=null&&L.id?(h=(O=be.value[C||((b=_e.value)==null?void 0:b.id)])==null?void 0:O.columns)==null?void 0:h.find(v=>{var Z;return v.id===((Z=y==null?void 0:y.colOptions)==null?void 0:Z.fk_relation_column_id)}):void 0;if((R=_==null?void 0:_.colOptions)!=null&&R.fk_related_model_id){await Oe(_.colOptions.fk_related_model_id);const v=(t=(S=be.value[_.colOptions.fk_related_model_id])==null?void 0:S.columns)==null?void 0:t.find(Z=>{var he;return Z.id===((he=y==null?void 0:y.colOptions)==null?void 0:he.fk_lookup_column_id)});v&&ga(v)?n.add(i.id):v&&(v==null?void 0:v.uidt)===fe.Lookup&&await u(i,v,_.colOptions.fk_related_model_id)}};await Promise.allSettled(o.map(i=>u(i,i)));const p=o.filter(i=>n.has(i==null?void 0:i.id)).map(i=>({value:i.id,label:i.title}));P.value=[...P.value,...p]},{immediate:!0}),ya(W),(e,a)=>{const o=na,n=ra,u=da,p=ha,k=Aa,i=ca,y=ma,C=pa,_=va,L=ka,b=fa,O=aa("e");return r(),f(_,{visible:s(W),"onUpdate:visible":a[14]||(a[14]=h=>q(W)?W.value=h:null),trigger:["click"],class:"!xs:hidden","overlay-class-name":"nc-dropdown-fields-menu nc-toolbar-dropdown"},{overlay:c(()=>{var h,R,S;return[w("div",{class:"pt-2 bg-white w-full min-w-72 max-w-80 rounded-lg nc-table-toolbar-menu","data-testid":"nc-fields-menu",onClick:a[13]||(a[13]=E(()=>{},["stop"]))},[!s(we)&&(((h=s(l))==null?void 0:h.type)===s(d).GALLERY||((R=s(l))==null?void 0:R.type)===s(d).KANBAN)?(r(),A("div",Ma,[w("div",$a,x(e.$t("labels.coverImageField")),1),w("div",Oa,[g(k,{value:s($),"onUpdate:value":a[0]||(a[0]=t=>q($)?$.value=t:null),class:"flex-1 max-w-[calc(100%_-_33px)]","dropdown-class-name":"nc-dropdown-cover-image !rounded-lg",bordered:!1,onClick:a[1]||(a[1]=E(()=>{},["stop"]))},{suffixIcon:c(()=>[g(o,{class:"text-gray-700",icon:"arrowDown"})]),default:c(()=>[(r(!0),A(J,null,Ce(s(P),t=>(r(),f(p,{key:t.value,value:t.value},{default:c(()=>[w("div",Ra,[w("div",{class:z(["flex-1 flex items-center gap-1",{"max-w-[calc(100%_-_20px)]":s($)===t.value,"max-w-full":s($)!==t.value}])},[t.value?(r(),f(j(xe(s(G)[t.value])),{key:0,class:"!w-3.5 !h-3.5 !text-gray-700 !ml-0"})):I("",!0),g(u,{class:"flex-1 max-w-[calc(100%_-_20px)] truncate","show-on-truncate-only":""},{title:c(()=>[M(x(t.label),1)]),default:c(()=>[M(x(t.label),1)]),_:2},1024)],2),s($)===t.value?(r(),f(o,{key:0,id:"nc-selected-item-icon",icon:"check",class:"flex-none text-primary w-4 h-4"})):I("",!0)])]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),s(Q)?(r(),f(_,{key:0,visible:s(F).isOpen,"onUpdate:visible":a[2]||(a[2]=t=>s(F).isOpen=t),placement:"bottomRight"},{overlay:c(()=>[g(C,{class:"nc-cover-image-object-fit-dropdown-menu min-w-[168px]"},{default:c(()=>[(r(),A(J,null,Ce(Ve,t=>g(y,{key:t.value,class:"!children:w-full",onClick:E(v=>Q.value=t.value,["stop"])},{default:c(()=>[w("span",null,x(t.label),1),t.value===s(F).isSaving?(r(),f(i,{key:0,size:"regular",class:"flex-none"})):t.value===s(Q)?(r(),f(o,{key:1,icon:"check",class:"flex-none text-primary w-4 h-4"})):I("",!0)]),_:2},1032,["onClick"])),64))]),_:1})]),default:c(()=>[w("button",Sa,[g(o,{icon:"settings",class:z(["h-4 w-4",{"!text-brand-500":s(F).isOpen}])},null,8,["class"])])]),_:1},8,["visible"])):I("",!0)])])):I("",!0),w("div",{class:"px-2",onClick:a[4]||(a[4]=E(()=>{},["stop"]))},[g(L,{ref_key:"fieldsMenuSearchRef",ref:ke,value:s(B),"onUpdate:value":a[3]||(a[3]=t=>q(B)?B.value=t:null),placeholder:e.$t("placeholder.searchFields"),class:"nc-toolbar-dropdown-search-field-input"},{prefix:c(()=>[g(o,{icon:"search",class:"nc-search-icon h-3.5 w-3.5 mr-1"})]),_:1},8,["value","placeholder"])]),w("div",Ea,[w("div",Fa,[(S=s(m))!=null&&S.filter(t=>t.title.toLowerCase().includes(s(B).toLowerCase())).length?I("",!0):(r(),A("div",Da,[a[15]||(a[15]=w("img",{src:ba,class:"!w-[164px] flex-none",alt:"No search results found"},null,-1)),M(" "+x(e.$t("title.noResultsMatchedYourSearch")),1)])),g(s(xa),{modelValue:s(m),"onUpdate:modelValue":a[7]||(a[7]=t=>q(m)?m.value=t:null),"item-key":"id","ghost-class":"nc-fields-menu-items-ghost",onChange:a[8]||(a[8]=t=>ne(t)),onStart:a[9]||(a[9]=t=>me.value=!0),onEnd:a[10]||(a[10]=t=>me.value=!1)},{item:c(({element:t})=>[s(ae).filter(v=>s(l).type!==s(d).CALENDAR?v!==s(je):!0).includes(t)?(r(),A("div",{key:t.id,"data-testid":`nc-fields-menu-${t.title}`,class:"pl-2 flex flex-row items-center rounded-md hover:bg-gray-100",onClick:a[6]||(a[6]=E(()=>{},["stop"]))},[(r(),f(j(("iconMap"in e?e.iconMap:s(H)).drag),{class:"cursor-move !h-3.75 text-gray-600 mr-1"})),Le((r(),A("div",{class:"flex flex-row items-center w-full cursor-pointer truncate ml-1 py-[5px] pr-2",onClick:()=>{t.show=!t.show,s(Se)(t.show,t)}},[(r(),f(j(xe(s(G)[t.fk_column_id])),{class:"!w-3.5 !h-3.5 !text-gray-500"})),g(u,{class:"flex-1 pl-1 pr-2 truncate","show-on-truncate-only":"",disabled:s(me)},{title:c(()=>[M(x(t.title),1)]),default:c(()=>[M(x(t.title),1)]),_:2},1032,["disabled"]),s(l).type===s(d).CALENDAR?(r(),A("div",Ba,[g(n,{class:z([{"!bg-gray-800 !text-white":t.bold},"!rounded-r-none !w-5 !h-5"]),size:"xxsmall",type:"secondary",onClick:E(v=>s(ie)(t,"bold",!t.bold),["stop"])},{default:c(()=>[(r(),f(j(("iconMap"in e?e.iconMap:s(H)).bold),{class:"!w-3 !h-3"}))]),_:2},1032,["class","onClick"]),g(n,{class:z([{"!bg-gray-800 !text-white":t.italic},"!rounded-x-none !border-x-0 !w-5 !h-5"]),size:"xxsmall",type:"secondary",onClick:E(v=>s(ie)(t,"italic",!t.italic),["stop"])},{default:c(()=>[(r(),f(j(("iconMap"in e?e.iconMap:s(H)).italic),{class:"!w-3 !h-3"}))]),_:2},1032,["class","onClick"]),g(n,{class:z([{"!bg-gray-800 !text-white":t.underline},"!rounded-l-none !w-5 !h-5"]),size:"xxsmall",type:"secondary",onClick:E(v=>s(ie)(t,"underline",!t.underline),["stop"])},{default:c(()=>[(r(),f(j(("iconMap"in e?e.iconMap:s(H)).underline),{class:"!w-3 !h-3"}))]),_:2},1032,["class","onClick"])])):I("",!0),g(b,{checked:t.show,disabled:t.isViewEssentialField,size:"xsmall",onChange:a[5]||(a[5]=v=>s(ge)("a:fields:show-hide"))},null,8,["checked","disabled"])],8,Va)),[[O,["a:fields:show-hide"]]]),a[16]||(a[16]=w("div",{class:"flex-1"},null,-1))],8,ja)):I("",!0)]),_:1},8,["modelValue"])])]),s(B)?I("",!0):(r(),A("div",Ga,[g(n,{class:"nc-fields-show-all-fields",size:"small",type:"ghost",onClick:a[11]||(a[11]=t=>ce.value=!s(ce))},{default:c(()=>[M(x(s(ce)?e.$t("general.hideAll"):e.$t("general.showAll"))+" "+x(e.$t("objects.fields").toLowerCase()),1)]),_:1}),s(Ee)?I("",!0):(r(),f(n,{key:0,class:"nc-fields-show-system-fields",size:"small",type:"ghost",onClick:a[12]||(a[12]=t=>ue.value=!s(ue))},{default:c(()=>[M(x(s(ue)?e.$t("title.hideSystemFields"):e.$t("activity.showSystemFields")),1)]),_:1}))]))])]}),default:c(()=>[w("div",{class:z({"nc-active-btn":s(se)})},[Le((r(),f(n,{disabled:s(Me),class:"nc-fields-menu-btn nc-toolbar-btn !h-7 !border-0",size:"small",type:"secondary"},{default:c(()=>{var h,R,S,t;return[w("div",Ia,[w("div",Ca,[((h=s(l))==null?void 0:h.type)===s(d).KANBAN||((R=s(l))==null?void 0:R.type)===s(d).GALLERY?(r(),f(o,{key:0,class:"h-4 w-4",icon:"creditCard"})):(r(),f(j(("iconMap"in e?e.iconMap:s(H)).fields),{key:1,class:"h-4 w-4"})),!s(Ne)&&!s($e)?(r(),A("span",La,[((S=s(l))==null?void 0:S.type)===s(d).KANBAN||((t=s(l))==null?void 0:t.type)===s(d).GALLERY?(r(),A(J,{key:0},[M(x(e.$t("title.editCards")),1)],64)):(r(),A(J,{key:1},[M(x(e.$t("objects.fields")),1)],64))])):I("",!0)]),s(se)?(r(),A("span",Na,x(s(se)),1)):I("",!0)])]}),_:1},8,["disabled"])),[[O,["c:fields"]]])],2)]),_:1},8,["visible"])}}}),_s=ua(Ua,[["__scopeId","data-v-c142a802"]]);export{_s as default};
