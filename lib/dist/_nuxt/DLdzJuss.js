import{u as _e}from"./-Hb63wRq.js";import{cU as c,ag as Se,N as De,at as we,cB as Be,g3 as be,cP as Ae,bL as se,r as L,g7 as Ge,g as $,L as Ie,dS as Oe,g6 as Le,hj as $e,H as le,a_ as Re,an as P,ao as F,hi as Te,hk as D,hl as re}from"./nEPQs079.js";import{a as ze}from"./BfMXOlc4.js";import{a as Ne}from"./vKaAFL5T.js";const Ve=[c.Attachment,c.QrCode,c.Barcode],[Me,je]=_e((f,h,v,b=!1)=>{const{api:A}=Se(),{appInfo:R}=De(),{base:_}=we(Be()),{sharedView:q,fetchSharedViewData:ce,fetchBulkAggregatedData:H}=be(),{gridViewCols:de}=ze(),{getMeta:E}=Ae(),ue=se(Ge,L(null)),m=$(()=>{const e=[];return Object.values(de.value).forEach(t=>{var n,a;if(t.group_by){const o=(a=(n=h==null?void 0:h.value)==null?void 0:n.columns)==null?void 0:a.find(i=>i.id===t.fk_column_id);o&&e.push({column:o,sort:t.group_by_sort||"asc",order:t.group_by_order||1})}}),e.sort((t,n)=>(t.order??1/0)-(n.order??1/0)),e}),fe=$(()=>!!m.value.length),{isUIAllowed:T}=Ie(),{sorts:z,nestedFilters:N}=Ne(),J=se(Le,Oe()),k=$(()=>{var e;return((e=R.value.defaultGroupByLimit)==null?void 0:e.limitGroup)||10}),G=$(()=>{var e;return((e=R.value.defaultGroupByLimit)==null?void 0:e.limitRecord)||10}),K=L([]),ge=$(()=>{var e;return(((e=h==null?void 0:h.value)==null?void 0:e.columns)||[]).filter(t=>Ve.includes(t.uidt)?!1:t.uidt===c.Lookup?t.id&&K.value.includes(t.id):!0)}),p=L({key:"root",color:"root",count:0,column:{},nestedIn:[],aggregations:{},paginationData:{page:1,pageSize:k.value},nested:!0,children:[],root:!0});async function Q(e,t){t=t||p.value,t&&(t.paginationData.page=e,await X({offset:(e-1)*(t.paginationData.pageSize||k.value)},t))}const he=e=>e.map(t=>({row:{...t},oldRow:{...t},rowMeta:{}})),V=(e,t,n)=>t.uidt===c.Checkbox?e?D.TRUE:D.FALSE:[c.User,c.CreatedBy,c.LastModifiedBy].includes(t.uidt)&&!e?D.NULL:t.uidt===c.LinkToAnotherRecord&&n&&e&&typeof e=="object"?e[n]??D.NULL:(e&&typeof e=="object"&&(e=JSON.stringify(e)),e??D.NULL),w=L($e.light),I=L(w.value[0]),M=()=>{const e=I.value,t=w.value.indexOf(I.value);return t===w.value.length-1?I.value=w.value[0]:I.value=w.value[t+1],e},me=(e,t)=>{var n,a;if(t)switch(t.uidt){case c.MultiSelect:{const o=(e==null?void 0:e.split(","))||[],i=[];for(const s of o){const u=(n=t.colOptions.options)==null?void 0:n.find(g=>g.title===s);u&&i.push(u.color)}return i.join(",")}case c.SingleSelect:{const o=(a=t.colOptions.options)==null?void 0:a.find(i=>i.title===e);return o?o.color||M():"gray"}case c.Checkbox:return e?re.success:re.error;default:return e?M():"gray"}return e?M():"gray"},j=(e,t="")=>e.reduce((n,a)=>{if(a.key===D.NULL)n+=`${n.length?"~and":""}(${a.title},gb_null)`;else if(a.column_uidt===c.Checkbox)n+=`${n.length?"~and":""}(${a.title},${a.key===D.TRUE?"checked":"notchecked"})`;else if([c.Date,c.DateTime,c.CreatedTime,c.LastModifiedTime].includes(a.column_uidt))n+=`${n.length?"~and":""}(${a.title},eq,exactDate,${a.key})`;else if([c.User,c.CreatedBy,c.LastModifiedBy].includes(a.column_uidt))try{const o=JSON.parse(a.key);n+=`${n.length?"~and":""}(${a.title},gb_eq,${(Array.isArray(o)?o:[o]).map(i=>i.id).join(",")})`}catch(o){console.error(o)}else n+=`${n.length?"~and":""}(${a.title},gb_eq,${a.key})`;return n},t),Y=e=>{if(e==="asc")return"+";if(e==="desc")return"-";if(e==="count-asc")return"~+";if(e==="count-desc")return"~-"};async function X(e={},t){var n,a,o,i,s,u,g,S;try{if(t=t||p.value,!((n=_==null?void 0:_.value)!=null&&n.id)||!((a=f.value)!=null&&a.id)||!((o=f.value)!=null&&o.fk_model_id)||!t)return;if(m.value.length===0){t.children=[];return}if(t.nestedIn.length>m.value.length)return;t.nestedIn.length===0&&(I.value=w.value[0]);const l=m.value[t.nestedIn.length],C=j(t.nestedIn,v==null?void 0:v.value);if(!l||!l.column.title||b&&!((i=q.value)!=null&&i.uuid))return;if(l.column.uidt===c.LinkToAnotherRecord){const r=await E(l.column.colOptions.fk_related_model_id);if(!r)return;t.displayValueProp=((g=((s=r.columns)==null?void 0:s.find(d=>d.pv))||((u=r.columns)==null?void 0:u[0]))==null?void 0:g.title)||""}const ie=b?await A.public.dataGroupBy(q.value.uuid,{offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??k.value),limit:t.paginationData.pageSize??k.value,...e,where:C,sort:`${Y(l.sort)}${l.column.title}`,column_name:l.column.title,sortsArr:z.value,filtersArr:N.value},{headers:{"xc-password":ue.value}}):await A.dbViewRow.groupBy("noco",_.value.id,f.value.fk_model_id,f.value.id,{offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??k.value),limit:t.paginationData.pageSize??k.value,...e,...T("sortSync")?{}:{sortArrJson:JSON.stringify(z.value)},...T("filterSync")?{}:{filterArrJson:JSON.stringify(N.value)},where:`${C}`,sort:`${Y(l.sort)}${l.column.title}`,column_name:l.column.title}),U=ie.list.reduce((r,d)=>{const y=r.find(O=>O.key===V(d[l.column.column_name]??d[l.column.title],l.column));return y?(y.count+=+d.count,y.paginationData={page:1,pageSize:k.value,totalRows:y.count},r):(l.column.title&&l.column.uidt&&r.push({key:V(d[l.column.title],l.column),column:l.column,count:+d.count,color:me(d[l.column.title],l.column),nestedIn:[...t.nestedIn,{title:l.column.title,column_name:l.column.title,key:V(d[l.column.title],l.column),column_uidt:l.column.uidt}],aggregations:d.aggregations??{},paginationData:{page:1,pageSize:t.nestedIn.length<m.value.length-1?k.value:G.value,totalRows:+d.count},nested:t.nestedIn.length<m.value.length-1}),r)},[]);t.children||(t.children=[]);for(const r of U){const d=(S=t.children)==null?void 0:S.find(y=>y.key===r.key);if(d){r.paginationData={page:d.paginationData.page||r.paginationData.page,pageSize:d.paginationData.pageSize||r.paginationData.pageSize,totalRows:r.count},r.color=d.color,Object.assign(d,r);continue}t.children.push(r)}t.children=t.children.filter(r=>U.find(d=>d.key===r.key)),t.count<=(t.paginationData.pageSize??k.value)&&t.children.sort((r,d)=>{const y=U.findIndex(B=>B.key===r.key),O=U.findIndex(B=>B.key===d.key);return y-O}),t.paginationData=ie.pageInfo;const oe=Math.max(1,Math.ceil(t.paginationData.totalRows/t.paginationData.pageSize));if(oe<t.paginationData.page&&await Q(oe,t),R.value.ee){const r=(t.children??[]).map(y=>({where:j(y.nestedIn,v==null?void 0:v.value),alias:y.key})),d=b?await H({aggregateFilterList:r}):await A.dbDataTableBulkAggregate.dbDataTableBulkAggregate(h.value.id,{viewId:f.value.id,aggregateFilterList:r});Object.entries(d).forEach(([y,O])=>{const B=((t==null?void 0:t.children)??[]).find(ke=>ke.key.toString()===y.toString());B&&Object.assign(B.aggregations,O)})}}catch(l){P.error(await F(l))}}async function Z(e,t=!1,n={}){var a,o,i;try{if(!((a=_==null?void 0:_.value)!=null&&a.id)||!((o=f.value)!=null&&o.id)||!((i=f.value)!=null&&i.fk_model_id)||e.children&&!t)return;e.paginationData||(e.paginationData={page:1,pageSize:G.value});const s=j(e.nestedIn,v==null?void 0:v.value),u={offset:((e.paginationData.page??0)-1)*(e.paginationData.pageSize??G.value),limit:e.paginationData.pageSize??G.value,where:`${s}`},g=b?await ce({sortsArr:z.value,filtersArr:N.value,...u},{isGroupBy:!0}):await A.dbViewRow.list("noco",_.value.id,f.value.fk_model_id,f.value.id,{...u,...n,...T("sortSync")?{}:{sortArrJson:JSON.stringify(z.value)},...T("filterSync")?{}:{filterArrJson:JSON.stringify(N.value)}});e.count=g.pageInfo.totalRows??0,e.rows=he(g.list),e.paginationData=g.pageInfo}catch(s){P.error(await F(s))}}async function ye(e,t){var n,a,o;try{if(!((n=h==null?void 0:h.value)!=null&&n.id)||!((a=f.value)!=null&&a.id)||!((o=f.value)!=null&&o.fk_model_id)||!R.value.ee)return;const i=t==null?void 0:t.filter(g=>g.type!==Te.None);if(i&&!(i!=null&&i.length))return;const s=(e.children??[]).map(g=>({where:j(g.nestedIn,v==null?void 0:v.value),alias:g.key})),u=b?await H({aggregateFilterList:s,...i?{aggregation:i}:{}}):await A.dbDataTableBulkAggregate.dbDataTableBulkAggregate(h.value.id,{viewId:f.value.id,aggregateFilterList:s,...i?{aggregation:i}:{}});Object.entries(u).forEach(([g,S])=>{const l=(e.children??[]).find(C=>C.key.toString()===g.toString());l&&Object.assign(l.aggregations,S)})}catch(i){P.error(await F(i))}}const ve=async(e,t)=>{e.paginationData||(e.paginationData={page:1,pageSize:G.value}),e.paginationData.page=t,await Z(e,!0)},W=(e,t=0)=>{if(e=e||p.value,!!e&&(t<m.value.length?e.nested=!0:e.nested=!1,e.nested?e!=null&&e.rows&&(e.rows=[]):e!=null&&e.children&&(e.children=[]),!(t>m.value.length)))for(const n of e.children||[])W(n,t+1)};le(()=>m.value.length,async()=>{m.value.length>0&&(p.value.paginationData={page:1,pageSize:k.value},p.value.column={},W(),Re(()=>J==null?void 0:J.trigger()))});const ee=(e,t,n=0)=>{var o;if(t=t||p.value,n>=e.length)return t;const a=(o=t.children)==null?void 0:o.find(i=>i.key===e[n].key);return a?a.nested?ee(e,a,n+1):a:t},te=e=>ee(e.nestedIn.slice(0,-1)),x=(e,t)=>{var n;if(e){if(e.count+=t,e.count===0){const a=te(e);a&&(a.children=(n=a.children)==null?void 0:n.filter(o=>o.key!==e.key))}e.root||x(te(e),t)}},ne=(e,t,n=0)=>{var a;if(t=t||p.value,t.nested){const o=(a=t.children)==null?void 0:a.find(i=>{if(m.value[n].column.title)return i.key===V(e.row[m.value[n].column.title],m.value[n].column,t.displayValueProp)});return console.log(o),o?ne(e,o,n+1):{found:!1,group:t}}return{found:!0,group:t}},ae=e=>{var t;e=e||p.value,e&&(!e.nested&&e.rows?e.rows.forEach(n=>{var o,i,s,u;const a=ne(n);a.found?a.group!==e&&(a.group&&((o=a.group.rows)==null||o.push(n),x(a.group,1)),e&&((i=e.rows)==null||i.splice(e.rows.indexOf(n),1),console.log("removed Bunch"),x(e,-1))):e?((s=e.rows)==null||s.splice(e.rows.indexOf(n),1),console.log("removed Bunch22"),x(e,-1)):(u=p.value.rows)==null||u.splice(p.value.rows.indexOf(n),1)}):(t=e.children)==null||t.forEach(n=>ae(n)))},pe=async()=>{var t,n,a,o;const e=[];try{for(const i of((t=h==null?void 0:h.value)==null?void 0:t.columns)||[]){if(i.uidt!==c.Lookup)continue;let s=i;for(;s&&s.uidt===c.Lookup;){const u=(a=(n=await E(s.fk_model_id))==null?void 0:n.columns)==null?void 0:a.find(S=>S.id===(s==null?void 0:s.colOptions).fk_relation_column_id);if(!(u!=null&&u.colOptions))break;const g=await E((u==null?void 0:u.colOptions).fk_related_model_id);if(s=(o=g==null?void 0:g.columns)==null?void 0:o.find(S=>S.id===(s==null?void 0:s.colOptions).fk_lookup_column_id),(s==null?void 0:s.id)===i.id)break}(s==null?void 0:s.uidt)!==c.Attachment&&i.id&&e.push(i.id)}K.value=e}catch(i){console.error(i)}};return le([()=>{var e;return(e=f==null?void 0:f.value)==null?void 0:e.id},()=>{var e;return(e=h.value)==null?void 0:e.columns}],async([e])=>{var t,n;e&&((t=f.value)==null?void 0:t.fk_model_id)===((n=h.value)==null?void 0:n.id)&&await pe()}),{rootGroup:p,groupBy:m,isGroupBy:fe,fieldsToGroupBy:ge,groupByLimit:3,loadGroups:X,loadGroupData:Z,loadGroupPage:ve,loadGroupAggregation:ye,groupWrapperChangePage:Q,redistributeRows:ae}},"useViewGroupBy");function Pe(){const f=je();if(f==null)throw new Error("Please call `useProvideViewGroupBy` on the appropriate parent component");return f}export{Pe as a,Me as u};
