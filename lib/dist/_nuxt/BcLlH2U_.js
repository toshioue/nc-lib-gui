import{f as Me,N as Ae,bN as y,fP as Oe,hq as $e,r as p,aE as Re,aC as Ee,aF as Te,g as I,dA as Ve,hG as je,hJ as Pe,gP as Be,hM as Le,L as He,cM as Ne,at as Ke,de as N,i as qe,H as re,hu as ce,aj as De,ak as Fe,aG as ze,o as m,c as M,P as t,b as A,w as f,aq as K,av as U,S as O,U as x,a as b,aa as L,di as S,d as q,t as _,Q as ue,Y as de,n as Ge,T as fe,V as Ue,W as Je,A as Qe,a1 as We,$ as Ye,dt as Xe,_ as Ze}from"./3QBYHahY.js";import{u as ve}from"./DGM-hiY9.js";import{B as et}from"./D4iSzjWt.js";import{M as tt}from"./CNtEbMQ_.js";import{T as lt}from"./CI9Dknfq.js";import{C as at,a as st}from"./Dg1gNFnz.js";import{S as ot,_ as nt}from"./BEpKpjF5.js";import"./Ci1lK5Ee.js";import"./xnDaHwV-.js";import"./CGxepfeV.js";import"./BQQOEPN4.js";import"./3ezdMRmZ.js";import"./DPgYHC40.js";const it={key:0,class:"w-full max-w-full"},rt={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},ct={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},ut={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},dt={class:"flex gap-2 text-gray-500 items-center h-full"},ft={class:"text-xs whitespace-normal"},vt=Me({__name:"MultiSelect",props:{modelValue:{},rowIndex:{},disableOptionCreation:{type:Boolean},location:{}},emits:["update:modelValue"],setup($,{emit:pe}){const me=pe,{isMobileMode:we}=Ae(),r=y(Oe),H=y($e),J=y(Re,p(!1)),Q=y(Ee,p(!1)),R=y(Te,p(!1)),D=I(()=>Q.value||J.value||R.value),W=y(Ve,p(!1)),Y=y(je,p(!1)),V=y(Pe,p(void 0)),ge=y(Be,p(!1)),F=p([]),E=p(),u=p(!1),z=p(!1),T=y(Le,p(!1)),v=p(),{$api:he}=Qe(),{isUIAllowed:X,isMetaReadOnly:ye}=He(),{isPg:Z,isMysql:ee}=Ne(),j=Ke([]),d=I(()=>{var e,l,a,o;if(r!=null&&r.value.colOptions){const i=r.value.colOptions?r.value.colOptions.options.filter(n=>n.title!=="")||[]:[];for(const n of i.filter(c=>c.order===null))n.title=(e=n.title)==null?void 0:e.replace(/^'/,"").replace(/'$/,"");let w=1;const h=(((l=N(r.value.meta))==null?void 0:l.limitOptions)||[]).reduce((n,c)=>(w<((c==null?void 0:c.order)??0)&&(w=c.order),{...n,[c.id]:c}),{})??{};return!Y.value&&R.value&&((a=N(r.value.meta))!=null&&a.isLimitOption)&&(((o=N(r.value.meta))==null?void 0:o.limitOptions)||[]).length?i.filter(n=>{var c,B;return((c=h[n.id])==null?void 0:c.show)!==void 0?(B=h[n.id])==null?void 0:B.show:!1}).map(n=>{var c;return{...n,value:n.title,order:n.id&&h[n.id]?(c=h[n.id])==null?void 0:c.order:w++}}).sort((n,c)=>n.order-c.order):i.map(n=>({...n,value:n.title}))}return[]}),te=I(()=>(d.value??[]).every(e=>e.title!==v.value)),le=I(()=>X("dataEdit")),k=I(()=>(le.value||R.value)&&D.value),g=I({get:()=>{const e=F.value.reduce((l,a)=>{var i;const o=(i=d.value.find(w=>w.id===a)||d.value.find(w=>w.title===a))==null?void 0:i.title;return o&&l.push(o),l},[]);return j.length&&e.push(...j),e},set:e=>{if(te.value&&e.length&&e[e.length-1]===v.value)return be();me("update:modelValue",e.length===0?null:e.join(","))}}),ae=I(()=>$.modelValue?Array.isArray($.modelValue)?$.modelValue:ee(r.value.source_id)?$.modelValue.toString().split(",").sort((e,l)=>{const a=d.value.find(i=>i.title===e),o=d.value.find(i=>i.title===l);return a&&o?a.order-o.order:0}):$.modelValue.toString().split(","):[]);qe(()=>{F.value=ae.value.flatMap(e=>{const l=d.value.find(o=>o.title===e||o.title===(e==null?void 0:e.trim())),a=(l==null?void 0:l.id)||(l==null?void 0:l.title);return a?[a]:[]})}),re(()=>$.modelValue,()=>{F.value=ae.value.flatMap(e=>{const l=d.value.find(a=>a.title===e||a.title===(e==null?void 0:e.trim()));return l&&(l.id||l.title)?[l.id||l.title]:[]})}),re(u,(e,l)=>{var a,o,i,w,h,n;e||(v.value=""),k.value&&(e?(n=(h=(w=E.value)==null?void 0:w.$el)==null?void 0:h.querySelector("input"))==null||n.focus():(i=(o=(a=E.value)==null?void 0:a.$el)==null?void 0:o.querySelector("input"))==null||i.blur())}),ve(Q,e=>{var l;switch(e.key){case"Escape":u.value=!1;break;case"Enter":k.value&&D.value&&!u.value&&(u.value=!0);break;case" ":break;case"ArrowUp":case"ArrowDown":case"ArrowRight":case"ArrowLeft":case"Delete":break;default:if(!k.value){e.preventDefault();break}!(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)&&((l=e.key)==null?void 0:l.length)===1&&!Xe()&&(e.stopPropagation(),u.value=!0);break}}),ve(u,e=>{e.key==="Escape"&&(u.value=!1)});const P=p(0);async function be(){var e,l;if(!v.value||W.value)return!1;try{j.push(v.value);const a=v==null?void 0:v.value;if(v.value="",P.value++,a&&!d.value.some(o=>o.title===a)){const o=[...d.value];o.push({title:a,value:a,color:ce.light[(d.value.length+1)%ce.light.length]}),r.value.colOptions={options:o.map(({value:w,...h})=>h)};const i={...r.value};i.cdf&&(Z(r.value.source_id)&&(i.cdf=i.cdf.substring(i.cdf.indexOf("'")+1,i.cdf.lastIndexOf("'"))),!ee(r.value.source_id)&&!Z(r.value.source_id)&&(i.cdf=i.cdf.replace(/''/g,"'"))),await he.dbTableColumn.update(((e=r.value)==null?void 0:e.fk_column_id)||((l=r.value)==null?void 0:l.id),i),P.value--,P.value||(g.value=[...g.value],j.splice(0,j.length))}else P.value--}catch(a){console.log(a),P.value--,De.error(await Fe(a))}}const ke=()=>{var e,l,a;v.value=(a=(l=(e=E.value)==null?void 0:e.$el)==null?void 0:l.querySelector(".ant-select-selection-search-input"))==null?void 0:a.value},xe=(e,l)=>{var a,o;((a=e.target)!=null&&a.classList.contains("ant-tag-close-icon")||(o=e.target)!=null&&o.closest(".ant-tag-close-icon"))&&(e.stopPropagation(),l())},_e=()=>{z.value||(u.value=k.value&&!u.value)};ze(document,"click",e=>{var l;u.value&&E.value&&!E.value.$el.contains(e.target)&&!((l=document.querySelector(".nc-dropdown-multi-select-cell.active"))!=null&&l.contains(e.target))&&(J.value=!1,u.value=!1)},!0);const Ce=I(()=>g.value.reduce((e,l)=>{const a=d.value.find(o=>o.value===l);return a&&e.push(a),e},[])),Ie=e=>{if(e.key==="Tab"){u.value=!1;return}else if(e.key==="Escape"&&R.value){u.value=!1;return}e.stopPropagation()},Se=()=>{var e;z.value=!0,setTimeout(()=>{z.value=!1},250),!(ge.value&&((e=g.value)!=null&&e.length))&&(u.value=!0)};return(e,l)=>{var B;const a=We,o=lt,i=at,w=st,h=Ye,n=ot,c=nt;return m(),M("div",{class:x(["nc-cell-field nc-multi-select h-full w-full flex items-center",{"read-only":t(H),"max-w-full":t(R)}]),onClick:_e},[!t(Y)&&t(R)&&((B=("parseProp"in e?e.parseProp:t(N))(t(r).meta))!=null&&B.isList)?(m(),M("div",it,[A(w,{value:t(g),"onUpdate:value":l[0]||(l[0]=s=>ue(g)?g.value=s:null),disabled:t(H)||!t(k),class:"nc-field-layout-list",onClick:l[1]||(l[1]=de(()=>{},["stop"]))},{default:f(()=>[(m(!0),M(K,null,U(t(d),s=>(m(),O(i,{key:s.title,value:s.title,"data-testid":`select-option-${t(r).title}-${e.location==="filter"?"filter":e.rowIndex}`,class:x(`nc-select-option-${t(r).title}-${s.title}`)},{default:f(()=>[A(o,{class:"rounded-tag max-w-full",color:s.color},{default:f(()=>[b("span",{style:L({color:t(S).isReadable(s.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(s.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:"text-small"},[A(a,{class:"truncate max-w-full","show-on-truncate-only":""},{title:f(()=>[q(_(s.title),1)]),default:f(()=>[b("span",rt,_(s.title),1)]),_:2},1024)],4)]),_:2},1032,["color"])]),_:2},1032,["value","data-testid","class"]))),128))]),_:1},8,["value","disabled"])])):(m(),M(K,{key:1},[t(D)?(m(),O(c,{key:1,ref_key:"aselect",ref:E,value:t(g),"onUpdate:value":l[3]||(l[3]=s=>ue(g)?g.value=s:null),mode:"multiple",class:x(["w-full overflow-hidden",{"caret-transparent":!t(le)}]),bordered:!1,"clear-icon":"","show-search":!t(we),"show-arrow":t(k)&&!t(H),open:t(u)&&t(k),disabled:t(H)||!t(k),"dropdown-class-name":`nc-dropdown-multi-select-cell !min-w-156px ${t(u)?"active":""}`,onSearch:ke,onKeydown:Ie,onFocus:Se,onBlur:l[4]||(l[4]=s=>u.value=!1)},{suffixIcon:f(()=>[A(h,{icon:"arrowDown",class:"text-gray-700 nc-select-expand-btn"})]),tagRender:f(({value:s,onClose:se})=>{var oe,ne;return[t(d).find(C=>C.title===s)?(m(),O(o,{key:0,class:x(["rounded-tag nc-selected-option",{"!my-0":!t(V)||t(V)===1}]),style:{display:"flex",alignItems:"center"},color:(oe=t(d).find(C=>C.title===s))==null?void 0:oe.color,closable:t(k)&&(t(g).length>1||!((ne=t(r))!=null&&ne.rqd)),"close-icon":("h"in e?e.h:t(Ge))(t(tt),{class:["ms-close-icon"]}),onClick:C=>xe(C,se),onClose:se},{default:f(()=>{var C,ie;return[b("span",{style:L({color:t(S).isReadable(((C=t(d).find(G=>G.title===s))==null?void 0:C.color)||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(((ie=t(d).find(G=>G.title===s))==null?void 0:ie.color)||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:x({"text-sm":t(T),"text-small":!t(T)})},_(s),7)]}),_:2},1032,["class","color","closable","close-icon","onClick","onClose"])):fe("",!0)]}),default:f(()=>[(m(!0),M(K,null,U(t(d),s=>(m(),O(n,{key:s.id||s.title,value:s.title,"data-testid":`select-option-${t(r).title}-${e.location==="filter"?"filter":e.rowIndex}`,class:x(`nc-select-option-${t(r).title}-${s.title}`),onClick:l[2]||(l[2]=de(()=>{},["stop"]))},{default:f(()=>[A(o,{class:"rounded-tag max-w-full",color:s.color},{default:f(()=>[b("span",{style:L({color:t(S).isReadable(s.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(s.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:x({"text-sm":t(T),"text-small":!t(T)})},[A(a,{class:"truncate max-w-full","show-on-truncate-only":""},{title:f(()=>[q(_(s.title),1)]),default:f(()=>[b("span",ut,_(s.title),1)]),_:2},1024)],6)]),_:2},1032,["color"])]),_:2},1032,["value","data-testid","class"]))),128)),!t(ye)&&t(v)&&t(te)&&!t(W)&&!e.disableOptionCreation&&t(X)("fieldEdit")?(m(),O(n,{key:t(v),value:t(v)},{default:f(()=>[b("div",dt,[(m(),O(Ue(("iconMap"in e?e.iconMap:t(Je)).plusThick),{class:"min-w-4"})),b("div",ft,[q(_(e.$t("msg.selectOption.createNewOptionNamed"))+" ",1),b("strong",null,_(t(v)),1)])])]),_:1},8,["value"])):fe("",!0)]),_:1},8,["value","show-search","show-arrow","open","disabled","class","dropdown-class-name"])):(m(),M("div",{key:0,class:"flex flex-wrap",style:L({display:"-webkit-box","max-width":"100%","-webkit-line-clamp":("rowHeightTruncateLines"in e?e.rowHeightTruncateLines:t(et))(t(V)),"-webkit-box-orient":"vertical",overflow:"hidden"})},[(m(!0),M(K,null,U(t(Ce),s=>(m(),O(o,{key:s.value,class:x(["rounded-tag max-w-full",{"!my-0":!t(V)||t(V)===1}]),color:s.color},{default:f(()=>[b("span",{style:L({color:t(S).isReadable(s.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(s.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:x({"text-sm":t(T),"text-small":!t(T)})},[A(a,{class:"truncate max-w-full","show-on-truncate-only":""},{title:f(()=>[q(_(s.title),1)]),default:f(()=>[b("span",ct,_(s.title),1)]),_:2},1024)],6)]),_:2},1032,["class","color"]))),128))],4))],64))],2)}}}),At=Ze(vt,[["__scopeId","data-v-6504aadc"]]);export{At as default};
