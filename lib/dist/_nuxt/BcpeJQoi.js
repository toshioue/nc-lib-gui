import{u as I}from"./CO8XXsKl.js";import{r as V,g,L as B,az as D,cN as ee,c_ as ue,d3 as S,H as $,aB as se,hh as le,A as ne,ht as ie,hu as oe,d7 as te,df as H}from"./Cgw6cdOy.js";const[fe,ae]=I((o,c,v,b=!1)=>{const L=V([]),f=V(),z=g(()=>(f.value||[]).reduce((e,u)=>(u.fk_column_id&&(e[u.fk_column_id]=u),e),{})),y=V(""),{$api:w,$e:x}=ne(),{isUIAllowed:E}=B(),{isSharedBase:G}=D(ee()),U=V(!1),{addUndo:M,defineViewScope:N}=ue(),m=g(()=>b||!E("viewFieldEdit")||G.value),A=V({}),j=e=>{var u,l,n;return((u=o.value)==null?void 0:u.type)===te.MAP&&((n=(l=o.value)==null?void 0:l.view)==null?void 0:n.fk_geo_data_col_id)===e.id},a=g(()=>{var e;return(e=c.value)!=null&&e.columns?c.value.columns.reduce((u,l)=>({...u,[l.id]:l}),{}):{}}),p=V({}),k=async()=>{var u,l,n,i,s;if(!c||!o)return;let e=1;if((u=o.value)!=null&&u.id){const r=(b?(l=c.value)==null?void 0:l.columns:(await w.dbViewColumn.list(o.value.id)).list).reduce((h,d)=>(d.show=!!d.show,{...h,[d.fk_column_id]:d}),{});if(f.value=(i=(n=c.value)==null?void 0:n.columns)==null?void 0:i.filter(h=>!ie(h,c.value)).map(h=>{var F;const d=r[h.id]||{};return{title:h.title,fk_column_id:h.id,...d,show:d.show||j(d),order:d.order||e++,aggregation:(d==null?void 0:d.aggregation)??oe.None,system:S((F=a==null?void 0:a.value)==null?void 0:F[d.fk_column_id]),isViewEssentialField:j(h),initialShow:d.show||j(d)||(d==null?void 0:d.group_by)}}).sort((h,d)=>h.order-d.order),m.value&&f.value)for(const h in A.value){const d=f.value.findIndex(F=>F.fk_column_id===h);d!==void 0&&d>-1&&(f.value[d]=A.value[h],f.value=f.value.sort((F,Z)=>F.order-Z.order))}const _=(b.value?(s=o.value)==null?void 0:s.columns:f.value)??[];p.value=_.reduce((h,d)=>({...h,[d.fk_column_id]:d}),{})}},Q=async e=>{var u,l,n;if(m.value){const i=(f.value||[]).reduce((s,t)=>(t.fk_column_id&&(t.show=!!t.initialShow,s[t.fk_column_id]=t),s),{});f.value=(u=f.value||[])==null?void 0:u.map(s=>{var r;const t={...s,show:(r=i[s.fk_column_id])==null?void 0:r.show};return A.value[s.fk_column_id]=s,t}),c.value.columns=(l=c.value.columns)==null?void 0:l.map(s=>i[s.id]?{...s,...i[s.id],id:i[s.id].fk_column_id}:s),v==null||v();return}(n=o==null?void 0:o.value)!=null&&n.id&&(e?await w.dbView.showAllColumn(o.value.id,{ignoreIds:e}):await w.dbView.showAllColumn(o.value.id)),await k(),v==null||v(),x("a:fields:show-all")},W=async e=>{var u,l,n;if(m.value){const i=(f.value||[]).reduce((s,t)=>{var r,_;return t.fk_column_id&&(t.show=!!((_=(r=a==null?void 0:a.value)==null?void 0:r[t.fk_column_id])!=null&&_.pv)||!!t.isViewEssentialField,s[t.fk_column_id]=t),s},{});f.value=(u=f.value||[])==null?void 0:u.map(s=>{var r;const t={...s,show:(r=i[s.fk_column_id])==null?void 0:r.show};return A.value[s.fk_column_id]=s,t}),c.value.columns=(l=c.value.columns)==null?void 0:l.map(s=>i[s.id]?{...s,...i[s.id],id:i[s.id].fk_column_id}:s),v==null||v();return}(n=o==null?void 0:o.value)!=null&&n.id&&(e?await w.dbView.hideAllColumn(o.value.id,{ignoreIds:e}):await w.dbView.hideAllColumn(o.value.id)),await k(),v==null||v(),x("a:fields:show-all")},q=(e,u)=>{var n,i,s,t,r;if(!((n=c.value)!=null&&n.columns))return;const l=c.value.columns.findIndex(_=>_.id===e);l!==-1&&(c.value.columns[l].meta={...H(((i=c.value.columns[l])==null?void 0:i.meta)||{}),defaultViewColOrder:u},c.value.columns=(c.value.columns||[]).map(_=>(_.id!==e||(_.meta={...H(_.meta||{}),defaultViewColOrder:u}),_))),(t=(s=c.value)==null?void 0:s.columnsById)!=null&&t[e]&&(c.value.columnsById[e].meta={...H((r=c.value.columns[l])==null?void 0:r.meta),defaultViewColOrder:u})},C=async(e,u,l=!1,n=!1)=>{var i,s,t;if(m.value&&f.value&&(f.value[u]=e,c.value.columns=(i=c.value.columns)==null?void 0:i.map(r=>r.id===e.fk_column_id?{...r,...e,id:e.fk_column_id}:r),A.value[e.fk_column_id]=e),n&&(e!=null&&e.fk_column_id)&&q(e.fk_column_id,e.order),E("viewFieldEdit")){if(e.id&&((s=o==null?void 0:o.value)!=null&&s.id))await w.dbViewColumn.update(o.value.id,e.id,e);else if((t=o.value)!=null&&t.id){const r=await w.dbViewColumn.create(o.value.id,e);return f.value&&(f.value[u]=r),r}}l||(await k(),v==null||v({shouldShowLoading:!1}))},O=g({get(){var e;return((e=o.value)==null?void 0:e.show_system_fields)||!1},set(e){var u;(u=o==null?void 0:o.value)!=null&&u.id&&(m.value||w.dbView.update(o.value.id,{show_system_fields:e}).finally(()=>{k(),v==null||v()}),o.value.show_system_fields=e),x("a:fields:system-fields")}}),J=g(()=>{var e;return((e=f.value)==null?void 0:e.filter(u=>{var l,n,i;return!u.initialShow&&m.value?!1:(n=(l=a==null?void 0:a.value)==null?void 0:l[u.fk_column_id])!=null&&n.pv&&(!y.value||u.title.toLowerCase().includes(y.value.toLowerCase()))?!0:!O.value&&S((i=a==null?void 0:a.value)==null?void 0:i[u.fk_column_id])?!1:y.value===""?!0:u.title.toLowerCase().includes(y.value.toLowerCase())}))||[]}),K=g(()=>{var e,u;return(u=(e=f.value||[])==null?void 0:e.filter(l=>{var n,i,s;return!l.initialShow&&m.value?!1:(i=(n=a==null?void 0:a.value)==null?void 0:n[l.fk_column_id])!=null&&i.pv?!0:!(!O.value&&S((s=a==null?void 0:a.value)==null?void 0:s[l.fk_column_id]))}).filter(l=>!l.show))==null?void 0:u.length}),P=g(()=>{var e,u,l;return((l=(u=(e=f==null?void 0:f.value)==null?void 0:e.filter(n=>{var i,s,t,r,_;return!O.value&&a.value&&((i=a==null?void 0:a.value)!=null&&i[n.fk_column_id])&&S((s=a.value)==null?void 0:s[n.fk_column_id])&&!((r=(t=a.value)==null?void 0:t[n.fk_column_id])!=null&&r.pv)?!1:n.show&&((_=a==null?void 0:a.value)==null?void 0:_[n.fk_column_id])}))==null?void 0:u.sort((n,i)=>n.order-i.order))==null?void 0:l.map(n=>{var i;return(i=a==null?void 0:a.value)==null?void 0:i[n.fk_column_id]}))||[]}),X=(e,u)=>{var n;const l=(n=f.value)==null?void 0:n.findIndex(i=>i.fk_column_id===u.fk_column_id);!l&&l!==0||(M({undo:{fn:i=>{u.show=!i,C(u,l)},args:[e]},redo:{fn:i=>{u.show=i,C(u,l)},args:[e]},scope:N({view:o.value})}),C(u,l,!e))},Y=(e,u,l)=>{var i;const n=(i=f.value)==null?void 0:i.findIndex(s=>s.fk_column_id===e.fk_column_id);!n&&n!==0||(e[u]=l,x("a:fields:style",{style:u,status:l}),C(e,n,!0))};$([()=>{var e;return(e=o==null?void 0:o.value)==null?void 0:e.id},()=>{var e;return(e=c.value)==null?void 0:e.columns}],async([e])=>{var u,l;if(e&&((u=o.value)==null?void 0:u.fk_model_id)===((l=c.value)==null?void 0:l.id)){U.value=!0;try{await k()}catch(n){console.error(n)}U.value=!1}},{immediate:!0});const R=V("180px"),T=async(e,u,l=!1)=>{var n,i;if(!l){const s=Object.keys(u).reduce((t,r)=>(p.value[e][r]&&(r==="width"?t[r]=`${R.value}px`:t[r]=p.value[e][r]),t),{});M({redo:{fn:t=>T(e,t,!0),args:[u]},undo:{fn:t=>T(e,t,!0),args:[s]},scope:N({view:o.value})})}try{!b.value&&E("viewFieldEdit")&&((n=p.value[e])!=null&&n.id)&&await w.dbView.gridColumnUpdate(p.value[e].id,{...u}),(i=p.value)!=null&&i[e]?Object.assign(p.value[e],{...p.value[e],...u}):await k()}catch(s){console.error(s)}};return $(P,e=>{L&&(L.value=e||[])},{immediate:!0}),se(le,L),{fields:f,fieldsMap:z,loadViewColumns:k,filteredFieldList:J,numberOfHiddenFields:K,filterQuery:y,showAll:Q,hideAll:W,saveOrUpdate:C,sortedAndFilteredFields:P,showSystemFields:O,metaColumnById:a,toggleFieldVisibility:X,toggleFieldStyles:Y,isViewColumnsLoading:U,updateGridViewColumn:T,gridViewCols:p,resizingColOldWith:R,isLocalMode:m}},"useViewColumnsOrThrow");function ce(){const o=ae();if(o==null)throw new Error("Please call `useProvideViewColumns` on the appropriate parent component");return o}export{ce as a,fe as u};
