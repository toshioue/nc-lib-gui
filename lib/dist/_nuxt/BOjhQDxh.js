import{f as Me,N as Ae,bL as y,fH as Oe,hf as $e,r as p,ay as Re,aw as je,az as Ee,g as I,fC as Te,hp as Ve,hs as Be,gs as Le,hv as He,L as Pe,cB as Ke,aj as Ne,d4 as K,i as De,H as re,hj as ce,an as ze,ao as Fe,aA as qe,o as m,c as M,P as t,b as A,w as f,al as N,am as G,U as O,T as x,a as b,a8 as H,d9 as S,d as D,t as _,Q as ue,Y as de,n as Ue,S as fe,V as Ge,W as Qe,A as We,ap as Ye,$ as Je,dj as Xe,_ as Ze}from"./B2hUoZAs.js";import{u as ve}from"./CEs-fTPr.js";import{B as et}from"./BXXS6TCz.js";import{M as tt}from"./CY5huSrU.js";import{T as lt}from"./B3nR1Eu5.js";import{C as at,a as st}from"./DMylWvyY.js";import{S as ot,_ as nt}from"./CaxUP45y.js";import"./Coz9Ftud.js";import"./C9qKCFvP.js";import"./1orNHd0L.js";import"./BQQOEPN4.js";import"./R1pHeCcp.js";import"./BGKYJ52S.js";const it={key:0,class:"w-full max-w-full"},rt={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},ct={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},ut={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},dt={class:"flex gap-2 text-gray-500 items-center h-full"},ft={class:"text-xs whitespace-normal"},vt=Me({__name:"MultiSelect",props:{modelValue:{},rowIndex:{},disableOptionCreation:{type:Boolean},location:{}},emits:["update:modelValue"],setup($,{emit:pe}){const me=pe,{isMobileMode:we}=Ae(),r=y(Oe),P=y($e),Q=y(Re,p(!1)),W=y(je,p(!1)),R=y(Ee,p(!1)),z=I(()=>W.value||Q.value||R.value),Y=y(Te,p(!1)),J=y(Ve,p(!1)),T=y(Be,p(void 0)),ge=y(Le,p(!1)),F=p([]),j=p(),u=p(!1),q=p(!1),E=y(He,p(!1)),v=p(),{$api:he}=We(),{isUIAllowed:X,isMetaReadOnly:ye}=Pe(),{isPg:Z,isMysql:ee}=Ke(),V=Ne([]),d=I(()=>{var e,l,a,o;if(r!=null&&r.value.colOptions){const i=r.value.colOptions?r.value.colOptions.options.filter(n=>n.title!=="")||[]:[];for(const n of i.filter(c=>c.order===null))n.title=(e=n.title)==null?void 0:e.replace(/^'/,"").replace(/'$/,"");let w=1;const h=(((l=K(r.value.meta))==null?void 0:l.limitOptions)||[]).reduce((n,c)=>(w<((c==null?void 0:c.order)??0)&&(w=c.order),{...n,[c.id]:c}),{})??{};return!J.value&&R.value&&((a=K(r.value.meta))!=null&&a.isLimitOption)&&(((o=K(r.value.meta))==null?void 0:o.limitOptions)||[]).length?i.filter(n=>{var c,L;return((c=h[n.id])==null?void 0:c.show)!==void 0?(L=h[n.id])==null?void 0:L.show:!1}).map(n=>{var c;return{...n,value:n.title,order:n.id&&h[n.id]?(c=h[n.id])==null?void 0:c.order:w++}}).sort((n,c)=>n.order-c.order):i.map(n=>({...n,value:n.title}))}return[]}),te=I(()=>(d.value??[]).every(e=>e.title!==v.value)),le=I(()=>X("dataEdit")),k=I(()=>(le.value||R.value)&&z.value),g=I({get:()=>{const e=F.value.reduce((l,a)=>{var i;const o=(i=d.value.find(w=>w.id===a)||d.value.find(w=>w.title===a))==null?void 0:i.title;return o&&l.push(o),l},[]);return V.length&&e.push(...V),e},set:e=>{if(te.value&&e.length&&e[e.length-1]===v.value)return be();me("update:modelValue",e.length===0?null:e.join(","))}}),ae=I(()=>$.modelValue?Array.isArray($.modelValue)?$.modelValue:ee(r.value.source_id)?$.modelValue.toString().split(",").sort((e,l)=>{const a=d.value.find(i=>i.title===e),o=d.value.find(i=>i.title===l);return a&&o?a.order-o.order:0}):$.modelValue.toString().split(","):[]);De(()=>{F.value=ae.value.flatMap(e=>{const l=d.value.find(o=>o.title===e||o.title===(e==null?void 0:e.trim())),a=(l==null?void 0:l.id)||(l==null?void 0:l.title);return a?[a]:[]})}),re(()=>$.modelValue,()=>{F.value=ae.value.flatMap(e=>{const l=d.value.find(a=>a.title===e||a.title===(e==null?void 0:e.trim()));return l&&(l.id||l.title)?[l.id||l.title]:[]})}),re(u,(e,l)=>{var a,o,i,w,h,n;e||(v.value=""),k.value&&(e?(n=(h=(w=j.value)==null?void 0:w.$el)==null?void 0:h.querySelector("input"))==null||n.focus():(i=(o=(a=j.value)==null?void 0:a.$el)==null?void 0:o.querySelector("input"))==null||i.blur())}),ve(W,e=>{var l;switch(e.key){case"Escape":u.value=!1;break;case"Enter":k.value&&z.value&&!u.value&&(u.value=!0);break;case" ":break;case"ArrowUp":case"ArrowDown":case"ArrowRight":case"ArrowLeft":case"Delete":break;default:if(!k.value){e.preventDefault();break}!(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)&&((l=e.key)==null?void 0:l.length)===1&&!Xe()&&(e.stopPropagation(),u.value=!0);break}}),ve(u,e=>{e.key==="Escape"&&(u.value=!1)});const B=p(0);async function be(){var e,l;if(!v.value||Y.value)return!1;try{V.push(v.value);const a=v==null?void 0:v.value;if(v.value="",B.value++,a&&!d.value.some(o=>o.title===a)){const o=[...d.value];o.push({title:a,value:a,color:ce.light[(d.value.length+1)%ce.light.length]}),r.value.colOptions={options:o.map(({value:w,...h})=>h)};const i={...r.value};i.cdf&&(Z(r.value.source_id)&&(i.cdf=i.cdf.substring(i.cdf.indexOf("'")+1,i.cdf.lastIndexOf("'"))),!ee(r.value.source_id)&&!Z(r.value.source_id)&&(i.cdf=i.cdf.replace(/''/g,"'"))),await he.dbTableColumn.update(((e=r.value)==null?void 0:e.fk_column_id)||((l=r.value)==null?void 0:l.id),i),B.value--,B.value||(g.value=[...g.value],V.splice(0,V.length))}else B.value--}catch(a){console.log(a),B.value--,ze.error(await Fe(a))}}const ke=()=>{var e,l,a;v.value=(a=(l=(e=j.value)==null?void 0:e.$el)==null?void 0:l.querySelector(".ant-select-selection-search-input"))==null?void 0:a.value},xe=(e,l)=>{var a,o;((a=e.target)!=null&&a.classList.contains("ant-tag-close-icon")||(o=e.target)!=null&&o.closest(".ant-tag-close-icon"))&&(e.stopPropagation(),l())},_e=()=>{q.value||(u.value=k.value&&!u.value)};qe(document,"click",e=>{var l;u.value&&j.value&&!j.value.$el.contains(e.target)&&!((l=document.querySelector(".nc-dropdown-multi-select-cell.active"))!=null&&l.contains(e.target))&&(Q.value=!1,u.value=!1)},!0);const Ce=I(()=>g.value.reduce((e,l)=>{const a=d.value.find(o=>o.value===l);return a&&e.push(a),e},[])),Ie=e=>{if(e.key==="Tab"){u.value=!1;return}else if(e.key==="Escape"&&R.value){u.value=!1;return}e.stopPropagation()},Se=()=>{var e;q.value=!0,setTimeout(()=>{q.value=!1},250),!(ge.value&&((e=g.value)!=null&&e.length))&&(u.value=!0)};return(e,l)=>{var L;const a=Ye,o=lt,i=at,w=st,h=Je,n=ot,c=nt;return m(),M("div",{class:x(["nc-cell-field nc-multi-select h-full w-full flex items-center",{"read-only":t(P),"max-w-full":t(R)}]),onClick:_e},[!t(J)&&t(R)&&((L=("parseProp"in e?e.parseProp:t(K))(t(r).meta))!=null&&L.isList)?(m(),M("div",it,[A(w,{value:t(g),"onUpdate:value":l[0]||(l[0]=s=>ue(g)?g.value=s:null),disabled:t(P)||!t(k),class:"nc-field-layout-list",onClick:l[1]||(l[1]=de(()=>{},["stop"]))},{default:f(()=>[(m(!0),M(N,null,G(t(d),s=>(m(),O(i,{key:s.title,value:s.title,"data-testid":`select-option-${t(r).title}-${e.location==="filter"?"filter":e.rowIndex}`,class:x(`nc-select-option-${t(r).title}-${s.title}`)},{default:f(()=>[A(o,{class:"rounded-tag max-w-full",color:s.color},{default:f(()=>[b("span",{style:H({color:t(S).isReadable(s.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(s.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:"text-small"},[A(a,{class:"truncate max-w-full","show-on-truncate-only":""},{title:f(()=>[D(_(s.title),1)]),default:f(()=>[b("span",rt,_(s.title),1)]),_:2},1024)],4)]),_:2},1032,["color"])]),_:2},1032,["value","data-testid","class"]))),128))]),_:1},8,["value","disabled"])])):(m(),M(N,{key:1},[t(z)?(m(),O(c,{key:1,ref_key:"aselect",ref:j,value:t(g),"onUpdate:value":l[3]||(l[3]=s=>ue(g)?g.value=s:null),mode:"multiple",class:x(["w-full overflow-hidden",{"caret-transparent":!t(le)}]),bordered:!1,"clear-icon":"","show-search":!t(we),"show-arrow":t(k)&&!t(P),open:t(u)&&t(k),disabled:t(P)||!t(k),"dropdown-class-name":`nc-dropdown-multi-select-cell !min-w-156px ${t(u)?"active":""}`,onSearch:ke,onKeydown:Ie,onFocus:Se,onBlur:l[4]||(l[4]=s=>u.value=!1)},{suffixIcon:f(()=>[A(h,{icon:"arrowDown",class:"text-gray-700 nc-select-expand-btn"})]),tagRender:f(({value:s,onClose:se})=>{var oe,ne;return[t(d).find(C=>C.title===s)?(m(),O(o,{key:0,class:x(["rounded-tag nc-selected-option",{"!my-0":!t(T)||t(T)===1}]),style:{display:"flex",alignItems:"center"},color:(oe=t(d).find(C=>C.title===s))==null?void 0:oe.color,closable:t(k)&&(t(g).length>1||!((ne=t(r))!=null&&ne.rqd)),"close-icon":("h"in e?e.h:t(Ue))(t(tt),{class:["ms-close-icon"]}),onClick:C=>xe(C,se),onClose:se},{default:f(()=>{var C,ie;return[b("span",{style:H({color:t(S).isReadable(((C=t(d).find(U=>U.title===s))==null?void 0:C.color)||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(((ie=t(d).find(U=>U.title===s))==null?void 0:ie.color)||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:x({"text-sm":t(E),"text-small":!t(E)})},_(s),7)]}),_:2},1032,["class","color","closable","close-icon","onClick","onClose"])):fe("",!0)]}),default:f(()=>[(m(!0),M(N,null,G(t(d),s=>(m(),O(n,{key:s.id||s.title,value:s.title,"data-testid":`select-option-${t(r).title}-${e.location==="filter"?"filter":e.rowIndex}`,class:x(`nc-select-option-${t(r).title}-${s.title}`),onClick:l[2]||(l[2]=de(()=>{},["stop"]))},{default:f(()=>[A(o,{class:"rounded-tag max-w-full",color:s.color},{default:f(()=>[b("span",{style:H({color:t(S).isReadable(s.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(s.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:x({"text-sm":t(E),"text-small":!t(E)})},[A(a,{class:"truncate max-w-full","show-on-truncate-only":""},{title:f(()=>[D(_(s.title),1)]),default:f(()=>[b("span",ut,_(s.title),1)]),_:2},1024)],6)]),_:2},1032,["color"])]),_:2},1032,["value","data-testid","class"]))),128)),!t(ye)&&t(v)&&t(te)&&!t(Y)&&!e.disableOptionCreation&&t(X)("fieldEdit")?(m(),O(n,{key:t(v),value:t(v)},{default:f(()=>[b("div",dt,[(m(),O(Ge(("iconMap"in e?e.iconMap:t(Qe)).plusThick),{class:"min-w-4"})),b("div",ft,[D(_(e.$t("msg.selectOption.createNewOptionNamed"))+" ",1),b("strong",null,_(t(v)),1)])])]),_:1},8,["value"])):fe("",!0)]),_:1},8,["value","show-search","show-arrow","open","disabled","class","dropdown-class-name"])):(m(),M("div",{key:0,class:"flex flex-wrap",style:H({display:"-webkit-box","max-width":"100%","-webkit-line-clamp":("rowHeightTruncateLines"in e?e.rowHeightTruncateLines:t(et))(t(T)),"-webkit-box-orient":"vertical",overflow:"hidden"})},[(m(!0),M(N,null,G(t(Ce),s=>(m(),O(o,{key:s.value,class:x(["rounded-tag max-w-full",{"!my-0":!t(T)||t(T)===1}]),color:s.color},{default:f(()=>[b("span",{style:H({color:t(S).isReadable(s.color||"#ccc","#fff",{level:"AA",size:"large"})?"#fff":t(S).mostReadable(s.color||"#ccc",["#0b1d05","#fff"]).toHex8String()}),class:x({"text-sm":t(E),"text-small":!t(E)})},[A(a,{class:"truncate max-w-full","show-on-truncate-only":""},{title:f(()=>[D(_(s.title),1)]),default:f(()=>[b("span",ct,_(s.title),1)]),_:2},1024)],6)]),_:2},1032,["class","color"]))),128))],4))],64))],2)}}}),At=Ze(vt,[["__scopeId","data-v-6504aadc"]]);export{At as default};
