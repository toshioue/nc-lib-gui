import{u as Ie}from"./DTl_5Njz.js";import{cP as $e,at as Ce,cB as Se,bL as Q,r as v,c$ as _e,az as be,cQ as Pe,g7 as Ve,aj as le,ai as qe,fC as Ue,g,g3 as Ae,cU as se,d4 as ge,cf as je,cg as Le,h_ as Fe,H as ie,u as Ne,gh as j,fI as k,ga as ze,gb as Be,an as F,ao as W,ca as Ge,A as Je}from"./BLdk6lRf.js";import{a as He}from"./lY7N86Qy.js";const[xe,Ke]=Ie((s,f,V,L=N=>{})=>{var fe,ce,pe;const{metas:N,getMeta:Oe}=$e(),{base:q}=Ce(Se()),{$api:O,$e:X}=Je(),ue=Q(_e,v()),we=Q(be,v(!1)),{addUndo:re,clone:G,defineViewScope:ne}=Pe(),oe=Q(Ve,v(null)),w=v(),I=v(),o=le({page:1,query:"",size:10}),E=v(0),p=le({page:1,query:"",size:10}),m=v(0),Y=v(!1),$=v([]),z=v([]),U=v([]),Z=v(!1),C=v([]),ve=le({state:null}),S=v(0),{t:J}=qe(),de=Q(Ue,v(!1)),c=g(()=>{var e;return(e=s.value)==null?void 0:e.colOptions}),{sharedView:x}=Ae(),D=((fe=q.value)==null?void 0:fe.id)||((pe=(ce=x.value)==null?void 0:ce.view)==null?void 0:pe.base_id),_=g(()=>{var e,a;return(a=N==null?void 0:N.value)==null?void 0:a[(e=s==null?void 0:s.value)==null?void 0:e.fk_model_id]}),r=g(()=>{var e,a;return(a=N.value)==null?void 0:a[(e=c.value)==null?void 0:e.fk_related_model_id]}),b=g(()=>_.value.columns.filter(e=>e.pk).map(e=>{var a,l;return(l=(a=f==null?void 0:f.value)==null?void 0:a.row)==null?void 0:l[e.title]}).join("___")),H=e=>{var a,l;return(l=(a=r.value)==null?void 0:a.columns)==null?void 0:l.filter(t=>t.pk).map(t=>(e==null?void 0:e[t.title])??(e==null?void 0:e[t.id])).join("___")},Ee=async()=>{await Oe(c.value.fk_related_model_id)},P=g(()=>{var e,a,l,t,i;return((i=((a=(e=r.value)==null?void 0:e.columns)==null?void 0:a.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.title)||""}),me=g(()=>{var e,a,l,t,i;return((i=((a=(e=r.value)==null?void 0:e.columns)==null?void 0:a.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.id)||""}),Re=g(()=>{var e,a,l;return((l=(a=(e=r.value)==null?void 0:e.columns)==null?void 0:a.filter(t=>t.pk))==null?void 0:l.map(t=>t.title))??[]}),K=g(()=>{var e,a,l,t,i;return(i=((a=(e=_.value)==null?void 0:e.columns)==null?void 0:a.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.title}),B=g(()=>{var l,t,i,u,d,R;let e={type:"",format:""};const a=((t=(l=r.value)==null?void 0:l.columns)==null?void 0:t.find(n=>n.pv))||((u=(i=r==null?void 0:r.value)==null?void 0:i.columns)==null?void 0:u[0]);return a&&((a==null?void 0:a.uidt)===se.DateTime&&(e={type:a==null?void 0:a.uidt,format:`${((d=ge(a==null?void 0:a.meta))==null?void 0:d.date_format)??je[0]} ${((R=ge(a==null?void 0:a.meta))==null?void 0:R.time_format)??Le[0]}`}),(a==null?void 0:a.uidt)===se.Time&&(e={type:a==null?void 0:a.uidt,format:`${Le[0]}`})),e}),Te=g(()=>f.value.row[K.value]&&B.value.type&&B.value.format?Fe(f.value.row[K.value],B.value.format,B.value.format!==se.Time):f.value.row[K.value]),M=async(e,a=!1)=>{var l,t,i,u,d,R;e&&(ve.state=e);try{let n=o.size*(o.page-1)-E.value;if((n<0||a)&&(n=0,E.value=0,o.page=1),Z.value=!0,de.value){const y=Ne().currentRoute;let T;if(we.value){const{formState:A}=He();T=A==null?void 0:A.value}w.value=await O.public.dataRelationList(y.value.params.viewId,s.value.id,{},{headers:{"xc-password":oe.value},query:{limit:o.size,offset:n,where:o.query&&`(${P.value},like,${o.query})`,fields:[P.value,...Re.value],rowData:JSON.stringify(T)}})}else if(V!=null&&V.value)w.value=await O.dbTableRow.list(j,D,(l=r==null?void 0:r.value)==null?void 0:l.id,{limit:o.size,offset:n,where:o.query&&`(${P.value},like,${o.query})`,linkColumnId:s.value.fk_column_id||s.value.id,linkRowData:JSON.stringify(f.value.row)});else{let h;try{(t=f.value)!=null&&t.row&&(h=Object.keys((i=f.value)==null?void 0:i.row).reduce((y,T)=>(f.value.row[T]!==f.value.oldRow[T]&&(y[T]=f.value.row[T]),y),{}))}catch{}w.value=await O.dbTableRow.nestedChildrenExcludedList(j,D,_.value.id,encodeURIComponent(b.value),c.value.type,(u=s==null?void 0:s.value)==null?void 0:u.id,{limit:String(o.size),offset:String(n),where:o.query&&`(${P.value},like,${o.query})`,linkRowData:h?JSON.stringify(h):void 0})}(d=w.value)==null||d.list.forEach((h,y)=>{C.value[y]=!1,U.value[y]=!1}),(R=w.value)!=null&&R.list&&e&&e[s.value.title]&&w.value.list.forEach((h,y)=>{([k.BELONGS_TO,k.ONE_TO_ONE].includes(c.value.type)?[e[s.value.title]]:e[s.value.title]).find(A=>{let ye=!0;for(const he in A)A[he]!==h[he]&&(ye=!1);return ye})&&(C.value[y]=!0)})}catch(n){const h=await ze(n);if(h.error===Be.INVALID_OFFSET_VALUE)return o.page=0,M(e,!0);F.error(`${J("msg.error.failedToLoadList")}: ${h.message}`)}finally{Z.value=!1}},ee=async(e=!1)=>{var a,l,t,i,u,d,R;try{if(Y.value=!0,[k.BELONGS_TO,k.ONE_TO_ONE].includes(c.value.type)||!b.value||!s.value)return;let n=p.size*(p.page-1)+m.value;n<0||e?(n=0,m.value=0,p.page=1):n>=S.value&&(n=0),de.value?I.value=await O.public.dataNestedList((a=x.value)==null?void 0:a.uuid,encodeURIComponent(b.value),c.value.type,s.value.id,{limit:String(p.size),offset:String(n),where:p.query&&`(${P.value},like,${p.query})`},{headers:{"xc-password":oe.value}}):I.value=await O.dbTableRow.nestedList(j,((l=q==null?void 0:q.value)==null?void 0:l.id)||((i=(t=x.value)==null?void 0:t.view)==null?void 0:i.base_id),_.value.id,encodeURIComponent(b.value),c.value.type,(u=s==null?void 0:s.value)==null?void 0:u.id,{limit:String(p.size),offset:String(n),where:p.query&&`(${P.value},like,${p.query})`}),(d=I.value)==null||d.list.forEach((h,y)=>{z.value[y]=!0,$.value[y]=!1}),p.query||(S.value=((R=I.value)==null?void 0:R.pageInfo.totalRows)??0)}catch(n){F.error(`${J("msg.error.failedToLoadChildrenList")}: ${await W(n)}`)}finally{Y.value=!1}},ke=async(e,a)=>{Ge.confirm({title:"Do you want to delete the record?",type:"warning",onOk:async()=>{const l=H(e);try{const t=await O.dbTableRow.delete(j,D,r.value.id,encodeURIComponent(l));if(t.message)return F.info(`Record delete failed: ${`Unable to delete record with ID ${l} because of the following:
              
${t.message.join(`
`)}.

              Clear the data first & try again`})}`),!1;L==null||L({shouldShowLoading:!1}),V!=null&&V.value||await ee(),a==null||a(e),X("a:links:delete-related-row")}catch(t){F.error(`${J("msg.error.deleteFailed")}: ${await W(t)}`)}}})},ae=async(e,{metaValue:a=_.value}={},l=!1,t)=>{var i;try{m.value=m.value-1,E.value=E.value-1,U.value[t]=!0,$.value[t]=!0,await O.dbTableRow.nestedRemove(j,q.value.id,a.id,encodeURIComponent(b.value),c.value.type,(i=s==null?void 0:s.value)==null?void 0:i.id,encodeURIComponent(H(e))),l||re({redo:{fn:u=>ae(u,{},!0,t),args:[G(e)]},undo:{fn:u=>te(u,{},!0,t),args:[G(e)]},scope:ne({view:ue.value})}),C.value[t]=!1,z.value[t]=!1,c.value.type!==k.BELONGS_TO&&c.value.type!==k.ONE_TO_ONE&&(S.value=S.value-1)}catch(u){F.error(`${J("msg.error.unlinkFailed")}: ${await W(u)}`)}finally{U.value[t]=!1,$.value[t]=!1}L==null||L({shouldShowLoading:!1}),X("a:links:unlink")},te=async(e,{metaValue:a=_.value}={},l=!1,t)=>{var i,u;try{U.value[t]=!0,$.value[t]=!0,m.value=m.value+1,E.value=E.value+1,await O.dbTableRow.nestedAdd(j,q.value.id,a.id,encodeURIComponent(b.value),c.value.type,(i=s==null?void 0:s.value)==null?void 0:i.id,encodeURIComponent(H(e))),l||re({redo:{fn:d=>te(d,{},!0,t),args:[G(e)]},undo:{fn:d=>ae(d,{},!0,t),args:[G(e)]},scope:ne({view:ue.value})}),C.value[t]=!0,z.value[t]=!0,c.value.type!==k.BELONGS_TO&&c.value.type!==k.ONE_TO_ONE?S.value=S.value+1:(C.value=Array((u=w.value)==null?void 0:u.list.length).fill(!1),C.value[t]=!0)}catch(d){F.error(`Linking failed: ${await W(d)}`)}finally{U.value[t]=!1,$.value[t]=!1}L==null||L({shouldShowLoading:!1}),X("a:links:link")};return ie(o,async()=>{await M(ve.state)}),ie(p,async()=>{await ee()}),ie(I,async()=>{var e;(e=I.value)==null||e.list.forEach((a,l)=>{z.value[l]=!0,$.value[l]=!1})}),{relatedTableMeta:r,loadRelatedTableMeta:Ee,relatedTableDisplayValueProp:P,displayValueTypeAndFormatProp:B,childrenExcludedList:w,childrenList:I,childrenListCount:S,childrenListOffsetCount:m,childrenExcludedOffsetCount:E,rowId:b,childrenExcludedListPagination:o,childrenListPagination:p,displayValueProp:K,meta:_,unlink:ae,link:te,loadChildrenExcludedList:M,loadChildrenList:ee,isChildrenExcludedListLinked:C,isChildrenListLinked:z,isChildrenListLoading:$,isChildrenExcludedListLoading:U,row:f,isChildrenLoading:Y,isChildrenExcludedLoading:Z,deleteRelatedRow:ke,getRelatedTableRowId:H,headerDisplayValue:Te,relatedTableDisplayValuePropId:me,resetChildrenExcludedOffsetCount:()=>{E.value=0},resetChildrenListOffsetCount:()=>{m.value=0}}},"ltar-store");function De(){const s=Ke();if(s==null)throw new Error("Please call `useLTARStore` on the appropriate parent component");return s}export{De as a,xe as u};
