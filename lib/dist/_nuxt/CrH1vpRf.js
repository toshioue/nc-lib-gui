import{ai as Oe,cZ as Ne,c_ as Ee,az as ye,cN as _e,cR as je,bN as Le,hq as Ke,g as ae,gL as ee,aj as E,ak as X,hR as Ue,hS as qe,d2 as L,f_ as Pe,A as $e,cS as Qe,gK as Ge,ar as Je,u as He,N as Xe,r as k,dB as Ze,gA as We,L as Ye,cr as be,d7 as Ve,df as ze,hT as me}from"./Cgw6cdOy.js";import{a as ke}from"./DFiWgQ57.js";import{d as eo,p as xe,e as b,r as N,f as re,i as oo,h as Te}from"./D7yS5JAk.js";import{b as to,c as no,d as io}from"./DpDIhxXu.js";function ro(ve){const{meta:o,viewMeta:P,formattedData:R,paginationData:f,callbacks:e}=ve,{t:M}=Oe(),{getMeta:oe,metas:ge}=Ne(),{addUndo:te,clone:K,defineViewScope:ne}=Ee(),{base:$}=ye(_e()),{$api:Q}=$e(),{isPaginationLoading:V}=ye(je()),_=Le(Ke),Se=ae({get(){return!!R.value.length&&R.value.every(t=>t.rowMeta.selected)},set(t){R.value.forEach(n=>n.rowMeta.selected=t)}});function se(t=R.value.length,n=o.value){return R.value.splice(t,0,{row:{...eo(n==null?void 0:n.columns)},oldRow:{},rowMeta:{new:!0}}),R.value[t]}async function ue(t,n={},{metaValue:r=o.value,viewMetaValue:d=P.value}={},i=!1){var m,h;const I=t.row;t.rowMeta&&(t.rowMeta.saving=!0);try{const{missingRequiredColumns:c,insertObj:a}=await xe({meta:r,ltarState:n,getMeta:oe,row:I,undo:i});if(c.size)return;const S=await Q.dbViewRow.create(ee,$==null?void 0:$.value.id,r==null?void 0:r.id,d==null?void 0:d.id,{...a,...n||{}});if(await(_==null?void 0:_.trigger()),!i){Object.assign(t,{row:{...S,...I},rowMeta:{...t.rowMeta||{},new:void 0},oldRow:{...S}});const y=b(S,r==null?void 0:r.columns),s=N(S,r==null?void 0:r.columns),v=re(s,R.value);te({redo:{fn:async function(u,l,g){var z,j;u.row={...s,...u.row};const C=await ue(u,l,void 0,!0);v!==-1&&g.pageSize===f.value.pageSize?g.page===f.value.page?R.value.splice(v,0,{row:{...u,...C},rowMeta:u.rowMeta,oldRow:u.oldRow}):await((z=e==null?void 0:e.changePage)==null?void 0:z.call(e,g.page)):await((j=e==null?void 0:e.loadData)==null?void 0:j.call(e))},args:[K(t),K(n),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(u){await Z(u),v!==-1&&R.value.splice(v,1),f.value.totalRows=f.value.totalRows-1},args:[y]},scope:ne({view:P.value})})}return await((m=e==null?void 0:e.syncCount)==null?void 0:m.call(e)),S}catch(c){E.error(await X(c))}finally{t.rowMeta&&(t.rowMeta.saving=!1),await((h=e==null?void 0:e.globalCallback)==null?void 0:h.call(e))}}async function de(t,{metaValue:n=o.value,viewMetaValue:r=P.value}={},d=!1){var I,m,h;V.value=!0;const i=K((n==null?void 0:n.columns)||[]).filter(c=>!c.pk&&(Ue(c)||qe(c))).map(c=>c.title);try{const c=((I=await Promise.all(t.map(async S=>{const{missingRequiredColumns:y,insertObj:s}=await xe({meta:n,ltarState:{},getMeta:oe,row:S.row,undo:d});if(y.size===0)return i.forEach(v=>delete s[v]),s})))==null?void 0:I.filter(Boolean))??[],a=await Q.dbDataTableRow.create(n==null?void 0:n.id,c,{viewId:r==null?void 0:r.id});return await((m=e==null?void 0:e.syncCount)==null?void 0:m.call(e)),a}catch(c){E.error(await X(c))}finally{await((h=e==null?void 0:e.globalCallback)==null?void 0:h.call(e)),V.value=!1}}async function we(t,n,{metaValue:r=o.value,viewMetaValue:d=P.value}={},i=!1){var I;t.rowMeta&&(t.rowMeta.saving=!0);try{const m=b(t.row,r==null?void 0:r.columns),h=await Q.dbViewRow.update(ee,$==null?void 0:$.value.id,r==null?void 0:r.id,d==null?void 0:d.id,m,{[n]:t.row[n]??null});return await(_==null?void 0:_.trigger({fields:[{title:n}]})),i||(te({redo:{fn:async function(a,S,y){var v,w,u;const s=await we(a,S,void 0,!0);if(y.page===f.value.page&&y.pageSize===f.value.pageSize){const l=re(N(a.row,(v=o==null?void 0:o.value)==null?void 0:v.columns),R.value);if(l!==-1){const g=R.value[l];Object.assign(g.row,s),Object.assign(g.oldRow,s)}else await((w=e==null?void 0:e.loadData)==null?void 0:w.call(e))}else await((u=e==null?void 0:e.changePage)==null?void 0:u.call(e,y.page))},args:[K(t),n,{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(a,S,y){var v,w,u;const s=await we({row:a.oldRow,oldRow:a.row,rowMeta:a.rowMeta},S,void 0,!0);if(y.page===f.value.page&&y.pageSize===f.value.pageSize){const l=re(N(a.row,(v=o==null?void 0:o.value)==null?void 0:v.columns),R.value);if(l!==-1){const g=R.value[l];Object.assign(g.row,s),Object.assign(g.oldRow,s)}else await((w=e==null?void 0:e.loadData)==null?void 0:w.call(e))}else await((u=e==null?void 0:e.changePage)==null?void 0:u.call(e,y.page))},args:[K(t),n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:P.value})}),Object.assign(t.row,r.columns.reduce((c,a)=>(a.title in h&&(a.uidt===L.Formula||a.uidt===L.QrCode||a.uidt===L.Barcode||a.uidt===L.Rollup||a.uidt===L.Checkbox||a.uidt===L.User||a.uidt===L.LastModifiedTime||a.uidt===L.LastModifiedBy||a.uidt===L.Lookup||a.uidt===L.Button||a.uidt===L.Attachment||a.au||oo(a==null?void 0:a.cdf)&&/ on update /i.test(a.cdf))&&(c[a.title]=h[a.title]),c),{})),Object.assign(t.oldRow,h)),await((I=e==null?void 0:e.globalCallback)==null?void 0:I.call(e)),h}catch(m){t.row[n]=t.oldRow[n],E.error(`${M("msg.error.rowUpdateFailed")}: ${await X(m)}`)}finally{t.rowMeta&&(t.rowMeta.saving=!1)}}async function ce(t,n,r,d={}){if(t.rowMeta&&(t.rowMeta.changed=!1),await Pe(()=>{var i,I;return!((i=t.rowMeta)!=null&&i.new&&((I=t.rowMeta)!=null&&I.saving))}).toMatch(i=>i),t.rowMeta.new)return await ue(t,r,d);n&&await we(t,n,d)}async function pe(t,n,{metaValue:r=o.value,viewMetaValue:d=P.value}={},i=!1){var h,c;const I=[];for(const a of t)a.rowMeta&&(a.rowMeta.changed=!1),I.push(Pe(()=>{var S,y;return!((S=a.rowMeta)!=null&&S.new&&((y=a.rowMeta)!=null&&y.saving))}).toMatch(S=>S));await Promise.all(I);const m=[];for(const a of t){a.rowMeta&&(a.rowMeta.saving=!0);const S=N(a.row,r==null?void 0:r.columns),y=n.reduce((s,v)=>(s[v]=a.row[v],s),{});m.push({...y,...S})}await Q.dbTableRow.bulkUpdate(ee,r==null?void 0:r.base_id,r==null?void 0:r.id,m),await(_==null?void 0:_.trigger({fields:n.map(a=>({title:a}))})),i||te({redo:{fn:async function(S,y,s){var v,w,u;if(await pe(S,y,{metaValue:r,viewMetaValue:d},!0),s.page===f.value.page&&s.pageSize===f.value.pageSize)for(const l of S){const g=re(N(l.row,(v=o==null?void 0:o.value)==null?void 0:v.columns),R.value);if(g!==-1){const C=R.value[g];Object.assign(C.row,l.row),Object.assign(C.oldRow,l.row)}else{await((w=e==null?void 0:e.loadData)==null?void 0:w.call(e));break}}else await((u=e==null?void 0:e.changePage)==null?void 0:u.call(e,s.page))},args:[K(t),K(n),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(S,y,s){var v,w,u;if(await pe(S,y,{metaValue:r,viewMetaValue:d},!0),s.page===f.value.page&&s.pageSize===f.value.pageSize)for(const l of S){const g=re(N(l.row,(v=o==null?void 0:o.value)==null?void 0:v.columns),R.value);if(g!==-1){const C=R.value[g];Object.assign(C.row,l.row),Object.assign(C.oldRow,l.row)}else{await((w=e==null?void 0:e.loadData)==null?void 0:w.call(e));break}}else await((u=e==null?void 0:e.changePage)==null?void 0:u.call(e,s.page))},args:[K(t.map(a=>({row:a.oldRow,oldRow:a.row,rowMeta:a.rowMeta}))),n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:d})});for(const a of t)a.rowMeta&&(a.rowMeta.saving=!1);r.columns.some(a=>[L.QrCode,L.LastModifiedTime,L.Barcode,L.Formula,L.Lookup,L.Rollup,L.LinkToAnotherRecord,L.LastModifiedBy].includes(a.uidt))&&await((h=e==null?void 0:e.loadData)==null?void 0:h.call(e)),await((c=e==null?void 0:e.globalCallback)==null?void 0:c.call(e))}async function J(t,{metaValue:n=o.value,viewMetaValue:r=P.value}={}){var d,i;r&&(await Q.dbTableRow.bulkUpdateAll(ee,n==null?void 0:n.base_id,n==null?void 0:n.id,t,{viewId:r.id}),await(_==null?void 0:_.trigger()),await((d=e==null?void 0:e.loadData)==null?void 0:d.call(e)),await((i=e==null?void 0:e.globalCallback)==null?void 0:i.call(e)))}const le=async(t,n,r,d,{metaValue:i=o.value}={})=>{try{await Q.dbTableRow.nestedAdd(ee,$.value.id,i==null?void 0:i.id,encodeURIComponent(t),d,r.title,encodeURIComponent(n))}catch(I){E.error(await X(I))}},W=async(t,{metaValue:n=o.value}={})=>{var d;const r=b(t,n==null?void 0:n.columns);for(const i of(n==null?void 0:n.columns)??[]){if(i.uidt!==L.LinkToAnotherRecord)continue;const I=i.colOptions,m=(d=ge.value)==null?void 0:d[I==null?void 0:I.fk_related_model_id];if(to(i)||no(i)){const h=t[i.title]??[];for(const c of h)await le(r,b(c,m.columns),i,I.type,{metaValue:n})}else io(i)&&t[i.title]&&await le(r,b(t[i.title],m.columns),i,I.type,{metaValue:n})}};async function Z(t,{metaValue:n=o.value,viewMetaValue:r=P.value}={}){if(!t)throw new Error("Delete not allowed for table which doesn't have primary Key");const d=await Q.dbViewRow.delete("noco",$.value.id,n==null?void 0:n.id,r==null?void 0:r.id,encodeURIComponent(t));return await(_==null?void 0:_.trigger()),d.message?(E.info(`Record delete failed: ${`Unable to delete record with ID ${t} because of the following:
              
${d.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}async function he(t,n){var r,d,i,I,m;try{const h=R.value[t];if(!h.rowMeta.new){const c=(d=(r=o==null?void 0:o.value)==null?void 0:r.columns)==null?void 0:d.filter(y=>y.pk).map(y=>h.row[y.title]).join("___"),a=await Q.dbTableRow.read(ee,$==null?void 0:$.value.id,(i=o.value)==null?void 0:i.id,encodeURIComponent(c),{getHiddenColumn:!0});if(h.row=a,!await Z(c))return;n||te({redo:{fn:async function(s){var u;await Z(s);const v=N(h.row,(u=o==null?void 0:o.value)==null?void 0:u.columns),w=re(v,R.value);w!==-1&&R.value.splice(w,1),f.value.totalRows=f.value.totalRows-1},args:[c]},undo:{fn:async function(s,v,w){var l,g,C;const u=N(s.row,(l=o.value)==null?void 0:l.columns);s.row={...u,...s.row},await ue(s,v,{},!0),W(s.row),t!==-1&&w.pageSize===f.value.pageSize?w.page===f.value.page?R.value.splice(t,0,s):await((g=e==null?void 0:e.changePage)==null?void 0:g.call(e,w.page)):await((C=e==null?void 0:e.loadData)==null?void 0:C.call(e))},args:[K(h),{},{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:P.value})})}R.value.splice(t,1),await((I=e==null?void 0:e.syncCount)==null?void 0:I.call(e))}catch(h){E.error(`${M("msg.error.deleteRowFailed")}: ${await X(h)}`)}await((m=e==null?void 0:e.globalCallback)==null?void 0:m.call(e))}async function De(){var i,I,m,h,c,a,S,y;let t=R.value.length;const n=[];let r="";for(;t--;){const{row:s,rowMeta:v}=R.value[t];if(v.selected&&!v.new){const w=Te((i=o==null?void 0:o.value)==null?void 0:i.columns),u=b(s,(I=o==null?void 0:o.value)==null?void 0:I.columns),l=N(s,(m=o==null?void 0:o.value)==null?void 0:m.columns);w&&u&&(r||(r=w),n.push({[r]:u,pkData:l,row:K(R.value[t]),rowIndex:t}))}}if(!n.length)return;V.value=!0;const{list:d}=await Q.dbTableRow.list(ee,$==null?void 0:$.value.id,(h=o.value)==null?void 0:h.id,{pks:n.map(s=>s[r]).join(",")});try{for(const s of n){const v=s.row,w=N(v.row,(c=o==null?void 0:o.value)==null?void 0:c.columns),u=d.find(l=>Object.keys(w).every(g=>w[g]===l[g]));v.row=K(u)}await Y(n.map(s=>s.pkData))}catch(s){return E.error(`${M("msg.error.deleteRowFailed")}: ${await X(s)}`)}if(!n.length){V.value=!1;return}te({redo:{fn:async function(v){var u,l,g,C;V.value=!0;const w=await Y(v.map(z=>z.pkData));if(Array.isArray(w))for(const{row:z}of v){const j=N(z.row,(u=o==null?void 0:o.value)==null?void 0:u.columns),H=re(j,R.value);H!==-1&&R.value.splice(H,1),f.value.totalRows=f.value.totalRows-1}await((l=e==null?void 0:e.syncCount)==null?void 0:l.call(e)),await((g=e==null?void 0:e.syncPagination)==null?void 0:g.call(e)),await((C=e==null?void 0:e.globalCallback)==null?void 0:C.call(e))},args:[n]},undo:{fn:async function(v,w){var g,C;const u=v.map(z=>{var H;const j=N(z.row,(H=o.value)==null?void 0:H.columns);return z.row={...j,...z.row},z}).reverse(),l=await de(u.map(z=>z.row),void 0,!0);if(Array.isArray(l))for(const{row:z,rowIndex:j}of u)W(z.row),j!==-1&&w.pageSize===f.value.pageSize?w.page===f.value.page?R.value.splice(j,0,z):await((g=e==null?void 0:e.changePage)==null?void 0:g.call(e,w.page)):await((C=e==null?void 0:e.loadData)==null?void 0:C.call(e))},args:[n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:P.value})}),await((a=e==null?void 0:e.syncCount)==null?void 0:a.call(e)),await((S=e==null?void 0:e.syncPagination)==null?void 0:S.call(e)),await((y=e==null?void 0:e.globalCallback)==null?void 0:y.call(e))}async function Re(t){var h,c,a,S,y,s,v,w;if(!t._start||!t._end)return;const n=Math.max(t._start.row,t._end.row),r=Math.min(t._start.row,t._end.row);let d=n+1;const i=[];let I="";for(;d--;){try{const{row:u,rowMeta:l}=R.value[d];if(!l.new){const g=Te((h=o==null?void 0:o.value)==null?void 0:h.columns),C=b(u,(c=o==null?void 0:o.value)==null?void 0:c.columns),z=N(u,(a=o==null?void 0:o.value)==null?void 0:a.columns);g&&C&&(I||(I=g),i.push({[I]:C,pkData:z,row:K(R.value[d]),rowIndex:d}))}}catch(u){return E.error(`${M("msg.error.deleteRowFailed")}: ${await X(u)}`)}if(d===r)break}if(!i.length)return;V.value=!0;const{list:m}=await Q.dbTableRow.list(ee,$==null?void 0:$.value.id,(S=o.value)==null?void 0:S.id,{pks:i.map(u=>u[I]).join(",")});try{for(const u of i){const l=u.row,g=N(l.row,(y=o==null?void 0:o.value)==null?void 0:y.columns),C=m.find(z=>Object.keys(g).every(j=>g[j]===z[j]));l.row=K(C)}await Y(i.map(u=>u.pkData))}catch(u){return E.error(`${M("msg.error.deleteRowFailed")}: ${await X(u)}`)}if(!i.length){V.value=!1;return}te({redo:{fn:async function(l){var C,z,j,H;V.value=!0;const g=await Y(l.map(U=>U.pkData));if(Array.isArray(g))for(const{row:U}of l){const ie=N(U.row,(C=o==null?void 0:o.value)==null?void 0:C.columns),fe=re(ie,R.value);fe!==-1&&R.value.splice(fe,1),f.value.totalRows=f.value.totalRows-1}await((z=e==null?void 0:e.syncCount)==null?void 0:z.call(e)),await((j=e==null?void 0:e.syncPagination)==null?void 0:j.call(e)),await((H=e==null?void 0:e.globalCallback)==null?void 0:H.call(e))},args:[i]},undo:{fn:async function(l,g){var j,H;const C=l.map(U=>{var fe;const ie=N(U.row,(fe=o.value)==null?void 0:fe.columns);return U.row={...ie,...U.row},U}).reverse(),z=await de(C.map(U=>U.row),void 0,!0);if(Array.isArray(z))for(const{row:U,rowIndex:ie}of C)W(U.row),ie!==-1&&g.pageSize===f.value.pageSize?g.page===f.value.page?R.value.splice(ie,0,U):await((j=e==null?void 0:e.changePage)==null?void 0:j.call(e,g.page)):await((H=e==null?void 0:e.loadData)==null?void 0:H.call(e))},args:[i,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ne({view:P.value})}),await((s=e==null?void 0:e.syncCount)==null?void 0:s.call(e)),await((v=e==null?void 0:e.syncPagination)==null?void 0:v.call(e)),await((w=e==null?void 0:e.globalCallback)==null?void 0:w.call(e))}async function Y(t,{metaValue:n=o.value,viewMetaValue:r=P.value}={}){try{const d=await Q.dbDataTableRow.delete(n==null?void 0:n.id,t.length===1?t[0]:t,{viewId:r==null?void 0:r.id});return await(_==null?void 0:_.trigger()),t.length===1&&d?[d]:d}catch(d){E.error(await X(d))}}return{insertRow:ue,updateRowProperty:we,addEmptyRow:se,deleteRow:he,deleteRowById:Z,deleteSelectedRows:De,deleteRangeOfRows:Re,updateOrSaveRow:ce,bulkUpdateRows:pe,bulkUpdateView:J,selectedAllRecords:Se,removeRowIfNew:t=>{const n=R.value.indexOf(t);return n>-1&&t.rowMeta.new?(R.value.splice(n,1),!0):!1},bulkDeleteRows:Y,bulkInsertRows:de}}const ao=ve=>ve.map(o=>({row:{...o},oldRow:{...o},rowMeta:{}}));function go(ve,o,P){const R=Qe(),{activeTableId:f,activeTable:e}=ye(R),M=ae(()=>ve.value||e.value),oe=ae(()=>{var p;return((p=ve.value)==null?void 0:p.id)||f.value}),{t:ge}=Oe(),te=Ge("optimisedQuery",()=>!0),{api:K,isLoading:ne,error:$}=Je(),Q=He(),V=Q.currentRoute,{appInfo:_,gridViewPageSize:Se}=Xe(),se=Se.value||_.value.defaultLimit||25,ue=k({page:1,pageSize:se}),de=k([]),we=k(),ce=k(),pe=k(),J=k([]),le=k(!1),W=Le(Ze,k(!1)),{base:Z}=ye(_e()),{sharedView:he,fetchSharedViewData:De,paginationData:Re}=We(),{$api:Y}=$e(),{sorts:Ce,nestedFilters:t}=ke(),{isUIAllowed:n}=Ye(),r=ae(()=>V.value.query),{isPaginationLoading:d}=ye(je()),i=ae({get:()=>W.value?Re.value:ue.value,set:p=>{W.value?Re.value=p:ue.value=p}}),I=ae(()=>{var D;const p=Ie();return((D=i.value)==null?void 0:D.isLastPage)&&p===J.value.length-1}),m=ae(()=>{var D;const p=Ie();return((D=i.value)==null?void 0:D.isFirstPage)&&p===0}),h=ae(()=>({offset:((i.value.page??0)-1)*(i.value.pageSize??se),limit:i.value.pageSize??se,where:(P==null?void 0:P.value)??""}));async function c(){var D,T;const{count:p}=await Y.dbViewRow.count(ee,(D=Z==null?void 0:Z.value)==null?void 0:D.id,oe.value,(T=o==null?void 0:o.value)==null?void 0:T.id);i.value.totalRows=p}async function a(){var q;const p=((q=i.value)==null?void 0:q.totalRows)??1/0,D=i.value.pageSize??se,T=i.value.page??1,A=Math.ceil(p/D),G=Math.max(1,Math.min(A,T));T>G?w==null||w(G):await s({offset:(G-1)*D,where:P==null?void 0:P.value})}async function S(){var D,T,A,G,q;if(!n("commentCount")||W.value)return;const p=(T=(D=J.value)==null?void 0:D.filter(({rowMeta:{new:O}})=>!O))==null?void 0:T.map(({row:O})=>{var x;return b(O,(x=M==null?void 0:M.value)==null?void 0:x.columns)});if(!(!(p!=null&&p.length)||p!=null&&p.some(O=>!O)))try{de.value=await Y.utils.commentCount({ids:p,fk_model_id:oe.value});for(const O of J.value){const x=b(O.row,(A=M.value)==null?void 0:A.columns);O.rowMeta.commentCount=+(((q=(G=de.value)==null?void 0:G.find(F=>F.row_id===x))==null?void 0:q.count)||0)}}catch(O){console.error(O)}}const y=k();async function s(p={},D=!0){var G,q,O,x,F;if((!((G=Z==null?void 0:Z.value)!=null&&G.id)||!oe.value||!((q=o.value)!=null&&q.id))&&!W.value)return;y.value&&y.value.cancel();const T=be.CancelToken;y.value=T.source(),D&&(d.value=!0);let A;try{A=W.value?await De({sortsArr:Ce.value,filtersArr:t.value,where:P==null?void 0:P.value}):await K.dbViewRow.list("noco",Z.value.id,oe.value,o.value.id,{...h.value,...p,...n("sortSync")?{}:{sortArrJson:JSON.stringify(Ce.value)},...n("filterSync")?{}:{filterArrJson:JSON.stringify(t.value)},where:P==null?void 0:P.value,...le.value?{excludeCount:"true"}:{}},{cancelToken:y.value.token})}catch(B){return B.code==="ERR_CANCELED"?void 0:((x=(O=B==null?void 0:B.response)==null?void 0:O.data)==null?void 0:x.error)==="FORMULA_ERROR"?(E.error(await X(B)),await R.reloadTableMeta(oe.value),s(p,D)):(console.error(B),E.error(await X(B)))}if(J.value=ao(A.list),i.value=A.pageInfo||i.value||{},W.value&&(Re.value=i.value),le.value=!A.pageInfo,d.value=!1,i.value.totalRows!==void 0&&i.value.totalRows!==null){const B=Math.max(1,Math.ceil(i.value.totalRows/i.value.pageSize));B<i.value.page&&await w(B)}((F=o.value)==null?void 0:F.type)===Ve.GRID&&S()}async function v(){var p,D;(p=o==null?void 0:o.value)!=null&&p.id&&(we.value=W.value?(D=he.value)==null?void 0:D.view:await Y.dbView.galleryRead(o.value.id))}async function w(p){i.value.page=p,await s({offset:(p-1)*(i.value.pageSize||se),where:P==null?void 0:P.value},!0)}const{insertRow:u,updateRowProperty:l,addEmptyRow:g,deleteRow:C,deleteRowById:z,deleteSelectedRows:j,deleteRangeOfRows:H,updateOrSaveRow:U,bulkUpdateRows:ie,bulkUpdateView:fe,selectedAllRecords:Ae,removeRowIfNew:Fe}=ro({meta:M,viewMeta:o,formattedData:J,paginationData:i,callbacks:{changePage:w,loadData:s,syncCount:c,syncPagination:a}});async function Me(){var p,D,T;if((p=o==null?void 0:o.value)!=null&&p.id)try{const{columns:A,...G}=await Y.dbView.formRead(o.value.id);let q=1;const O=(A||[]).reduce((x,F)=>(q<F.order&&(q=F.order),{...x,[F.fk_column_id]:F}),{});pe.value=G,ce.value=(T=(D=M==null?void 0:M.value)==null?void 0:D.columns)==null?void 0:T.map(x=>{var F,B;return{...x,fk_column_id:x.id,fk_view_id:(F=o.value)==null?void 0:F.id,...O[x.id]?O[x.id]:{},meta:{validators:[],...ze((B=O[x.id])==null?void 0:B.meta),...ze(x.meta)},order:O[x.id]&&O[x.id].order||q++,id:O[x.id]&&O[x.id].id}}).sort((x,F)=>x.order-F.order)}catch(A){return E.error(`${ge("msg.error.setFormDataFailed")}: ${await X(A)}`)}}async function Be(p){var D;try{if(!((D=o==null?void 0:o.value)!=null&&D.id)||!p)return;await Y.dbView.formUpdate(o.value.id,p)}catch(T){return E.error(`${ge("msg.error.formViewUpdateFailed")}: ${await X(T)}`)}}function Ie(){return J.value.findIndex(p=>{var D;return r.value.rowId===b(p.row,(D=M.value)==null?void 0:D.columns)})}return{error:$,isLoading:ne,loadData:s,paginationData:i,queryParams:h,formattedData:J,insertRow:u,updateRowProperty:l,changePage:w,addEmptyRow:g,deleteRow:C,deleteRowById:z,deleteSelectedRows:j,deleteRangeOfRows:H,updateOrSaveRow:U,bulkUpdateRows:ie,bulkUpdateView:fe,selectedAllRecords:Ae,syncCount:c,syncPagination:a,galleryData:we,loadGalleryData:v,loadFormView:Me,formColumnData:ce,formViewData:pe,updateFormView:Be,aggCommentCount:de,loadAggCommentsCount:S,removeRowIfNew:Fe,navigateToSiblingRow:async p=>{var q,O,x,F,B;let T=Ie()+(p===me.NEXT?1:-1);for(;(O=(q=J.value[T])==null?void 0:q.rowMeta)!=null&&O.new;)T=T+(p===me.NEXT?1:-1);const A=((x=i==null?void 0:i.value)==null?void 0:x.page)||1;if(T<0){if(A===1)return E.info(ge("msg.info.noMoreRecords"));await w(A-1),T=J.value.length-1}else if(T>=J.value.length){if((F=i==null?void 0:i.value)!=null&&F.isLastPage)return E.info(ge("msg.info.noMoreRecords"));await w(A+1),T=0}const G=b(J.value[T].row,(B=M.value)==null?void 0:B.columns);G&&await Q.push({query:{...r.value,rowId:G}})},getExpandedRowIndex:Ie,optimisedQuery:te,islastRow:I,isFirstRow:m}}export{go as a,ro as u};
