import{u as x}from"./DTl_5Njz.js";import{r as u,ag as N,at as q,cB as B,L as F,bL as J,fC as L,g3 as U,g as $,cP as G,gh as R,an as H,ao as K,A as Q}from"./BLdk6lRf.js";import{a as W}from"./BtPl72f0.js";import{p as X}from"./CwqgNcWF.js";const Y=s=>s.map(o=>({row:{...o},oldRow:{...o},rowMeta:{}})),[ta,Z]=x((s,o,h=!1,e)=>{if(!s)throw new Error("Table meta is not available");const S=1e3,l=u([]),{api:b}=N(),{base:i}=q(B()),{$api:d}=Q(),{isUIAllowed:w}=F(),c=u(h)||J(L,u(!1)),{sorts:j,nestedFilters:y}=W(),{sharedView:A,fetchSharedViewData:C}=U(),p=u({}),m=u(),f=u({page:1,pageSize:S}),P=$(()=>({limit:f.value.pageSize??S,where:(e==null?void 0:e.value)??""}));async function D(){var t,r,n;const{count:a}=await d.dbViewRow.count(R,(t=i==null?void 0:i.value)==null?void 0:t.title,(r=s==null?void 0:s.value)==null?void 0:r.id,(n=o==null?void 0:o.value)==null?void 0:n.id);f.value.totalRows=a}async function E(){var a,t,r;!((a=o==null?void 0:o.value)!=null&&a.id)||!((t=s==null?void 0:s.value)!=null&&t.columns)||(p.value=c.value?(r=A.value)==null?void 0:r.view:await d.dbView.mapRead(o.value.id),m.value=s.value.columns.filter(n=>n.id===p.value.fk_geo_data_col_id)[0]||{})}async function I(){var t,r,n;if((!((t=i==null?void 0:i.value)!=null&&t.id)||!((r=s.value)!=null&&r.id)||!((n=o.value)!=null&&n.id))&&!(c!=null&&c.value))return;const a=c.value?await C({sortsArr:j.value,filtersArr:y.value}):await b.dbViewRow.list("noco",i.value.id,s.value.id,o.value.id,{...P.value,...w("filterSync")?{}:{filterArrJson:JSON.stringify(y.value)},where:e==null?void 0:e.value});l.value=Y(a.list)}async function k(a){var t;!((t=o==null?void 0:o.value)!=null&&t.id)||!w("dataEdit",{skipSourceCheck:!0})||await d.dbView.mapUpdate(o.value.id,a)}const{getMeta:z}=G();async function T(a,t={},{metaValue:r=s.value,viewMetaValue:n=o.value}={}){const O=a.row;a.rowMeta&&(a.rowMeta.saving=!0);try{const{missingRequiredColumns:v,insertObj:_}=await X({meta:r,ltarState:t,getMeta:z,row:O});if(v.size)return;const g=await d.dbViewRow.create(R,i==null?void 0:i.value.id,r==null?void 0:r.id,n==null?void 0:n.id,_);return Object.assign(a,{row:{...g,...O},rowMeta:{...a.rowMeta||{},new:void 0},oldRow:{...g}}),D(),g}catch(v){H.error(await K(v))}finally{a.rowMeta&&(a.rowMeta.saving=!1)}}function V(a=l.value.length){return l.value.splice(a,0,{row:{},oldRow:{},rowMeta:{new:!0}}),l.value[a]}return{formattedData:l,loadMapData:I,loadMapMeta:E,updateMapMeta:k,mapMetaData:p,geoDataFieldColumn:m,addEmptyRow:V,insertRow:T,syncCount:D,paginationData:f}});function ra(){const s=Z();if(s==null)throw new Error("Please call `useProvideMapViewStore` on the appropriate parent component");return s}export{ra as a,ta as u};
