import{f as Je,L as Le,ay as Fe,az as Ie,aA as Me,r as D,g as ke,N as je,aB as H,aC as Xe,aD as Ze,aE as es,aF as ss,H as ze,i as ts,aG as as,ae as K,o as n,c as u,S as z,w as c,b as g,a as e,t as o,T as x,P as s,U as h,d as _,V as os,W as ls,aq as P,av as ns,R as is,aH as rs,au as $e,aI as Se,aJ as J,aK as F,Q as cs,aL as ds,aj as Ae,ak as Be,aM as ps,$ as us,a1 as _s,a0 as gs,aN as fs,aO as ms,p as vs,e as hs,A as bs,_ as ys,aP as xs,ar as ws}from"./3QBYHahY.js";import{_ as Is}from"./DEDKhbvL.js";import{_ as ks}from"./DmzaAQYu.js";import{_ as $s}from"./BSepFqtU.js";import{_ as Ss}from"./C95Svpv6.js";import{u as As}from"./CdQRhxEe.js";import{p as De}from"./DkE_qgY_.js";const W=A=>(vs("data-v-505aa1df"),A=A(),hs(),A),Bs={"data-rec":"true"},Ds={key:0,class:"text-red-500"},Ls={class:"flex flex-row items-center gap-3 justify-between"},Ms={class:"keep-word min-w-[100px]"},js={key:0,class:"flex items-center gap-3 justify-end flex-wrap"},zs={class:"flex items-center gap-3"},Es={class:"flex items-center gap-2"},Rs={class:"!sticky top-0 z-5"},Us={class:"flex items-center gap-3"},Ps={class:"flex items-center gap-3"},Ts=W(()=>e("div",null,"Time",-1)),Cs={class:"cell-base"},Ns={class:"cell-type"},Os={class:"cell-sub-type"},Ys={class:"cell-description"},Gs={class:"cell-ip"},Vs={key:0},Ks=["onClick"],Ws={class:"cell-user"},qs={key:0,class:"w-full flex gap-3 items-center"},Qs={class:"flex-1 flex flex-col max-w-[calc(100%_-_44px)]"},Hs={class:"w-full flex gap-3"},Js={class:"cell-timestamp"},Fs={class:"cell-base"},Xs={key:0,class:"w-full"},Zs={class:"text-gray-600 text-xs"},et={class:"cell-type"},st={class:"truncate bg-gray-200 px-2 py-1 rounded-lg"},tt={class:"truncate"},at={class:"cell-sub-type"},ot={class:"truncate"},lt={class:"truncate"},nt={class:"cell-description"},it={class:"truncate"},rt={class:"cell-ip"},ct={class:"truncate"},dt={class:"flex items-center justify-center absolute left-0 top-0 w-full h-full z-10 pb-10 pointer-events-none"},pt={class:"flex flex-col justify-center items-center gap-2"},ut={class:"text-center"},_t={key:0,class:"flex items-center justify-center absolute left-0 top-0 w-full h-full pb-10 flex items-center justify-center text-gray-500"},gt={class:"flex justify-between items-center w-full px-6"},ft=W(()=>e("div",null," ",-1)),mt={class:"text-gray-500 text-xs"},vt={class:"flex items-center justify-between gap-x-2 w-full"},ht=W(()=>e("div",{class:"flex-1 text-base font-weight-700 text-gray-900"},"Audit Details",-1)),bt={class:"flex items-center gap-2"},yt={key:0,class:"nc-expanded-audit flex flex-col gap-4"},xt={class:"bg-gray-50 rounded-lg border-1 border-gray-200"},wt={class:"flex"},It={class:"w-1/2 border-r border-gray-200 flex flex-col gap-2 px-4 py-3"},kt=W(()=>e("div",{class:"cell-header"},"Performed by",-1)),$t={key:0,class:"w-full flex gap-3 items-center"},St={class:"flex-1 flex flex-col"},At={class:"w-full flex gap-3"},Bt={class:"text-sm text-gray-800 capitalize font-semibold"},Dt={class:"text-xs text-gray-600"},Lt={key:1,class:"text-small leading-[18px] text-gray-600"},Mt={class:"w-1/2 flex flex-col gap-2 px-4 py-3"},jt={class:"cell-header"},zt={class:"text-small leading-[18px] text-gray-600"},Et={class:"border-t-1 border-gray-200 flex"},Rt={class:"w-1/2 border-r border-gray-200 flex flex-col gap-2 px-4 py-3"},Ut={class:"cell-header"},Pt={key:0,class:"flex items-stretch gap-3"},Tt={class:"flex items-center"},Ct={class:"text-sm font-weight-500 text-gray-900"},Nt={class:"text-small leading-[18px] text-gray-600"},Ot={class:"w-1/2"},Yt={class:"h-1/2 border-b border-gray-200 flex items-center gap-2 px-4 py-3"},Gt={class:"cell-header"},Vt={class:"text-small leading-[18px] text-gray-600 bg-gray-200 px-1 rounded-md"},Kt={class:"h-1/2 flex items-center gap-2 px-4 py-3"},Wt={class:"cell-header"},qt={class:"text-small leading-[18px] text-gray-600"},Qt={class:"flex flex-col gap-2"},Ht={class:"cell-header"},Jt={class:"!text-small !leading-[18px] !text-gray-600 mb-0"},Ft=Je({__name:"AuditLogs",props:{workspaceId:{},baseId:{},sourceId:{},bordered:{type:Boolean,default:!0}},setup(A){const b=A,{isUIAllowed:T}=Le(),{$api:q}=bs(),C=Fe(),{loadAudits:N}=C,{audits:m,auditLogsQuery:p,auditPaginationData:v}=Ie(C),X=Me(),{getBaseUsers:Ee,loadProjects:Re}=X,{bases:w}=Ie(X),Q=D([]),f=ke(()=>{var l;const t=new Map;return(l=Q.value)==null||l.forEach(d=>{d!=null&&d.email&&t.set(d.email,d)}),t}),{appInfo:O}=je(),I=D(!1),L=D(!1),i=D(null),M=D();async function j(t=v.value.page,l=v.value.pageSize,d=!0){try{if(!T("workspaceAuditList")&&!b.baseId||!T("baseAuditList")&&b.baseId)return;d&&(v.value.page=1),I.value=!0,await N(b.workspaceId,d?1:t,l)}catch{}finally{I.value=!1}}const Ue=async t=>{v.value.page=t,await j(void 0,void 0,!1)},{onLeft:Pe,onRight:Te,onUp:Ce,onDown:Ne}=As({paginationDataRef:v,changePage:Ue,isViewDataLoading:I}),Oe=async()=>{try{if(!p.value.baseId)return;const{users:t}=await Ee({baseId:p.value.baseId});Q.value=t}catch(t){Ae.error(await Be(t))}},Ye=async()=>{try{const t=await q.orgUsers.list();if(!(t!=null&&t.list))return;Q.value=t.list}catch(t){Ae.error(await Be(t))}},Ge=t=>{i.value=t,L.value=!0},Z=t=>{var l,d,B;(l=m.value)!=null&&l.length&&(((d=p.value.orderBy)==null?void 0:d[t])==="asc"?p.value.orderBy[t]="desc":((B=p.value.orderBy)==null?void 0:B[t])==="desc"?p.value.orderBy[t]=void 0:p.value.orderBy[t]="asc",j(void 0,void 0,!1))},Ve=ke(()=>!0);H(Xe,D(!0)),H(es,Ze(Ve)),H(ss,D(!0)),ze(()=>p.value.baseId,()=>{p.value.baseId&&Oe()},{immediate:!0}),ts(async()=>{b.baseId?p.value.baseId=b.baseId:(p.value.baseId=void 0,p.value.sourceId=void 0),b.sourceId&&(p.value.sourceId=b.sourceId),b.baseId||await Promise.allSettled([Re(),Ye()]),O.value.auditEnabled&&await j(v.value.page,v.value.pageSize,!1)}),as(M,"scroll",()=>{var d,B,y,G;const t=(d=M.value)==null?void 0:d.querySelector("th.cell-user"),l=(B=M.value)==null?void 0:B.querySelector("th.cell-base");!(t!=null&&t.getBoundingClientRect().right)||!(l!=null&&l.getBoundingClientRect().left)||((l==null?void 0:l.getBoundingClientRect().left)<(t==null?void 0:t.getBoundingClientRect().right)+180?(y=M.value)==null||y.classList.add("sticky-shadow"):(G=M.value)==null||G.classList.remove("sticky-shadow"))});const Y=()=>ps()?"⌥":"ALT";return K("ArrowLeft",Pe),K("ArrowRight",Te),K("ArrowUp",Ce),K("ArrowDown",Ne),(t,l)=>{var se,te,ae,oe,le,ne,ie,re;const d=us,B=Is,y=_s,G=gs,ee=ks,Ke=fs,We=$e,qe=$s,Qe=ms,He=Ss;return n(),u("div",{class:h(["h-full flex flex-col",{"gap-4 px-1":t.baseId}])},[t.baseId?x("",!0):(n(),z(B,{key:0},{icon:c(()=>[g(d,{icon:"audit",class:"flex-none text-gray-700 h-5 w-5"})]),title:c(()=>[e("span",Bs,o(t.$t("title.auditLogs")),1)]),_:1})),e("div",{class:h(["nc-content-max-w flex flex-col",{"gap-6 p-6 h-[calc(100vh_-_100px)]":!t.baseId,"gap-4 h-full":t.baseId}])},[s(O).auditEnabled?x("",!0):(n(),u("div",Ds,"Audit logs are currently disabled by administrators.")),e("div",{class:h(["flex flex-col",{"gap-6":!t.baseId,"gap-4":t.baseId}])},[e("div",Ls,[e("div",{class:h({"flex-1 max-w-[75%]":t.baseId})},[t.baseId?(n(),u("h6",{key:0,class:h(["font-semibold text-gray-900 !my-0 flex items-center gap-1",{"text-xl":t.baseId,"text-2xl":!t.baseId}]),style:{"word-break":"keep-all"}},[e("span",Ms,o(t.$t("title.auditLogs")),1),g(y,{class:h(["max-w-[80%] truncate",{"!leading-7":t.baseId,"!leading-8":!t.baseId}]),"show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var a;return[_(o((a=s(w).get(t.baseId))==null?void 0:a.title),1)]}),default:c(()=>{var a;return[_(" : "+o((a=s(w).get(t.baseId))==null?void 0:a.title),1)]}),_:1},8,["class"])],2)):x("",!0)],2),s(O).auditEnabled?(n(),u("div",js,[e("div",zs,[g(G,{type:"text",size:"small",disabled:s(I),onClick:l[0]||(l[0]=a=>j())},{default:c(()=>[e("div",Es,[_(o(t.$t("general.refresh"))+" ",1),(n(),z(os(("iconMap"in t?t.iconMap:s(ls)).refresh),{class:h(["h-3.5 w-3.5",{"animate-infinite animate-spin":s(I)}])},null,8,["class"]))])]),_:1},8,["disabled"])])])):x("",!0)])],2),s(O).auditEnabled?(n(),u(P,{key:1},[e("div",{class:h(["table-container relative",{"h-[calc(100%_-_48px)] ":t.baseId,"h-[calc(100%_-_56px)]":!t.baseId,bordered:t.bordered}])},[e("div",{ref_key:"tableWrapper",ref:M,class:"nc-audit-logs-table h-full max-h-[calc(100%_-_40px)] relative nc-scrollbar-thin !overflow-auto"},[e("table",Rs,[e("thead",null,[e("tr",null,[e("th",{class:h(["cell-user !hover:bg-gray-100 select-none cursor-pointer",{"cursor-not-allowed":!((se=s(m))!=null&&se.length)}]),onClick:l[1]||(l[1]=a=>Z("user"))},[e("div",Us,[e("div",null,o(t.$t("objects.user")),1),(te=s(p).orderBy)!=null&&te.user?(n(),z(d,{key:0,icon:"chevronDown",class:h(["flex-none",{"transform rotate-180":((ae=s(p).orderBy)==null?void 0:ae.user)==="asc"}])},null,8,["class"])):(n(),z(d,{key:1,icon:"chevronUpDown",class:"flex-none"}))])],2),e("th",{class:h(["cell-timestamp !hover:bg-gray-100 select-none cursor-pointer",{"cursor-not-allowed":!((oe=s(m))!=null&&oe.length)}]),onClick:l[2]||(l[2]=a=>Z("created_at"))},[e("div",Ps,[Ts,(le=s(p).orderBy)!=null&&le.created_at?(n(),z(d,{key:0,icon:"chevronDown",class:h(["flex-none",{"transform rotate-180":((ne=s(p).orderBy)==null?void 0:ne.created_at)==="asc"}])},null,8,["class"])):(n(),z(d,{key:1,icon:"chevronUpDown",class:"flex-none"}))])],2),e("th",Cs,[e("div",null,o(t.$t("objects.project")),1)]),e("th",Ns,[e("div",null,o(t.$t("general.type")),1)]),e("th",Os,[e("div",null,o(t.$t("general.subType")),1)]),e("th",Ys,[e("div",null,o(t.$t("labels.description")),1)]),e("th",Gs,[e("div",null,o(t.$t("general.ipAddress")),1)])])])]),(ie=s(m))!=null&&ie.length?(n(),u("table",Vs,[e("tbody",null,[(n(!0),u(P,null,ns(s(m),(a,V)=>{var E,R,U;return n(),u("tr",{key:V,class:h({selected:((E=s(i))==null?void 0:E.id)===a.id&&s(L)}),onClick:r=>Ge(a)},[e("td",Ws,[e("div",null,[a.user&&((R=s(f).get(a.user))!=null&&R.email)?(n(),u("div",qs,[g(ee,{email:(U=s(f).get(a.user))==null?void 0:U.email,size:"base",class:"flex-none"},null,8,["email"]),e("div",Qs,[e("div",Hs,[g(y,{class:"text-sm !leading-5 text-gray-800 capitalize font-semibold truncate","show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var r,k,$,S;return[_(o(((r=s(f).get(a.user))==null?void 0:r.display_name)||((S=(k=s(f).get(a.user))==null?void 0:k.email)==null?void 0:S.slice(0,($=s(f).get(a.user))==null?void 0:$.email.indexOf("@")))),1)]}),default:c(()=>{var r,k,$,S;return[_(" "+o(((r=s(f).get(a.user))==null?void 0:r.display_name)||((S=(k=s(f).get(a.user))==null?void 0:k.email)==null?void 0:S.slice(0,($=s(f).get(a.user))==null?void 0:$.email.indexOf("@")))),1)]}),_:2},1024)]),g(y,{class:"text-xs !leading-4 text-gray-600 truncate","show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var r;return[_(o((r=s(f).get(a.user))==null?void 0:r.email),1)]}),default:c(()=>{var r;return[_(" "+o((r=s(f).get(a.user))==null?void 0:r.email),1)]}),_:2},1024)])])):(n(),u(P,{key:1},[_(o(a.user),1)],64))])]),e("td",Js,[e("div",null,[g(y,{placement:"bottom"},{title:c(()=>[_(o(("parseStringDateTime"in t?t.parseStringDateTime:s(De))(a.created_at,"D MMMM YYYY HH:mm")),1)]),default:c(()=>[_(" "+o(s(Se)(a.created_at)),1)]),_:2},1024)])]),e("td",Fs,[e("div",null,[a.base_id?(n(),u("div",Xs,[g(y,{class:"truncate text-sm !leading-5 text-gray-800 font-semibold","show-on-truncate-only":"",placement:"bottom"},{title:c(()=>{var r;return[_(o((r=s(w).get(a.base_id))==null?void 0:r.title),1)]}),default:c(()=>{var r;return[_(" "+o((r=s(w).get(a.base_id))==null?void 0:r.title),1)]}),_:2},1024),e("div",Zs,"ID: "+o(a.base_id),1)])):(n(),u(P,{key:1},[_(o(a.base_id),1)],64))])]),e("td",et,[e("div",null,[e("div",st,[g(y,{class:"truncate",placement:"bottom","show-on-truncate-only":""},{title:c(()=>[_(o(s(J)[a.op_type]),1)]),default:c(()=>[e("span",tt,o(s(J)[a.op_type]),1)]),_:2},1024)])])]),e("td",at,[e("div",null,[e("div",ot,[g(y,{class:"truncate",placement:"bottom","show-on-truncate-only":""},{title:c(()=>[_(o(s(F)[a.op_sub_type]),1)]),default:c(()=>[e("span",lt,o(s(F)[a.op_sub_type]),1)]),_:2},1024)])])]),e("td",nt,[e("div",null,[e("div",it,o(a.description),1)])]),e("td",rt,[e("div",null,[e("div",ct,o(a.ip),1)])])],10,Ks)}),128))])])):x("",!0)],512),is(e("div",dt,[e("div",pt,[g(Ke,{size:"xlarge"}),e("span",ut,o(t.$t("general.loading")),1)])],512),[[rs,s(I)]]),!s(I)&&!((re=s(m))!=null&&re.length)?(n(),u("div",_t,[g(We,{image:s($e).PRESENTED_IMAGE_SIMPLE,description:t.$t("labels.noData"),class:"!my-0"},null,8,["image","description"])])):x("",!0),s(v).totalRows?(n(),u("div",{key:1,class:h(["flex flex-row justify-center items-center bg-gray-50 min-h-10",{"pointer-events-none":s(I)}])},[e("div",gt,[ft,g(qe,{current:s(v).page,"onUpdate:current":[l[3]||(l[3]=a=>s(v).page=a),l[5]||(l[5]=a=>j(void 0,void 0,!1))],"page-size":s(v).pageSize,"onUpdate:pageSize":[l[4]||(l[4]=a=>s(v).pageSize=a),l[6]||(l[6]=a=>j(t.currentPage,a,!1))],total:+s(v).totalRows,"show-size-changer":"","use-stored-page-size":!1,"prev-page-tooltip":`${Y()}+←`,"next-page-tooltip":`${Y()}+→`,"first-page-tooltip":`${Y()}+↓`,"last-page-tooltip":`${Y()}+↑`},null,8,["current","page-size","total","prev-page-tooltip","next-page-tooltip","first-page-tooltip","last-page-tooltip"]),e("div",mt,o(s(v).totalRows)+" "+o(s(v).totalRows===1?"record":"records"),1)])],2)):x("",!0)],2),g(He,{visible:s(L),"onUpdate:visible":l[7]||(l[7]=a=>cs(L)?L.value=a:null),size:"medium","show-separator":!1,onKeydown:l[8]||(l[8]=ds(a=>L.value=!1,["esc"]))},{header:c(()=>[e("div",vt,[ht,e("div",bt,[g(y,{placement:"bottom",class:"text-gray-600 text-small leading-[18px]"},{title:c(()=>[_(o(("parseStringDateTime"in t?t.parseStringDateTime:s(De))(s(i).created_at,"D MMMM YYYY HH:mm")),1)]),default:c(()=>[_(" "+o(s(Se)(s(i).created_at)),1)]),_:1})])])]),default:c(()=>{var a,V,E,R,U,r,k,$,S,ce,de,pe,ue,_e,ge,fe,me,ve,he,be,ye,xe,we;return[s(i)?(n(),u("div",yt,[e("div",xt,[e("div",wt,[e("div",It,[kt,(a=s(i))!=null&&a.user&&((V=s(f).get(s(i).user))!=null&&V.email)?(n(),u("div",$t,[g(ee,{email:(E=s(f).get(s(i).user))==null?void 0:E.email,size:"base",class:"flex-none"},null,8,["email"]),e("div",St,[e("div",At,[e("span",Bt,o(((R=s(f).get(s(i).user))==null?void 0:R.display_name)||((k=(U=s(f).get(s(i).user))==null?void 0:U.email)==null?void 0:k.slice(0,(r=s(f).get(s(i).user))==null?void 0:r.email.indexOf("@")))),1)]),e("span",Dt,o(($=s(f).get(s(i).user))==null?void 0:$.email),1)])])):(n(),u("div",Lt,o((S=s(i))==null?void 0:S.user),1))]),e("div",Mt,[e("div",jt,o(t.$t("general.ipAddress")),1),e("div",zt,o((ce=s(i))==null?void 0:ce.ip),1)])]),e("div",Et,[e("div",Rt,[e("div",Ut,o(t.$t("objects.project")),1),(de=s(i))!=null&&de.base_id&&s(w).get((pe=s(i))==null?void 0:pe.base_id)?(n(),u("div",Pt,[e("div",Tt,[g(Qe,{color:(ge=(_e=s(w).get((ue=s(i))==null?void 0:ue.base_id))==null?void 0:_e.meta)==null?void 0:ge.iconColor,type:((me=s(w).get((fe=s(i))==null?void 0:fe.base_id))==null?void 0:me.type)||"database",class:"nc-view-icon w-5 h-5"},null,8,["color","type"])]),e("div",null,[e("div",Ct,o((he=s(w).get((ve=s(i))==null?void 0:ve.base_id))==null?void 0:he.title),1),e("div",Nt,o((be=s(i))==null?void 0:be.base_id),1)])])):(n(),u(P,{key:1},[_(o(s(i).base_id),1)],64))]),e("div",Ot,[e("div",Yt,[e("div",Gt,o(t.$t("general.type")),1),e("div",Vt,o(s(J)[(ye=s(i))==null?void 0:ye.op_type]),1)]),e("div",Kt,[e("div",Wt,o(t.$t("general.subType")),1),e("div",qt,o(s(F)[(xe=s(i))==null?void 0:xe.op_sub_type]),1)])])])]),e("div",Qt,[e("div",Ht,o(t.$t("labels.description")),1),e("div",null,[e("pre",Jt,o((we=s(i))==null?void 0:we.description),1)])])])):x("",!0)]}),_:1},8,["visible"])],64)):x("",!0)],2)],2)}}}),la=ys(Ft,[["__scopeId","data-v-505aa1df"]]),na=xs("userStore",()=>{const{api:A}=ws(),{user:b}=je(),{loadRoles:T}=Le(),q=Me(),C=async({attrs:m})=>{if(!b.value)throw new Error("User is not defined");await A.userProfile.update(m),b.value={...b.value,...m},q.clearBasesUser()},N=T;return ze(()=>{var m;return(m=b.value)==null?void 0:m.id},(m,p)=>{m&&m!==p&&N()},{immediate:!0}),{loadCurrentUser:N,updateUserProfile:C}});export{la as _,na as u};
