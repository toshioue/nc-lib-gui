import{_ as J}from"./Cx8Z_l6r.js";import{f as U,cB as W,at as q,ai as K,r as b,i as Q,n as C,O as X,o,c as f,a as t,P as i,R as E,U as _,w as y,V as I,W as T,d as $,t as g,b as v,T as Y,ak as B,S as Z,cT as N,an as w,ao as ee,aS as te,A as R}from"./DKhUGBot.js";import{_ as ae}from"./BkUIf4Fh.js";import{_ as se}from"./D6MTqk13.js";import"./B0emH2s-.js";import"./DPW1f6my.js";import"./D_FwWME_.js";import"./CX4Cv_ut.js";import"./DEJjMRn_.js";import"./BQQOEPN4.js";import"./DX_5E9FR.js";import"./BOlDoh1A.js";import"./CUg8TjpL.js";import"./gHfFefeo.js";import"./Qczbj6zB.js";import"./BqRqK2Ui.js";import"./CNjr3NNT.js";import"./G7I_n9Op.js";import"./Cz8K5PX4.js";import"./GPQ-Eg6I.js";import"./BpnlUwoJ.js";import"./CxxuE4Yq.js";const oe={class:"h-full flex flex-col w-full"},ne={class:"h-full flex flex-col"},ie={class:"flex flex-row justify-between items-center w-full mb-4"},ce={class:"flex"},le={key:0},re={class:"flex items-center gap-2"},me={key:1},de={class:"flex items-center gap-2 text-gray-600 font-light"},pe={class:"h-auto max-h-[calc(100%_-_72px)] overflow-y-auto nc-scrollbar-thin"},ue={key:0},fe={class:"flex items-center gap-1"},_e={class:"min-w-5 flex items-center justify-center"},ye={class:"overflow-ellipsis min-w-0 shrink-1"},ve=t("div",{class:"flex place-content-center item-center"},null,-1),Ge=U({__name:"Metadata",props:{sourceId:{}},emits:["baseSynced"],setup(j,{emit:V}){const x=j,A=V,{$api:S}=R(),k=W(),{loadTables:L}=k,{base:m}=q(k),{t:d}=K(),n=b(!1),p=b(!1),u=b([]);async function h(){var e,c,s;try{if(!((e=m.value)!=null&&e.id))return;n.value=!0,p.value=!1,u.value=await S.source.metaDiffGet((c=m.value)==null?void 0:c.id,x.sourceId);for(const a of u.value)((s=a.detectedChanges)==null?void 0:s.length)>0&&(a.syncState=a.detectedChanges.map(l=>l==null?void 0:l.msg).join(", "),p.value=!0)}catch(a){console.error(a)}finally{n.value=!1}}const{$poller:P}=R();async function G(){var e,c;try{if(!((e=m.value)!=null&&e.id)||!p.value)return;n.value=!0;const s=await S.source.metaDiffSync((c=m.value)==null?void 0:c.id,x.sourceId);P.subscribe({id:s.id},async a=>{a.status!=="close"&&(a.status===N.COMPLETED?(w.info(d("msg.info.metaDataRecreated")),await L(),await h(),A("baseSynced"),n.value=!1):status===N.FAILED&&(w.error("Failed to sync base metadata"),n.value=!1))})}catch(s){w.error(await ee(s))}}Q(async()=>{u.value.length===0&&await h()});const D=e=>()=>C("div",{class:"text-gray-500"},e),z=[{title:D(d("labels.models")),key:"table_name"},{title:D(d("labels.syncState")),dataIndex:"syncState",key:"syncState",customRender:e=>C("div",{style:{color:e.text?"red":"gray"}},e.text||d("msg.info.metaNoChange"))}];return(e,c)=>{const s=te,a=ae,l=B,F=J,O=se,M=X("e");return o(),f("div",oe,[t("div",ne,[t("div",ie,[t("div",ce,[i(p)?(o(),f("div",le,[E((o(),_(s,{class:"nc-btn-metasync-sync-now",type:"primary",onClick:G},{default:y(()=>[t("div",re,[(o(),_(I(("iconMap"in e?e.iconMap:i(T)).databaseSync))),$(" "+g(e.$t("activity.metaSync")),1)])]),_:1})),[[M,["a:proj-meta:meta-data:sync"]]])])):(o(),f("div",me,[t("span",null,[v(a,{message:e.$t("msg.info.tablesMetadataInSync"),type:"success","show-icon":""},null,8,["message"])])]))]),E((o(),_(s,{class:"self-start !rounded-md nc-btn-metasync-reload",onClick:h},{default:y(()=>[t("div",de,[(o(),_(I(("iconMap"in e?e.iconMap:i(T)).reload),{class:Y({"animate-infinite animate-spin !text-success":i(n)})},null,8,["class"])),$(" "+g(e.$t("general.reload")),1)])]),_:1})),[[M,["a:proj-meta:meta-data:reload"]]])]),t("div",pe,[v(O,{class:"nc-metasync-table w-full",size:"small","custom-row":r=>({class:`nc-metasync-row nc-metasync-row-${r.table_name}`}),"data-source":i(u)??[],columns:z,pagination:!1,loading:i(n),sticky:"",bordered:""},{emptyText:y(()=>[v(l,{image:("Empty"in e?e.Empty:i(B)).PRESENTED_IMAGE_SIMPLE,description:e.$t("labels.noData")},null,8,["image","description"])]),bodyCell:y(({record:r,column:H})=>[H.key==="table_name"?(o(),f("div",ue,[t("div",fe,[t("div",_e,[v(F,{meta:r,class:"text-gray-500"},null,8,["meta"])]),t("span",ye,g(r.title||r.table_name),1)])])):Z("",!0)]),_:1},8,["custom-row","data-source","loading"])])]),ve])}}});export{Ge as default};
