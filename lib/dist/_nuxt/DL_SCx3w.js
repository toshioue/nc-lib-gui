import{_ as $e,o as c,c as C,f as na,ac as la,g as M,dM as d,cB as oa,au as sa,at as ia,cH as ca,cI as ra,bL as ua,gT as da,r as v,ag as pa,ai as ma,hE as le,hF as S,da as fa,H as oe,i as va,a_ as ba,U as _,w as s,a as i,d as $,t as m,b as o,P as a,a7 as w,al as I,am as B,V as x,W as E,S as U,Q as F,Y as _a,hG as se,A as we,cT as Ce,an as R,ao as ke,hH as Sa,a2 as ya,a1 as ga,dt as wa,$ as Ca,ca as ka,p as ha,e as $a}from"./B2hUoZAs.js";import{_ as Ua}from"./BiF6nT3q.js";import{_ as Ta}from"./JjoFIP7R.js";import{_ as Ma}from"./DFYMF386.js";import{f as b,b as Ia,h as Pa}from"./CZHF7Hd-.js";import{r as La}from"./BNDnQ_SZ.js";import{a as Na}from"./DodZPEOQ.js";import{F as he}from"./By21eAqY.js";import"./BWYzyVlv.js";import{I as xa}from"./CwHJfKcC.js";import{_ as Ea,C as Fa}from"./CioeS9VM.js";import{_ as ja}from"./cvW-uYte.js";import{S as Da,_ as Aa}from"./CaxUP45y.js";import{_ as Ba}from"./BOBr5Pny.js";import{_ as Ra}from"./kd0F6MQ0.js";import{_ as Oa}from"./7hPDkg8v.js";import"./pcWi62uI.js";import"./C9qKCFvP.js";import"./GHAU6jsY.js";import"./boyBAVNN.js";import"./fKrvpb1C.js";import"./BGKYJ52S.js";import"./i4toF4kp.js";import"./BQQOEPN4.js";import"./1orNHd0L.js";import"./R1pHeCcp.js";const Qa={};function Va(P,ie){return c(),C("span")}const Wa=$e(Qa,[["render",Va]]),Ue=P=>(ha("data-v-edec7b74"),P=P(),$a(),P),za={class:"py-6 px-8"},qa={class:"create-source bg-white relative flex flex-col justify-center gap-2 w-full"},Ka={class:"prose-xl font-bold self-start mb-4 flex items-center gap-2"},Ga=Ue(()=>i("span",{class:"flex-grow"},null,-1)),Ha={class:"nc-scrollbar-md",style:{maxHeight:"60vh"}},Ja={class:"flex items-center gap-2 justify-between"},Ya={class:"flex items-right justify-end gap-2"},Xa={class:"flex items-center gap-2 justify-between"},Za={class:"flex gap-2"},et={class:"flex py-1 items-center gap-1"},at=Ue(()=>i("span",null,":",-1)),tt={class:"flex items-center justify-center"},nt={class:"flex items-center gap-2 justify-between"},lt={class:"flex items-center gap-2 justify-between"},ot={class:"flex justify-end"},st={class:"flex justify-end gap-2"},it=na({__name:"CreateBase",props:{open:{type:Boolean},connectionType:{}},emits:["update:open","sourceCreated"],setup(P,{emit:ie}){const ce=P,re=ie,W=la(ce,"open",re),Te=M(()=>ce.connectionType??d.MYSQL),Me=oa(),{loadProject:Ie}=sa(),{base:Pe}=ia(Me),{loadProjectTables:Le}=ca(),{refreshCommandPalette:Ne}=ra(),z=ua(da,void 0),j=M(()=>{var e;return(z==null?void 0:z.value)??((e=Pe.value)==null?void 0:e.id)}),xe=he.useForm,k=v(!1),q=v(!1),K=v(),{api:G}=pa(),{$e:O}=we(),{t:H}=ma(),T=v(!1),t=v({title:"",dataSource:{...le(d.MYSQL)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:S.No,extraParameters:[],is_schema_readonly:!0,is_data_readonly:!1}),D=v({title:"",dataSource:{...le(d.MYSQL)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:S.No,extraParameters:[]}),ue=v(!1),de=v(0),Ee=()=>{de.value+=1,de.value>=2&&(ue.value=!0)},Fe=M(()=>fa.filter(e=>![d.SNOWFLAKE,d.DATABRICKS,...ue.value?[]:[d.MSSQL]].includes(e.value))),je=M(()=>{let e={"dataSource.connection.host":[b()],"dataSource.connection.port":[b()],"dataSource.connection.user":[b()],"dataSource.connection.password":[b()],"dataSource.connection.database":[b()]};switch(t.value.dataSource.client){case d.SQLITE:e={"dataSource.connection.connection.filename":[b()]};break;case d.SNOWFLAKE:e={"dataSource.connection.account":[b()],"dataSource.connection.username":[b()],"dataSource.connection.password":[b()],"dataSource.connection.warehouse":[b()],"dataSource.connection.database":[b()],"dataSource.connection.schema":[b()]};break;case d.PG:case d.MSSQL:e["dataSource.searchPath.0"]=[b()];break}return{title:[{required:!0,message:H("labels.sourceNameRequired")},Ia],extraParameters:[Pa],"dataSource.client":[b()],...e}}),{validate:pe,validateInfos:g}=xe(t.value,je),me=e=>{t.value.dataSource.connection.database=`${e.trim()}_noco`},fe=()=>{t.value.dataSource={...le(t.value.dataSource.client)},me(t.value.title)},De=e=>{if(t.value.dataSource.client!==d.SQLITE){const n=t.value.dataSource.connection;switch(e){case S.No:delete n.ssl;break;case S.Allowed:n.ssl="true";break;default:n.ssl={ca:"",cert:"",key:""};break}}},ve=()=>{if(t.value.dataSource.client!==d.SQLITE){const e=t.value.dataSource.connection;e.ssl?typeof e.ssl=="string"?t.value.sslUse=S.Allowed:t.value.sslUse=S.Preferred:t.value.sslUse=S.No}},Ae=()=>{t.value.extraParameters.push({key:"",value:""})},Be=e=>{t.value.extraParameters.splice(e,1)},be=["camelize","none"],L=v(""),N=v(!1),A=v(!1),J=v(),Y=v(),X=v(),Z=(e,n)=>{n&&La(n,r=>{"ssl"in t.value.dataSource.connection&&typeof t.value.dataSource.connection.ssl=="object"&&(t.value.dataSource.connection.ssl[e]=r??"")})},ee=M(()=>!!t.value.sslUse&&t.value.sslUse!==S.No&&t.value.sslUse!==S.Allowed);function _e(){const e=Object.fromEntries(new Map(t.value.extraParameters.map(r=>[r.key,r.value]))),n={...t.value.dataSource.connection,...e};return"ssl"in n&&n.ssl&&(t.value.sslUse===S.No||typeof n.ssl=="object"&&Object.values(n.ssl).every(r=>r==null))&&delete n.ssl,n}const Se=()=>{var e,n,r,f,p;(p=(f=(r=(n=(e=K.value)==null?void 0:e.$el.querySelector(".ant-form-item-explain-error"))==null?void 0:n.parentNode)==null?void 0:r.parentNode)==null?void 0:f.querySelector("input"))==null||p.focus()},{$poller:Re}=we(),Oe=async()=>{try{await pe()}catch{Se();return}try{if(!j.value)return;T.value=!0;const e=_e(),n={...t.value.dataSource,connection:e},r=await G.source.create(j.value,{alias:t.value.title,type:t.value.dataSource.client,config:n,inflection_column:t.value.inflection.inflectionColumn,inflection_table:t.value.inflection.inflectionTable,is_schema_readonly:t.value.is_schema_readonly,is_data_readonly:t.value.is_data_readonly});Re.subscribe({id:r.id},async f=>{f.status!=="close"&&(f.status===Ce.COMPLETED?(O("a:base:create:extdb"),j.value&&(await Ie(j.value,!0),await Le(j.value,!0)),re("sourceCreated"),W.value=!1,T.value=!1):status===Ce.FAILED&&(R.error("Failed to create base"),T.value=!1))})}catch(e){R.error(await ke(e)),T.value=!1}finally{Ne()}},Qe=async()=>{try{await pe()}catch{Se();return}O("a:source:create:extdb:test-connection",[]);try{if(q.value=!0,t.value.dataSource.client===d.SQLITE)k.value=!0;else{const e=_e();e.database=Sa(t.value.dataSource);const n={...t.value.dataSource,connection:e},r=await G.utils.testConnection(n);r.code===0?k.value=!0:(k.value=!1,R.error(`${H("msg.error.dbConnectionFailed")} ${r.message}`))}}catch(e){k.value=!1,R.error(await ke(e))}q.value=!1},Ve=async()=>{if(!L.value||L.value==="")return;const e=await G.utils.urlToConfig({url:L.value});e?(t.value.dataSource.client=e.client,t.value.dataSource.connection={...e.connection}):R.error(H("msg.error.invalidURL")),A.value=!1,ve()},We=()=>{D.value={...t.value},N.value=!0},ze=()=>{t.value={...D.value},N.value=!1,ve()};oe(()=>t.value.dataSource,()=>k.value=!1,{deep:!0}),oe(()=>t.value.title,e=>me(e)),va(async()=>{t.value.title=await Na(),ba(()=>{setTimeout(()=>{var n,r;const e=(r=(n=K.value)==null?void 0:n.$el)==null?void 0:r.querySelector("input[type=text]");e==null||e.setSelectionRange(0,t.value.title.length),e==null||e.focus()},500)})}),oe(Te,e=>{t.value.dataSource.client=e,fe()},{immediate:!0});const qe=e=>{W.value=e},ae=M({get:()=>!t.value.is_schema_readonly,set:e=>{t.value.is_schema_readonly=!e,e&&(t.value.is_data_readonly=!1),O("c:source:schema-write-toggle",{allowed:!e,edit:!0})}}),te=M({get:()=>!t.value.is_data_readonly,set:e=>{t.value.is_data_readonly=!e,O("c:source:data-write-toggle",{allowed:!e})}});return(e,n)=>{const r=Wa,f=xa,p=ja,Q=Da,V=Aa,Ke=Ba,Ge=Ra,He=Ua,h=ya,ne=ga,ye=Oa,Je=wa,Ye=Ea,Xe=Fa,Ze=Ca,ea=he,aa=Ta,ge=ka,ta=Ma;return c(),_(ta,{visible:a(W),closable:!a(T),keyboard:!a(T),"mask-closable":!1,width:750,"onUpdate:visible":qe},{default:s(()=>[i("div",za,[i("div",qa,[i("h1",Ka,[$(m(e.$t("title.newBase"))+" ",1),o(r),Ga]),o(ea,{ref_key:"form",ref:K,model:a(t),name:"external-base-create-form",layout:"horizontal","no-style":"","label-col":{span:5}},{default:s(()=>[i("div",Ha,[o(p,w({label:"Source Name"},a(g).title),{default:s(()=>[o(f,{value:a(t).title,"onUpdate:value":n[0]||(n[0]=l=>a(t).title=l),class:"nc-extdb-proj-name"},null,8,["value"])]),_:1},16),o(p,w({label:e.$t("labels.dbType")},a(g)["dataSource.client"]),{default:s(()=>[o(V,{value:a(t).dataSource.client,"onUpdate:value":n[1]||(n[1]=l=>a(t).dataSource.client=l),class:"nc-extdb-db-type","dropdown-class-name":"nc-dropdown-ext-db-type",onChange:fe},{default:s(()=>[(c(!0),C(I,null,B(a(Fe),l=>(c(),_(Q,{key:l.value,value:l.value},{default:s(()=>[i("div",Ja,[i("div",null,m(l.text),1),a(t).dataSource.client===l.value?(c(),_(x(("iconMap"in e?e.iconMap:a(E)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):U("",!0)])]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1},16,["label"]),a(t).dataSource.client===a(d).SQLITE?(c(),_(p,w({key:0,label:e.$t("labels.sqliteFile")},a(g)["dataSource.connection.connection.filename"]),{default:s(()=>[o(f,{value:a(t).dataSource.connection.connection.filename,"onUpdate:value":n[2]||(n[2]=l=>a(t).dataSource.connection.connection.filename=l)},null,8,["value"])]),_:1},16,["label"])):(c(),C(I,{key:1},[o(p,w({label:e.$t("labels.hostAddress")},a(g)["dataSource.connection.host"]),{default:s(()=>[o(f,{value:a(t).dataSource.connection.host,"onUpdate:value":n[3]||(n[3]=l=>a(t).dataSource.connection.host=l),class:"nc-extdb-host-address"},null,8,["value"])]),_:1},16,["label"]),o(p,w({label:e.$t("labels.port")},a(g)["dataSource.connection.port"]),{default:s(()=>[o(Ke,{value:a(t).dataSource.connection.port,"onUpdate:value":n[4]||(n[4]=l=>a(t).dataSource.connection.port=l),class:"!w-full nc-extdb-host-port"},null,8,["value"])]),_:1},16,["label"]),o(p,w({label:e.$t("labels.username")},a(g)["dataSource.connection.user"]),{default:s(()=>[o(f,{value:a(t).dataSource.connection.user,"onUpdate:value":n[5]||(n[5]=l=>a(t).dataSource.connection.user=l),class:"nc-extdb-host-user"},null,8,["value"])]),_:1},16,["label"]),o(p,{label:e.$t("labels.password")},{default:s(()=>[o(Ge,{value:a(t).dataSource.connection.password,"onUpdate:value":n[6]||(n[6]=l=>a(t).dataSource.connection.password=l),class:"nc-extdb-host-password"},null,8,["value"])]),_:1},8,["label"]),o(p,w({label:e.$t("labels.database")},a(g)["dataSource.connection.database"]),{default:s(()=>[o(f,{value:a(t).dataSource.connection.database,"onUpdate:value":n[7]||(n[7]=l=>a(t).dataSource.connection.database=l),placeholder:e.$t("labels.dbCreateIfNotExists"),class:"nc-extdb-host-database"},null,8,["value","placeholder"])]),_:1},16,["label"]),[a(d).MSSQL,a(d).PG].includes(a(t).dataSource.client)&&a(t).dataSource.searchPath?(c(),_(p,w({key:0,label:e.$t("labels.schemaName")},a(g)["dataSource.searchPath.0"]),{default:s(()=>[o(f,{value:a(t).dataSource.searchPath[0],"onUpdate:value":n[8]||(n[8]=l=>a(t).dataSource.searchPath[0]=l)},null,8,["value"])]),_:1},16,["label"])):U("",!0)],64)),o(He,{allowMetaWrite:a(ae),"onUpdate:allowMetaWrite":n[9]||(n[9]=l=>F(ae)?ae.value=l:null),allowDataWrite:a(te),"onUpdate:allowDataWrite":n[10]||(n[10]=l=>F(te)?te.value=l:null)},null,8,["allowMetaWrite","allowDataWrite"]),a(t).dataSource.client!==a(d).SQLITE&&a(t).dataSource.client!==a(d).DATABRICKS&&a(t).dataSource.client!==a(d).SNOWFLAKE?(c(),C(I,{key:2},[i("div",Ya,[o(h,{type:"ghost",size:"small",class:"nc-extdb-btn-import-url !rounded-md",onClick:n[11]||(n[11]=_a(l=>A.value=!0,["stop"]))},{default:s(()=>[$(m(e.$t("activity.useConnectionUrl")),1)]),_:1})]),o(Xe,{ghost:"","expand-icon-position":"right",class:"!mt-6"},{default:s(()=>[o(Ye,{key:"1"},{header:s(()=>[i("span",null,m(e.$t("title.advancedParameters")),1)]),default:s(()=>[o(p,{label:"SSL mode"},{default:s(()=>[o(V,{value:a(t).sslUse,"onUpdate:value":n[12]||(n[12]=l=>a(t).sslUse=l),"dropdown-class-name":"nc-dropdown-ssl-mode",onSelect:De},{default:s(()=>[(c(!0),C(I,null,B(Object.values(a(S)),l=>(c(),_(Q,{key:l,value:l},{default:s(()=>{var u;return[i("div",Xa,[i("div",null,m(l),1),((u=a(t))==null?void 0:u.sslUse)===l?(c(),_(x(("iconMap"in e?e.iconMap:a(E)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):U("",!0)])]}),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),o(p,{label:"SSL keys"},{default:s(()=>[i("div",Za,[o(ne,{placement:"top"},{title:s(()=>[i("span",null,m(e.$t("tooltip.clientCert")),1)]),default:s(()=>[o(h,{size:"small",disabled:!a(ee),class:"shadow",onClick:n[13]||(n[13]=l=>{var u;return(u=a(X))==null?void 0:u.click()})},{default:s(()=>[$(m(e.$t("labels.clientCert")),1)]),_:1},8,["disabled"])]),_:1}),o(ne,{placement:"top"},{title:s(()=>[i("span",null,m(e.$t("tooltip.clientKey")),1)]),default:s(()=>[o(h,{size:"small",disabled:!a(ee),class:"shadow",onClick:n[14]||(n[14]=l=>{var u;return(u=a(Y))==null?void 0:u.click()})},{default:s(()=>[$(m(e.$t("labels.clientKey")),1)]),_:1},8,["disabled"])]),_:1}),o(ne,{placement:"top"},{title:s(()=>[i("span",null,m(e.$t("tooltip.clientCA")),1)]),default:s(()=>[o(h,{size:"small",disabled:!a(ee),class:"shadow",onClick:n[15]||(n[15]=l=>{var u;return(u=a(J))==null?void 0:u.click()})},{default:s(()=>[$(m(e.$t("labels.serverCA")),1)]),_:1},8,["disabled"])]),_:1})])]),_:1}),i("input",{ref_key:"caFileInput",ref:J,type:"file",class:"!hidden",onChange:n[16]||(n[16]=l=>Z(("CertTypes"in e?e.CertTypes:a(se)).ca,a(J)))},null,544),i("input",{ref_key:"certFileInput",ref:X,type:"file",class:"!hidden",onChange:n[17]||(n[17]=l=>Z(("CertTypes"in e?e.CertTypes:a(se)).cert,a(X)))},null,544),i("input",{ref_key:"keyFileInput",ref:Y,type:"file",class:"!hidden",onChange:n[18]||(n[18]=l=>Z(("CertTypes"in e?e.CertTypes:a(se)).key,a(Y)))},null,544),o(ye),o(p,w({class:"mb-2",label:e.$t("labels.extraConnectionParameters")},a(g).extraParameters),{default:s(()=>[o(Je,null,{default:s(()=>[(c(!0),C(I,null,B(a(t).extraParameters,(l,u)=>(c(),C("div",{key:u},[i("div",et,[o(f,{value:l.key,"onUpdate:value":y=>l.key=y},null,8,["value","onUpdate:value"]),at,o(f,{value:l.value,"onUpdate:value":y=>l.value=y},null,8,["value","onUpdate:value"]),(c(),_(x(("iconMap"in e?e.iconMap:a(E)).close),{style:{"font-size":"1.5em",color:"red"},onClick:y=>Be(u)},null,8,["onClick"]))])]))),128)),o(h,{size:"small",type:"dashed",class:"w-full caption mt-2",onClick:Ae},{default:s(()=>[i("div",tt,[(c(),_(x(("iconMap"in e?e.iconMap:a(E)).plus)))])]),_:1})]),_:1})]),_:1},16,["label"]),o(ye),o(p,{label:e.$t("labels.inflection.tableName")},{default:s(()=>[o(V,{value:a(t).inflection.inflectionTable,"onUpdate:value":n[19]||(n[19]=l=>a(t).inflection.inflectionTable=l),"dropdown-class-name":"nc-dropdown-inflection-table-name"},{default:s(()=>[(c(),C(I,null,B(be,l=>o(Q,{key:l,value:l},{default:s(()=>{var u,y;return[i("div",nt,[i("div",null,m(l),1),((y=(u=a(t))==null?void 0:u.inflection)==null?void 0:y.inflectionTable)===l?(c(),_(x(("iconMap"in e?e.iconMap:a(E)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):U("",!0)])]}),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"]),o(p,{label:e.$t("labels.inflection.columnName")},{default:s(()=>[o(V,{value:a(t).inflection.inflectionColumn,"onUpdate:value":n[20]||(n[20]=l=>a(t).inflection.inflectionColumn=l),"dropdown-class-name":"nc-dropdown-inflection-column-name"},{default:s(()=>[(c(),C(I,null,B(be,l=>o(Q,{key:l,value:l},{default:s(()=>{var u,y;return[i("div",lt,[i("div",null,m(l),1),((y=(u=a(t))==null?void 0:u.inflection)==null?void 0:y.inflectionColumn)===l?(c(),_(x(("iconMap"in e?e.iconMap:a(E)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):U("",!0)])]}),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"]),i("div",ot,[o(h,{type:"primary",size:"small",class:"!rounded-md",onClick:n[21]||(n[21]=l=>We())},{default:s(()=>[$(m(e.$t("activity.editConnJson")),1)]),_:1})])]),_:1})]),_:1})],64)):U("",!0)]),o(p,{class:"flex justify-end !mt-5"},{default:s(()=>[i("div",st,[i("div",{class:"w-[15px] h-[15px] cursor-pointer",onDblclick:Ee},null,32),o(h,{type:a(k)?"ghost":"primary",size:"small",class:"nc-extdb-btn-test-connection !rounded-md",loading:a(q),onClick:Qe},{default:s(()=>[a(k)?(c(),_(Ze,{key:0,icon:"circleCheck",class:"text-primary mr-2"})):U("",!0),$(" "+m(e.$t("activity.testDbConn")),1)]),_:1},8,["type","loading"]),o(h,{size:"small",type:"primary",disabled:!a(k),loading:a(T),class:"nc-extdb-btn-submit !rounded-md",onClick:Oe},{default:s(()=>[$(m(e.$t("general.submit")),1)]),_:1},8,["disabled","loading"])])]),_:1})]),_:1},8,["model"]),o(ge,{visible:a(N),"onUpdate:visible":n[23]||(n[23]=l=>F(N)?N.value=l:null),title:e.$t("activity.editConnJson"),width:"600px","wrap-class-name":"nc-modal-edit-connection-json",onOk:ze},{default:s(()=>[a(N)?(c(),_(aa,{key:0,modelValue:a(D),"onUpdate:modelValue":n[22]||(n[22]=l=>F(D)?D.value=l:null),class:"h-[400px] w-full"},null,8,["modelValue"])):U("",!0)]),_:1},8,["visible","title"]),o(ge,{visible:a(A),"onUpdate:visible":n[25]||(n[25]=l=>F(A)?A.value=l:null),title:e.$t("activity.useConnectionUrl"),width:"500px","ok-text":e.$t("general.ok"),"cancel-text":e.$t("general.cancel"),"wrap-class-name":"nc-modal-connection-url",onOk:Ve},{default:s(()=>[o(f,{value:a(L),"onUpdate:value":n[24]||(n[24]=l=>F(L)?L.value=l:null)},null,8,["value"])]),_:1},8,["visible","title","ok-text","cancel-text"])])])]),_:1},8,["visible","closable","keyboard"])}}}),Et=$e(it,[["__scopeId","data-v-edec7b74"]]);export{Et as default};
