import{u as Fe}from"./CSl6euFG.js";import{r as f,az as G,cQ as _e,aB as Me,gD as Re,ar as Ne,cY as De,cM as Ve,aA as Ye,ai as Te,M as Ee,g as V,d2 as Q,d1 as s,fO as O,fr as Y,de as v,H as q,gE as Ae,ge as Le,dJ as je,gF as qe,gj as Ce,gk as oe,aj as W,gG as Ie,ak as Pe,gH as ne,fQ as Z,cr as y,gI as He}from"./3QBYHahY.js";import{u as xe}from"./Bj2FvocX.js";import{u as Ue}from"./T74iQZdg.js";import{i as ue,A as Be}from"./D4iSzjWt.js";import{i as $e,e as Je}from"./BYmqikBK.js";import{g as Ge,e as Qe,r as We}from"./CryEDKiL.js";import{F as Ze}from"./DAKhk9t6.js";const ze=Ze.useForm,[ot,Ke]=Fe(T=>{const E=f(!1),z=f(!1),A=f(!1),C=f(!1),b=f(null),M=f(null),R=f(0),{sharedView:L}=G(_e());Me(Re,b);const h=f(),k=f(),F=f(),_=f({}),I=je(),{api:P,isLoading:de}=Ne(),{metas:fe,setMeta:K,getMeta:ce}=De(),H=Ve(),{base:me,sqlUis:X}=G(H),pe=Ye(),{basesUser:ee}=G(pe),{t:x}=Te(),j=Ee(),c=f({}),te=f({}),ie=f({}),N=f({}),ae=V(()=>{var e,t,i;return typeof((e=h.value)==null?void 0:e.redirect_url)=="string"&&!!((i=(t=h.value)==null?void 0:t.redirect_url)!=null&&i.trim())});xe(k);const{state:p}=Ue(f({row:c,rowMeta:{new:!0},oldRow:{}})),D=V(()=>{var e;return((e=F.value)==null?void 0:e.filter(t=>t.show).filter(t=>!Q(t)&&t.uidt!==s.SpecificDBType&&(!O(t)||Y(t.uidt))))||[]}),ve=async()=>{var e,t;M.value=null;try{const i=await P.public.sharedViewMetaGet(T,{headers:{"xc-password":b.value}});C.value=!1,L.value=i,h.value=i.view,k.value=i.model;const r=(i.columns||[]).reduce((a,u)=>({...a,[u.fk_column_id]:u}),{});F.value=(((e=i.model)==null?void 0:e.columns)||[]).filter(a=>r[a.id]).map(a=>{if(!Q(a)&&!O(a)&&!ue(a)&&a.uidt!==s.SpecificDBType&&(a!=null&&a.title)&&$e(a==null?void 0:a.cdf)&&!/^\w+\(\)|CURRENT_TIMESTAMP$/.test(a.cdf)){const u=typeof a.cdf=="string"?a.cdf.replace(/^'|'$/g,""):a.cdf;[s.Number,s.Duration,s.Percent,s.Currency,s.Decimal].includes(a.uidt)?(c.value[a.title]=Number(u)||null,N.value[a.title]=Number(u)||null):a.uidt===s.Checkbox?["true","1"].includes(String(u).toLowerCase())?(c.value[a.title]=!0,N.value[a.title]=!0):["false","0"].includes(String(u).toLowerCase())&&(c.value[a.title]=!1,N.value[a.title]=!1):(c.value[a.title]=u,N.value[a.title]=u)}return{...a,meta:{...v(r[a.id].meta),...v(a.meta)},description:r[a.id].description}});const n=i.meta;_.value=qe(n)?JSON.parse(n):n,await K(i.model),(t=me.value)!=null&&t.sources||H.setProject({sources:[{id:i.source_id,type:i.client}]});const d={...i.relatedMetas};Object.keys(d).forEach(a=>K(d[a])),i.users&&ee.value.set(i.base_id,i.users),await ye()}catch(i){const r=await Ce(i);i.response&&i.response.status===404?z.value=!0:r.error===oe.INVALID_SHARED_VIEW_PASSWORD?(C.value=!0,b.value&&b.value!==""&&(M.value=r.message)):r.error===oe.UNKNOWN_ERROR&&(console.error("Error occurred while loading shared form view",i),W.error("Error occurred while loading shared form view"))}},S=V(()=>{const e=new Set;return D.value.reduce((t,i)=>(t[i.title]=Ge(i.title,e),t),{})}),re=V(()=>{const e={};if(!D.value||!Object.keys(S.value).length)return e;for(const t of D.value){let i=[{validator:(n,d)=>new Promise((a,u)=>J(t)&&(typeof d=="string"&&(d=d.trim()),t.uidt===s.Checkbox&&!d||t.uidt!==s.Checkbox&&!We(d)||t.uidt===s.Rating&&(!d||Number(d)<1))?u(x("msg.error.fieldRequired")):a())}];const r=Qe(v(t.meta).validators??[],t);i=[...i,...r],i.length&&(e[S.value[t.title]]=i)}return e}),we=V(()=>{if(!Object.keys(S.value).length)return{};const e=Object.keys(c.value).reduce((i,r)=>(i[S.value[r]]=c.value[r],i),{}),t=Object.keys(p.value).reduce((i,r)=>(i[S.value[r]]=p.value[r],i),{});return{...e,...t}}),{validate:U,validateInfos:he,clearValidate:B}=ze(we,re),se=()=>{for(const e of D.value)e.title&&J(e)&&c.value[e.title]===void 0&&p.value[e.title]===void 0&&(O(e)?p.value[e.title]=null:c.value[e.title]=null)},ge=async()=>{var e;se();try{return await U([...Object.keys(c.value).map(t=>S.value[t]),...Object.keys(p.value).map(t=>S.value[t])].filter(t=>t!==void 0)),!0}catch(t){if(console.error("Error occurred while validating all fields:",t),(e=t==null?void 0:t.errorFields)!=null&&e.length)return W.error(x("msg.error.someOfTheRequiredFieldsAreEmpty")),!1}},Se=async()=>{var e,t,i,r;try{if(!await ge())return;E.value=!0;const n={...c.value,...p.value},d={};for(const m of(i=(t=fe.value)==null?void 0:t[(e=L.value)==null?void 0:e.fk_model_id])==null?void 0:i.columns)m.uidt===s.Attachment&&n[m.title]&&(d[`_${m.title}`]=n[m.title].map(g=>g.file));const a=Ie({data:n,...d}),u=await P.public.dataCreate(L.value.uuid,a,{headers:{"xc-password":b.value}}),o=Je(u,(r=k.value)==null?void 0:r.columns);if(o&&ae.value){const m=h.value.redirect_url.replace("{record_id}",o);window.location.href=m,window.location.reload()}else A.value=!0,E.value=!1}catch(n){console.error(n),await W.error(await Pe(n))}E.value=!1},le=async()=>{I.trigger(),p.value={...ie.value},c.value={...N.value,..._.value.preFillEnabled?te.value:{}},B()};async function ye(){if(Object.keys(j.query||{}).length){F.value=await Promise.all((F.value||[]).map(async e=>{const t=j.query[e.title]||j.query[encodeURIComponent(e.title)];if(!e.title||!t||Q(e)||O(e)&&!Y(e)||!_.value.preFillEnabled&&!O(e)&&!Y(e)||ue(e)||e.uidt===s.SpecificDBType)return e;const i=Array.isArray(t)?t.map(n=>decodeURIComponent(n).trim()):decodeURIComponent(t).trim(),r=await Oe(e,i);if(r!==void 0&&(Y(e)?p.value={...p.value||{},[e.title]:r}:c.value[e.title]=r,_.value.preFillEnabled))switch(_.value.preFilledMode){case ne.Hidden:{e.show=!1;break}case ne.Locked:{e.read_only=!0;break}}return e}));try{ie.value=JSON.parse(JSON.stringify(p.value||{})),te.value=JSON.parse(JSON.stringify(c.value||{}))}catch{}}}function be(e){var t;return(t=e!=null&&e.source_id?X.value[e==null?void 0:e.source_id]:Object.values(X.value)[0])==null?void 0:t.getAbstractType(e)}async function Oe(e,t){var r,n,d,a,u;let i;switch(e.uidt){case s.SingleSelect:case s.MultiSelect:case s.User:{const o=(v(e.meta).isLimitOption?v(e.meta).limitOptions||[]:[]).reduce((l,w)=>(w!=null&&w.id&&(l[w.id]=w),l),{}),m=t.split(",");let g=[];[s.SingleSelect,s.MultiSelect].includes(e.uidt)?(g=(((r=e.colOptions)==null?void 0:r.options)||[]).filter(l=>{var w;return!!(l!=null&&l.id&&(l!=null&&l.title)&&m.includes(l.title)&&(o[l.id]?(w=o[l.id])!=null&&w.show:!v(e.meta).isLimitOption||!(v(e.meta).limitOptions||[]).length))}).map(l=>l.title),g.length&&(i=e.uidt===s.SingleSelect?g[0]:g.join(","))):(g=((n=k.value)!=null&&n.base_id?ee.value.get(k.value.base_id)||[]:[]).filter(l=>{var w;return!!(l!=null&&l.id&&(l!=null&&l.email)&&(m.includes(l.email)||m.includes(l.id))&&(o[l.id]?(w=o[l.id])!=null&&w.show:!v(e.meta).isLimitOption||!(v(e.meta).limitOptions||[]).length))}).map(l=>l.email),g.length&&(i=(d=v(e.meta))!=null&&d.is_multi?g.join(","):g[0]));break}case s.Checkbox:{["true",!0,"1",1].includes(t.toLowerCase())?i=!0:["false",!1,"0",0].includes(t.toLowerCase())&&(i=!1);break}case s.Rating:{isNaN(Number(t))||(i=Math.min(Math.max(Number(t),0),v(e.meta).max??5));break}case s.URL:{v(e.meta).validate?He(t)&&(i=t):i=t;break}case s.Year:{/^\d+$/.test(t)&&(i=Number(t));break}case s.Date:{const o=y(t);(o.isValid()&&o.toISOString()===t||y(t,"YYYY-MM-DD").isValid())&&(i=y(t).format("YYYY-MM-DD"));break}case s.DateTime:{const o=y(t);(o.isValid()&&o.toISOString()===t||y(t,"YYYY-MM-DD HH:mm:ss").isValid())&&(i=y(t).utc().format("YYYY-MM-DD HH:mm:ssZ"));break}case s.Time:{let o=y(t);o.isValid()||(o=y(t,"HH:mm:ss")),o.isValid()||(o=y(`1999-01-01 ${t}`)),o.isValid()&&(i=o.format(H.isMysql(e.source_id)?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD HH:mm:ssZ"));break}case s.LinkToAnotherRecord:case s.Links:{const o=Array.isArray(t)?t:t.split(",");i=await ke(e,o),(((a=e.colOptions)==null?void 0:a.type)===Z.BELONGS_TO||((u=e.colOptions)==null?void 0:u.type)===Z.ONE_TO_ONE)&&(i=i[0]);break}default:Be(e,be(e))?isNaN(Number(t))||(i=Number(t)):i=t}return i}async function ke(e,t){var d,a,u,o;const i=await ce((d=e.colOptions)==null?void 0:d.fk_related_model_id),r=(a=i==null?void 0:i.columns)==null?void 0:a.find(m=>m.pk),n=(u=i==null?void 0:i.columns)==null?void 0:u.find(m=>m.pv);return(o=await P.public.dataRelationList(j.params.viewId,e.id,{},{headers:{"xc-password":b.value},query:{limit:Math.max(25,t.length),where:`(${r.title},in,${t.join(",")})`,fields:[r.title,n.title]}}))==null?void 0:o.list}let $;q(A,e=>{var t,i,r;if(e&&((t=h.value)!=null&&t.show_blank_form)){if(typeof((i=h.value)==null?void 0:i.redirect_url)=="string")return;R.value=5,$=Ae(()=>{R.value=R.value-1,R.value<0&&(A.value=!1,I.trigger(),clearInterval($))},1e3)}e||((r=h.value)!=null&&r.show_blank_form&&clearInterval($),le(),B())});function J(e){var t;if(!O(e)&&(e.rqd&&!e.cdf||e.pk&&!(e.ai||e.cdf)||e.required))return!0;if(Y(e)&&e.colOptions&&e.colOptions.type===Z.BELONGS_TO){const i=(t=F.value)==null?void 0:t.find(r=>{var n;return r.id===((n=e==null?void 0:e.colOptions)==null?void 0:n.fk_child_column_id)});if((i&&i.rqd&&!i.cdf||e.required)&&i)return!0}else if(O(e)&&e.required)return!0;return!1}return q(b,(e,t)=>{e!==t&&M.value&&(M.value=null)}),q(()=>{var e;return(e=h.value)==null?void 0:e.heading},()=>{var e;Le(`${((e=h.value)==null?void 0:e.heading)??"NocoDB"}`)},{flush:"post"}),q(p,async()=>{try{await U(Object.keys(p.value).map(e=>S.value[e]).filter(e=>e!==void 0))}catch{}},{deep:!0}),{sharedView:L,sharedFormView:h,loadSharedView:ve,columns:F,submitForm:Se,clearForm:le,progress:E,meta:k,validators:re,formColumns:D,formState:c,notFound:z,password:b,passwordError:M,submitted:A,secondsRemain:R,passwordDlg:C,isLoading:de,sharedViewMeta:_,onReset:I.on,validate:U,validateInfos:he,clearValidate:B,additionalState:p,isRequired:J,handleAddMissingRequiredFieldDefaultState:se,fieldMappings:S,isValidRedirectUrl:ae}},"shared-form-view-store");function nt(){const T=Ke();if(T==null)throw new Error("Please call `useProvideSharedFormStore` on the appropriate parent component");return T}export{nt as a,ot as u};
