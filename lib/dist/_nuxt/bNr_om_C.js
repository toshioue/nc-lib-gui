import{u as Te}from"./GMLocJHP.js";import{r as f,ax as W,cO as Ee,az as Ae,gU as Le,ap as Ie,cW as qe,cL as Pe,ay as je,ag as He,K as xe,f as F,fy as me,d0 as Q,c$ as n,f$ as k,fE as Y,dc as h,F as I,gV as Ue,gs as Be,dJ as $e,gW as Je,gx as Ge,gy as ve,ah as Z,gX as We,ai as Qe,gY as pe,g3 as K,cq as S,gZ as Ze}from"./DZZ6t_j4.js";import{u as Ke}from"./qW2V2r_p.js";import{u as ze}from"./CA74dF2b.js";import{F as he,g as Xe,e as et,r as tt}from"./BCU2uY6p.js";import{i as we,A as it}from"./C4K5fdHe.js";import{i as rt,e as at}from"./BDAIZopQ.js";import{F as st}from"./BYINaHrJ.js";const lt=st.useForm,[ht,ot]=Te(C=>{const T=f(!1),z=f(!1),E=f(!1),q=f(!1),b=f(null),R=f(null),M=f(0),{sharedView:N}=W(Ee());Ae(Le,b);const y=f(),_=f(),O=f(),V=f({}),P=$e(),{api:j,isLoading:ye}=Ie(),{metas:ge,setMeta:X,getMeta:ee}=qe(),H=Pe(),{base:Se,sqlUis:te}=W(H),be=je(),{basesUser:ie}=W(be),{t:x}=He(),U=xe(),d=f({}),re=f({}),ae=f({}),D=f({}),se=f({}),le=F(()=>{var e,t,r;return typeof((e=y.value)==null?void 0:e.redirect_url)=="string"&&!!((r=(t=y.value)==null?void 0:t.redirect_url)!=null&&r.trim())});Ke(_);const{state:c}=ze(f({row:d,rowMeta:{new:!0},oldRow:{}})),B=F(()=>{var e;return(e=O.value||[])==null?void 0:e.filter(t=>oe(t))}),Fe=F(()=>B.value.reduce((e,t)=>(e[t.fk_column_id]=t,e),{})),Oe=F(()=>new he({nestedGroupedFilters:se.value,formViewColumns:B.value,formViewColumnsMapByFkColumnId:Fe.value,formState:{...d.value||{},...c.value||{}},isSharedForm:!0,isMysql:e=>{var t;return["mysql",me.MYSQL].includes(((t=N.value)==null?void 0:t.client)||me.MYSQL)},getMeta:ee})),A=F(()=>{var e;return((e=O.value)==null?void 0:e.filter(t=>t.show&&oe(t)))||[]});function oe(e){return!Q(e)&&e.uidt!==n.SpecificDBType&&(!k(e)||Y(e.uidt))}const ke=async()=>{var e,t,r,l;R.value=null;try{const a=await j.public.sharedViewMetaGet(C,{headers:{"xc-password":b.value}});q.value=!1,N.value=a,y.value=a.view,_.value=a.model,ce(Array.isArray((e=a==null?void 0:a.filter)==null?void 0:e.children)?(t=a==null?void 0:a.filter)==null?void 0:t.children:[]);const u=(a.columns||[]).reduce((i,s)=>({...i,[s.fk_column_id]:s}),{});O.value=(((r=a.model)==null?void 0:r.columns)||[]).filter(i=>u[i.id]).map(i=>{if(!Q(i)&&!k(i)&&!we(i)&&i.uidt!==n.SpecificDBType&&(i!=null&&i.title)&&rt(i==null?void 0:i.cdf)&&!/^\w+\(\)|CURRENT_TIMESTAMP$/.test(i.cdf)){const s=typeof i.cdf=="string"?i.cdf.replace(/^'|'$/g,""):i.cdf;[n.Number,n.Duration,n.Percent,n.Currency,n.Decimal].includes(i.uidt)?(d.value[i.title]=Number(s)||null,D.value[i.title]=Number(s)||null):i.uidt===n.Checkbox?["true","1"].includes(String(s).toLowerCase())?(d.value[i.title]=!0,D.value[i.title]=!0):["false","0"].includes(String(s).toLowerCase())&&(d.value[i.title]=!1,D.value[i.title]=!1):(d.value[i.title]=s,D.value[i.title]=s)}return{...i,order:u[i.id].order||i.order,visible:!0,meta:{...h(u[i.id].meta),...h(i.meta)},description:u[i.id].description}}).sort((i,s)=>(i.order??1/0)-(s.order??1/0));const m=a.meta;V.value=Je(m)?JSON.parse(m):m,await X(a.model),(l=Se.value)!=null&&l.sources||H.setProject({sources:[{id:a.source_id,type:a.client}]});const v={...a.relatedMetas};Object.keys(v).forEach(i=>X(v[i])),a.users&&ie.value.set(a.base_id,a.users),await Ne(),L()}catch(a){const u=await Ge(a);a.response&&a.response.status===404?z.value=!0:u.error===ve.INVALID_SHARED_VIEW_PASSWORD?(q.value=!0,b.value&&b.value!==""&&(R.value=u.message)):u.error===ve.UNKNOWN_ERROR&&(console.error("Error occurred while loading shared form view",a),Z.error("Error occurred while loading shared form view"))}},g=F(()=>{const e=new Set;return A.value.reduce((t,r)=>(t[r.title]=Xe(r.title,e),t),{})}),ne=F(()=>{const e={};if(!A.value||!Object.keys(g.value).length)return e;for(const t of A.value){let r=[{validator:(a,u)=>new Promise((m,v)=>G(t)&&t.show&&(typeof u=="string"&&(u=u.trim()),t.uidt===n.Rating&&(!u||Number(u)<1)||t.uidt===n.Checkbox&&!u||t.uidt!==n.Checkbox&&!tt(u))?v(x("msg.error.fieldRequired")):m())},{validator:a=>new Promise(u=>(L(),u()))}];const l=et(h(t.meta).validators??[],t);r=[...r,...l],r.length&&(e[g.value[t.title]]=r)}return e}),_e=F(()=>{if(!Object.keys(g.value).length)return{};const e=Object.keys(d.value).reduce((r,l)=>(r[g.value[l]]=d.value[l],r),{}),t=Object.keys(c.value).reduce((r,l)=>(r[g.value[l]]=c.value[l],r),{});return{...e,...t}}),{validate:$,validateInfos:Ve,clearValidate:ue}=lt(_e,ne),de=async()=>{for(const e of B.value)e.title&&e.show&&e.visible&&G(e)&&d.value[e.title]===void 0&&c.value[e.title]===void 0&&(k(e)?c.value={...c.value||{},[e.title]:null}:d.value[e.title]=null),!e.visible&&e.title&&(delete d.value[e.title],delete c.value[e.title])},Re=async()=>{var e;await de();try{return await $([...Object.keys(d.value).map(t=>g.value[t]),...Object.keys(c.value).map(t=>g.value[t])].filter(t=>t!==void 0)),!0}catch(t){if(console.error("Error occurred while validating all fields:",t),(e=t==null?void 0:t.errorFields)!=null&&e.length)return Z.error(x("msg.error.someOfTheRequiredFieldsAreEmpty")),!1}},Me=async()=>{var e,t,r,l;try{if(!await Re())return;T.value=!0;const a={...d.value,...c.value},u={};for(const s of(r=(t=ge.value)==null?void 0:t[(e=N.value)==null?void 0:e.fk_model_id])==null?void 0:r.columns)s.uidt===n.Attachment&&a[s.title]&&(u[`_${s.title}`]=a[s.title].map(p=>p.file));const m=We({data:a,...u}),v=await j.public.dataCreate(N.value.uuid,m,{headers:{"xc-password":b.value}}),i=at(v,(l=_.value)==null?void 0:l.columns);if(i&&le.value){const s=y.value.redirect_url.replace("{record_id}",i),p=document.createElement("a");p.href=s,p.host===window.location.host?(window.history.pushState({},"Redirect",s),window.location.reload()):window.location.href=s}else E.value=!0,T.value=!1}catch(a){console.error(a),await Z.error(await Qe(a))}T.value=!1},fe=async()=>{P.trigger(),c.value={...ae.value},d.value={...D.value,...V.value.preFillEnabled?re.value:{}},ue(),L()};async function Ne(){if(Object.keys(U.query||{}).length){O.value=await Promise.all((O.value||[]).map(async e=>{const t=U.query[e.title];if(!e.title||!t||Q(e)||k(e)&&!Y(e)||!V.value.preFillEnabled&&!k(e)&&!Y(e)||we(e)||e.uidt===n.SpecificDBType)return e;const r=Array.isArray(t)?t.map(a=>decodeURIComponent(a).trim()):decodeURIComponent(t).trim(),l=await Ye(e,r);if(l!==void 0&&(Y(e)?c.value={...c.value||{},[e.title]:l}:d.value[e.title]=l,V.value.preFillEnabled))switch(V.value.preFilledMode){case pe.Hidden:{e.show=!1,e.meta={...h(e.meta),preFilledHiddenField:!0};break}case pe.Locked:{e.read_only=!0;break}}return e}));try{ae.value=JSON.parse(JSON.stringify(c.value||{})),re.value=JSON.parse(JSON.stringify(d.value||{}))}catch{}}}function De(e){var t;return(t=e!=null&&e.source_id?te.value[e==null?void 0:e.source_id]:Object.values(te.value)[0])==null?void 0:t.getAbstractType(e)}async function Ye(e,t){var l,a,u,m,v;let r;switch(e.uidt){case n.SingleSelect:case n.MultiSelect:case n.User:{const i=(h(e.meta).isLimitOption?h(e.meta).limitOptions||[]:[]).reduce((o,w)=>(w!=null&&w.id&&(o[w.id]=w),o),{}),s=t.split(",");let p=[];[n.SingleSelect,n.MultiSelect].includes(e.uidt)?(p=(((l=e.colOptions)==null?void 0:l.options)||[]).filter(o=>{var w;return!!(o!=null&&o.id&&(o!=null&&o.title)&&s.includes(o.title)&&(i[o.id]?(w=i[o.id])!=null&&w.show:!h(e.meta).isLimitOption||!(h(e.meta).limitOptions||[]).length))}).map(o=>o.title),p.length&&(r=e.uidt===n.SingleSelect?p[0]:p.join(","))):(p=((a=_.value)!=null&&a.base_id?ie.value.get(_.value.base_id)||[]:[]).filter(o=>{var w;return!!(o!=null&&o.id&&(o!=null&&o.email)&&(s.includes(o.email)||s.includes(o.id))&&(i[o.id]?(w=i[o.id])!=null&&w.show:!h(e.meta).isLimitOption||!(h(e.meta).limitOptions||[]).length))}).map(o=>o.email),p.length&&(r=(u=h(e.meta))!=null&&u.is_multi?p.join(","):p[0]));break}case n.Checkbox:{["true",!0,"1",1].includes(t.toLowerCase())?r=!0:["false",!1,"0",0].includes(t.toLowerCase())&&(r=!1);break}case n.Rating:{isNaN(Number(t))||(r=Math.min(Math.max(Number(t),0),h(e.meta).max??5));break}case n.URL:{h(e.meta).validate?Ze(t)&&(r=t):r=t;break}case n.Year:{/^\d+$/.test(t)&&(r=Number(t));break}case n.Date:{const i=S(t);(i.isValid()&&i.toISOString()===t||S(t,"YYYY-MM-DD").isValid())&&(r=S(t).format("YYYY-MM-DD"));break}case n.DateTime:{const i=S(t);(i.isValid()&&i.toISOString()===t||S(t,"YYYY-MM-DD HH:mm:ss").isValid())&&(r=S(t).utc().format("YYYY-MM-DD HH:mm:ssZ"));break}case n.Time:{let i=S(t);i.isValid()||(i=S(t,"HH:mm:ss")),i.isValid()||(i=S(`1999-01-01 ${t}`)),i.isValid()&&(r=i.format(H.isMysql(e.source_id)?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD HH:mm:ssZ"));break}case n.LinkToAnotherRecord:case n.Links:{const i=Array.isArray(t)?t:t.split(",");r=await Ce(e,i),(((m=e.colOptions)==null?void 0:m.type)===K.BELONGS_TO||((v=e.colOptions)==null?void 0:v.type)===K.ONE_TO_ONE)&&(r=r[0]);break}default:it(e,De(e))?isNaN(Number(t))||(r=Number(t)):r=t}return r}async function Ce(e,t){var u,m,v,i;const r=await ee((u=e.colOptions)==null?void 0:u.fk_related_model_id),l=(m=r==null?void 0:r.columns)==null?void 0:m.find(s=>s.pk),a=(v=r==null?void 0:r.columns)==null?void 0:v.find(s=>s.pv);return(i=await j.public.dataRelationList(U.params.viewId,e.id,{},{headers:{"xc-password":b.value},query:{limit:Math.max(25,t.length),where:`(${l.title},in,${t.join(",")})`,fields:[l.title,a.title]}}))==null?void 0:i.list}let J;I(E,e=>{var t,r,l;if(e&&((t=y.value)!=null&&t.show_blank_form)){if(typeof((r=y.value)==null?void 0:r.redirect_url)=="string")return;M.value=5,J=Ue(()=>{M.value=M.value-1,M.value<0&&(E.value=!1,P.trigger(),clearInterval(J))},1e3)}e||((l=y.value)!=null&&l.show_blank_form&&clearInterval(J),fe())});function G(e){var t;if(!k(e)&&(e.rqd&&!e.cdf||e.pk&&!(e.ai||e.cdf)||e.required))return!0;if(Y(e)&&e.colOptions&&e.colOptions.type===K.BELONGS_TO){const r=(t=O.value)==null?void 0:t.find(l=>{var a;return l.id===((a=e==null?void 0:e.colOptions)==null?void 0:a.fk_child_column_id)});if((r&&r.rqd&&!r.cdf||e.required)&&r)return!0}else if(k(e)&&e.required)return!0;return!1}function ce(e){if(!e.length)return;const r=new he({data:e}).getNestedGroupedFilters();se.value={...r}}async function L(){await Oe.value.validateVisibility()}return I(b,(e,t)=>{e!==t&&R.value&&(R.value=null)}),I(()=>{var e;return(e=y.value)==null?void 0:e.heading},()=>{var e;Be(`${((e=y.value)==null?void 0:e.heading)??"NocoDB"}`)},{flush:"post"}),I(c,async()=>{try{await $(Object.keys(c.value).map(e=>g.value[e]).filter(e=>e!==void 0))}catch{}},{deep:!0}),{sharedView:N,sharedFormView:y,loadSharedView:ke,columns:O,submitForm:Me,clearForm:fe,progress:T,meta:_,validators:ne,formColumns:A,formState:d,notFound:z,password:b,passwordError:R,submitted:E,secondsRemain:M,passwordDlg:q,isLoading:ye,sharedViewMeta:V,onReset:P.on,validate:$,validateInfos:Ve,clearValidate:ue,additionalState:c,isRequired:G,handleAddMissingRequiredFieldDefaultState:de,fieldMappings:g,isValidRedirectUrl:le,loadAllviewFilters:ce,checkFieldVisibility:L}},"shared-form-view-store");function wt(){const C=ot();if(C==null)throw new Error("Please call `useProvideSharedFormStore` on the appropriate parent component");return C}export{wt as a,ht as u};
