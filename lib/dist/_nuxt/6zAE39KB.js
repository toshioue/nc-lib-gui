import{u as ka}from"./DGy9VVU7.js";import{r as w,ce as A,L as Da,N as ba,g as M,aj as Sa,ag as Ya,at as Ra,cB as Ca,ai as Aa,cQ as xa,bL as Va,fB as Ha,g2 as Ja,H as C,cU as Pa,A as Na,an as H,ao as j,gg as Ta}from"./DKhUGBot.js";import{a as $a}from"./D-d1Vlq3.js";import{e as Ma,r as ja}from"./Ce4Hnuew.js";const ea=o=>o.map(c=>({row:{...c},oldRow:{...c},rowMeta:{}})),[La,Ea]=ka((o,c,ia=!1,P)=>{if(!o)throw new Error("Table meta is not available");const y=w(A()),{isUIAllowed:z}=Da(),{isMobileMode:ca}=ba(),E=M(()=>{var a,e;return(e=(a=o.value)==null?void 0:a.columns)==null?void 0:e.find(l=>l.pv)}),d=w(),T=Sa({value:"",field:""}),t=w(A()),b=w(A()),g=w(A()),q=w(!1),Q=w(!1),N=w(!ca.value),v=w({start:A(t.value).startOf("week"),end:A(t.value).startOf("week").add(6,"day")}),ta=25,G=w([]),F=w([]),I=w(!1),K=w([]),h=w(d.value??"allRecords"),{api:Z}=Ya(),{base:f}=Ra(Ca()),{$api:W,$e:la}=Na(),{t:B}=Aa(),{addUndo:va,clone:ra,defineViewScope:fa}=xa(),R=w(ia)||Va(Ha,w(!1)),{sorts:L,nestedFilters:J}=$a(),{sharedView:ya,fetchSharedViewData:ua,fetchSharedViewActiveDate:ma,fetchSharedCalendarViewData:wa}=Ja(),Y=w({}),oa=w({page:1,pageSize:ta}),X=M(()=>({limit:oa.value.pageSize??ta,where:(P==null?void 0:P.value)??""})),S=w([]),sa=M(()=>{var a,e;return!S.value||!S.value[0]?null:(e=(a=S.value[0])==null?void 0:a.fk_from_col)==null?void 0:e.uidt}),U=M(()=>{var e;let a=((e=Y.value)==null?void 0:e.meta)??{};if(typeof a=="string")try{a=JSON.parse(a)}catch{}return a}),$=M(()=>{let a=[];if(!S.value)return[];if(h.value==="allRecords")a=[];else if(h.value==="withoutDates")S.value.forEach(e=>{const l=e.fk_from_col,u=e.fk_to_col;if(!l)return;const r=[];l&&r.push({fk_column_id:l.id,logical_op:"or",comparison_op:"blank"}),u&&r.push({fk_column_id:u.id,logical_op:"or",comparison_op:"blank"}),a=[...a,...r]}),a=[{is_group:!0,logical_op:"or",children:a}];else if(h.value==="week"||h.value==="month"||h.value==="day"||h.value==="year"||h.value==="selectedDate"||h.value==="selectedHours"){let e=null,l=null,u=null,r=null;switch(h.value){case"day":l=t.value.startOf("day"),u=t.value.endOf("day"),e=t.value.subtract(1,"day").endOf("day"),r=t.value.add(1,"day").startOf("day");break;case"week":l=v.value.start.startOf("day"),u=v.value.end.endOf("day"),e=v.value.start.subtract(1,"day").endOf("day"),r=v.value.end.add(1,"day").startOf("day");break;case"month":{const s=g.value.startOf("month"),i=g.value.endOf("month"),_=Math.max(i.diff(s,"day")+1,35);l=s.subtract((s.day()+7)%7,"day").add(1,"day"),u=l.add(_,"day").endOf("day"),e=l.subtract(1,"day").endOf("day"),r=u.add(1,"day").startOf("day");break}case"year":l=t.value.startOf("year"),u=t.value.endOf("year"),e=l.subtract(1,"day").endOf("day"),r=u.add(1,"day").startOf("day");break;case"selectedDate":l=t.value.startOf("day"),u=t.value.endOf("day"),e=t.value.subtract(1,"day").endOf("day"),r=t.value.add(1,"day").startOf("day");break;case"selectedHours":l=(b.value??A()).startOf("hour"),u=(b.value??A()).endOf("hour"),e=l==null?void 0:l.subtract(1,"hour").endOf("hour"),r=u==null?void 0:u.add(1,"hour").startOf("hour");break}l=l.format("YYYY-MM-DD HH:mm:ssZ"),e=e.format("YYYY-MM-DD HH:mm:ssZ"),r=r.format("YYYY-MM-DD HH:mm:ssZ"),S.value.forEach(s=>{const i=s.fk_from_col,_=s.fk_to_col;let p=[];i&&_?(p=[{is_group:!0,logical_op:"and",children:[{fk_column_id:i.id,comparison_op:"lt",comparison_sub_op:"exactDate",value:r},{fk_column_id:_.id,comparison_op:"gt",comparison_sub_op:"exactDate",value:e}]},{fk_column_id:i.id,comparison_op:"eq",logical_op:"or",comparison_sub_op:"exactDate",value:l}],a.push({is_group:!0,logical_op:"or",children:p})):i&&(p=[{fk_column_id:i.id,comparison_op:"lt",comparison_sub_op:"exactDate",value:r},{fk_column_id:i.id,comparison_op:"gt",comparison_sub_op:"exactDate",value:e}],a.push({is_group:!0,logical_op:"and",children:p}))})}return E.value&&T.value&&(a.length>0?a=[{is_group:!0,logical_op:"and",children:[...a,{fk_column_id:E.value.id,comparison_op:"like",value:T.value}]}]:a.push({fk_column_id:E.value.id,comparison_op:"like",value:T.value})),a});async function pa(a={}){var e,l,u,r;if(!((!((e=f==null?void 0:f.value)!=null&&e.id)||!((l=o.value)!=null&&l.id)||!((u=c.value)!=null&&u.id))&&!R.value||!((r=S.value)!=null&&r.length))&&!I.value)try{const s=R.value?await ua({...a,sortsArr:L.value,filtersArr:[...J.value,...$.value],offset:a.offset}):await Z.dbViewRow.list("noco",f.value.id,o.value.id,c.value.id,{...a,offset:a.offset,...z("filterSync")?{filterArrJson:JSON.stringify([...$.value])}:{filterArrJson:JSON.stringify([J.value,...$.value])}});F.value=[...F.value,...ea(s.list)]}catch(s){console.log(s)}}const x=async()=>{var u,r,s,i,_,p,m;if(!((u=f==null?void 0:f.value)!=null&&u.id)||!((r=o.value)!=null&&r.id)||!((s=c.value)!=null&&s.id)||!((i=S.value)!=null&&i.length))return;let a=null,e=null,l=null;if(d.value==="week"||d.value==="day"||d.value==="month"){const n=y.value.startOf("month"),O=y.value.endOf("month"),D=Math.max(O.diff(n,"day")+1,35);l=n.subtract((n.day()+7)%7,"day");const ga=l.add(D,"day");a=l.subtract(1,"day").endOf("day"),e=ga.add(1,"day").startOf("day")}else d.value==="year"&&(a=t.value.startOf("year").subtract(1,"day").endOf("day"),e=t.value.endOf("year").add(1,"day").startOf("day"));if(a=a.format("YYYY-MM-DD HH:mm:ssZ"),e=e.format("YYYY-MM-DD HH:mm:ssZ"),!(!((_=f==null?void 0:f.value)!=null&&_.id)||!((p=o.value)!=null&&p.id)||!((m=c.value)!=null&&m.id)))try{const n=R.value?await ma({from_date:a,to_date:e,sortsArr:L.value,filtersArr:J.value}):await Z.dbCalendarViewRowCount.dbCalendarViewRowCount("noco",f.value.id,o.value.id,c.value.id,{...X.value,from_date:a,to_date:e});K.value=n.dates.map(O=>A(O)),n.count>3e3&&d.value!=="year"&&H.warning("This current date range has more than 3000 records. Some records may not be displayed. To get complete records, contact support")}catch(n){K.value=[],H.error(`${B("msg.error.fetchingActiveDates")} ${await j(n)}`),console.log(n)}},ha=async a=>{la("c:calendar:change-calendar-view",a);try{d.value=a,await na({meta:{...typeof Y.value.meta=="string"?JSON.parse(Y.value.meta):Y.value.meta,active_view:a}}),d.value==="week"&&(b.value=null)}catch(e){H.error("Error changing calendar view"),console.log(e)}};async function _a(){var a,e,l,u;if(!(!((a=c==null?void 0:c.value)!=null&&a.id)||!((e=o==null?void 0:o.value)!=null&&e.columns))){Q.value=!0;try{const r=R.value?(l=ya.value)==null?void 0:l.view:await W.dbView.calendarRead(c.value.id);Y.value=r;const s=typeof r.meta=="string"?JSON.parse(r.meta):r.meta;d.value=s==null?void 0:s.active_view,d.value||(d.value="month"),S.value=(u=r==null?void 0:r.calendar_range)==null?void 0:u.map(i=>{var _,p,m,n;return{id:i==null?void 0:i.id,fk_from_col:(p=(_=o.value)==null?void 0:_.columns)==null?void 0:p.find(O=>O.id===i.fk_from_column_id),fk_to_col:i.fk_to_column_id?(n=(m=o.value)==null?void 0:m.columns)==null?void 0:n.find(O=>O.id===i.fk_to_column_id):null}})}catch(r){H.error(`Error loading calendar meta ${await j(r)}`)}finally{Q.value=!1}}}async function V(a=!0){var s,i,_,p,m;if((!((s=f==null?void 0:f.value)!=null&&s.id)||!((i=o.value)!=null&&i.id)||!((_=c.value)!=null&&_.id))&&!(R!=null&&R.value)||!((p=S.value)!=null&&p.length)||d.value==="year")return;let e=null,l=null,u=null,r=null;switch(d.value){case"week":l=v.value.start.startOf("day"),u=v.value.end.endOf("day"),e=v.value.start.subtract(1,"day").endOf("day"),r=v.value.end.add(1,"day").startOf("day"),(m=U.value)!=null&&m.hide_weekend&&(u=u.subtract(2,"day"),r=r.subtract(2,"day"));break;case"month":{const n=g.value.startOf("month"),O=g.value.endOf("month"),D=Math.max(O.diff(n,"day")+1,35);l=n.subtract((n.day()+7)%7,"day"),u=l.add(D,"day"),e=l.subtract(1,"day").endOf("day"),r=u.add(1,"day").startOf("day");break}case"day":l=t.value.startOf("day"),u=t.value.endOf("day"),e=t.value.subtract(1,"day").endOf("day"),r=t.value.add(1,"day").startOf("day");break}e=e.format("YYYY-MM-DD HH:mm:ssZ"),r=r.format("YYYY-MM-DD HH:mm:ssZ");try{a&&(q.value=!0);const n=R.value?await wa({sortsArr:L.value,from_date:e,to_date:r,filtersArr:J.value}):await Z.dbCalendarViewRow.list("noco",f.value.id,o.value.id,c.value.id,{from_date:e,to_date:r},{...X.value,...z("filterSync")?{filterArrJson:[]}:{filterArrJson:JSON.stringify([J.value])},where:(P==null?void 0:P.value)??"",filterArrJson:JSON.stringify([...J.value])});G.value=ea(n.list)}catch(n){H.error(`${B("msg.error.fetchingCalendarData")} ${await j(n)}`),console.log(n)}finally{q.value=!1}}async function na(a){var l;if(!((l=c==null?void 0:c.value)!=null&&l.id)||!z("dataEdit",{skipSourceCheck:!0})||R.value)return;const e={...typeof Y.value.meta=="string"?JSON.parse(Y.value.meta):Y.value.meta,...typeof a.meta=="string"?JSON.parse(a.meta):a.meta};try{await W.dbView.calendarUpdate(c.value.id,{...a,meta:JSON.stringify(e)}),Y.value={...Y.value,...a,meta:e}}catch(u){H.error("Error updating changes"),console.log(u)}}function da(a){var l;const e=ja(a,(l=o==null?void 0:o.value)==null?void 0:l.columns);for(const u of G.value)if(Object.keys(e).every(r=>e[r]===u.row[r]))return u}const Oa=async a=>{switch(d.value){case"month":g.value=a==="next"?g.value.add(1,"month"):g.value.subtract(1,"month"),y.value=a==="next"?y.value.add(1,"month"):y.value.subtract(1,"month"),y.value.year()!==t.value.year()&&(y.value=t.value);break;case"year":t.value=a==="next"?t.value.add(1,"year"):t.value.subtract(1,"year"),y.value.year()!==t.value.year()&&(y.value=t.value);break;case"day":t.value=a==="next"?t.value.add(1,"day"):t.value.subtract(1,"day"),b.value=t.value,(y.value.year()!==t.value.year()||y.value.month()!==t.value.month())&&(y.value=t.value);break;case"week":v.value=a==="next"?{start:v.value.start.add(7,"day"),end:v.value.end.add(7,"day")}:{start:v.value.start.subtract(7,"day"),end:v.value.end.subtract(7,"day")},y.value.month()!==v.value.end.month()&&(y.value=v.value.start);break}},k=async(a=!0)=>{var e,l,u,r;if(!(!((e=f==null?void 0:f.value)!=null&&e.id)||!((l=o.value)!=null&&l.id)||!((u=c.value)!=null&&u.id)||!((r=S.value)!=null&&r.length)))try{a&&(I.value=!0);const s=R.value?await ua({sortsArr:L.value,filtersArr:[...J.value,...$.value]}):await Z.dbViewRow.list("noco",f.value.id,o.value.id,c.value.id,{...X.value,filterArrJson:JSON.stringify([...$.value])});F.value=ea(s.list)}catch(s){H.error(`${B("msg.error.fetchingCalendarData")} ${await j(s)}`),console.log(s)}finally{I.value=!1}};async function aa(a,e,l=!1){var u,r,s;try{const i=Ma(a.row,(u=o==null?void 0:o.value)==null?void 0:u.columns),_=e.reduce((m,n)=>(m[n]=a.row[n],m),{}),p=await W.dbViewRow.update(Ta,f==null?void 0:f.value.id,(r=o.value)==null?void 0:r.id,(s=c==null?void 0:c.value)==null?void 0:s.id,i,_);return l||(va({redo:{fn:async(m,n)=>{const O=await aa(m,n,!0),D=da(m.row);D&&Object.assign(D.row,O),Object.assign(D==null?void 0:D.oldRow,O)},args:[ra(a),e]},undo:{fn:async(m,n)=>{const O=await aa({row:m.oldRow,oldRow:m.row,rowMeta:m.rowMeta},n,!0),D=da(m.row);D&&Object.assign(D.row,O),Object.assign(D.oldRow,O)},args:[ra(a),e]},scope:fa({view:c.value})}),Object.assign(a.row,p),Object.assign(a.oldRow,p)),await x(),p}catch(i){H.error(`${B("msg.error.rowUpdateFailed")} ${await j(i)}`)}}return C(t,async(a,e)=>{d.value==="month"||d.value==="week"?h.value==="selectedDate"&&N.value&&await k():d.value==="year"?a.year()!==e.year()?await Promise.all([V(),k(),await x()]):h.value==="selectedDate"&&N.value&&await k():N.value?await Promise.all([k(),V()]):await Promise.all([V()]),d.value==="year"&&a.year()!==e.year()&&await x()}),C(b,async()=>{sa.value!==Pa.Date&&N.value&&h.value==="selectedHours"&&await k()}),C(g,async()=>{d.value==="month"&&await Promise.all([V(),k(),x()])}),C(v,async()=>{d.value==="week"&&await Promise.all([V(),k()])}),C(d,async(a,e)=>{e==="week"?(y.value=t.value,g.value=b.value??t.value??v.value.start,t.value=b.value??v.value.start,b.value=t.value??v.value.start):e==="month"?(t.value=g.value,y.value=t.value,b.value=t.value,v.value={start:t.value.startOf("week"),end:t.value.endOf("week")}):e==="day"?(y.value=t.value,b.value=t.value,g.value=t.value,v.value={start:t.value.startOf("week"),end:t.value.endOf("week")}):e==="year"&&(g.value=t.value,b.value=t.value,y.value=t.value,v.value={start:t.value.startOf("week"),end:t.value.endOf("week")}),h.value=d.value??"allRecords",d.value==="year"?await Promise.all([k(),x()]):await Promise.all([V(),k(),x()])}),C(N,async a=>{a&&await k()}),C(h,async()=>{la("a:calendar:sidebar-filter",h.value),await k()}),C(T,async()=>{await k()}),C(y,async()=>{d.value!=="year"&&await x()}),C(()=>U.value.hide_weekend,async()=>{d.value==="week"&&await V()}),{fetchActiveDates:x,formattedSideBarData:F,loadMoreSidebarData:pa,updateCalendarMeta:na,loadSidebarData:k,displayField:E,sideBarFilterOption:h,searchQuery:T,activeDates:K,isCalendarDataLoading:q,isCalendarMetaLoading:Q,changeCalendarView:ha,calDataType:sa,loadCalendarMeta:_a,calendarRange:S,loadCalendarData:V,formattedData:G,isSidebarLoading:I,showSideMenu:N,selectedTime:b,calendarMetaData:Y,updateRowProperty:aa,activeCalendarView:d,pageDate:y,paginationData:oa,selectedDate:t,selectedMonth:g,selectedDateRange:v,paginateCalendarView:Oa,viewMetaProperties:U}});function za(){const o=Ea();if(o==null)throw new Error("Please call `useProvideCalendarViewStore` on the appropriate parent component");return o}export{za as a,La as u};
