import{u as Qe,_ as We,v as Fe}from"./jpVQnSic.js";import{f as Ve,cM as je,aA as ze,az as Oe,bN as Re,g5 as qe,g as w,cU as Ge,r as _,ar as Ke,ai as He,fl as d,H as ce,i as Ye,g8 as $,o as f,c as D,a as i,b as n,w as s,a9 as x,P as a,aq as B,av as H,S as v,T as E,d as C,t as h,V as Je,W as Xe,Q as Y,U as ie,A as Ze,g7 as ea,aj as re,ak as de,g9 as aa,b1 as ta,gb as oa,dD as na,a1 as sa,$ as la,a0 as ca,dr as ia,p as ra,e as da,_ as ua}from"./3QBYHahY.js";import{_ as ma}from"./D7hrRKCy.js";import{a as pa,b as fa}from"./S2hS9mCy.js";import{_ as _a}from"./C726Gdw3.js";import{_ as va}from"./leimKhvx.js";import{b as ba,e as Sa,f as L}from"./CWtzMcwx.js";import{F as ue}from"./DAKhk9t6.js";import"./kHOslGNR.js";import{I as ha}from"./CmN9vPg3.js";import{_ as ga,C as ya}from"./CPUhUHn0.js";import{_ as wa}from"./Bk0xUMNV.js";import{S as xa}from"./BEpKpjF5.js";import"./DHsWytsD.js";import"./C95Svpv6.js";import"./S6k-HM05.js";import"./DiZ67kIC.js";import"./BsWDDIqE.js";import"./BQQOEPN4.js";import"./xnDaHwV-.js";import"./Kma333Sh.js";import"./BKGO7k13.js";import"./boyBAVNN.js";import"./BHEjdcp1.js";import"./CSl6euFG.js";import"./BrEnaVC0.js";import"./C00NHga8.js";import"./DgfVJyEd.js";import"./G4Pt-Lbf.js";import"./DbU9XkQ5.js";import"./ceYq-xax.js";import"./DD1BMgnW.js";import"./CQG617t7.js";import"./P3kwmRxC.js";import"./Dg1gNFnz.js";import"./Ci1lK5Ee.js";import"./CyuhXrst.js";import"./Cu_tC_Dm.js";import"./CdYx1kPu.js";import"./3ezdMRmZ.js";import"./BS24yECD.js";import"./Uiq3YTcq.js";import"./KpkGjOx_.js";import"./B3xChUf-.js";import"./C_IZzKNf.js";import"./CTSlxRce.js";import"./5_MZ2zba.js";import"./CJ26qO3d.js";import"./BVQBF9Vn.js";import"./DHn6lT7K.js";import"./DEDKhbvL.js";import"./DRopnK1z.js";import"./DmzaAQYu.js";import"./Wbpa_-L5.js";import"./CUFZaymE.js";import"./DkE_qgY_.js";import"./2yzrrcqg.js";import"./DdUr8XSo.js";import"./PcgFfkcK.js";import"./BkiSZLeF.js";import"./CsJPQclb.js";import"./DsWDg2xe.js";import"./WrawXyJR.js";import"./Ddy65kPJ.js";import"./wEQwkVjR.js";import"./DPgYHC40.js";import"./CGxepfeV.js";const Q=I=>(ra("data-v-e9859ce1"),I=I(),da(),I),ka={class:"edit-source bg-white relative h-full flex flex-col w-full"},Pa={class:"h-full max-h-[calc(100%_-_65px)] flex"},Ca={class:"nc-edit-source-left-panel nc-scrollbar-thin relative"},Ia={class:"h-full max-w-[768px] mx-auto"},Ta={class:"nc-form-section"},Ua={class:"nc-form-section-body"},Na=["data-testid"],$a={class:"nc-form-section"},Da={class:"nc-form-section-body"},Ea={class:"nc-form-section"},La=Q(()=>i("div",{class:"nc-form-section-title"},"Permissions",-1)),Aa={class:"nc-form-section-body"},Ma=Q(()=>i("div",{class:"nc-form-section-title"},"Advanced options",-1)),Ba=Q(()=>i("span",null,null,-1)),Qa={class:"flex flex-col gap-4"},Wa={class:"flex flex-col gap-4"},Fa=Q(()=>i("div",null,null,-1)),Va={class:"flex items-center justify-center h-full w-full !bg-white !bg-opacity-85 z-1000"},ja={class:"nc-edit-source-right-panel"},za={class:"p-4 w-full flex items-center justify-between gap-3 border-t-1 border-gray-200"},Oa={class:"flex-1 flex items-center gap-3"},Ra={class:"flex-1 flex items-center gap-3 text-[#C86827]"},qa={class:"flex items-center gap-3"},Ga=Ve({__name:"EditBase",props:{sourceId:{}},emits:["sourceUpdated","close"],setup(I,{emit:me}){const J=I,X=me,pe=je(),fe=ze(),{base:k}=Oe(pe),{integrations:W,loadIntegrations:_e}=Qe(),F=Re(qe,void 0),ve=w(()=>{var t;return(F==null?void 0:F.value)??((t=k.value)==null?void 0:t.id)}),{refreshCommandPalette:be}=Ge(),Se=ue.useForm,b=_(!1),V=_(!1),Z=_(),{api:j}=Ke(),{$e:A}=Ze(),{t:he}=He(),ge=_(!1),ye=_(!1),ee=_(0),P=_([]),T=_(!1),we=()=>{ee.value+=1,ee.value>=2&&(ye.value=!0)},e=_(((t=d.MYSQL)=>({title:"",dataSource:{...ea(t)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:$.No,extraParameters:[],is_schema_readonly:!0,is_data_readonly:!1}))()),g=w(()=>e.value.fk_integration_id&&W.value.find(t=>t.id===e.value.fk_integration_id)),xe=w(()=>{var t,o,c;return(c=(o=(t=g.value)==null?void 0:t.config)==null?void 0:o.connection)==null?void 0:c.database}),z=w(()=>{var t,o,c;return(c=(o=(t=g.value)==null?void 0:t.config)==null?void 0:o.searchPath)==null?void 0:c[0]}),ae=t=>{if(t==="database")return xe.value;if(t==="schema")return z.value},ke=w(()=>({title:[ba()],extraParameters:[Sa],"dataSource.client":[L()],...e.value.dataSource.client===d.SQLITE?{}:e.value.dataSource.client===d.SNOWFLAKE?{"dataSource.connection.database":[L()],"dataSource.connection.schema":[L()]}:{"dataSource.connection.database":g.value&&ae("database")?[]:[L()],...[d.PG,d.MSSQL].includes(e.value.dataSource.client)&&e.value.dataSource.searchPath?{"dataSource.searchPath.0":g.value&&ae("schema")?[]:[L()]}:{}}})),{validate:te,validateInfos:y}=Se(e,ke),Pe=()=>{if(e.value.dataSource.client!==d.SQLITE){const t=e.value.dataSource.connection;t.ssl?typeof t.ssl=="string"?e.value.sslUse=$.Allowed:e.value.sslUse=$.Preferred:e.value.sslUse=$.No}},oe=["camelize","none"];function ne(){const t=Object.fromEntries(new Map(e.value.extraParameters.map(c=>[c.key,c.value]))),o={...e.value.dataSource.connection,...t};return o.ssl=Fe(o,e.value.sslUse,e.value.dataSource.client),o}const se=()=>{var t,o,c,r,m;(m=(r=(c=(o=(t=Z.value)==null?void 0:t.$el.querySelector(".ant-form-item-explain-error"))==null?void 0:o.parentNode)==null?void 0:c.parentNode)==null?void 0:r.querySelector("input"))==null||m.focus()},Ce=async()=>{var t,o,c,r,m,u;try{await te()}catch{se();return}try{if(!((t=k.value)!=null&&t.id))return;const S=ne(),p={...e.value.dataSource,connection:S};p.client===d.SQLITE&&((c=(o=p.connection)==null?void 0:o.connection)!=null&&c.filename)&&(p.connection.filename=p.connection.connection.filename),g.value&&(((r=p.connection)==null?void 0:r.database)===""&&(p.connection.database=void 0),((m=p.searchPath)==null?void 0:m[0])===""&&(p.searchPath=void 0)),await j.source.update((u=k.value)==null?void 0:u.id,J.sourceId,{alias:e.value.title,type:e.value.dataSource.client,config:p,inflection_column:e.value.inflection.inflectionColumn,inflection_table:e.value.inflection.inflectionTable,is_schema_readonly:e.value.is_schema_readonly,is_data_readonly:e.value.is_data_readonly}),A("a:source:edit:extdb"),await fe.loadProject(ve.value,!0),X("sourceUpdated"),X("close")}catch(S){re.error(await de(S))}finally{be()}},U=_(),Ie=async()=>{try{await te()}catch{se();return}A("a:source:edit:extdb:test-connection",[]);try{if(V.value=!0,e.value.dataSource.client===d.SQLITE)b.value=!0;else{const t=ne();t.database=aa(e.value.dataSource);let o=e.value.dataSource.searchPath;g.value&&((t==null?void 0:t.database)===""&&(t.database=void 0),(o==null?void 0:o[0])===""&&(o=void 0));const c={...e.value.dataSource,connection:t,searchPath:o,fk_integration_id:e.value.fk_integration_id},r=await j.utils.testConnection(c);r.code===0?b.value=!0:(b.value=!1,re.error(`${he("msg.error.dbConnectionFailed")} ${r.message}`))}}catch(t){b.value=!1,U.value=await de(t)}V.value=!1};ce(()=>e.value.dataSource,()=>{b.value=!1,U.value=null},{deep:!0}),Ye(async()=>{var t,o,c,r;if(T.value=!0,W.value.length||await _e(!0,(t=k.value)==null?void 0:t.id),(o=k.value)!=null&&o.id){const m=["host","port","user","password","database"],u=await j.source.read((c=k.value)==null?void 0:c.id,J.sourceId),S=Object.entries(u.config.connection||{}).filter(([p])=>!m.includes(p)).map(([p,N])=>({key:p,value:N}));e.value={title:u.alias||"",dataSource:{connection:{},...u.config||{},searchPath:((r=u.config)==null?void 0:r.searchPath)||[]},inflection:{inflectionColumn:u.inflection_column,inflectionTable:u.inflection_table},extraParameters:S,sslUse:$.No,is_schema_readonly:u.is_schema_readonly,is_data_readonly:u.is_data_readonly,fk_integration_id:u.fk_integration_id},Pe()}T.value=!1}),ce(()=>e.value.dataSource.searchPath,t=>{[d.PG,d.MSSQL].includes(e.value.dataSource.client)&&!t&&(e.value.dataSource.searchPath=[])},{immediate:!0});const O=w({get:()=>!e.value.is_schema_readonly,set:t=>{e.value.is_schema_readonly=!t,t&&(e.value.is_data_readonly=!1),A("c:source:schema-write-toggle",{allowed:!t,edit:!0})}}),R=w({get:()=>!e.value.is_data_readonly,set:t=>{e.value.is_data_readonly=!t,A("c:source:data-write-toggle",{allowed:!t,edit:!0})}}),Te=t=>{t?(P.value=["1"],Ue(!0,"nc-source-advanced-options")):P.value=[]};let q;function Ue(t,o){q&&clearTimeout(q),ta(()=>{const c=document.querySelector(`.edit-source .${o}`);c&&(q=setTimeout(()=>{c.scrollIntoView({block:"center",behavior:"smooth"})},400))})}return(t,o)=>{const c=ha,r=wa,m=oa,u=na,S=We,p=sa,N=xa,G=ma,Ne=pa,M=la,K=ca,$e=ga,De=ya,Ee=ue,Le=ia,Ae=_a,Me=fa,Be=va;return f(),D("div",ka,[i("div",Pa,[i("div",Ca,[i("div",Ia,[n(Ee,{ref_key:"form",ref:Z,model:a(e),"hide-required-mark":"",name:"external-base-create-form",layout:"vertical","no-style":"",class:"flex flex-col gap-5.5"},{default:s(()=>[i("div",Ta,[i("div",Ua,[n(u,{gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,x({label:"Data Source Name"},a(y).title),{default:s(()=>[n(c,{value:a(e).title,"onUpdate:value":o[0]||(o[0]=l=>a(e).title=l),class:"nc-extdb-proj-name"},null,8,["value"])]),_:1},16)]),_:1})]),_:1}),n(u,{gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,{label:"Select connection"},{default:s(()=>[n(G,{value:a(e).fk_integration_id,disabled:"",class:"nc-extdb-db-type nc-select-shadow","dropdown-class-name":"nc-dropdown-ext-db-type",placeholder:"Select connection","allow-clear":"","show-search":"","dropdown-match-select-width":""},{default:s(()=>[(f(!0),D(B,null,H(a(W),l=>(f(),v(N,{key:l.id,value:l.id},{default:s(()=>[i("div",{class:"w-full flex gap-2 items-center","data-testid":l.title},[l!=null&&l.sub_type?(f(),v(S,{key:0,type:l.sub_type,style:{filter:"grayscale(100%) brightness(115%)"}},null,8,["type"])):E("",!0),n(p,{class:"flex-1 truncate","show-on-truncate-only":""},{title:s(()=>[C(h(l.title),1)]),default:s(()=>[C(" "+h(l.title),1)]),_:2},1024),a(e).fk_integration_id===l.id?(f(),v(Je(("iconMap"in t?t.iconMap:a(Xe)).check),{key:1,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):E("",!0)],8,Na)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})])]),i("div",$a,[i("div",Da,[a(e).dataSource.client===a(d).SQLITE?(f(),D(B,{key:0},[],64)):a(e).dataSource.client===a(d).SNOWFLAKE?(f(),v(u,{key:1,gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,x({label:t.$t("labels.database")},a(y)["dataSource.connection.database"]),{default:s(()=>[n(c,{value:a(e).dataSource.connection.database,"onUpdate:value":o[1]||(o[1]=l=>a(e).dataSource.connection.database=l),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16,["label"])]),_:1}),n(m,{span:12},{default:s(()=>[n(r,x({label:"Schema"},a(y)["dataSource.connection.schema"]),{default:s(()=>[n(c,{value:a(e).dataSource.connection.schema,"onUpdate:value":o[2]||(o[2]=l=>a(e).dataSource.connection.schema=l),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16)]),_:1})]),_:1})):a(e).dataSource.client===a(d).DATABRICKS?(f(),v(u,{key:2,gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,x({label:"Database"},a(y)["dataSource.connection.database"]),{default:s(()=>[n(c,{value:a(e).dataSource.connection.database,"onUpdate:value":o[3]||(o[3]=l=>a(e).dataSource.connection.database=l),class:"nc-extdb-host-database"},null,8,["value"])]),_:1},16)]),_:1}),n(m,{span:12},{default:s(()=>[n(r,x({label:"Schema"},a(y)["dataSource.connection.schema"]),{default:s(()=>[n(c,{value:a(e).dataSource.connection.schema,"onUpdate:value":o[4]||(o[4]=l=>a(e).dataSource.connection.schema=l),class:"nc-extdb-host-schema"},null,8,["value"])]),_:1},16)]),_:1})]),_:1})):(f(),v(u,{key:3,gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,x({label:t.$t("labels.database")},a(y)["dataSource.connection.database"]),{default:s(()=>[n(c,{value:a(e).dataSource.connection.database,"onUpdate:value":o[5]||(o[5]=l=>a(e).dataSource.connection.database=l),placeholder:t.$t("labels.dbCreateIfNotExists"),class:"nc-extdb-host-database"},null,8,["value","placeholder"])]),_:1},16,["label"])]),_:1}),n(m,{span:12},{default:s(()=>{var l;return[([a(d).MSSQL,a(d).PG].includes(a(e).dataSource.client)||[a(d).MSSQL,a(d).PG].includes((l=a(g))==null?void 0:l.sub_type))&&a(e).dataSource.searchPath?(f(),v(r,x({key:0,label:t.$t("labels.schemaName")},a(y)["dataSource.searchPath.0"]),{default:s(()=>[n(c,{value:a(e).dataSource.searchPath[0],"onUpdate:value":o[6]||(o[6]=le=>a(e).dataSource.searchPath[0]=le),placeholder:a(z)&&`${a(z)} (default)`},null,8,["value","placeholder"])]),_:1},16,["label"])):E("",!0)]}),_:1})]),_:1}))])]),i("div",Ea,[La,i("div",Aa,[n(Ne,{allowMetaWrite:a(O),"onUpdate:allowMetaWrite":o[7]||(o[7]=l=>Y(O)?O.value=l:null),allowDataWrite:a(R),"onUpdate:allowDataWrite":o[8]||(o[8]=l=>Y(R)?R.value=l:null)},null,8,["allowMetaWrite","allowDataWrite"])])]),[a(d).SQLITE,a(d).SNOWFLAKE,a(d).DATABRICKS].includes(a(e).dataSource.client)?E("",!0):(f(),v(De,{key:0,"active-key":a(P),"onUpdate:activeKey":o[12]||(o[12]=l=>Y(P)?P.value=l:null),ghost:"",class:"nc-source-advanced-options !mt-4"},{expandIcon:s(({isActive:l})=>[n(K,{type:"text",size:"small",class:"!-ml-1.5",onClick:o[9]||(o[9]=le=>Te(!a(P).length))},{default:s(()=>[Ma,n(M,{icon:"chevronDown",class:ie(["ml-2 flex-none cursor-pointer transform transition-transform duration-500",{"!rotate-180":l}])},null,8,["class"])]),_:2},1024)]),default:s(()=>[n($e,{key:"1",collapsible:"disabled"},{header:s(()=>[Ba]),default:s(()=>[i("div",Qa,[i("div",Wa,[n(u,{gutter:24},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(r,{label:t.$t("labels.inflection.tableName")},{default:s(()=>[n(G,{value:a(e).inflection.inflectionTable,"onUpdate:value":o[10]||(o[10]=l=>a(e).inflection.inflectionTable=l),class:"nc-select-shadow","dropdown-class-name":"nc-dropdown-inflection-table-name"},{default:s(()=>[(f(),D(B,null,H(oe,l=>n(N,{key:l,value:l},{default:s(()=>[C(h(l),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"])]),_:1}),n(m,{span:12},{default:s(()=>[n(r,{label:t.$t("labels.inflection.columnName")},{default:s(()=>[n(G,{value:a(e).inflection.inflectionColumn,"onUpdate:value":o[11]||(o[11]=l=>a(e).inflection.inflectionColumn=l),class:"nc-select-shadow","dropdown-class-name":"nc-dropdown-inflection-column-name"},{default:s(()=>[(f(),D(B,null,H(oe,l=>n(N,{key:l,value:l},{default:s(()=>[C(h(l),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["active-key"])),Fa]),_:1},8,["model"])]),n(Ae,{"model-value":a(T),inline:"",transition:"",class:"!bg-opacity-15"},{default:s(()=>[i("div",Va,[n(Le,{size:"large"})])]),_:1},8,["model-value"])]),i("div",ja,[n(Me),n(Be)])]),i("div",za,[i("div",Oa,[i("div",Ra,[n(M,{icon:"alertTriangle",class:"flex-none"}),i("div",null,h(t.$t("msg.warning.dbValid")),1)])]),i("div",qa,[i("div",{class:"w-[15px] h-[15px] cursor-pointer",onDblclick:we},null,32),n(p,{disabled:!a(U)},{title:s(()=>[C(h(a(U)),1)]),default:s(()=>[n(K,{type:"secondary",size:"small",class:ie(["nc-extdb-btn-test-connection",{"pointer-events-none":a(b)}]),loading:a(V),disabled:a(T),"icon-position":"right",onClick:Ie},{icon:s(()=>[a(b)?(f(),v(M,{key:0,icon:"circleCheckSolid",class:"!text-green-700 w-4 h-4"})):a(U)?(f(),v(M,{key:1,icon:"alertTriangleSolid",class:"!text-red-700 w-4 h-4"})):E("",!0)]),default:s(()=>[i("span",null,h(a(b)?"Test successful":"Test connection"),1)]),_:1},8,["class","loading","disabled"])]),_:1},8,["disabled"]),n(K,{size:"small",type:"primary",disabled:!a(b)||a(T),loading:a(ge),class:"nc-extdb-btn-submit",onClick:Ce},{default:s(()=>[C(h(t.$t("general.submit")),1)]),_:1},8,["disabled","loading"])])])])}}}),io=ua(Ga,[["__scopeId","data-v-e9859ce1"]]);export{io as default};
