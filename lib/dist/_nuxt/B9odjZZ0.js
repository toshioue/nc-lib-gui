import{ai as Oe,cP as Me,cQ as Ee,at as ye,cB as je,cG as _e,bL as Le,hd as Ne,g as re,gg as V,an as U,ao as H,hy as Ue,hz as Ke,cU as $,fO as Pe,A as $e,cH as Qe,ge as qe,ag as Ge,u as He,N as Je,r as b,fB as Xe,g2 as Ze,L as We,cZ as Ye,d4 as ze,hA as me}from"./DKhUGBot.js";import{a as be}from"./D-d1Vlq3.js";import{d as Ve,p as xe,e as X,r as F,f as ie,i as ke,h as Te}from"./Ce4Hnuew.js";import{b as eo,c as oo,d as to}from"./lyxpGZoZ.js";import{a as no}from"./B6xwUs71.js";function io(fe){const{meta:o,viewMeta:z,formattedData:l,paginationData:f,callbacks:e}=fe,{t:Z}=Oe(),{getMeta:ae,metas:he}=Me(),{addUndo:k,clone:B,defineViewScope:ee}=Ee(),{base:j}=ye(je()),{$api:q}=$e(),{isPaginationLoading:W}=ye(_e()),_=Le(Ne),se=re({get(){return!!l.value.length&&l.value.every(t=>t.rowMeta.selected)},set(t){l.value.forEach(n=>n.rowMeta.selected=t)}});function Re(t=l.value.length,n=o.value){return l.value.splice(t,0,{row:{...Ve(n==null?void 0:n.columns)},oldRow:{},rowMeta:{new:!0}}),l.value[t]}async function oe(t,n={},{metaValue:r=o.value,viewMetaValue:i=z.value}={},d=!1){var x,h;const S=t.row;t.rowMeta&&(t.rowMeta.saving=!0);try{const{missingRequiredColumns:c,insertObj:a}=await xe({meta:r,ltarState:n,getMeta:ae,row:S,undo:d});if(c.size)return;const I=await q.dbViewRow.create(V,j==null?void 0:j.value.id,r==null?void 0:r.id,i==null?void 0:i.id,{...a,...n||{}});if(await(_==null?void 0:_.trigger()),!d){Object.assign(t,{row:{...I,...S},rowMeta:{...t.rowMeta||{},new:void 0},oldRow:{...I}});const y=X(I,r==null?void 0:r.columns),u=F(I,r==null?void 0:r.columns),w=ie(u,l.value);k({redo:{fn:async function(s,p,v){var m,L;s.row={...u,...s.row};const D=await oe(s,p,void 0,!0);w!==-1&&v.pageSize===f.value.pageSize?v.page===f.value.page?l.value.splice(w,0,{row:{...s,...D},rowMeta:s.rowMeta,oldRow:s.oldRow}):await((m=e==null?void 0:e.changePage)==null?void 0:m.call(e,v.page)):await((L=e==null?void 0:e.loadData)==null?void 0:L.call(e))},args:[B(t),B(n),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(s){await ge(s),w!==-1&&l.value.splice(w,1),f.value.totalRows=f.value.totalRows-1},args:[y]},scope:ee({view:z.value})})}return await((x=e==null?void 0:e.syncCount)==null?void 0:x.call(e)),I}catch(c){U.error(await H(c))}finally{t.rowMeta&&(t.rowMeta.saving=!1),await((h=e==null?void 0:e.globalCallback)==null?void 0:h.call(e))}}async function ve(t,{metaValue:n=o.value,viewMetaValue:r=z.value}={},i=!1){var S,x,h;W.value=!0;const d=B((n==null?void 0:n.columns)||[]).filter(c=>!c.pk&&(Ue(c)||Ke(c))).map(c=>c.title);try{const c=((S=await Promise.all(t.map(async I=>{const{missingRequiredColumns:y,insertObj:u}=await xe({meta:n,ltarState:{},getMeta:ae,row:I.row,undo:i});if(y.size===0)return d.forEach(w=>delete u[w]),u})))==null?void 0:S.filter(Boolean))??[],a=await q.dbDataTableRow.create(n==null?void 0:n.id,c,{viewId:r==null?void 0:r.id});return await((x=e==null?void 0:e.syncCount)==null?void 0:x.call(e)),a}catch(c){U.error(await H(c))}finally{await((h=e==null?void 0:e.globalCallback)==null?void 0:h.call(e)),W.value=!1}}async function ue(t,n,{metaValue:r=o.value,viewMetaValue:i=z.value}={},d=!1){var S;t.rowMeta&&(t.rowMeta.saving=!0);try{const x=X(t.row,r==null?void 0:r.columns),h=await q.dbViewRow.update(V,j==null?void 0:j.value.id,r==null?void 0:r.id,i==null?void 0:i.id,x,{[n]:t.row[n]??null});return await(_==null?void 0:_.trigger({fields:[{title:n}]})),d||(k({redo:{fn:async function(a,I,y){var w,R,s;const u=await ue(a,I,void 0,!0);if(y.page===f.value.page&&y.pageSize===f.value.pageSize){const p=ie(F(a.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),l.value);if(p!==-1){const v=l.value[p];Object.assign(v.row,u),Object.assign(v.oldRow,u)}else await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e))}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,y.page))},args:[B(t),n,{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(a,I,y){var w,R,s;const u=await ue({row:a.oldRow,oldRow:a.row,rowMeta:a.rowMeta},I,void 0,!0);if(y.page===f.value.page&&y.pageSize===f.value.pageSize){const p=ie(F(a.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),l.value);if(p!==-1){const v=l.value[p];Object.assign(v.row,u),Object.assign(v.oldRow,u)}else await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e))}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,y.page))},args:[B(t),n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ee({view:z.value})}),Object.assign(t.row,r.columns.reduce((c,a)=>(a.title in h&&(a.uidt===$.Formula||a.uidt===$.QrCode||a.uidt===$.Barcode||a.uidt===$.Rollup||a.uidt===$.Checkbox||a.uidt===$.User||a.uidt===$.LastModifiedTime||a.uidt===$.LastModifiedBy||a.uidt===$.Lookup||a.au||ke(a==null?void 0:a.cdf)&&/ on update /i.test(a.cdf))&&(c[a.title]=h[a.title]),c),{})),Object.assign(t.oldRow,h)),await((S=e==null?void 0:e.globalCallback)==null?void 0:S.call(e)),h}catch(x){t.row[n]=t.oldRow[n],U.error(`${Z("msg.error.rowUpdateFailed")}: ${await H(x)}`)}finally{t.rowMeta&&(t.rowMeta.saving=!1)}}async function ce(t,n,r,i={}){if(t.rowMeta&&(t.rowMeta.changed=!1),await Pe(()=>{var d,S;return!((d=t.rowMeta)!=null&&d.new&&((S=t.rowMeta)!=null&&S.saving))}).toMatch(d=>d),t.rowMeta.new)return await oe(t,r,i);n&&await ue(t,n,i)}async function M(t,n,{metaValue:r=o.value,viewMetaValue:i=z.value}={},d=!1){var h,c;const S=[];for(const a of t)a.rowMeta&&(a.rowMeta.changed=!1),S.push(Pe(()=>{var I,y;return!((I=a.rowMeta)!=null&&I.new&&((y=a.rowMeta)!=null&&y.saving))}).toMatch(I=>I));await Promise.all(S);const x=[];for(const a of t){a.rowMeta&&(a.rowMeta.saving=!0);const I=F(a.row,r==null?void 0:r.columns),y=n.reduce((u,w)=>(u[w]=a.row[w],u),{});x.push({...y,...I})}await q.dbTableRow.bulkUpdate(V,r==null?void 0:r.base_id,r==null?void 0:r.id,x),await(_==null?void 0:_.trigger({fields:n.map(a=>({title:a}))})),d||k({redo:{fn:async function(I,y,u){var w,R,s;if(await M(I,y,{metaValue:r,viewMetaValue:i},!0),u.page===f.value.page&&u.pageSize===f.value.pageSize)for(const p of I){const v=ie(F(p.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),l.value);if(v!==-1){const D=l.value[v];Object.assign(D.row,p.row),Object.assign(D.oldRow,p.row)}else{await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e));break}}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,u.page))},args:[B(t),B(n),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(I,y,u){var w,R,s;if(await M(I,y,{metaValue:r,viewMetaValue:i},!0),u.page===f.value.page&&u.pageSize===f.value.pageSize)for(const p of I){const v=ie(F(p.row,(w=o==null?void 0:o.value)==null?void 0:w.columns),l.value);if(v!==-1){const D=l.value[v];Object.assign(D.row,p.row),Object.assign(D.oldRow,p.row)}else{await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e));break}}else await((s=e==null?void 0:e.changePage)==null?void 0:s.call(e,u.page))},args:[B(t.map(a=>({row:a.oldRow,oldRow:a.row,rowMeta:a.rowMeta}))),n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ee({view:i})});for(const a of t)a.rowMeta&&(a.rowMeta.saving=!1);r.columns.some(a=>[$.QrCode,$.LastModifiedTime,$.Barcode,$.Formula,$.Lookup,$.Rollup,$.LinkToAnotherRecord,$.LastModifiedBy].includes(a.uidt))&&await((h=e==null?void 0:e.loadData)==null?void 0:h.call(e)),await((c=e==null?void 0:e.globalCallback)==null?void 0:c.call(e))}async function Ie(t,{metaValue:n=o.value,viewMetaValue:r=z.value}={}){var i,d;r&&(await q.dbTableRow.bulkUpdateAll(V,n==null?void 0:n.base_id,n==null?void 0:n.id,t,{viewId:r.id}),await(_==null?void 0:_.trigger()),await((i=e==null?void 0:e.loadData)==null?void 0:i.call(e)),await((d=e==null?void 0:e.globalCallback)==null?void 0:d.call(e)))}const Y=async(t,n,r,i,{metaValue:d=o.value}={})=>{try{await q.dbTableRow.nestedAdd(V,j.value.id,d==null?void 0:d.id,encodeURIComponent(t),i,r.title,encodeURIComponent(n))}catch(S){U.error(await H(S))}},J=async(t,{metaValue:n=o.value}={})=>{var i;const r=X(t,n==null?void 0:n.columns);for(const d of(n==null?void 0:n.columns)??[]){if(d.uidt!==$.LinkToAnotherRecord)continue;const S=d.colOptions,x=(i=he.value)==null?void 0:i[S==null?void 0:S.fk_related_model_id];if(eo(d)||oo(d)){const h=t[d.title]??[];for(const c of h)await Y(r,X(c,x.columns),d,S.type,{metaValue:n})}else to(d)&&t[d.title]&&await Y(r,X(t[d.title],x.columns),d,S.type,{metaValue:n})}};async function ge(t,{metaValue:n=o.value,viewMetaValue:r=z.value}={}){if(!t)throw new Error("Delete not allowed for table which doesn't have primary Key");const i=await q.dbViewRow.delete("noco",j.value.id,n==null?void 0:n.id,r==null?void 0:r.id,encodeURIComponent(t));return await(_==null?void 0:_.trigger()),i.message?(U.info(`Record delete failed: ${`Unable to delete record with ID ${t} because of the following:
              
${i.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}async function De(t,n){var r,i,d,S,x;try{const h=l.value[t];if(!h.rowMeta.new){const c=(i=(r=o==null?void 0:o.value)==null?void 0:r.columns)==null?void 0:i.filter(y=>y.pk).map(y=>h.row[y.title]).join("___"),a=await q.dbTableRow.read(V,j==null?void 0:j.value.id,(d=o.value)==null?void 0:d.id,encodeURIComponent(c),{getHiddenColumn:!0});if(h.row=a,!await ge(c))return;n||k({redo:{fn:async function(u){var s;await ge(u);const w=F(h.row,(s=o==null?void 0:o.value)==null?void 0:s.columns),R=ie(w,l.value);R!==-1&&l.value.splice(R,1),f.value.totalRows=f.value.totalRows-1},args:[c]},undo:{fn:async function(u,w,R){var p,v,D;const s=F(u.row,(p=o.value)==null?void 0:p.columns);u.row={...s,...u.row},await oe(u,w,{},!0),J(u.row),t!==-1&&R.pageSize===f.value.pageSize?R.page===f.value.page?l.value.splice(t,0,u):await((v=e==null?void 0:e.changePage)==null?void 0:v.call(e,R.page)):await((D=e==null?void 0:e.loadData)==null?void 0:D.call(e))},args:[B(h),{},{page:f.value.page,pageSize:f.value.pageSize}]},scope:ee({view:z.value})})}l.value.splice(t,1),await((S=e==null?void 0:e.syncCount)==null?void 0:S.call(e))}catch(h){U.error(`${Z("msg.error.deleteRowFailed")}: ${await H(h)}`)}await((x=e==null?void 0:e.globalCallback)==null?void 0:x.call(e))}async function pe(){var d,S,x,h,c,a,I,y;let t=l.value.length;const n=[];let r="";for(;t--;){const{row:u,rowMeta:w}=l.value[t];if(w.selected&&!w.new){const R=Te((d=o==null?void 0:o.value)==null?void 0:d.columns),s=X(u,(S=o==null?void 0:o.value)==null?void 0:S.columns),p=F(u,(x=o==null?void 0:o.value)==null?void 0:x.columns);R&&s&&(r||(r=R),n.push({[r]:s,pkData:p,row:B(l.value[t]),rowIndex:t}))}}if(!n.length)return;W.value=!0;const{list:i}=await q.dbTableRow.list(V,j==null?void 0:j.value.id,(h=o.value)==null?void 0:h.id,{pks:n.map(u=>u[r]).join(",")});try{for(const u of n){const w=u.row,R=F(w.row,(c=o==null?void 0:o.value)==null?void 0:c.columns),s=i.find(p=>Object.keys(R).every(v=>R[v]===p[v]));w.row=B(s)}await te(n.map(u=>u.pkData))}catch(u){return U.error(`${Z("msg.error.deleteRowFailed")}: ${await H(u)}`)}if(!n.length){W.value=!1;return}k({redo:{fn:async function(w){var s,p,v,D;W.value=!0;const R=await te(w.map(m=>m.pkData));if(Array.isArray(R))for(const{row:m}of w){const L=F(m.row,(s=o==null?void 0:o.value)==null?void 0:s.columns),G=ie(L,l.value);G!==-1&&l.value.splice(G,1),f.value.totalRows=f.value.totalRows-1}await((p=e==null?void 0:e.syncCount)==null?void 0:p.call(e)),await((v=e==null?void 0:e.syncPagination)==null?void 0:v.call(e)),await((D=e==null?void 0:e.globalCallback)==null?void 0:D.call(e))},args:[n]},undo:{fn:async function(w,R){var v,D;const s=w.map(m=>{var G;const L=F(m.row,(G=o.value)==null?void 0:G.columns);return m.row={...L,...m.row},m}).reverse(),p=await ve(s.map(m=>m.row),void 0,!0);if(Array.isArray(p))for(const{row:m,rowIndex:L}of s)J(m.row),L!==-1&&R.pageSize===f.value.pageSize?R.page===f.value.page?l.value.splice(L,0,m):await((v=e==null?void 0:e.changePage)==null?void 0:v.call(e,R.page)):await((D=e==null?void 0:e.loadData)==null?void 0:D.call(e))},args:[n,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ee({view:z.value})}),await((a=e==null?void 0:e.syncCount)==null?void 0:a.call(e)),await((I=e==null?void 0:e.syncPagination)==null?void 0:I.call(e)),await((y=e==null?void 0:e.globalCallback)==null?void 0:y.call(e))}async function de(t){var h,c,a,I,y,u,w,R;if(!t._start||!t._end)return;const n=Math.max(t._start.row,t._end.row),r=Math.min(t._start.row,t._end.row);let i=n+1;const d=[];let S="";for(;i--;){try{const{row:s,rowMeta:p}=l.value[i];if(!p.new){const v=Te((h=o==null?void 0:o.value)==null?void 0:h.columns),D=X(s,(c=o==null?void 0:o.value)==null?void 0:c.columns),m=F(s,(a=o==null?void 0:o.value)==null?void 0:a.columns);v&&D&&(S||(S=v),d.push({[S]:D,pkData:m,row:B(l.value[i]),rowIndex:i}))}}catch(s){return U.error(`${Z("msg.error.deleteRowFailed")}: ${await H(s)}`)}if(i===r)break}if(!d.length)return;W.value=!0;const{list:x}=await q.dbTableRow.list(V,j==null?void 0:j.value.id,(I=o.value)==null?void 0:I.id,{pks:d.map(s=>s[S]).join(",")});try{for(const s of d){const p=s.row,v=F(p.row,(y=o==null?void 0:o.value)==null?void 0:y.columns),D=x.find(m=>Object.keys(v).every(L=>v[L]===m[L]));p.row=B(D)}await te(d.map(s=>s.pkData))}catch(s){return U.error(`${Z("msg.error.deleteRowFailed")}: ${await H(s)}`)}if(!d.length){W.value=!1;return}k({redo:{fn:async function(p){var D,m,L,G;W.value=!0;const v=await te(p.map(E=>E.pkData));if(Array.isArray(v))for(const{row:E}of p){const ne=F(E.row,(D=o==null?void 0:o.value)==null?void 0:D.columns),we=ie(ne,l.value);we!==-1&&l.value.splice(we,1),f.value.totalRows=f.value.totalRows-1}await((m=e==null?void 0:e.syncCount)==null?void 0:m.call(e)),await((L=e==null?void 0:e.syncPagination)==null?void 0:L.call(e)),await((G=e==null?void 0:e.globalCallback)==null?void 0:G.call(e))},args:[d]},undo:{fn:async function(p,v){var L,G;const D=p.map(E=>{var we;const ne=F(E.row,(we=o.value)==null?void 0:we.columns);return E.row={...ne,...E.row},E}).reverse(),m=await ve(D.map(E=>E.row),void 0,!0);if(Array.isArray(m))for(const{row:E,rowIndex:ne}of D)J(E.row),ne!==-1&&v.pageSize===f.value.pageSize?v.page===f.value.page?l.value.splice(ne,0,E):await((L=e==null?void 0:e.changePage)==null?void 0:L.call(e,v.page)):await((G=e==null?void 0:e.loadData)==null?void 0:G.call(e))},args:[d,{page:f.value.page,pageSize:f.value.pageSize}]},scope:ee({view:z.value})}),await((u=e==null?void 0:e.syncCount)==null?void 0:u.call(e)),await((w=e==null?void 0:e.syncPagination)==null?void 0:w.call(e)),await((R=e==null?void 0:e.globalCallback)==null?void 0:R.call(e))}async function te(t,{metaValue:n=o.value,viewMetaValue:r=z.value}={}){try{const i=await q.dbDataTableRow.delete(n==null?void 0:n.id,t.length===1?t[0]:t,{viewId:r==null?void 0:r.id});return await(_==null?void 0:_.trigger()),t.length===1&&i?[i]:i}catch(i){U.error(await H(i))}}return{insertRow:oe,updateRowProperty:ue,addEmptyRow:Re,deleteRow:De,deleteRowById:ge,deleteSelectedRows:pe,deleteRangeOfRows:de,updateOrSaveRow:ce,bulkUpdateRows:M,bulkUpdateView:Ie,selectedAllRecords:se,removeRowIfNew:t=>{const n=l.value.indexOf(t);return n>-1&&t.rowMeta.new?(l.value.splice(n,1),!0):!1},bulkDeleteRows:te,bulkInsertRows:ve}}const ro=fe=>fe.map(o=>({row:{...o},oldRow:{...o},rowMeta:{}}));function go(fe,o,z){const{activeTableId:l,activeTable:f}=ye(Qe()),e=re(()=>fe.value||f.value),Z=re(()=>{var g;return((g=fe.value)==null?void 0:g.id)||l.value}),{t:ae}=Oe(),he=qe("optimisedQuery",()=>!0),{api:k,isLoading:B,error:ee}=Ge(),j=He(),q=j.currentRoute,{appInfo:W,gridViewPageSize:_}=Je(),se=_.value||W.value.defaultLimit||25,Re=b({page:1,pageSize:se}),oe=b([]),ve=b(),ue=b(),ce=b(),M=b([]),Ie=b(!1),Y=Le(Xe,b(!1)),{base:J}=ye(je()),{sharedView:ge,fetchSharedViewData:De,paginationData:pe}=Ze(),{$api:de}=$e(),{sorts:te,nestedFilters:Ce}=be(),{isUIAllowed:t}=We(),n=re(()=>q.value.query),{isPaginationLoading:r}=ye(_e()),i=re({get:()=>Y.value?pe.value:Re.value,set:g=>{Y.value?pe.value=g:Re.value=g}}),d=re(()=>{var C;const g=Se();return((C=i.value)==null?void 0:C.isLastPage)&&g===M.value.length-1}),S=re(()=>{var C;const g=Se();return((C=i.value)==null?void 0:C.isFirstPage)&&g===0}),x=re(()=>({offset:((i.value.page??0)-1)*(i.value.pageSize??se),limit:i.value.pageSize??se,where:(z==null?void 0:z.value)??""}));async function h(){var C,T;const{count:g}=await de.dbViewRow.count(V,(C=J==null?void 0:J.value)==null?void 0:C.id,Z.value,(T=o==null?void 0:o.value)==null?void 0:T.id);i.value.totalRows=g}async function c(){var N;const g=((N=i.value)==null?void 0:N.totalRows)??1/0,C=i.value.pageSize??se,T=i.value.page??1,A=Math.ceil(g/C),K=Math.max(1,Math.min(A,T));T>K?w==null||w(K):await y({offset:(K-1)*C,where:z==null?void 0:z.value})}async function a(){var C,T,A,K,N;if(!t("commentCount")||Y.value)return;const g=(T=(C=M.value)==null?void 0:C.filter(({rowMeta:{new:O}})=>!O))==null?void 0:T.map(({row:O})=>{var P;return X(O,(P=e==null?void 0:e.value)==null?void 0:P.columns)});if(!(!(g!=null&&g.length)||g!=null&&g.some(O=>!O))){oe.value=await de.utils.commentCount({ids:g,fk_model_id:Z.value});for(const O of M.value){const P=X(O.row,(A=e.value)==null?void 0:A.columns);O.rowMeta.commentCount=+(((N=(K=oe.value)==null?void 0:K.find(Q=>Q.row_id===P))==null?void 0:N.count)||0)}}}const I=b();async function y(g={},C=!0){var K,N,O;if((!((K=J==null?void 0:J.value)!=null&&K.id)||!Z.value||!((N=o.value)!=null&&N.id))&&!Y.value)return;I.value&&I.value.cancel();const T=no.CancelToken;I.value=T.source(),C&&(r.value=!0);let A;try{A=Y.value?await De({sortsArr:te.value,filtersArr:Ce.value,where:z==null?void 0:z.value}):await k.dbViewRow.list("noco",J.value.id,Z.value,o.value.id,{...x.value,...g,...t("sortSync")?{}:{sortArrJson:JSON.stringify(te.value)},...t("filterSync")?{}:{filterArrJson:JSON.stringify(Ce.value)},where:z==null?void 0:z.value,...Ie.value?{excludeCount:"true"}:{}},{cancelToken:I.value.token})}catch(P){return P.code==="ERR_CANCELED"?void 0:(console.error(P),U.error(await H(P)))}if(M.value=ro(A.list),i.value=A.pageInfo||i.value||{},Y.value&&(pe.value=i.value),Ie.value=!A.pageInfo,r.value=!1,i.value.totalRows!==void 0&&i.value.totalRows!==null){const P=Math.max(1,Math.ceil(i.value.totalRows/i.value.pageSize));P<i.value.page&&await w(P)}((O=o.value)==null?void 0:O.type)===Ye.GRID&&a()}async function u(){var g,C;(g=o==null?void 0:o.value)!=null&&g.id&&(ve.value=Y.value?(C=ge.value)==null?void 0:C.view:await de.dbView.galleryRead(o.value.id))}async function w(g){i.value.page=g,await y({offset:(g-1)*(i.value.pageSize||se),where:z==null?void 0:z.value},!0)}const{insertRow:R,updateRowProperty:s,addEmptyRow:p,deleteRow:v,deleteRowById:D,deleteSelectedRows:m,deleteRangeOfRows:L,updateOrSaveRow:G,bulkUpdateRows:E,bulkUpdateView:ne,selectedAllRecords:we,removeRowIfNew:Ae}=io({meta:e,viewMeta:o,formattedData:M,paginationData:i,callbacks:{changePage:w,loadData:y,syncCount:h,syncPagination:c}});async function Fe(){var g,C,T;if((g=o==null?void 0:o.value)!=null&&g.id)try{const{columns:A,...K}=await de.dbView.formRead(o.value.id);let N=1;const O=(A||[]).reduce((P,Q)=>(N<Q.order&&(N=Q.order),{...P,[Q.fk_column_id]:Q}),{});ce.value=K,ue.value=(T=(C=e==null?void 0:e.value)==null?void 0:C.columns)==null?void 0:T.map(P=>{var Q,le;return{...P,fk_column_id:P.id,fk_view_id:(Q=o.value)==null?void 0:Q.id,...O[P.id]?O[P.id]:{},meta:{validators:[],...ze((le=O[P.id])==null?void 0:le.meta),...ze(P.meta)},order:O[P.id]&&O[P.id].order||N++,id:O[P.id]&&O[P.id].id}}).sort((P,Q)=>P.order-Q.order)}catch(A){return U.error(`${ae("msg.error.setFormDataFailed")}: ${await H(A)}`)}}async function Be(g){var C;try{if(!((C=o==null?void 0:o.value)!=null&&C.id)||!g)return;await de.dbView.formUpdate(o.value.id,g)}catch(T){return U.error(`${ae("msg.error.formViewUpdateFailed")}: ${await H(T)}`)}}function Se(){return M.value.findIndex(g=>{var C;return n.value.rowId===X(g.row,(C=e.value)==null?void 0:C.columns)})}return{error:ee,isLoading:B,loadData:y,paginationData:i,queryParams:x,formattedData:M,insertRow:R,updateRowProperty:s,changePage:w,addEmptyRow:p,deleteRow:v,deleteRowById:D,deleteSelectedRows:m,deleteRangeOfRows:L,updateOrSaveRow:G,bulkUpdateRows:E,bulkUpdateView:ne,selectedAllRecords:we,syncCount:h,syncPagination:c,galleryData:ve,loadGalleryData:u,loadFormView:Fe,formColumnData:ue,formViewData:ce,updateFormView:Be,aggCommentCount:oe,loadAggCommentsCount:a,removeRowIfNew:Ae,navigateToSiblingRow:async g=>{var N,O,P,Q,le;let T=Se()+(g===me.NEXT?1:-1);for(;(O=(N=M.value[T])==null?void 0:N.rowMeta)!=null&&O.new;)T=T+(g===me.NEXT?1:-1);const A=((P=i==null?void 0:i.value)==null?void 0:P.page)||1;if(T<0){if(A===1)return U.info(ae("msg.info.noMoreRecords"));await w(A-1),T=M.value.length-1}else if(T>=M.value.length){if((Q=i==null?void 0:i.value)!=null&&Q.isLastPage)return U.info(ae("msg.info.noMoreRecords"));await w(A+1),T=0}const K=X(M.value[T].row,(le=e.value)==null?void 0:le.columns);K&&await j.push({query:{...n.value,rowId:K}})},getExpandedRowIndex:Se,optimisedQuery:he,islastRow:d,isFirstRow:S}}export{go as a,io as u};
