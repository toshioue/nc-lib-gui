import le from"./hZgTYrdl.js";import ae from"./37hePIet.js";import{e as se,cL as oe,cW as ne,bL as Z,r as _,d7 as ie,d6 as ce,ba as de,a5 as ue,ab as re,ge as me,F as pe,d0 as fe,fE as ve,g as _e,o as h,Q as w,w as r,a as i,T as N,N as a,U as V,d as m,t as u,b as f,O as j,c as be,W as he,y as ge,m as ke,f$ as ye,c$ as xe,iH as we,Z as $e,$ as Ce,_ as Me}from"./DZZ6t_j4.js";import{_ as Le}from"./DfeSAprs.js";import{_ as Ne}from"./Bdv7ru7D.js";import{D as Te}from"./Dg0-TbNo.js";import"./DKN1hQ6S.js";import{I as Ae}from"./BQuyMdA-.js";import"./ByVBARmO.js";import"./C4K5fdHe.js";import"./DNgdBwTe.js";import"./eX8_g88K.js";import"./vll-Pnjv.js";import"./t0mbNaqp.js";import"./B5RRVMt5.js";import"./DGj1ycqW.js";import"./BQQOEPN4.js";import"./DyDFI6NE.js";const Ie={class:"flex flex-col gap-3"},Ve={class:"text-base text-gray-800 font-semibold"},je={class:"text-gray-500 text-[13px] leading-5"},Be={class:"font-semibold"},Oe={class:"flex w-full gap-2 justify-between items-center"},Ue={class:"flex items-center gap-2"},ze={class:"border-1 rounded-md h-[300px] nc-scrollbar-md border-gray-200"},Fe=["data-testid","onClick"],Ee={class:"flex flex-row items-center w-full cursor-pointer truncate ml-1 py-[5px] pr-2"},Re={class:"flex w-full gap-2 justify-end"},De=se({__name:"AddLookups",props:{column:{},value:{type:Boolean}},setup(G){const B=G,{$api:O}=ge(),U=oe(),{getMeta:J,metas:z}=ne(),p=Z(ie,_()),F=Z(ce,_()),{loadTables:K}=U,{tables:E}=de(U),R=ue(B,"column"),g=re(B,"value"),D=_(),T=_(!1),k=_(""),b=_([]),c=_({}),P=e=>ke(ye(e)?le:ae,{columnMeta:e}),d=me(async()=>{var t;const e=(t=R.value.colOptions)==null?void 0:t.fk_related_model_id;if(e){let n=E.value.find(s=>s.id===e);return n||(await K(),n=E.value.find(s=>s.id===e)),n}return null}),X=()=>{Object.keys(c.value).forEach(e=>c.value[e]=!1)},Y=()=>{b.value.forEach(e=>c.value[e.id]=!0)},ee=async()=>{var e,t,n,s,$,C,M,v,y,l,x,H,S;try{T.value=!0;const L=[],W=((t=(e=p.value)==null?void 0:e.columns)==null?void 0:t.length)??0;for(const[A]of Object.entries(c.value).filter(([,o])=>o)){const o=z.value[(n=d.value)==null?void 0:n.id].columns.find(I=>I.id===A),q=b.value.findIndex(I=>I.id===A),Q={uidt:xe.Lookup,fk_lookup_column_id:A,fk_relation_column_id:R.value.id,lookupTableTitle:(s=d.value)==null?void 0:s.title,lookupColumnTitle:(o==null?void 0:o.title)||o.column_name,table_name:($=p.value)==null?void 0:$.table_name,title:`${o==null?void 0:o.title} from ${(C=d.value)==null?void 0:C.title}`,view_id:(M=F.value)==null?void 0:M.id,order:W+q,column_name:`${o==null?void 0:o.title} from (${(v=d.value)==null?void 0:v.title})`,column_order:{order:W+q,view_id:(y=F.value)==null?void 0:y.id}},te=we({formState:Q,metaColumns:(l=d.value)==null?void 0:l.columns,tableExplorerColumns:(x=p.value)==null?void 0:x.columns});L.push({op:"add",column:{...Q,title:te}})}await O.dbTableColumn.bulk((H=p.value)==null?void 0:H.id,{hash:D.value,ops:L}),await J((S=p==null?void 0:p.value)==null?void 0:S.id,!0),g.value=!1}catch(L){console.error(L)}finally{T.value=!1}};return pe([d,k],async()=>{if(d.value){const e=z.value[d.value.id].columns;b.value=e.filter(t=>!fe(t)&&!ve(t)).filter(t=>{var n,s;return(s=t==null?void 0:t.title)==null?void 0:s.toLowerCase().startsWith((n=k.value)==null?void 0:n.toLowerCase())})}}),_e(async()=>{var e;D.value=(await O.dbTableColumn.hash((e=p.value)==null?void 0:e.id)).hash}),(e,t)=>{const n=Ae,s=$e,$=Ce,C=Le,M=Ne;return h(),w(M,{visible:a(g),"onUpdate:visible":t[3]||(t[3]=v=>j(g)?g.value=v:null),size:"small"},{default:r(()=>{var v,y;return[i("div",Ie,[i("div",null,[i("h1",Ve,[(h(),w(N(("iconMap"in e?e.iconMap:a(V)).cellLookup),{class:"text-gray-500 pb-1"})),m(" "+u(e.$t("general.addLookupField")),1)]),i("div",je,[m(u(e.$t("labels.addNewLookupHelperText1"))+" ",1),i("span",Be,u(((v=a(d))==null?void 0:v.title)??((y=a(d))==null?void 0:y.table_name)),1),m(" "+u(e.$t("labels.addNewLookupHelperText2")),1)])]),i("div",Oe,[f(n,{value:a(k),"onUpdate:value":t[0]||(t[0]=l=>j(k)?k.value=l:null),class:"w-full h-8 flex-1",size:"small",placeholder:e.$t("placeholder.searchFields")},{prefix:r(()=>[(h(),w(N(("iconMap"in e?e.iconMap:a(V)).search),{class:"w-4 text-gray-500 h-4"}))]),_:1},8,["value","placeholder"]),i("div",Ue,[f(s,{size:"small",type:"text",class:"!text-xs",onClick:X},{default:r(()=>[m(u(e.$t("labels.clearAll")),1)]),_:1}),f(s,{size:"small",type:"text",class:"!text-xs",onClick:Y},{default:r(()=>[m(u(e.$t("general.addAll")),1)]),_:1})])]),i("div",ze,[f(a(Te),{modelValue:a(b),"onUpdate:modelValue":t[1]||(t[1]=l=>j(b)?b.value=l:null),"item-key":"id","ghost-class":"nc-lookup-menu-items-ghost"},{item:r(({element:l})=>[(h(),be("div",{key:l.id,"data-testid":`nc-lookup-add-menu-${l.title}`,class:"px-3 py-1 flex flex-row items-center rounded-md hover:bg-gray-100",onClick:he(x=>a(c)[l.id]=!a(c)[l.id],["stop"])},[(h(),w(N(("iconMap"in e?e.iconMap:a(V)).drag),{class:"cursor-move !h-3.75 text-gray-600 mr-1"})),i("div",Ee,[(h(),w(N(P(l)),{class:"!w-3.5 !h-3.5 !text-gray-500"})),f($,{class:"flex-1 pl-1 pr-2 truncate","show-on-truncate-only":""},{title:r(()=>[m(u(l.title),1)]),default:r(()=>[m(u(l.title),1)]),_:2},1024),f(C,{checked:a(c)[l.id],"onUpdate:checked":x=>a(c)[l.id]=x,size:"default"},null,8,["checked","onUpdate:checked"])]),t[4]||(t[4]=i("div",{class:"flex-1"},null,-1))],8,Fe))]),_:1},8,["modelValue"])]),i("div",Re,[f(s,{type:"secondary",size:"small",onClick:t[2]||(t[2]=l=>g.value=!1)},{default:r(()=>[m(u(e.$t("general.cancel")),1)]),_:1}),f(s,{loading:a(T),disabled:!Object.values(a(c)).filter(Boolean).length,size:"small",onClick:ee},{default:r(()=>[m(u(e.$t("general.addLookupField",{count:Object.values(a(c)).filter(Boolean).length||""})),1)]),_:1},8,["loading","disabled"])])])]}),_:1},8,["visible"])}}}),nt=Me(De,[["__scopeId","data-v-e4296839"]]);export{nt as default};
