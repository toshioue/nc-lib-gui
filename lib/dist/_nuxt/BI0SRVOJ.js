const __vite__fileDeps=["./CWm929xG.js","./DZZ6t_j4.js","./entry.DIDWwc7m.css","./C9Sjn86N.js","./C4K5fdHe.js","./ByVBARmO.js","./PlainCell.1kvaRUkA.css","./0yfimkpx.js","./RecordCard.BkJXt930.css","./Tryc0omP.js","./CA74dF2b.js","./GMLocJHP.js","./qW2V2r_p.js","./boyBAVNN.js","./BDAIZopQ.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{e as Le,f as T,r as h,gz as ze,J as Pe,bL as ce,d7 as $e,hA as Ve,cq as r,jr as fe,o as R,c as D,a as H,ao as P,at as N,S as ve,N as v,t as Ae,a8 as Be,W as me,b as we,w as pe,Q as Ie,R as ye,X as K,a4 as Y,y as Oe,da as Fe,_ as Te}from"./DZZ6t_j4.js";import{a as Ne}from"./DWT0yQl9.js";import{a as Xe}from"./i4aLU0Nw.js";import{k as je,e as I}from"./BDAIZopQ.js";import"./GMLocJHP.js";import"./B05h-4V9.js";const qe=K(()=>Y(()=>import("./CWm929xG.js"),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url).then(k=>k.default||k)),Ue=K(()=>Y(()=>import("./0yfimkpx.js"),__vite__mapDeps([7,1,2,8]),import.meta.url).then(k=>k.default||k)),We=K(()=>Y(()=>import("./Tryc0omP.js"),__vite__mapDeps([9,10,11,1,2,12,5,13,14]),import.meta.url).then(k=>k.default||k)),Je={class:"flex h-6"},Qe=["onClick","onDblclick"],Ge=["onClick","onDblclick"],He={class:"absolute nc-scrollbar-md overflow-y-auto mt-9 pointer-events-none inset-0","data-testid":"nc-calendar-week-record-container"},Ke=["data-testid","data-unique-id","onMouseover","onMousedown"],Ye=Le({__name:"DateField",emits:["expandRecord","newRecord"],setup(k,{emit:_e}){const X=_e,{selectedDateRange:_,formattedData:x,formattedSideBarData:Z,calendarRange:O,selectedDate:j,displayField:ge,updateRowProperty:q,viewMetaProperties:be,updateFormat:$}=Ne(),M=T(()=>{var e;return(e=be.value)!=null&&e.hide_weekend?5:7}),C=h(null),{$e:he}=Oe(),{width:Re}=ze(C),{isUIAllowed:S}=Pe(),V=ce($e,h()),De=ce(Ve,h()),{fields:ee}=Xe(),ke=T(()=>ee.value?new Map(ee.value.map(e=>[e.fk_column_id,{underline:e.underline,bold:e.bold,italic:e.italic}])):new Map),U=e=>ke.value.get(e.id),te=T(()=>{let e=r(_.value.start),o=r(_.value.end);M.value===5&&(o=o.subtract(2,"day"));const a=[];for(;e.isBefore(o)||e.isSame(o,"day");)a.push(r(e)),e=e.add(1,"day");return a}),ae=(e,o,a)=>{let c=0;for(;;){let i=!0;for(let t=0;t<a;t++){const l=o+t;if(e[l]||(e[l]={}),e[l][c]){i=!1;break}}if(i)return c;c++}},oe=e=>e&&e.isBetween(r(_.value.start).startOf("day"),r(_.value.end).endOf("day"),"day","[]"),xe=T(()=>{if(!x.value||!O.value)return[];const e={0:{},1:{},2:{},3:{},4:{},5:{},6:{}},o=[],a=Re.value/M.value;return O.value.forEach(c=>{const i=c.fk_from_col,t=c.fk_to_col;if(i&&t)for(const l of[...x.value].filter(m=>{const n=r(m.row[i.title]),d=r(m.row[t.title]);return!n.isValid()||!d.isValid()?!1:!d.isBefore(n)})){const m=l.rowMeta.id??fe();let n=r(l.row[i.title]);const d=n.clone(),s=r(l.row[t.title]);n.isBefore(_.value.start)&&(n=r(_.value.start));const g=n.diff(_.value.start,"day");let p=Math.max(Math.min(s.diff(n,"day"),6)+1,1);s.isAfter(n,"month")&&(p=7-g),g>0&&(p=Math.min(p,7-g));const y=`calc(max(${p} * ${a}px, ${a}px))`;let u=-1;for(let z=0;z<p;z++){const B=g+z;e[B]||(e[B]={}),u===-1&&(u=ae(e,B,p))}for(let z=0;z<p;z++){const B=g+z;e[B][u]=!0}let f="none";const E=oe(d),de=oe(s);E&&de?f="rounded":n&&s&&n.isBefore(_.value.start)&&s.isAfter(_.value.end)||n&&s&&(n.isAfter(_.value.end)||s.isBefore(_.value.start))?f="none":E?f="leftRounded":de&&(f="rightRounded"),o.push({...l,rowMeta:{...l.rowMeta,range:c,position:f,id:m,style:{width:y,left:`${g*a}px`,top:`${u*28}px`}}})}else if(i)for(const l of x.value){const m=l.rowMeta.id??fe(),n=r(l.row[i.title]),d=Math.max(n.diff(_.value.start,"day"),0),s=ae(e,d,1);e[d][s]=!0,o.push({...l,rowMeta:{...l.rowMeta,range:c,id:m,position:"rounded",style:{width:`calc(${a}px)`,left:`${d*a}px`,top:`${s*28}px`}}})}}),o}),L=h(null),W=h(!1),J=h(),A=h(!1),w=h(),F=h(),b=h(null),Q=h(),Ee=Fe((e,o,a)=>{q(e,o,a)},500),ne=e=>{var p,y;if(!S("dataEdit")||!C.value||!b.value)return;const{width:o,left:a}=C.value.getBoundingClientRect(),c=(e.clientX-a-window.scrollX)/o,i=(p=b.value.rowMeta.range)==null?void 0:p.fk_from_col,t=(y=b.value.rowMeta.range)==null?void 0:y.fk_to_col;if(!i||!t)return;const l=r(b.value.row[t.title]),m=r(b.value.row[i.title]),n=Math.floor(c*M.value);let d=[],s;if(F.value==="right"){let u=r(_.value.start).add(n,"day");if(d=[t.title],r(u).isBefore(m,"day")&&(u=m.clone()),!u.isValid())return;s={...b.value,row:{...b.value.row,[t.title]:u.format($.value)}}}else if(F.value==="left"){let u=r(_.value.start).add(n,"day");if(d=[i.title],r(u).isAfter(l)&&(u=r(r(l)).clone()),!u)return;s={...b.value,row:{...b.value.row,[i.title]:r(u).format($.value)}}}const g=I(s.row,V.value.columns);x.value=x.value.map(u=>I(u.row,V.value.columns)===g?s:u),Ee(s,d,!1)},re=()=>{W.value=!1,F.value=null,b.value=null,document.removeEventListener("mousemove",ne),document.removeEventListener("mouseup",re)},Me=(e,o,a)=>{S("dataEdit")&&(W.value=!0,F.value=e,b.value=a,document.addEventListener("mousemove",ne),document.addEventListener("mouseup",re))},G=(e,o)=>{var y,u;const{width:a,left:c}=C.value.getBoundingClientRect(),i=(e.clientX-c-window.scrollX)/a,t=(y=w.value.rowMeta.range)==null?void 0:y.fk_from_col,l=(u=w.value.rowMeta.range)==null?void 0:u.fk_to_col;if(!t)return{updatedProperty:[],newRow:null};const m=Math.floor(i*M.value),n=r(_.value.start).add(m,"day");if(!n)return{updatedProperty:[],newRow:null};let d;const s={...w.value,row:{...w.value.row,[t.title]:r(n).format($.value)}},g=[t.title];if(l){const f=w.value.row[t.title]?r(w.value.row[t.title]):null,E=w.value.row[l.title]?r(w.value.row[l.title]):null;f&&E?d=r(n).add(E.diff(f,"day"),"day"):f&&!E?d=r(n).endOf("day"):!f&&E?d=r(n).endOf("day"):d=n.clone(),s.row[l.title]=r(d).format($.value),g.push(l.title)}const p=I(s.row,V.value.columns);return o?(x.value=[...x.value,s],Z.value=Z.value.filter(f=>I(f.row,V.value.columns)!==p)):x.value=x.value.map(f=>I(f.row,V.value.columns)===p?s:f),{updateProperty:g,newRow:s}},le=e=>{S("dataEdit")&&(!C.value||!w.value||G(e,!1))},se=e=>{if(e.preventDefault(),clearTimeout(J.value),!S("dataEdit")||!A.value||!C.value||!w.value)return;const{updateProperty:o,newRow:a}=G(e);if(!a)return;document.querySelectorAll(".draggable-record").forEach(i=>{i.style.visibility="",i.style.opacity="100%"}),L.value&&(L.value.style.boxShadow="none",L.value=null),w.value=void 0,q(a,o,!1),document.removeEventListener("mousemove",le),document.removeEventListener("mouseup",se)},Se=(e,o)=>{if(W.value)return;let a=e.target;A.value=!1,J.value=setTimeout(()=>{if(!S("dataEdit"))return;for(A.value=!0;!a.classList.contains("draggable-record");)a=a.parentElement;document.querySelectorAll(".draggable-record").forEach(t=>{t.getAttribute("data-unique-id").includes(o.rowMeta.id)||(t.style.opacity="30%")}),A.value=!0,L.value=a,w.value=o,document.addEventListener("mousemove",le),document.addEventListener("mouseup",se)},200);const c=()=>{clearTimeout(J.value),document.removeEventListener("mouseup",c),A.value||X("expandRecord",o)};document.addEventListener("mouseup",c)},Ce=e=>{var a;if(!S("dataEdit"))return;e.preventDefault();const o=(a=e.dataTransfer)==null?void 0:a.getData("text/plain");if(o){const{record:c}=JSON.parse(o);w.value=c;const{updateProperty:i,newRow:t}=G(e,!0);L.value&&(L.value.style.boxShadow="none",L.value=null),q(t,i,!1),he("c:calendar:day:drag-record")}},ie=e=>{j.value=e,w.value=void 0},ue=e=>{if(!S("dataEdit")||!O.value)return;const o=O.value[0].fk_from_col;if(!o)return;const a={row:{[o.title]:e.format($.value)}};X("newRecord",a)};return(e,o)=>{const a=qe,c=Ue,i=We;return R(),D("div",{class:"flex relative flex-col prevent-select","data-testid":"nc-calendar-week-view",onDrop:Ce},[H("div",Je,[(R(!0),D(P,null,N(v(te),(t,l)=>(R(),D("div",{key:l,class:ve([{"!border-brand-500 !border-b-gray-200":v(r)(t).isSame(v(j),"day"),"w-1/5":v(M)===5,"w-1/7":v(M)===7},"cursor-pointer text-center text-[10px] font-semibold leading-4 flex items-center justify-center uppercase text-gray-500 w-full py-1 border-gray-200 border-l-gray-50 border-t-gray-50 last:border-r-0 border-1 bg-gray-50"]),onClick:m=>ie(t),onDblclick:m=>ue(t)},Ae(v(r)(t).format("DD ddd")),43,Qe))),128))]),H("div",{ref_key:"container",ref:C,class:"flex h-[calc(100vh-11.6rem)]"},[(R(!0),D(P,null,N(v(te),(t,l)=>(R(),D("div",{key:l,class:ve([{"!border-1 !border-t-0 border-brand-500":v(r)(t).isSame(v(j),"day"),"!bg-gray-50":t.get("day")===0||t.get("day")===6,"w-1/5":v(M)===5,"w-1/7":v(M)===7},"flex cursor-pointer flex-col border-r-1 min-h-[100vh] last:border-r-0 items-center"]),"data-testid":"nc-calendar-week-day",onClick:m=>ie(t),onDblclick:m=>ue(t)},null,42,Ge))),128))],512),H("div",He,[(R(!0),D(P,null,N(v(xe),(t,l)=>{var m;return R(),D(P,{key:l},[((m=t.rowMeta.style)==null?void 0:m.display)!=="none"?(R(),D("div",{key:0,"data-testid":`nc-calendar-week-record-${t.row[v(ge).title]}`,"data-unique-id":t.rowMeta.id,style:Be({...t.rowMeta.style}),class:"absolute group draggable-record pointer-events-auto nc-calendar-week-record-card",onMouseleave:o[0]||(o[0]=n=>Q.value=null),onMouseover:n=>Q.value=t.rowMeta.id,onMousedown:me(n=>Se(n,t),["stop"])},[we(i,{row:t},{default:pe(()=>{var n,d,s,g,p;return[we(c,{hover:v(Q)===t.rowMeta.id||t.rowMeta.id===((d=(n=v(w))==null?void 0:n.rowMeta)==null?void 0:d.id),position:t.rowMeta.position,record:t,resize:!!((s=t.rowMeta.range)!=null&&s.fk_to_col)&&v(S)("dataEdit"),selected:((p=(g=v(w))==null?void 0:g.rowMeta)==null?void 0:p.id)===t.rowMeta.id,color:"blue",onDblclick:me(y=>X("expandRecord",t),["stop"]),onResizeStart:Me},{default:pe(()=>[(R(!0),D(P,null,N(v(De),(y,u)=>(R(),D(P,{key:u},[("isRowEmpty"in e?e.isRowEmpty:v(je))(t,y)?ye("",!0):(R(),Ie(a,{key:0,modelValue:t.row[y.title],"onUpdate:modelValue":f=>t.row[y.title]=f,class:"text-xs",bold:U(y).bold,column:y,italic:U(y).italic,underline:U(y).underline},null,8,["modelValue","onUpdate:modelValue","bold","column","italic","underline"]))],64))),128))]),_:2},1032,["hover","position","record","resize","selected","onDblclick"])]}),_:2},1032,["row"])],44,Ke)):ye("",!0)],64)}),128))])],32)}}}),rt=Te(Ye,[["__scopeId","data-v-1630eedb"]]);export{rt as default};
