import{_ as J}from"./BLvTi2Ht.js";import{f as U,cN as q,az as H,ai as K,r as w,i as Q,O as X,o as n,c as d,a as o,P as m,R as $,S as v,w as i,V as I,W as T,d as _,t as f,b as p,U as j,T as B,d1 as V,aj as x,ak as Y,aV as Z,a1 as ee,A as E}from"./Cgw6cdOy.js";import{_ as te}from"./Bi6QLLC9.js";import{_ as ae}from"./CpJUN2HL.js";const se={class:"h-full flex flex-col w-full"},ne={class:"h-full flex flex-col"},oe={class:"flex flex-row justify-between items-center w-full mb-4"},le={class:"flex"},ie={key:0},ce={class:"flex items-center gap-2"},me={key:1},fe={class:"flex items-center gap-2 text-gray-600 font-light"},ue={key:0,class:"flex items-center gap-2 max-w-full"},de={class:"min-w-5 flex items-center justify-center"},_e={key:1,class:"flex items-center gap-2 max-w-full"},pe=o("div",{class:"flex place-content-center item-center"},null,-1),ge=U({__name:"Metadata",props:{sourceId:{}},emits:["baseSynced"],setup(R,{emit:A}){const S=R,L=A,{$api:k}=E(),C=q(),{loadTables:W}=C,{base:r}=H(C),{t:g}=K(),l=w(!1),y=w(!1),h=w([]);async function b(){var e,c,s;try{if(!((e=r.value)!=null&&e.id))return;l.value=!0,y.value=!1,h.value=await k.source.metaDiffGet((c=r.value)==null?void 0:c.id,S.sourceId);for(const a of h.value)((s=a.detectedChanges)==null?void 0:s.length)>0&&(a.syncState=a.detectedChanges.map(u=>u==null?void 0:u.msg).join(", "),y.value=!0)}catch(a){console.error(a)}finally{l.value=!1}}const{$poller:z}=E();async function F(){var e,c;try{if(!((e=r.value)!=null&&e.id)||!y.value)return;l.value=!0;const s=await k.source.metaDiffSync((c=r.value)==null?void 0:c.id,S.sourceId);z.subscribe({id:s.id},async a=>{a.status!=="close"&&(a.status===V.COMPLETED?(x.info(g("msg.info.metaDataRecreated")),await W(),await b(),L("baseSynced"),l.value=!1):status===V.FAILED&&(x.error("Failed to sync base metadata"),l.value=!1))})}catch(s){x.error(await Y(s))}}Q(async()=>{h.value.length===0&&await b()});const G=[{title:g("labels.models"),key:"table_name",name:"table_name",minWidth:200,padding:"0px 12px"},{title:g("labels.syncState"),dataIndex:"syncState",key:"syncState",minWidth:200,padding:"0px 12px"}],O=e=>({class:`nc-metasync-row nc-metasync-row-${e.table_name}`});return(e,c)=>{const s=Z,a=ae,u=J,D=ee,P=te,M=X("e");return n(),d("div",se,[o("div",ne,[o("div",oe,[o("div",le,[m(y)?(n(),d("div",ie,[$((n(),v(s,{class:"nc-btn-metasync-sync-now",type:"primary",onClick:F},{default:i(()=>[o("div",ce,[(n(),v(I(("iconMap"in e?e.iconMap:m(T)).databaseSync))),_(" "+f(e.$t("activity.metaSync")),1)])]),_:1})),[[M,["a:proj-meta:meta-data:sync"]]])])):(n(),d("div",me,[o("span",null,[p(a,{message:e.$t("msg.info.tablesMetadataInSync"),type:"success","show-icon":"",class:"!rounded-md"},null,8,["message"])])]))]),$((n(),v(s,{class:"self-start !rounded-md nc-btn-metasync-reload",onClick:b},{default:i(()=>[o("div",fe,[(n(),v(I(("iconMap"in e?e.iconMap:m(T)).reload),{class:j({"animate-infinite animate-spin !text-success":m(l)})},null,8,["class"])),_(" "+f(e.$t("general.reload")),1)])]),_:1})),[[M,["a:proj-meta:meta-data:reload"]]])]),p(P,{columns:G,data:m(h)??[],"row-height":"44px","header-row-height":"44px","is-data-loading":m(l),"custom-row":O,class:"nc-metasync-table h-[calc(100%_-_58px)] w-full"},{bodyCell:i(({column:N,record:t})=>[N.key==="table_name"?(n(),d("div",ue,[o("div",de,[p(u,{meta:t,class:"text-gray-500"},null,8,["meta"])]),p(D,{class:"truncate","show-on-truncate-only":""},{title:i(()=>[_(f(t.title||t.table_name),1)]),default:i(()=>[_(" "+f(t.title||t.table_name),1)]),_:2},1024)])):B("",!0),N.key==="syncState"?(n(),d("div",_e,[p(D,{class:"truncate","show-on-truncate-only":""},{title:i(()=>[_(f((t==null?void 0:t.syncState)||e.$t("msg.info.metaNoChange")),1)]),default:i(()=>[o("span",{class:j({"text-red-500":t==null?void 0:t.syncState,"text-gray-500":!(t!=null&&t.syncState)})},f((t==null?void 0:t.syncState)||e.$t("msg.info.metaNoChange")),3)]),_:2},1024)])):B("",!0)]),_:1},8,["data","is-data-loading"])]),pe])}}});export{ge as default};
