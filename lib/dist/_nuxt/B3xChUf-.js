import{at as we,dC as ce,ai as ye,cY as Te,cU as de,u as he,aA as xe,az as Q,cR as ee,cM as ue,cQ as se,g as O,H as $e,d1 as oe,aj as E,ak as ie,cc as Ie,d2 as ke,n as Ce,d3 as pe,B as X,A as Me,dq as ne,f as De,ad as Pe,r as z,i as Be,b1 as Se,O as Le,o as y,S,w as p,a as f,b as g,d as L,t as w,P as s,aL as J,c_ as Ve,c$ as Ne,a9 as je,T as W,c as Z,U as Ee,Y as Re,R as Ue,Q as ze,$ as Oe,a0 as Ae,a3 as Fe,dD as qe,_ as Ge}from"./3QBYHahY.js";import{_ as He}from"./C95Svpv6.js";import{u as fe}from"./C_IZzKNf.js";import{g as Ke}from"./DgfVJyEd.js";import{a as le}from"./CWtzMcwx.js";import{F as re}from"./DAKhk9t6.js";import"./kHOslGNR.js";import{I as Ye}from"./CmN9vPg3.js";import{C as Qe,a as Xe}from"./Dg1gNFnz.js";import{_ as Je}from"./Bk0xUMNV.js";import{_ as We}from"./BsWDDIqE.js";function Ze(C){const _=we({title:"",table_name:"",description:"",columns:ce,is_hybrid:!0}),{t:l}=ye(),{$e:M,$api:b}=Me(),{getMeta:D,removeMeta:$}=Te(),{closeTab:A}=fe(),{refreshCommandPalette:R}=de(),I=he().currentRoute,T=xe(),{bases:h}=Q(T),{baseTables:F}=Q(ee()),{loadProjectTables:q}=ee(),{loadTables:m,baseUrl:G,isXcdbBase:H}=ue(),{loadViews:K}=se(),{openedViewsTab:k,viewsByTable:Y}=Q(se()),x=O(()=>I.value.params.typeOrId),P=O(()=>F.value.get(C.baseId)||[]),U=O(()=>h.value.get(C.baseId)),V=async(a,c=!1)=>{if(!a.base_id)return;let e=h.value.get(a.base_id);if(!e&&(await T.loadProject(a.base_id),await q(a.base_id),e=h.value.get(a.base_id),!e))throw new Error("Base not found");let t=x.value??"nc";["nc","base"].includes(I.value.params.typeOrId)&&(t=I.value.params.typeOrId);let n=e.id;["base"].includes(I.value.params.typeOrId)&&(n=I.value.params.baseId);const d=async()=>{k.value==="view"&&await X(`${c?"#":""}/${t}/${n}/${a==null?void 0:a.id}`,c?{open:ne}:void 0),a.isViewsLoading=!0;try{await K({tableId:a.id});const i=Y.value.get(a.id)??[];if(k.value!=="view"&&i.length&&i[0].id){const v=i.find(B=>B.is_default)||i[0];await X(`${c?"#":""}/${t}/${n}/${a==null?void 0:a.id}/${v.id}/${k.value}`,c?{open:ne}:void 0)}}catch(i){console.error(i)}finally{a.isViewsLoading=!1}},r=async()=>{a.isMetaLoading=!0;try{await D(a.id)}catch(i){console.error(i)}finally{a.isMetaLoading=!1}};c?await d():await Promise.all([d(),r()])},N=async()=>{var r,i,v,B;const{onTableCreate:a,baseId:c}=C;_.title&&(_.title=_.title.trim());let{sourceId:e}=C;if(c in h.value||await T.loadProject(c),!e&&(e=(i=(r=h.value.get(c))==null?void 0:r.sources)==null?void 0:i[0].id,!e))throw new Error("Source not found");const t=await T.getSqlUi(c,e),n=(B=(v=h.value.get(c))==null?void 0:v.sources)==null?void 0:B.find(o=>o.id===e);if(!t)return;const d=t==null?void 0:t.getNewTableColumns().filter(o=>o.column_name==="id"&&_.columns.includes("id_ag")?(Object.assign(o,t==null?void 0:t.getDataTypeForUiType({uidt:oe.ID},"AG")),o.dtxp=t==null?void 0:t.getDefaultLengthForDatatype(o.dt),o.dtxs=t==null?void 0:t.getDefaultScaleForDatatype(o.dt),!0):_.columns.includes(o.column_name)).map(o=>(n&&n.inflection_column!=="camelize"&&(o.title=o.column_name),o));try{const o=await b.source.tableCreate(c,e,{..._,columns:d});M("a:table:create"),a==null||a(o),R(),await V(o)}catch(o){E.error(await ie(o))}};return $e(()=>_.title,a=>{_.table_name=`${a}`}),{table:_,tables:P,base:U,createTable:N,generateUniqueTitle:()=>{_.title=Ke("Table",P.value,"title")},deleteTable:a=>{M("c:table:delete"),Ie.confirm({title:`${l("msg.info.deleteTableConfirmation")} : ${a.title}?`,wrapClassName:"nc-modal-table-delete",okText:l("general.yes"),okType:"danger",cancelText:l("general.no"),width:450,async onOk(){var c;try{const e=await D(a.id,!0),t=(c=e==null?void 0:e.columns)==null?void 0:c.filter(n=>n.uidt===oe.LinkToAnotherRecord&&!ke(n));if(t!=null&&t.length&&!H(a.source_id)){const n=await Promise.all(t.map(async(d,r)=>{var v;const i=await D((v=d==null?void 0:d.colOptions)==null?void 0:v.fk_related_model_id);return`${r+1}. ${d.title} is a LinkToAnotherRecord of ${i&&i.title||d.title}`}));E.info(Ce("div",{innerHTML:`<div style="padding:10px 4px">Unable to delete tables because of the following.
              <br><br>${n.join("<br>")}<br><br>
              Delete them & try again</div>`}));return}await b.dbTable.delete(a==null?void 0:a.id),await A({type:pe.TABLE,id:a.id,title:a.title}),await m(),$(a.id),R(),E.info(l("msg.info.tableDeleted")),M("a:table:delete"),P.value.length===0?await X(G({id:U.value.id,type:"database"})):await V(P.value[0])}catch(e){E.error(await ie(e))}}})},openTable:V}}const et={class:"flex justify-between w-full items-center"},tt={class:"flex flex-row items-center gap-x-2 text-base font-semibold text-gray-800"},at={href:"https://docs.nocodb.com/tables/create-table",target:"_blank",class:"text-[13px]"},st={class:"flex flex-col mt-1"},ot={class:"flex flex-col gap-5"},it={class:"flex gap-3 text-gray-800 h-7 mb-1 items-center justify-between"},nt={class:"text-[13px]"},lt={class:"mb-1"},rt={key:1,class:"flex"},ct={class:"flex flex-row justify-between gap-x-2"},dt={class:"flex !text-gray-700 items-center gap-2"},ut={class:"first-letter:capitalize"},pt={key:1},ft={class:"flex gap-2 items-center"},mt=De({__name:"TableCreate",props:{modelValue:{type:Boolean},sourceId:{},baseId:{}},emits:["update:modelValue","create"],setup(C,{emit:_}){const l=C,M=_,b=Pe(l,"modelValue",M),D=z(!1),$=z(),{addTab:A}=fe(),{isMysql:R,isMssql:te,isPg:I,isSnowflake:T}=ue(),{loadProjectTables:h,addTable:F}=ee(),{refreshCommandPalette:q}=de(),{table:m,createTable:G,generateUniqueTitle:H,tables:K,base:k}=Ze({async onTableCreate(e){await A({id:e.id,title:e.title,type:pe.TABLE,baseId:l.baseId}),F(l.baseId,e),await h(l.baseId,!0),M("create",e),b.value=!1},sourceId:l.sourceId,baseId:l.baseId}),Y=re.useForm,x=z(!1),P=()=>{m.description="",x.value=!1},U=O(()=>({title:[le,{validator:(e,t)=>new Promise((n,d)=>(K.value||[]).some(r=>r.title===(t||"")&&r.source_id===l.sourceId)?d(new Error("Duplicate table alias")):n(!0))},{validator:(e,t)=>new Promise((n,d)=>{var v;let r=255;if(R(l.sourceId)?r=64:I(l.sourceId)?r=63:te(l.sourceId)&&(r=128),((((v=k==null?void 0:k.value)==null?void 0:v.prefix)||"")+t).length>r)return d(new Error(`Table name exceeds ${r} characters`));n()})}],table_name:[le]})),{validate:V,validateInfos:N}=Y(m,U),ae=ce.map((e,t)=>({value:e,disabled:t===0})),j=z(!1),a=async()=>{if(!j.value)try{j.value=!0,await V(),await G(),b.value=!1}catch(e){if(console.error(e),e.errorFields.map(t=>E.error(t.errors.join(","))),e.errorFields.length)return}finally{setTimeout(()=>{j.value=!1},500),q()}},c=()=>{x.value?x.value=!1:(x.value=!0,setTimeout(()=>{var e;(e=$.value)==null||e.focus()},100))};return Be(()=>{H(),Se(()=>{var e,t;(e=$.value)==null||e.focus(),(t=$.value)==null||t.select()})}),(e,t)=>{const n=Oe,d=Ye,r=Je,i=Ae,v=We,B=Qe,o=Fe,me=Xe,_e=qe,ve=re,be=He,ge=Le("e");return y(),S(be,{visible:s(b),"onUpdate:visible":t[6]||(t[6]=u=>ze(b)?b.value=u:null),"show-separator":!1,header:e.$t("activity.createTable"),size:"small",onKeydown:t[7]||(t[7]=J(u=>b.value=!1,["esc"]))},{header:p(()=>[f("div",et,[f("div",tt,[g(n,{icon:"table",class:"!text-gray-600 w-5 h-5"}),L(" "+w(e.$t("activity.createTable")),1)]),f("a",at,w(e.$t("title.docs")),1)])]),default:p(()=>[f("div",st,[g(ve,{layout:"vertical",model:s(m),name:"create-new-table-form",class:"flex flex-col gap-5",onKeydown:[J(a,["enter"]),t[5]||(t[5]=J(u=>b.value=!1,["esc"]))]},{default:p(()=>[f("div",ot,[g(r,Ve(Ne(s(N).title)),{default:p(()=>[g(d,{ref_key:"inputEl",ref:$,value:s(m).title,"onUpdate:value":t[0]||(t[0]=u=>s(m).title=u),class:"nc-input-sm nc-input-shadow","hide-details":"","data-testid":"create-table-title-input",placeholder:e.$t("msg.info.enterTableName")},null,8,["value","placeholder"])]),_:1},16),s(x)?(y(),S(r,je({key:0},s(N).description,{class:{"!mb-1":s(T)(l.sourceId),"!mb-0":!s(T)(l.sourceId)}}),{default:p(()=>[f("div",it,[f("span",nt,w(e.$t("labels.description")),1),g(i,{type:"text",class:"!h-6 !w-5",size:"xsmall",onClick:P},{default:p(()=>[g(n,{icon:"delete",class:"text-gray-700 w-3.5 h-3.5"})]),_:1})]),g(v,{ref_key:"inputEl",ref:$,value:s(m).description,"onUpdate:value":t[1]||(t[1]=u=>s(m).description=u),class:"nc-input-sm nc-input-text-area nc-input-shadow px-3 !text-gray-800 max-h-[150px] min-h-[100px]","hide-details":"","data-testid":"create-table-title-input",placeholder:e.$t("msg.info.enterTableDescription")},null,8,["value","placeholder"])]),_:1},16,["class"])):W("",!0),s(T)(l.sourceId)?(y(),S(B,{key:1,checked:s(m).is_hybrid,"onUpdate:checked":t[2]||(t[2]=u=>s(m).is_hybrid=u),class:"!flex flex-row items-center"},{default:p(()=>[L(" Hybrid Table ")]),_:1},8,["checked"])):W("",!0)]),s(D)?(y(),Z("div",{key:0,class:Ee(["nc-table-advanced-options",{active:s(D)}])},[f("div",null,[f("div",lt,w(e.$t("msg.info.defaultColumns")),1),g(_e,null,{default:p(()=>[g(me,{value:s(m).columns,"onUpdate:value":t[3]||(t[3]=u=>s(m).columns=u),options:s(ae),class:"!flex flex-row justify-between w-full"},{label:p(({value:u})=>[u==="id"?(y(),S(o,{key:0,placement:"top",class:"!flex"},{title:p(()=>[f("span",null,w(e.$t("msg.idColumnRequired")),1)]),default:p(()=>[L(" "+w(e.$t("datatype.ID")),1)]),_:1})):(y(),Z("div",rt,w(u),1))]),_:1},8,["value","options"])]),_:1})])],2)):W("",!0),f("div",ct,[s(x)?(y(),Z("div",pt)):(y(),S(i,{key:0,size:"small",type:"text",onClick:Re(c,["stop"])},{default:p(()=>[f("div",dt,[g(n,{icon:"plus",class:"h-4 w-4"}),f("span",ut,w(e.$t("labels.addDescription").toLowerCase()),1)])]),_:1})),f("div",ft,[g(i,{type:"secondary",size:"small",onClick:t[4]||(t[4]=u=>b.value=!1)},{default:p(()=>[L(w(e.$t("general.cancel")),1)]),_:1}),Ue((y(),S(i,{type:"primary",size:"small",disabled:s(N).title.validateStatus==="error",loading:s(j),onClick:a},{loading:p(()=>[L(w(e.$t("title.creatingTable")),1)]),default:p(()=>[L(w(e.$t("activity.createTable"))+" ",1)]),_:1},8,["disabled","loading"])),[[ge,["a:table:create"]]])])])]),_:1},8,["model"])])]),_:1},8,["visible","header"])}}}),kt=Ge(mt,[["__scopeId","data-v-45c352c8"]]);export{kt as _,Ze as u};
