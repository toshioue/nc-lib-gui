import{u as wt}from"./GMLocJHP.js";import{c$ as f,ap as At,L as Nt,ax as Jt,cL as Lt,gO as Mt,cW as $t,bL as gt,r as x,gU as jt,f as C,J as Tt,dJ as zt,gT as Rt,hO as Gt,F as yt,a$ as Vt,hN as K,ah as Z,ai as tt,hP as j,hQ as ht}from"./DZZ6t_j4.js";import{a as xt}from"./i4aLU0Nw.js";import{a as Ct}from"./B05h-4V9.js";const Et=[f.Attachment,f.QrCode,f.Barcode,f.Button],[Qt,Ut]=wt((m,k,v,J=!1)=>{const{api:L}=At(),{appInfo:E}=Nt(),{base:N}=Jt(Lt()),{sharedView:et,fetchSharedViewData:mt,fetchBulkAggregatedData:nt,fetchBulkListData:vt,fetchBulkGroupData:St}=Mt(),{gridViewCols:q}=xt(),{getMeta:F}=$t(),kt=gt(jt,x(null)),D=C(()=>{const e=[];return Object.values(q.value).forEach(t=>{var n,a;if(t.group_by){const r=(a=(n=k==null?void 0:k.value)==null?void 0:n.columns)==null?void 0:a.find(s=>s.id===t.fk_column_id);r&&e.push({column:r,sort:t.group_by_sort||"asc",order:t.group_by_order||1})}}),e.sort((t,n)=>(t.order??1/0)-(n.order??1/0)),e}),Dt=C(()=>!!D.value.length),{isUIAllowed:I}=Tt(),{sorts:T,nestedFilters:A}=Ct(),Q=gt(Rt,zt()),_=C(()=>{var e;return((e=E.value.defaultGroupByLimit)==null?void 0:e.limitGroup)||25}),M=C(()=>{var e;return((e=E.value.defaultGroupByLimit)==null?void 0:e.limitRecord)||10}),at=x([]),bt=C(()=>{var e;return(((e=k==null?void 0:k.value)==null?void 0:e.columns)||[]).filter(t=>Et.includes(t.uidt)?!1:t.uidt===f.Lookup?t.id&&at.value.includes(t.id):!0)}),p=x({key:"root",color:"root",count:0,column:{},nestedIn:[],aggregations:{},paginationData:{page:1,pageSize:_.value},nested:!0,children:[],root:!0});async function it(e,t){t=t||p.value,t&&(t.paginationData.page=e,await ot({offset:(e-1)*(t.paginationData.pageSize||_.value)},t))}const H=e=>e.map(t=>({row:{...t},oldRow:{...t},rowMeta:{}})),U=(e,t,n)=>t.uidt===f.Checkbox?e?j.TRUE:j.FALSE:[f.User,f.CreatedBy,f.LastModifiedBy].includes(t.uidt)&&!e?j.NULL:t.uidt===f.LinkToAnotherRecord&&n&&e&&typeof e=="object"?e[n]??j.NULL:(e&&typeof e=="object"&&(e=JSON.stringify(e)),e??j.NULL),z=x(Gt.light),G=x(z.value[0]),Y=()=>{const e=G.value,t=z.value.indexOf(G.value);return t===z.value.length-1?G.value=z.value[0]:G.value=z.value[t+1],e},_t=(e,t)=>{var n,a;if(t)switch(t.uidt){case f.MultiSelect:{const r=(e==null?void 0:e.split(","))||[],s=[];for(const i of r){const o=(n=t.colOptions.options)==null?void 0:n.find(g=>g.title===i);o&&s.push(o.color)}return s.join(",")}case f.SingleSelect:{const r=(a=t.colOptions.options)==null?void 0:a.find(s=>s.title===e);return r?r.color||Y():"gray"}case f.Checkbox:return e?ht.success:ht.error;default:return e?Y():"gray"}return e?Y():"gray"},$=(e,t="")=>e.reduce((n,a)=>{if(a.key===j.NULL)n+=`${n.length?"~and":""}(${a.title},gb_null)`;else if(a.column_uidt===f.Checkbox)n+=`${n.length?"~and":""}(${a.title},${a.key===j.TRUE?"checked":"notchecked"})`;else if([f.Date,f.DateTime,f.CreatedTime,f.LastModifiedTime].includes(a.column_uidt))n+=`${n.length?"~and":""}(${a.title},gb_eq,exactDate,${a.key})`;else if([f.User,f.CreatedBy,f.LastModifiedBy].includes(a.column_uidt))try{const r=JSON.parse(a.key);n+=`${n.length?"~and":""}(${a.title},gb_eq,${(Array.isArray(r)?r:[r]).map(s=>s.id).join(",")})`}catch(r){console.error(r)}else n+=`${n.length?"~and":""}(${a.title},gb_eq,${a.key})`;return n},t),X=e=>{if(e==="asc")return"+";if(e==="desc")return"-";if(e==="count-asc")return"~+";if(e==="count-desc")return"~-"},st=async(e,t)=>{var s;t=t||p.value;const n=D.value[t.nestedIn.length];if(!n)return t;const a=e.list.reduce((i,o)=>{const g=i.find(u=>u.key===U(o[n.column.column_name]??o[n.column.title],n.column));return g?(g.count+=+o.count,g.paginationData={page:1,pageSize:t.paginationData.pageSize||_.value,totalRows:g.count},i):(n.column.title&&n.column.uidt&&i.push({key:U(o[n.column.title],n.column),column:n.column,count:+o.count,color:_t(o[n.column.title],n.column),nestedIn:[...t.nestedIn,{title:n.column.title,column_name:n.column.title,key:U(o[n.column.title],n.column),column_uidt:n.column.uidt}],aggregations:o.aggregations??{},paginationData:{page:1,pageSize:t.nestedIn.length<D.value.length-1?t.paginationData.pageSize||_.value:M.value,totalRows:+o.count},nested:t.nestedIn.length<D.value.length-1}),i)},[]);t.children||(t.children=[]);for(const i of a){const o=(s=t.children)==null?void 0:s.find(g=>g.key===i.key);if(o){i.paginationData={page:o.paginationData.page||i.paginationData.page,pageSize:o.paginationData.pageSize||i.paginationData.pageSize,totalRows:i.count},i.color=o.color,Object.assign(o,i);continue}t.children.push(i)}t.children=t.children.filter(i=>a.find(o=>o.key===i.key)),t.count<=(t.paginationData.pageSize??_.value)&&t.children.sort((i,o)=>{const g=a.findIndex(h=>h.key===i.key),u=a.findIndex(h=>h.key===o.key);return g-u}),t.paginationData=e.pageInfo;const r=Math.max(1,Math.ceil(t.paginationData.totalRows/t.paginationData.pageSize));return r<t.paginationData.page&&await it(r,t),t};async function ot(e={},t,n){var a,r,s,i,o,g,u,h,R;try{if(t=t||p.value,!((a=N==null?void 0:N.value)!=null&&a.id)||!((r=m.value)!=null&&r.id)||!((s=m.value)!=null&&s.fk_model_id)||!t)return;if(D.value.length===0){t.children=[];return}if(t.nestedIn.length>D.value.length)return;t.nestedIn.length===0&&(G.value=z.value[0]);const b=D.value[t.nestedIn.length],V=$(t.nestedIn,v==null?void 0:v.value);if(!b||!b.column.title||J&&!((i=et.value)!=null&&i.uuid))return;if(b.column.uidt===f.LinkToAnotherRecord){const S=await F(b.column.colOptions.fk_related_model_id);if(!S)return;t.displayValueProp=((u=((o=S.columns)==null?void 0:o.find(O=>O.pv))||((g=S.columns)==null?void 0:g[0]))==null?void 0:u.title)||""}if(!(n!=null&&n.triggerChildOnly)){const S=J?await L.public.dataGroupBy(et.value.uuid,{offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??_.value),limit:t.paginationData.pageSize??_.value,...e,where:V,sort:`${X(b.sort)}${b.column.title}`,column_name:b.column.title,sortsArr:T.value,filtersArr:A.value},{headers:{"xc-password":kt.value}}):await L.dbViewRow.groupBy("noco",N.value.id,m.value.fk_model_id,m.value.id,{offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??_.value),limit:t.paginationData.pageSize??_.value,...e,...I("sortSync")?{}:{sortArrJson:JSON.stringify(T.value)},...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)},where:`${V}`,sort:`${X(b.sort)}${b.column.title}`,column_name:b.column.title});t=await st(S,t)}if(E.value.ee){const S=new Map,O=Object.values(q.value).map(d=>({field:d.fk_column_id,type:d.aggregation??K.None})).filter(d=>d.type!==K.None),y=(t.children??[]).map(d=>{let l=d.key;(!(l!=null&&l.length)||l.startsWith(" ")||l.endsWith(" "))&&(l=Math.random().toString(36).substring(7),S.set(l,d.key));try{if(l=JSON.parse(l),typeof l=="object")return l=Math.random().toString(36).substring(7),S.set(l,d.key),{where:$(d.nestedIn,v==null?void 0:v.value),alias:l,...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)}}}catch{}return{where:$(d.nestedIn,v==null?void 0:v.value),alias:l,...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)}}}),c=J?await nt({aggregation:O},y):await L.dbDataTableBulkAggregate.dbDataTableBulkAggregate(k.value.id,{viewId:m.value.id,aggregation:O},y);Object.entries(c).forEach(([d,l])=>{const B=((t==null?void 0:t.children)??[]).find(w=>w.key.toString()===d.toString());if(B)Object.assign(B.aggregations,l);else{const w=S.get(d),P=((t==null?void 0:t.children)??[]).find(It=>It.key.toString()===w.toString());P&&Object.assign(P.aggregations,l)}})}if(t!=null&&t.children&&t.nestedIn.length===D.value.length-1){const S=new Map,O=(h=t==null?void 0:t.children)==null?void 0:h.map(y=>{let c=y.key;(!(c!=null&&c.length)||c.startsWith(" ")||c.endsWith(" "))&&(c=Math.random().toString(36).substring(7),S.set(c,y.key));try{c=JSON.parse(c),typeof c=="object"&&(c=Math.random().toString(36).substring(7),S.set(c,y.key))}catch{}return{alias:c,where:$(y.nestedIn,v==null?void 0:v.value),offset:((y.paginationData.page??0)-1)*(y.paginationData.pageSize??M.value),limit:y.paginationData.pageSize??M.value,...I("sortSync")?{}:{sortArrJson:JSON.stringify(T.value)},...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)}}});if(O.length>0){const y=J?await vt({},O):await L.dbDataTableBulkList.dbDataTableBulkList(k.value.id,{viewId:m.value.id},O,{});Object.entries(y).forEach(([c,d])=>{const l=((t==null?void 0:t.children)??[]).find(B=>B.key.toString()===c.toString());if(l)l.count=d.pageInfo.totalRows??0,l.rows=H(d.list),l.paginationData=d.pageInfo;else{const B=S.get(c),w=((t==null?void 0:t.children)??[]).find(P=>P.key.toString()===B.toString());w&&(w.count=d.pageInfo.totalRows??0,w.rows=H(d.list),w.paginationData=d.pageInfo)}})}}if(t!=null&&t.children&&t.nestedIn.length<D.value.length-1){const S=new Map,O=(R=t==null?void 0:t.children)==null?void 0:R.map(y=>{const c=D.value[y.nestedIn.length],d=$(y.nestedIn,v==null?void 0:v.value);let l=y.key;(!(l!=null&&l.length)||l.startsWith(" ")||l.endsWith(" "))&&(l=Math.random().toString(36).substring(7),S.set(l,y.key));try{l=JSON.parse(l),typeof l=="object"&&(l=Math.random().toString(36).substring(7),S.set(l,y.key))}catch{}return{alias:l,offset:((y.paginationData.page??0)-1)*(y.paginationData.pageSize??_.value),limit:y.paginationData.pageSize??_.value,...I("sortSync")?{}:{sortArrJson:JSON.stringify(T.value)},...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)},where:`${d}`,sort:`${X(c.sort)}${c.column.title}`,column_name:c.column.title}});if(O.length>0){const y=J?await St({},O):await L.dbDataTableBulkGroupList.dbDataTableBulkGroupList(k.value.id,{viewId:m.value.id},O);for(const[c,d]of Object.entries(y)){let l=((t==null?void 0:t.children)??[]).find(B=>B.key.toString()===c.toString());if(!l){const B=S.get(c);l=((t==null?void 0:t.children)??[]).find(w=>w.key.toString()===B.toString())}Object.assign(l,await st(d,l))}}}}catch(b){console.log(b),Z.error(await tt(b))}}async function lt(e,t=!1,n={}){var a,r,s;try{if(!((a=N==null?void 0:N.value)!=null&&a.id)||!((r=m.value)!=null&&r.id)||!((s=m.value)!=null&&s.fk_model_id)||e.children&&!t)return;e.paginationData||(e.paginationData={page:1,pageSize:M.value});const i=$(e.nestedIn,v==null?void 0:v.value),o={offset:((e.paginationData.page??0)-1)*(e.paginationData.pageSize??M.value),limit:e.paginationData.pageSize??M.value,where:`${i}`},g=J?await mt({sortsArr:T.value,filtersArr:A.value,...o},{isGroupBy:!0}):await L.dbViewRow.list("noco",N.value.id,m.value.fk_model_id,m.value.id,{...o,...n,...I("sortSync")?{}:{sortArrJson:JSON.stringify(T.value)},...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)}});e.count=g.pageInfo.totalRows??0,e.rows=H(g.list),e.paginationData=g.pageInfo}catch(i){Z.error(await tt(i))}}async function pt(e,t){var n,a,r;try{if(!((n=k==null?void 0:k.value)!=null&&n.id)||!((a=m.value)!=null&&a.id)||!((r=m.value)!=null&&r.fk_model_id)||!E.value.ee)return;let s=t;if(t||(s=Object.values(q.value).map(u=>({field:u.fk_column_id,type:u.aggregation??K.None}))),s=s==null?void 0:s.filter(u=>u.type!==K.None),s&&!(s!=null&&s.length))return;const i=new Map,o=(e.children??[]).map(u=>{let h=u.key;(!(h!=null&&h.length)||h.startsWith(" ")||h.endsWith(" "))&&(h=Math.random().toString(36).substring(7),i.set(h,u.key));try{h=JSON.parse(u.key),typeof h=="object"&&(h=Math.random().toString(36).substring(7),i.set(h,u.key))}catch{}return{where:$(u.nestedIn,v==null?void 0:v.value),alias:h,...I("filterSync")?{}:{filterArrJson:JSON.stringify(A.value)}}}),g=J?await nt({...s?{aggregation:s}:{}},o):await L.dbDataTableBulkAggregate.dbDataTableBulkAggregate(k.value.id,{viewId:m.value.id,...s?{aggregation:s}:{}},o);Object.entries(g).forEach(([u,h])=>{const R=(e.children??[]).find(b=>b.key.toString()===u.toString());if(R)Object.assign(R.aggregations,h);else{const b=i.get(u);if(b){const V=(e.children??[]).find(S=>S.key.toString()===b.toString());V&&Object.assign(V.aggregations,h)}}})}catch(s){Z.error(await tt(s))}}const Ot=async(e,t)=>{e.paginationData||(e.paginationData={page:1,pageSize:M.value}),e.paginationData.page=t,await lt(e,!0)},rt=(e,t=0)=>{if(e=e||p.value,!!e&&(t<D.value.length?e.nested=!0:e.nested=!1,e.nested?e!=null&&e.rows&&(e.rows=[]):e!=null&&e.children&&(e.children=[]),!(t>D.value.length)))for(const n of e.children||[])rt(n,t+1)};yt(()=>D.value.length,async()=>{D.value.length>0&&(p.value.paginationData={page:1,pageSize:_.value},p.value.column={},rt(),Vt(()=>Q==null?void 0:Q.trigger()))});const ct=(e,t,n=0)=>{var r;if(t=t||p.value,n>=e.length)return t;const a=(r=t.children)==null?void 0:r.find(s=>s.key===e[n].key);return a?a.nested?ct(e,a,n+1):a:t},dt=e=>ct(e.nestedIn.slice(0,-1)),W=(e,t)=>{var n;if(e){if(e.count+=t,e.count===0){const a=dt(e);a&&(a.children=(n=a.children)==null?void 0:n.filter(r=>r.key!==e.key))}e.root||W(dt(e),t)}},ft=(e,t,n=0)=>{var a;if(t=t||p.value,t.nested){const r=(a=t.children)==null?void 0:a.find(s=>{if(D.value[n].column.title)return s.key===U(e.row[D.value[n].column.title],D.value[n].column,t.displayValueProp)});return r?ft(e,r,n+1):{found:!1,group:t}}return{found:!0,group:t}},ut=e=>{var t;e=e||p.value,e&&(!e.nested&&e.rows?e.rows.forEach(n=>{var r,s,i,o;const a=ft(n);a.found?a.group!==e&&(a.group&&((r=a.group.rows)==null||r.push(n),W(a.group,1)),e&&((s=e.rows)==null||s.splice(e.rows.indexOf(n),1),W(e,-1))):e?((i=e.rows)==null||i.splice(e.rows.indexOf(n),1),W(e,-1)):(o=p.value.rows)==null||o.splice(p.value.rows.indexOf(n),1)}):(t=e.children)==null||t.forEach(n=>ut(n)))},Bt=async()=>{var t,n,a,r;const e=[];try{for(const s of((t=k==null?void 0:k.value)==null?void 0:t.columns)||[]){if(s.uidt!==f.Lookup)continue;let i=s;for(;i&&i.uidt===f.Lookup;){const o=(a=(n=await F(i.fk_model_id))==null?void 0:n.columns)==null?void 0:a.find(u=>u.id===(i==null?void 0:i.colOptions).fk_relation_column_id);if(!(o!=null&&o.colOptions))break;const g=await F((o==null?void 0:o.colOptions).fk_related_model_id);if(i=(r=g==null?void 0:g.columns)==null?void 0:r.find(u=>u.id===(i==null?void 0:i.colOptions).fk_lookup_column_id),(i==null?void 0:i.id)===s.id)break}(i==null?void 0:i.uidt)!==f.Attachment&&s.id&&e.push(s.id)}at.value=e}catch(s){console.error(s)}};return yt([()=>{var e;return(e=m==null?void 0:m.value)==null?void 0:e.id},()=>{var e;return(e=k.value)==null?void 0:e.columns}],async([e])=>{var t,n;e&&((t=m.value)==null?void 0:t.fk_model_id)===((n=k.value)==null?void 0:n.id)&&await Bt()}),{rootGroup:p,groupBy:D,isGroupBy:Dt,fieldsToGroupBy:bt,groupByLimit:3,loadGroups:ot,loadGroupData:lt,loadGroupPage:Ot,loadGroupAggregation:pt,groupWrapperChangePage:it,redistributeRows:ut}},"useViewGroupBy");function Ht(){const m=Ut();if(m==null)throw new Error("Please call `useProvideViewGroupBy` on the appropriate parent component");return m}export{Ht as a,Qt as u};
