import{u as Ie}from"./CO8XXsKl.js";import{cZ as $e,az as Se,cN as _e,bN as Z,r as v,d9 as Ce,aF as be,c_ as Pe,gE as Ve,at as le,ai as qe,dB as Ae,g,gA as Ne,d2 as se,df as ge,ct as Ue,cu as Le,ib as Fe,H as ie,u as je,gL as U,fR as T,gk as ze,gl as Be,aj as F,ak as Q,cc as Ge,A as Je}from"./Cgw6cdOy.js";import{a as He}from"./MA4kh5_N.js";const[xe,Ke]=Ie((s,f,V,L=j=>{})=>{var fe,ce,pe;const{metas:j,getMeta:Oe}=$e(),{base:q}=Se(_e()),{$api:O,$e:W}=Je(),ue=Z(Ce,v()),we=Z(be,v(!1)),{addUndo:re,clone:G,defineViewScope:ne}=Pe(),oe=Z(Ve,v(null)),w=v(),I=v(),o=le({page:1,query:"",size:10}),E=v(0),p=le({page:1,query:"",size:10}),m=v(0),X=v(!1),$=v([]),z=v([]),A=v([]),Y=v(!1),S=v([]),ve=le({state:null}),_=v(0),{t:J}=qe(),de=Z(Ae,v(!1)),c=g(()=>{var e;return(e=s.value)==null?void 0:e.colOptions}),{sharedView:x}=Ne(),D=((fe=q.value)==null?void 0:fe.id)||((pe=(ce=x.value)==null?void 0:ce.view)==null?void 0:pe.base_id),C=g(()=>{var e,a;return(a=j==null?void 0:j.value)==null?void 0:a[(e=s==null?void 0:s.value)==null?void 0:e.fk_model_id]}),r=g(()=>{var e,a;return(a=j.value)==null?void 0:a[(e=c.value)==null?void 0:e.fk_related_model_id]}),b=g(()=>C.value.columns.filter(e=>e.pk).map(e=>{var a,l;return(l=(a=f==null?void 0:f.value)==null?void 0:a.row)==null?void 0:l[e.title]}).join("___")),H=e=>{var a,l;return(l=(a=r.value)==null?void 0:a.columns)==null?void 0:l.filter(t=>t.pk).map(t=>(e==null?void 0:e[t.title])??(e==null?void 0:e[t.id])).join("___")},Ee=async()=>{await Oe(c.value.fk_related_model_id)},P=g(()=>{var e,a,l,t,i;return((i=((a=(e=r.value)==null?void 0:e.columns)==null?void 0:a.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.title)||""}),me=g(()=>{var e,a,l,t,i;return((i=((a=(e=r.value)==null?void 0:e.columns)==null?void 0:a.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.id)||""}),Re=g(()=>{var e,a,l;return((l=(a=(e=r.value)==null?void 0:e.columns)==null?void 0:a.filter(t=>t.pk))==null?void 0:l.map(t=>t.title))??[]}),K=g(()=>{var e,a,l,t,i;return(i=((a=(e=C.value)==null?void 0:e.columns)==null?void 0:a.find(u=>u.pv))||((t=(l=r==null?void 0:r.value)==null?void 0:l.columns)==null?void 0:t[0]))==null?void 0:i.title}),B=g(()=>{var l,t,i,u,d,R;let e={type:"",format:""};const a=((t=(l=r.value)==null?void 0:l.columns)==null?void 0:t.find(n=>n.pv))||((u=(i=r==null?void 0:r.value)==null?void 0:i.columns)==null?void 0:u[0]);return a&&((a==null?void 0:a.uidt)===se.DateTime&&(e={type:a==null?void 0:a.uidt,format:`${((d=ge(a==null?void 0:a.meta))==null?void 0:d.date_format)??Ue[0]} ${((R=ge(a==null?void 0:a.meta))==null?void 0:R.time_format)??Le[0]}`}),(a==null?void 0:a.uidt)===se.Time&&(e={type:a==null?void 0:a.uidt,format:`${Le[0]}`})),e}),ke=g(()=>f.value.row[K.value]&&B.value.type&&B.value.format?Fe(f.value.row[K.value],B.value.format,B.value.format!==se.Time):f.value.row[K.value]),M=async(e,a=!1)=>{var l,t,i,u,d,R;e&&(ve.state=e);try{let n=o.size*(o.page-1)-E.value;if((n<0||a)&&(n=0,E.value=0,o.page=1),Y.value=!0,de.value){const y=je().currentRoute;let k;if(we.value){const{formState:N}=He();k=N==null?void 0:N.value}w.value=await O.public.dataRelationList(y.value.params.viewId,s.value.id,{},{headers:{"xc-password":oe.value},query:{limit:o.size,offset:n,where:o.query&&`(${P.value},like,${o.query})`,fields:[P.value,...Re.value],rowData:JSON.stringify(k)}})}else if(V!=null&&V.value)w.value=await O.dbTableRow.list(U,D,(l=r==null?void 0:r.value)==null?void 0:l.id,{limit:o.size,offset:n,where:o.query&&`(${P.value},like,${o.query})`,linkColumnId:s.value.fk_column_id||s.value.id,linkRowData:JSON.stringify(f.value.row)});else{let h;try{(t=f.value)!=null&&t.row&&(h=Object.keys((i=f.value)==null?void 0:i.row).reduce((y,k)=>(f.value.row[k]!==f.value.oldRow[k]&&(y[k]=f.value.row[k]),y),{}))}catch{}w.value=await O.dbTableRow.nestedChildrenExcludedList(U,D,C.value.id,encodeURIComponent(b.value),c.value.type,(u=s==null?void 0:s.value)==null?void 0:u.id,{limit:String(o.size),offset:String(n),where:o.query&&`(${P.value},like,${o.query})`,linkRowData:h?JSON.stringify(h):void 0})}(d=w.value)==null||d.list.forEach((h,y)=>{S.value[y]=!1,A.value[y]=!1}),(R=w.value)!=null&&R.list&&e&&e[s.value.title]&&w.value.list.forEach((h,y)=>{([T.BELONGS_TO,T.ONE_TO_ONE].includes(c.value.type)?[e[s.value.title]]:e[s.value.title]).find(N=>{let ye=!0;for(const he in N)N[he]!==h[he]&&(ye=!1);return ye})&&(S.value[y]=!0)})}catch(n){const h=await ze(n);if(h.error===Be.INVALID_OFFSET_VALUE)return o.page=0,M(e,!0);F.error(`${J("msg.error.failedToLoadList")}: ${h.message}`)}finally{Y.value=!1}},ee=async(e=!1)=>{var a,l,t,i,u,d,R;try{if(X.value=!0,[T.BELONGS_TO,T.ONE_TO_ONE].includes(c.value.type)||!b.value||!s.value)return;let n=p.size*(p.page-1)+m.value;n<0||e?(n=0,m.value=0,p.page=1):n>=_.value&&(n=0),de.value?I.value=await O.public.dataNestedList((a=x.value)==null?void 0:a.uuid,encodeURIComponent(b.value),c.value.type,s.value.id,{limit:String(p.size),offset:String(n),where:p.query&&`(${P.value},like,${p.query})`},{headers:{"xc-password":oe.value}}):I.value=await O.dbTableRow.nestedList(U,((l=q==null?void 0:q.value)==null?void 0:l.id)||((i=(t=x.value)==null?void 0:t.view)==null?void 0:i.base_id),C.value.id,encodeURIComponent(b.value),c.value.type,(u=s==null?void 0:s.value)==null?void 0:u.id,{limit:String(p.size),offset:String(n),where:p.query&&`(${P.value},like,${p.query})`}),(d=I.value)==null||d.list.forEach((h,y)=>{z.value[y]=!0,$.value[y]=!1}),p.query||(_.value=((R=I.value)==null?void 0:R.pageInfo.totalRows)??0)}catch(n){F.error(`${J("msg.error.failedToLoadChildrenList")}: ${await Q(n)}`)}finally{X.value=!1}},Te=async(e,a)=>{Ge.confirm({title:"Do you want to delete the record?",type:"warning",onOk:async()=>{const l=H(e);try{const t=await O.dbTableRow.delete(U,D,r.value.id,encodeURIComponent(l));if(t.message)return F.info(`Record delete failed: ${`Unable to delete record with ID ${l} because of the following:
              
${t.message.join(`
`)}.

              Clear the data first & try again`})}`),!1;L==null||L({shouldShowLoading:!1}),V!=null&&V.value||await ee(),a==null||a(e),W("a:links:delete-related-row")}catch(t){F.error(`${J("msg.error.deleteFailed")}: ${await Q(t)}`)}}})},ae=async(e,{metaValue:a=C.value}={},l=!1,t)=>{var i;try{m.value=m.value-1,E.value=E.value-1,A.value[t]=!0,$.value[t]=!0,await O.dbTableRow.nestedRemove(U,q.value.id,a.id,encodeURIComponent(b.value),c.value.type,(i=s==null?void 0:s.value)==null?void 0:i.id,encodeURIComponent(H(e))),l||re({redo:{fn:u=>ae(u,{},!0,t),args:[G(e)]},undo:{fn:u=>te(u,{},!0,t),args:[G(e)]},scope:ne({view:ue.value})}),S.value[t]=!1,z.value[t]=!1,c.value.type!==T.BELONGS_TO&&c.value.type!==T.ONE_TO_ONE&&(_.value=_.value-1)}catch(u){F.error(`${J("msg.error.unlinkFailed")}: ${await Q(u)}`)}finally{A.value[t]=!1,$.value[t]=!1}L==null||L({shouldShowLoading:!1}),W("a:links:unlink")},te=async(e,{metaValue:a=C.value}={},l=!1,t)=>{var i,u;try{A.value[t]=!0,$.value[t]=!0,m.value=m.value+1,E.value=E.value+1,await O.dbTableRow.nestedAdd(U,q.value.id,a.id,encodeURIComponent(b.value),c.value.type,(i=s==null?void 0:s.value)==null?void 0:i.id,encodeURIComponent(H(e))),l||re({redo:{fn:d=>te(d,{},!0,t),args:[G(e)]},undo:{fn:d=>ae(d,{},!0,t),args:[G(e)]},scope:ne({view:ue.value})}),S.value[t]=!0,z.value[t]=!0,c.value.type!==T.BELONGS_TO&&c.value.type!==T.ONE_TO_ONE?_.value=_.value+1:(S.value=Array((u=w.value)==null?void 0:u.list.length).fill(!1),S.value[t]=!0)}catch(d){F.error(`Linking failed: ${await Q(d)}`)}finally{A.value[t]=!1,$.value[t]=!1}L==null||L({shouldShowLoading:!1}),W("a:links:link")};return ie(o,async()=>{await M(ve.state)}),ie(p,async()=>{await ee()}),ie(I,async()=>{var e;(e=I.value)==null||e.list.forEach((a,l)=>{z.value[l]=!0,$.value[l]=!1})}),{relatedTableMeta:r,loadRelatedTableMeta:Ee,relatedTableDisplayValueProp:P,displayValueTypeAndFormatProp:B,childrenExcludedList:w,childrenList:I,childrenListCount:_,childrenListOffsetCount:m,childrenExcludedOffsetCount:E,rowId:b,childrenExcludedListPagination:o,childrenListPagination:p,displayValueProp:K,meta:C,unlink:ae,link:te,loadChildrenExcludedList:M,loadChildrenList:ee,isChildrenExcludedListLinked:S,isChildrenListLinked:z,isChildrenListLoading:$,isChildrenExcludedListLoading:A,row:f,isChildrenLoading:X,isChildrenExcludedLoading:Y,deleteRelatedRow:Te,getRelatedTableRowId:H,headerDisplayValue:ke,relatedTableDisplayValuePropId:me,resetChildrenExcludedOffsetCount:()=>{E.value=0},resetChildrenListOffsetCount:()=>{m.value=0}}},"ltar-store");function De(){const s=Ke();if(s==null)throw new Error("Please call `useLTARStore` on the appropriate parent component");return s}export{De as a,xe as u};
